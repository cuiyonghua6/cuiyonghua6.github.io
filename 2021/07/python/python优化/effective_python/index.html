<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>Effective Python（摘录） | 崔永华的个人网站</title>
  <meta name="keywords" content=" python优化 , python基础 ">
  <meta name="description" content="Effective Python（摘录） | 崔永华的个人网站">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="标签">
<meta property="og:url" content="http://cuiyonghua.com/tags/index.html">
<meta property="og:site_name" content="崔永华的个人网站">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-07-04T03:30:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="标签">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0"></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.1.0"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="undefined">
  <input class="theme_blog_path" value>
  <input id="theme_shortcut" value="true">
  <input id="theme_highlight_on" value="true">
  <input id="theme_code_copy" value="true">
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>崔永华</span>
</div>

<div class="icon">
    
        
            <a title="csdn"
               href="https://cuiyonghua.blog.csdn.net/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/cuiyonghua6"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="https://weibo.com/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/people/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(357)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="爬虫">
                        <i class="fold iconfont icon-right"></i>
                        
                        爬虫
                        <small>(66)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="爬虫<--->appium">
                                        
                                        appium
                                        
                                            <small>(5
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->pyppeteer">
                                        
                                        pyppeteer
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->scrapy">
                                        
                                        scrapy
                                        
                                            <small>(12
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->selenium">
                                        
                                        selenium
                                        
                                            <small>(11
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->反爬逆向">
                                        
                                        反爬逆向
                                        
                                            <small>(10
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->爬虫总结">
                                        
                                        爬虫总结
                                        
                                            <small>(12
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->爬虫案例">
                                        
                                        爬虫案例
                                        
                                            <small>(14
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="数据处理">
                        <i class="fold iconfont icon-right"></i>
                        
                        数据处理
                        <small>(30)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="数据处理<--->ES">
                                        
                                        ES
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->MySQL">
                                        
                                        MySQL
                                        
                                            <small>(6
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->PostgreSQL">
                                        
                                        PostgreSQL
                                        
                                            <small>(20
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->大数据">
                                        
                                        大数据
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="python">
                        <i class="fold iconfont icon-right"></i>
                        
                        python
                        <small>(118)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="python<--->python优化">
                                        
                                        python优化
                                        
                                            <small>(8
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python基础">
                                        
                                        python基础
                                        
                                            <small>(28
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python案例">
                                        
                                        python案例
                                        
                                            <small>(32
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python模块">
                                        
                                        python模块
                                        
                                            <small>(10
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python算法">
                                        
                                        python算法
                                        
                                            <small>(19
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->web">
                                        
                                        web
                                        
                                            <small>(21
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="前端">
                        <i class="fold iconfont icon-right"></i>
                        
                        前端
                        <small>(33)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="前端<--->javascript">
                                        
                                        javascript
                                        
                                            <small>(16
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="前端<--->jQuery">
                                        
                                        jQuery
                                        
                                            <small>(7
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="前端<--->vue">
                                        
                                        vue
                                        
                                            <small>(6
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="前端<--->前端案例">
                                        
                                        前端案例
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="部署">
                        <i class="fold iconfont icon-right"></i>
                        
                        部署
                        <small>(7)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="部署<--->jenkins">
                                        
                                        jenkins
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="部署<--->linux">
                                        
                                        linux
                                        
                                            <small>(6
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="java">
                        <i class="fold iconfont icon-right"></i>
                        
                        java
                        <small>(78)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="java<--->java基础">
                                        
                                        java基础
                                        
                                            <small>(20
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java案例">
                                        
                                        java案例
                                        
                                            <small>(25
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java算法">
                                        
                                        java算法
                                        
                                            <small>(8
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java设计模式">
                                        
                                        java设计模式
                                        
                                            <small>(25
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="其它">
                        <i class="fold iconfont icon-right"></i>
                        
                        其它
                        <small>(19)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="其它<--->Android">
                                        
                                        Android
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->工具">
                                        
                                        工具
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->英语">
                                        
                                        英语
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->计算机">
                                        
                                        计算机
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->读书">
                                        
                                        读书
                                        
                                            <small>(6
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="机器学习">
                        <i class="fold iconfont icon-right"></i>
                        
                        机器学习
                        <small>(6)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="机器学习<--->NLP">
                                        
                                        NLP
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="机器学习<--->科学计算">
                                        
                                        科学计算
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="357">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
            <li><a target="_blank" href="https://blog.wedaggo.com/">冯义万</a></li>
            
            <li><a target="_blank" href="https://xu-shaoyu.github.io/">徐绍玉</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>36计解说</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>appium</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ES</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>fastapi</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>flask</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hive</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>javascript</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java基础</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java打印图形</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java设计模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>jQuery</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>linum</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>MySQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>NLP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PostgreSQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pyppeteer</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python3</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python优化</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python基础</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>scrapy</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>selenium</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vue</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>web</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>其它</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>前端</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>前端案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>反爬逆向</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>大数据</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>工具</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数据处理</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>日常生活</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>机器学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>爬虫</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>爬虫总结</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>爬虫案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>科学计算</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>英语</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>计算机</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>读书</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>部署</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 其它 工具 "
           href="/2021/08/others/tools/Processing介绍及几个python模式下的案例/"
           data-tag="其它,工具"
           data-author="" >
            <span class="post-title" title="Processing介绍及几个python模式下的案例">Processing介绍及几个python模式下的案例</span>
            <span class="post-date" title="2021-08-08 20:00:20">2021/08/08</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/08/spider/cases/爬取热榜数据并通过Qt界面显示/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取热榜数据并通过Qt界面显示">爬取热榜数据并通过Qt界面显示</span>
            <span class="post-date" title="2021-08-07 16:42:38">2021/08/07</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/08/front/07vue/vue流行的UI库和开源的项目/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue流行的UI库和开源的项目">vue流行的UI库和开源的项目</span>
            <span class="post-date" title="2021-08-04 15:24:20">2021/08/04</span>
        </a>
        
        <a  class="全部文章 其它 工具 "
           href="/2021/08/others/tools/markdown中数学符号公式整理/"
           data-tag="其它,工具"
           data-author="" >
            <span class="post-title" title="markdown中数学符号公式整理">markdown中数学符号公式整理</span>
            <span class="post-date" title="2021-08-01 20:00:20">2021/08/01</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/异步爬虫爬照片/"
           data-tag="爬虫,爬虫案例"
           data-author="" >
            <span class="post-title" title="异步爬虫爬照片">异步爬虫爬照片</span>
            <span class="post-date" title="2021-07-25 16:04:43">2021/07/25</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2021/07/python/python优化/effective_python/"
           data-tag="python优化,python基础"
           data-author="" >
            <span class="post-title" title="Effective Python（摘录）">Effective Python（摘录）</span>
            <span class="post-date" title="2021-07-21 15:24:20">2021/07/21</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/爬取豆瓣top250数据/"
           data-tag="python,爬虫案例"
           data-author="" >
            <span class="post-title" title="分别用多进程，多线程，协程爬取豆瓣top250数据">分别用多进程，多线程，协程爬取豆瓣top250数据</span>
            <span class="post-date" title="2021-07-19 20:34:53">2021/07/19</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/爬取九酷音乐/"
           data-tag="python,爬虫案例"
           data-author="" >
            <span class="post-title" title="爬取九酷音乐">爬取九酷音乐</span>
            <span class="post-date" title="2021-07-12 20:44:15">2021/07/12</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2021/06/python/python算法/cases/python解决约瑟夫环问题/"
           data-tag="python,python算法"
           data-author="" >
            <span class="post-title" title="python解决约瑟夫环问题">python解决约瑟夫环问题</span>
            <span class="post-date" title="2021-06-27 22:09:25">2021/06/27</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2021/06/python/python优化/用装饰器改进代码/"
           data-tag="python,python优化"
           data-author="" >
            <span class="post-title" title="用装饰器改进代码">用装饰器改进代码</span>
            <span class="post-date" title="2021-06-26 15:24:20">2021/06/26</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2021/06/spider/selenium/案例_从谷歌插件中爬取胖球信息/"
           data-tag="python,selenium"
           data-author="" >
            <span class="post-title" title="案例_从谷歌插件中爬取胖球信息">案例_从谷歌插件中爬取胖球信息</span>
            <span class="post-date" title="2021-06-25 16:42:38">2021/06/25</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2021/06/spider/selenium/linux上安装selenium环境及测试/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="linux上安装selenium环境及测试">linux上安装selenium环境及测试</span>
            <span class="post-date" title="2021-06-24 19:03:22">2021/06/24</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2021/06/python/python优化/好代码的一般特征/"
           data-tag="python,python优化"
           data-author="" >
            <span class="post-title" title="好代码的一般特征">好代码的一般特征</span>
            <span class="post-date" title="2021-06-22 15:24:20">2021/06/22</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2021/06/python/cases/比较2个图片的相似度/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="比较2个图片的相似度">比较2个图片的相似度</span>
            <span class="post-date" title="2021-06-21 13:50:19">2021/06/21</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/05/front/07vue/vue3.x面试总结/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue3.x面试总结">vue3.x面试总结</span>
            <span class="post-date" title="2021-05-15 15:24:20">2021/05/15</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/05/front/07vue/vue3.x经典案例46个/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue3.x经典案例46个">vue3.x经典案例46个</span>
            <span class="post-date" title="2021-05-12 15:24:20">2021/05/12</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/05/front/07vue/vue3.x配套工具及项目化构建/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue3.x配套工具及项目化构建">vue3.x配套工具及项目化构建</span>
            <span class="post-date" title="2021-05-09 15:24:20">2021/05/09</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/05/front/07vue/vue3.x高级语法/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue3.x高级语法">vue3.x高级语法</span>
            <span class="post-date" title="2021-05-08 15:24:20">2021/05/08</span>
        </a>
        
        <a  class="全部文章 前端 vue "
           href="/2021/05/front/07vue/vue3.x基础/"
           data-tag="前端,vue"
           data-author="" >
            <span class="post-title" title="vue3.x基础">vue3.x基础</span>
            <span class="post-date" title="2021-05-06 15:24:20">2021/05/06</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2021/05/python/python模块/pyecharts数据可视化/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="pyecharts数据可视化">pyecharts数据可视化</span>
            <span class="post-date" title="2021-05-05 17:46:54">2021/05/05</span>
        </a>
        
        <a  class="全部文章 前端 前端案例 "
           href="/2021/05/front/04cases/echarts的使用/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="echarts的使用">echarts的使用</span>
            <span class="post-date" title="2021-05-05 15:24:20">2021/05/05</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2021/04/python/web/django概述及资料参考/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="django概述及资料参考">django概述及资料参考</span>
            <span class="post-date" title="2021-04-01 15:24:20">2021/04/01</span>
        </a>
        
        <a  class="全部文章 其它 Android "
           href="/2021/03/others/android/Android环境搭建及第一个应用/"
           data-tag="其它,Android"
           data-author="" >
            <span class="post-title" title="Android环境搭建及第一个应用">Android环境搭建及第一个应用</span>
            <span class="post-date" title="2021-03-27 17:39:41">2021/03/27</span>
        </a>
        
        <a  class="全部文章 其它 Android "
           href="/2021/03/others/android/Android概述/"
           data-tag="其它,Android"
           data-author="" >
            <span class="post-title" title="Android概述">Android概述</span>
            <span class="post-date" title="2021-03-27 17:39:41">2021/03/27</span>
        </a>
        
        <a  class="全部文章 数据处理 大数据 "
           href="/2021/03/database/大数据/使用reduce进行累加操作/"
           data-tag="数据处理,大数据"
           data-author="" >
            <span class="post-title" title="使用reduce进行累加操作">使用reduce进行累加操作</span>
            <span class="post-date" title="2021-03-13 15:24:20">2021/03/13</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2021/03/others/reading/千古奇文_命运赋/"
           data-tag="其它,读书"
           data-author="" >
            <span class="post-title" title="千古奇文_命运赋">千古奇文_命运赋</span>
            <span class="post-date" title="2021-03-02 20:00:20">2021/03/02</span>
        </a>
        
        <a  class="全部文章 其它 工具 "
           href="/2021/03/others/tools/网站收集/"
           data-tag="其它,工具"
           data-author="" >
            <span class="post-title" title="阿里云网址记录">阿里云网址记录</span>
            <span class="post-date" title="2021-03-01 20:00:20">2021/03/01</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2021/02/others/reading/诗_十不足/"
           data-tag="其它,读书"
           data-author="" >
            <span class="post-title" title="诗_十不足">诗_十不足</span>
            <span class="post-date" title="2021-02-03 20:00:20">2021/02/03</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2021/01/python/python模块/pyautogui模块的案例/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="pyautogui模块的案例">pyautogui模块的案例</span>
            <span class="post-date" title="2021-01-01 19:22:17">2021/01/01</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/12/python/web/FastAPI的介绍特性及几个常用案例/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="FastAPI的介绍特性及几个常用案例">FastAPI的介绍特性及几个常用案例</span>
            <span class="post-date" title="2020-12-29 12:08:15">2020/12/29</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2020/12/front/03javascript/typescript简介和基础类型/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="typescript简介和基础类型">typescript简介和基础类型</span>
            <span class="post-date" title="2020-12-27 15:24:20">2020/12/27</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2020/12/front/03javascript/javascript的86个面试题汇总/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="Javascript的86个面试题汇总">Javascript的86个面试题汇总</span>
            <span class="post-date" title="2020-12-15 20:15:43">2020/12/15</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/12/python/python模块/freegames有趣的游戏库/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="freegames有趣的游戏库">freegames有趣的游戏库</span>
            <span class="post-date" title="2020-12-02 14:00:54">2020/12/02</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/12/python/python模块/PySnooper调试神级工具/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="PySnooper调试神级工具">PySnooper调试神级工具</span>
            <span class="post-date" title="2020-12-01 14:00:54">2020/12/01</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/11/spider/cases/用requests+tkinter实现小型翻译器/"
           data-tag="爬虫,爬虫案例"
           data-author="" >
            <span class="post-title" title="用requests+tkinter实现小型翻译器">用requests+tkinter实现小型翻译器</span>
            <span class="post-date" title="2020-11-30 20:43:06">2020/11/30</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/10/spider/cases/爬取阳光电影的链接/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取阳光电影的链接">爬取阳光电影的链接</span>
            <span class="post-date" title="2020-10-20 17:59:21">2020/10/20</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/10/spider/反爬逆向/frida详解/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="frida详解">frida详解</span>
            <span class="post-date" title="2020-10-18 19:52:19">2020/10/18</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2020/10/front/03javascript/javascript_ES6至ES10新特性/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript_ES6至ES10新特性">javascript_ES6至ES10新特性</span>
            <span class="post-date" title="2020-10-17 15:24:20">2020/10/17</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/10/spider/反爬逆向/adb配置及常见命令/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="adb配置及常见命令">adb配置及常见命令</span>
            <span class="post-date" title="2020-10-14 19:52:19">2020/10/14</span>
        </a>
        
        <a  class="全部文章 爬虫 appium "
           href="/2020/10/spider/appium/appium自动化测试并生成测试报告/"
           data-tag="爬虫,appium"
           data-author="" >
            <span class="post-title" title="appium自动化测试并生成测试报告">appium自动化测试并生成测试报告</span>
            <span class="post-date" title="2020-10-14 10:30:00">2020/10/14</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2020/10/deploy/linux/vim相关配置/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="vim相关配置">vim相关配置</span>
            <span class="post-date" title="2020-10-13 15:24:20">2020/10/13</span>
        </a>
        
        <a  class="全部文章 其它 英语 "
           href="/2020/10/others/english/800_centence/"
           data-tag="英语"
           data-author="" >
            <span class="post-title" title="800个句子掌握7000单词">800个句子掌握7000单词</span>
            <span class="post-date" title="2020-10-11 01:30:00">2020/10/11</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2020/10/spider/selenium/selenium的一些问题/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="selenium的一些问题">selenium的一些问题</span>
            <span class="post-date" title="2020-10-10 10:35:00">2020/10/10</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2020/10/java/java基础/java9到14新特性/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="JDK9到14的重要新特性">JDK9到14的重要新特性</span>
            <span class="post-date" title="2020-10-02 23:19:19">2020/10/02</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2020/10/java/java基础/java8新特性/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="Java8新特性总结">Java8新特性总结</span>
            <span class="post-date" title="2020-10-01 23:19:19">2020/10/01</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2020/10/deploy/linux/vi和vim的常用指令/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="vi和vim的常用指令">vi和vim的常用指令</span>
            <span class="post-date" title="2020-10-01 15:24:20">2020/10/01</span>
        </a>
        
        <a  class="全部文章 前端 前端案例 "
           href="/2020/09/front/04cases/三种加密方式 sha1加密、MD5加密、Base64加密/"
           data-tag="前端,前端案例"
           data-author="" >
            <span class="post-title" title="三种加密方式 sha1加密、MD5加密、Base64加密">三种加密方式 sha1加密、MD5加密、Base64加密</span>
            <span class="post-date" title="2020-09-29 10:30:00">2020/09/29</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2020/09/others/computer/mac下关闭chrome浏览器的自动更新/"
           data-tag="其它,计算机"
           data-author="" >
            <span class="post-title" title="mac下关闭chrome浏览器的自动更新">mac下关闭chrome浏览器的自动更新</span>
            <span class="post-date" title="2020-09-14 17:39:41">2020/09/14</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/09/spider/反爬逆向/逆向概述/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="逆向概述">逆向概述</span>
            <span class="post-date" title="2020-09-02 19:52:19">2020/09/02</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2020/09/spider/爬虫总结/爬虫初中高巅峰级需要掌握的知识点/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬虫初中高巅峰级需要掌握的知识点">爬虫初中高巅峰级需要掌握的知识点</span>
            <span class="post-date" title="2020-09-01 19:52:19">2020/09/01</span>
        </a>
        
        <a  class="全部文章 爬虫 appium "
           href="/2020/08/spider/appium/appium真机测试/"
           data-tag="爬虫,appium"
           data-author="" >
            <span class="post-title" title="appium真机测试">appium真机测试</span>
            <span class="post-date" title="2020-08-09 10:30:00">2020/08/09</span>
        </a>
        
        <a  class="全部文章 爬虫 appium "
           href="/2020/08/spider/appium/appium常用元素定位/"
           data-tag="爬虫,appium"
           data-author="" >
            <span class="post-title" title="appium常用元素定位">appium常用元素定位</span>
            <span class="post-date" title="2020-08-08 10:30:00">2020/08/08</span>
        </a>
        
        <a  class="全部文章 爬虫 appium "
           href="/2020/08/spider/appium/appium学习建议及相关网站/"
           data-tag="爬虫,appium"
           data-author="" >
            <span class="post-title" title="appium学习建议及相关网站">appium学习建议及相关网站</span>
            <span class="post-date" title="2020-08-07 10:30:00">2020/08/07</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2020/08/deploy/docker/docker使用及相关网站/"
           data-tag="部署,linum"
           data-author="" >
            <span class="post-title" title="docker使用及相关网站">docker使用及相关网站</span>
            <span class="post-date" title="2020-08-06 15:24:20">2020/08/06</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2020/08/deploy/linux/DevOps常用的10个工具/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="DevOps常用的10个工具">DevOps常用的10个工具</span>
            <span class="post-date" title="2020-08-05 15:24:20">2020/08/05</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2020/08/spider/爬虫总结/PyExecJS库/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="用python执行js代码：PyExecJS库">用python执行js代码：PyExecJS库</span>
            <span class="post-date" title="2020-08-04 20:37:51">2020/08/04</span>
        </a>
        
        <a  class="全部文章 数据处理 大数据 "
           href="/2020/08/database/大数据/hive操作/"
           data-tag="数据处理,大数据,hive"
           data-author="" >
            <span class="post-title" title="hive操作">hive操作</span>
            <span class="post-date" title="2020-08-03 15:24:20">2020/08/03</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/07/python/python优化/python3面试汇总/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="python3面试汇总">python3面试汇总</span>
            <span class="post-date" title="2020-07-26 10:35:00">2020/07/26</span>
        </a>
        
        <a  class="全部文章 机器学习 "
           href="/2020/07/deep_learnning/深度学习/特征工程/"
           data-tag="机器学习"
           data-author="" >
            <span class="post-title" title="特征工程">特征工程</span>
            <span class="post-date" title="2020-07-24 01:30:00">2020/07/24</span>
        </a>
        
        <a  class="全部文章 机器学习 "
           href="/2020/07/deep_learnning/深度学习/机器学习概述/"
           data-tag="机器学习"
           data-author="" >
            <span class="post-title" title="机器学习概述">机器学习概述</span>
            <span class="post-date" title="2020-07-23 01:30:00">2020/07/23</span>
        </a>
        
        <a  class="全部文章 机器学习 NLP "
           href="/2020/07/deep_learnning/NLP/NLP自然语言处理概述/"
           data-tag="机器学习,NLP"
           data-author="" >
            <span class="post-title" title="NLP自然语言处理概述">NLP自然语言处理概述</span>
            <span class="post-date" title="2020-07-22 01:30:00">2020/07/22</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/07/python/python模块/loguru超好用的日志模块/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="loguru超好用的日志模块">loguru超好用的日志模块</span>
            <span class="post-date" title="2020-07-21 20:54:16">2020/07/21</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/07/spider/反爬逆向/Ajax动态刷新-有道翻译案例/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="Ajax动态刷新-有道翻译案例">Ajax动态刷新-有道翻译案例</span>
            <span class="post-date" title="2020-07-20 20:39:05">2020/07/20</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/ajaxcrawl/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码12 - ajaxcrawl">scrapy源码12 - ajaxcrawl</span>
            <span class="post-date" title="2020-07-15 10:35:00">2020/07/15</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2020/07/database/mysql/mysql与pg用户管理对比/"
           data-tag="数据处理,PostgreSQL,MySQL"
           data-author="" >
            <span class="post-title" title="MySQL用户管理与PostgreSQL用户管理的对比">MySQL用户管理与PostgreSQL用户管理的对比</span>
            <span class="post-date" title="2020-07-13 15:24:20">2020/07/13</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/webclient/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码11 - webclient">scrapy源码11 - webclient</span>
            <span class="post-date" title="2020-07-13 10:35:00">2020/07/13</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/tls/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码10 - tls">scrapy源码10 - tls</span>
            <span class="post-date" title="2020-07-12 10:35:00">2020/07/12</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/downloadermiddleware/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码9 - downloadermiddleware">scrapy源码9 - downloadermiddleware</span>
            <span class="post-date" title="2020-07-11 10:35:00">2020/07/11</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/contextfactory/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码8 - contextfactory">scrapy源码8 - contextfactory</span>
            <span class="post-date" title="2020-07-09 10:35:00">2020/07/09</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/07/python/python优化/python编码规范/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python编码规范">python编码规范</span>
            <span class="post-date" title="2020-07-08 15:24:20">2020/07/08</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/downloader/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码7：downloader的源码分析">scrapy源码7：downloader的源码分析</span>
            <span class="post-date" title="2020-07-08 10:35:00">2020/07/08</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/deffer和parallel/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码6：deffer和parallel的源码分析">scrapy源码6：deffer和parallel的源码分析</span>
            <span class="post-date" title="2020-07-07 10:35:00">2020/07/07</span>
        </a>
        
        <a  class="全部文章 爬虫 pyppeteer "
           href="/2020/07/spider/pyppeteer/02_各种案例/"
           data-tag="python,pyppeteer"
           data-author="" >
            <span class="post-title" title="pyppeteer的各种案例">pyppeteer的各种案例</span>
            <span class="post-date" title="2020-07-06 10:30:00">2020/07/06</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/middleware/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码5：middleware的源码分析">scrapy源码5：middleware的源码分析</span>
            <span class="post-date" title="2020-07-05 10:35:00">2020/07/05</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/spidermw/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码4：spidermw的源码分析">scrapy源码4：spidermw的源码分析</span>
            <span class="post-date" title="2020-07-04 10:35:00">2020/07/04</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/scraper/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码3：scraper的源码分析">scrapy源码3：scraper的源码分析</span>
            <span class="post-date" title="2020-07-03 10:35:00">2020/07/03</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2020/07/java/java算法/用java实现巧妙过桥问题/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现巧妙过桥问题">用java实现巧妙过桥问题</span>
            <span class="post-date" title="2020-07-01 13:31:38">2020/07/01</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/scheduler/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码2：scheduler的源码分析">scrapy源码2：scheduler的源码分析</span>
            <span class="post-date" title="2020-07-01 10:35:00">2020/07/01</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2020/06/java/java算法/用java实现蛇形打印/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现蛇形打印">用java实现蛇形打印</span>
            <span class="post-date" title="2020-06-30 20:49:27">2020/06/30</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/06/spider/scrapy/engine/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码1：engine的源码分析">scrapy源码1：engine的源码分析</span>
            <span class="post-date" title="2020-06-30 10:35:00">2020/06/30</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2020/06/java/java算法/用java实现哥德巴赫猜想/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现哥德巴赫猜想">用java实现哥德巴赫猜想</span>
            <span class="post-date" title="2020-06-30 09:14:25">2020/06/30</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2020/06/java/java算法/用java实现字符串匹配问题/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现字符串匹配问题">用java实现字符串匹配问题</span>
            <span class="post-date" title="2020-06-29 12:30:47">2020/06/29</span>
        </a>
        
        <a  class="全部文章 爬虫 appium "
           href="/2020/06/spider/appium/appium概述/"
           data-tag="爬虫,appium"
           data-author="" >
            <span class="post-title" title="appium概述环境搭建及案例">appium概述环境搭建及案例</span>
            <span class="post-date" title="2020-06-28 10:30:00">2020/06/28</span>
        </a>
        
        <a  class="全部文章 爬虫 pyppeteer "
           href="/2020/06/spider/pyppeteer/01_介绍及环境/"
           data-tag="python,pyppeteer"
           data-author="" >
            <span class="post-title" title="pyppeteer的环境搭建，常见参数及2个案例">pyppeteer的环境搭建，常见参数及2个案例</span>
            <span class="post-date" title="2020-06-28 10:30:00">2020/06/28</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2020/06/spider/selenium/案例_用selenium爬取拉钩职位信息/"
           data-tag="python,selenium"
           data-author="" >
            <span class="post-title" title="案例_用selenium爬取拉钩职位信息">案例_用selenium爬取拉钩职位信息</span>
            <span class="post-date" title="2020-06-19 16:42:38">2020/06/19</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/06/spider/cases/使用asyncio+aiohttp爬取数据并拼装返回的数据/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="使用asyncio+aiohttp爬取数据并拼装返回的数据">使用asyncio+aiohttp爬取数据并拼装返回的数据</span>
            <span class="post-date" title="2020-06-18 18:25:13">2020/06/18</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/06/python/python模块/tqdm进度条模块详解/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="tqdm进度条模块详解">tqdm进度条模块详解</span>
            <span class="post-date" title="2020-06-17 19:22:17">2020/06/17</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/06/spider/cases/用4种方式爬取CSDN用户的全部文章/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用4种方式爬取CSDN用户的全部文章">用4种方式爬取CSDN用户的全部文章</span>
            <span class="post-date" title="2020-06-17 17:25:55">2020/06/17</span>
        </a>
        
        <a  class="全部文章 数据处理 大数据 "
           href="/2020/06/database/大数据/对象存储OSS/"
           data-tag="数据处理,大数据"
           data-author="" >
            <span class="post-title" title="对象存储OSS">对象存储OSS</span>
            <span class="post-date" title="2020-06-17 15:24:20">2020/06/17</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2020/06/spider/selenium/案例_用selenium爬取csdn博客/"
           data-tag="python,selenium"
           data-author="" >
            <span class="post-title" title="案例_用selenium爬取csdn博客">案例_用selenium爬取csdn博客</span>
            <span class="post-date" title="2020-06-15 16:42:38">2020/06/15</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2020/06/database/mysql/mysql报错1366/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="mysql报错：1366, Incorrect string value:for colum 的解决办法">mysql报错：1366, Incorrect string value:for colum 的解决办法</span>
            <span class="post-date" title="2020-06-09 15:24:20">2020/06/09</span>
        </a>
        
        <a  class="全部文章 机器学习 科学计算 "
           href="/2020/05/deep_learnning/科学计算/科学计算pandas/"
           data-tag="机器学习,科学计算"
           data-author="" >
            <span class="post-title" title="科学计算pandas">科学计算pandas</span>
            <span class="post-date" title="2020-05-29 09:30:00">2020/05/29</span>
        </a>
        
        <a  class="全部文章 机器学习 科学计算 "
           href="/2020/05/deep_learnning/科学计算/科学计算scipy/"
           data-tag="机器学习,科学计算"
           data-author="" >
            <span class="post-title" title="科学计算scipy">科学计算scipy</span>
            <span class="post-date" title="2020-05-29 01:30:00">2020/05/29</span>
        </a>
        
        <a  class="全部文章 机器学习 科学计算 "
           href="/2020/05/deep_learnning/科学计算/科学计算numpy/"
           data-tag="机器学习,科学计算"
           data-author="" >
            <span class="post-title" title="科学计算numpy">科学计算numpy</span>
            <span class="post-date" title="2020-05-29 01:30:00">2020/05/29</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/05/python/web/flask/flask的常见操作/"
           data-tag="python3,fastapi"
           data-author="" >
            <span class="post-title" title="flask的常见操作">flask的常见操作</span>
            <span class="post-date" title="2020-05-23 15:24:20">2020/05/23</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/05/python/cases/钉钉报警案例/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="钉钉报警案例">钉钉报警案例</span>
            <span class="post-date" title="2020-05-22 13:50:19">2020/05/22</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/05/spider/cases/爬链家二手房存mongo/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用python爬取链家二手房信息，并把数据存入mongodb">用python爬取链家二手房信息，并把数据存入mongodb</span>
            <span class="post-date" title="2020-05-21 21:00:59">2020/05/21</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2020/05/others/reading/与人相处/"
           data-tag="其它,读书"
           data-author="" >
            <span class="post-title" title="与人相处">与人相处</span>
            <span class="post-date" title="2020-05-01 20:00:20">2020/05/01</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/04/python/python优化/关于python的思考/"
           data-tag="python,python优化"
           data-author="" >
            <span class="post-title" title="关于python的思考">关于python的思考</span>
            <span class="post-date" title="2020-04-24 15:24:20">2020/04/24</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/04/python/web/flask,tornado,fastapi的比较/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask,tornado,fastapi 的比较">flask,tornado,fastapi 的比较</span>
            <span class="post-date" title="2020-04-23 15:24:20">2020/04/23</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/03/spider/反爬逆向/基于Base64编码的反爬虫/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="基于Base64编码的反爬虫">基于Base64编码的反爬虫</span>
            <span class="post-date" title="2020-03-29 23:36:33">2020/03/29</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/03/spider/cases/用3种方式爬取动态网站数据/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用3种方式爬取动态网站数据">用3种方式爬取动态网站数据</span>
            <span class="post-date" title="2020-03-28 18:26:59">2020/03/28</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/03/python/python优化/使用生成器/"
           data-tag="python优化,python基础"
           data-author="" >
            <span class="post-title" title="使用生成器">使用生成器</span>
            <span class="post-date" title="2020-03-24 15:24:20">2020/03/24</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/03/python/python优化/异步编程/"
           data-tag="python,python优化"
           data-author="" >
            <span class="post-title" title="异步编程">异步编程</span>
            <span class="post-date" title="2020-03-20 15:24:20">2020/03/20</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/03/python/python模块/collections模块/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="collections模块">collections模块</span>
            <span class="post-date" title="2020-03-01 20:30:21">2020/03/01</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/02/spider/反爬逆向/请求参数中的mcode是按时间戳通过base64加密得来的/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="请求参数中的mcode是按时间戳通过base64加密得来的">请求参数中的mcode是按时间戳通过base64加密得来的</span>
            <span class="post-date" title="2020-02-29 19:58:44">2020/02/29</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/02/spider/反爬逆向/请求头中加X-Requested-With才能请求到数据/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="请求头中加X-Requested-With才能请求到数据">请求头中加X-Requested-With才能请求到数据</span>
            <span class="post-date" title="2020-02-29 19:56:03">2020/02/29</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2020/02/spider/爬虫总结/爬虫常见的加解密方法/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="爬虫常见的加解密方法">爬虫常见的加解密方法</span>
            <span class="post-date" title="2020-02-03 20:37:51">2020/02/03</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/02/python/cases/将excel中的内容存入mysql/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="将excel中的内容存入mysql">将excel中的内容存入mysql</span>
            <span class="post-date" title="2020-02-02 15:24:20">2020/02/02</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/02/python/cases/Python3代码雨/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python实现代码雨">用python实现代码雨</span>
            <span class="post-date" title="2020-02-01 15:24:20">2020/02/01</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/02/python/cases/用python实现工厂设计模式/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python实现工厂设计模式">用python实现工厂设计模式</span>
            <span class="post-date" title="2020-02-01 15:24:20">2020/02/01</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/01/python/cases/用python实现简单记事本功能/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python实现简单记事本功能">用python实现简单记事本功能</span>
            <span class="post-date" title="2020-01-31 23:48:44">2020/01/31</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/01/python/cases/tkinter库实现计算器功能/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="tkinter库实现计算器功能">tkinter库实现计算器功能</span>
            <span class="post-date" title="2020-01-31 23:32:46">2020/01/31</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask部署/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask部署">flask部署</span>
            <span class="post-date" title="2020-01-16 15:24:20">2020/01/16</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask拓展模块/flask_Sijax/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask_Sijax">flask_Sijax</span>
            <span class="post-date" title="2020-01-15 15:24:20">2020/01/15</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask拓展模块/flask_SQLAlchemy/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask_SQLAlchemy">flask_SQLAlchemy</span>
            <span class="post-date" title="2020-01-14 15:24:20">2020/01/14</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask拓展模块/flask_WTF/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask_WTF">flask_WTF</span>
            <span class="post-date" title="2020-01-13 15:24:20">2020/01/13</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask拓展模块/flask邮件/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask邮件">flask邮件</span>
            <span class="post-date" title="2020-01-12 15:24:20">2020/01/12</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask扩展/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask扩展">flask扩展</span>
            <span class="post-date" title="2020-01-11 15:24:20">2020/01/11</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask文件上传/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask文件上传">flask文件上传</span>
            <span class="post-date" title="2020-01-10 15:24:20">2020/01/10</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask消息闪现/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask消息闪现">flask消息闪现</span>
            <span class="post-date" title="2020-01-09 15:24:20">2020/01/09</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask重定向和错误/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask重定向和错误">flask重定向和错误</span>
            <span class="post-date" title="2020-01-08 15:24:20">2020/01/08</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask_cookie和session/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask_cookie和session">flask_cookie和session</span>
            <span class="post-date" title="2020-01-07 15:24:20">2020/01/07</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask静态文件/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask静态文件">flask静态文件</span>
            <span class="post-date" title="2020-01-06 15:24:20">2020/01/06</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask模板/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask模板">flask模板</span>
            <span class="post-date" title="2020-01-05 15:24:20">2020/01/05</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask_URL构建/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask_URL构建">flask_URL构建</span>
            <span class="post-date" title="2020-01-04 15:24:20">2020/01/04</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask变量规则/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask变量规则">flask变量规则</span>
            <span class="post-date" title="2020-01-04 15:24:20">2020/01/04</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask路由/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask路由">flask路由</span>
            <span class="post-date" title="2020-01-03 15:24:20">2020/01/03</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2020/01/python/web/flask/flask概述及相关网站/"
           data-tag="python,web"
           data-author="" >
            <span class="post-title" title="flask概述及相关网站">flask概述及相关网站</span>
            <span class="post-date" title="2020-01-02 15:24:20">2020/01/02</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/12/spider/selenium/突破屏蔽/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="如何突破网站对selenium的屏蔽">如何突破网站对selenium的屏蔽</span>
            <span class="post-date" title="2019-12-29 10:35:00">2019/12/29</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/12/spider/selenium/selenium启动Chrome配置参数问题/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="selenium启动Chrome配置参数问题">selenium启动Chrome配置参数问题</span>
            <span class="post-date" title="2019-12-28 10:35:00">2019/12/28</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/12/spider/selenium/在scrapy中使用selenium/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="在scrapy中使用selenium">在scrapy中使用selenium</span>
            <span class="post-date" title="2019-12-27 20:29:35">2019/12/27</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/12/spider/selenium/selenium的常见操作/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="selenium的常见操作">selenium的常见操作</span>
            <span class="post-date" title="2019-12-25 10:35:00">2019/12/25</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/12/database/PostgreSql/20191220_对pg中json数据进行增删改/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="向PostgreSQL中json中加入某个字段 或者更新某个字段的SQL语句">向PostgreSQL中json中加入某个字段 或者更新某个字段的SQL语句</span>
            <span class="post-date" title="2019-12-20 15:24:20">2019/12/20</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/11/java/java案例/用3种方式现猜石头剪刀布的游戏的功能/"
           data-tag="java,java案例,python案例"
           data-author="" >
            <span class="post-title" title="分别用java，go，python语言 实现猜石头剪刀布的游戏的功能">分别用java，go，python语言 实现猜石头剪刀布的游戏的功能</span>
            <span class="post-date" title="2019-11-09 18:48:15">2019/11/09</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2019/11/python/python模块/python标准库主题/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="《Python3标准库》主题">《Python3标准库》主题</span>
            <span class="post-date" title="2019-11-07 13:29:07">2019/11/07</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/11/spider/爬虫总结/aiohttp的使用/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="aiohttp的使用">aiohttp的使用</span>
            <span class="post-date" title="2019-11-03 20:37:51">2019/11/03</span>
        </a>
        
        <a  class="全部文章 数据处理 ES "
           href="/2019/11/database/es/es介绍及python操作es/"
           data-tag="数据处理,ES"
           data-author="" >
            <span class="post-title" title="Elasticsearch的介绍 以及使用python操作es详细步骤">Elasticsearch的介绍 以及使用python操作es详细步骤</span>
            <span class="post-date" title="2019-11-01 15:24:20">2019/11/01</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/10/python/cases/面向对象扑克牌发牌程序/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="面向对象扑克牌发牌程序">面向对象扑克牌发牌程序</span>
            <span class="post-date" title="2019-10-29 22:43:29">2019/10/29</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2019/10/python/python模块/PyQt5模块/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="PyQt5模块">PyQt5模块</span>
            <span class="post-date" title="2019-10-28 19:22:17">2019/10/28</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2019/10/spider/反爬逆向/运行js的execjs模块/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="运行js的execjs模块">运行js的execjs模块</span>
            <span class="post-date" title="2019-10-12 19:52:19">2019/10/12</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/10/database/PostgreSql/20191008_更改数据/"
           data-tag="数据处理,PostgreSQL,MySQL"
           data-author="" >
            <span class="post-title" title="对数据库中的数据 进行增删改查用到的SQL语句">对数据库中的数据 进行增删改查用到的SQL语句</span>
            <span class="post-date" title="2019-10-08 15:24:20">2019/10/08</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/09/database/mysql/mysql更改数据/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="MySQL中增加，更新或删除 数据库中原数据的内容">MySQL中增加，更新或删除 数据库中原数据的内容</span>
            <span class="post-date" title="2019-09-27 15:24:20">2019/09/27</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/09/python/python算法/MD5加密总结/"
           data-tag="python,python算法"
           data-author="" >
            <span class="post-title" title="MD5加密总结">MD5加密总结</span>
            <span class="post-date" title="2019-09-23 22:09:25">2019/09/23</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/09/python/cases/python中用正则表达式匹配文本/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="python中用正则表达式匹配文本">python中用正则表达式匹配文本</span>
            <span class="post-date" title="2019-09-21 17:24:10">2019/09/21</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/09/database/mysql/每5分钟mysql的插入量/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="统计每5分钟，MySQL数据库中数据的插入量">统计每5分钟，MySQL数据库中数据的插入量</span>
            <span class="post-date" title="2019-09-21 15:24:20">2019/09/21</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/09/python/cases/python控制台学生信息管理系统/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="python控制台学生信息管理系统">python控制台学生信息管理系统</span>
            <span class="post-date" title="2019-09-10 14:13:49">2019/09/10</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/09/database/PostgreSql/20190909_查看pg内存/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="查询PostgreSQL占多大内存">查询PostgreSQL占多大内存</span>
            <span class="post-date" title="2019-09-09 15:24:20">2019/09/09</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/08/spider/爬虫总结/随机请求头手机端/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="随机请求头手机端">随机请求头手机端</span>
            <span class="post-date" title="2019-08-31 10:29:57">2019/08/31</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/08/spider/爬虫总结/随机请求头web端/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="随机请求头web端">随机请求头web端</span>
            <span class="post-date" title="2019-08-30 10:29:57">2019/08/30</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/08/python/python算法/树_红黑树/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="树_红黑树">树_红黑树</span>
            <span class="post-date" title="2019-08-28 13:35:15">2019/08/28</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/08/python/cases/用python输出矩阵的转置形式/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python输出矩阵的转置形式">用python输出矩阵的转置形式</span>
            <span class="post-date" title="2019-08-27 17:50:39">2019/08/27</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190827_内部结构/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十八. 内部结构">PostgreSQL：十八. 内部结构</span>
            <span class="post-date" title="2019-08-27 15:24:20">2019/08/27</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190825_配置与监控/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十七. 服务器配置与数据库监控">PostgreSQL：十七. 服务器配置与数据库监控</span>
            <span class="post-date" title="2019-08-25 15:24:20">2019/08/25</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190824_高可用/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十六. 高可用、负载均衡和数据复制">PostgreSQL：十六. 高可用、负载均衡和数据复制</span>
            <span class="post-date" title="2019-08-24 15:24:20">2019/08/24</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/08/python/cases/打印各种图形总结/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python实现打印各种图形总结">用python实现打印各种图形总结</span>
            <span class="post-date" title="2019-08-23 17:17:53">2019/08/23</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/08/python/cases/python控制台商品购买系统/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="python控制台商品购买系统">python控制台商品购买系统</span>
            <span class="post-date" title="2019-08-23 16:36:25">2019/08/23</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190823_性能优化/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十五. 性能优化">PostgreSQL：十五. 性能优化</span>
            <span class="post-date" title="2019-08-23 15:24:20">2019/08/23</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/08/python/cases/数字转人民币大写汉字读法/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="数字转人民币大写汉字读法">数字转人民币大写汉字读法</span>
            <span class="post-date" title="2019-08-23 14:06:10">2019/08/23</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190822_备份还原/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十四. 数据备份与还原">PostgreSQL：十四. 数据备份与还原</span>
            <span class="post-date" title="2019-08-22 15:24:20">2019/08/22</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190821_用户管理/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十三. PostgreSQL的用户管理">PostgreSQL：十三. PostgreSQL的用户管理</span>
            <span class="post-date" title="2019-08-21 15:24:20">2019/08/21</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190819_事务处理/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十二. 事务处理">PostgreSQL：十二. 事务处理</span>
            <span class="post-date" title="2019-08-19 15:24:20">2019/08/19</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190818_触发器/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十一. 触发器">PostgreSQL：十一. 触发器</span>
            <span class="post-date" title="2019-08-18 15:24:20">2019/08/18</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190817_视图/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 十. 视图">PostgreSQL 十. 视图</span>
            <span class="post-date" title="2019-08-17 15:24:20">2019/08/17</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/08/spider/cases/用python抓取网上的照片并保存在本地/"
           data-tag="爬虫,爬虫案例"
           data-author="" >
            <span class="post-title" title="用python抓取网上的照片并保存在本地">用python抓取网上的照片并保存在本地</span>
            <span class="post-date" title="2019-08-17 10:28:24">2019/08/17</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190816_索引/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 九. 索引">PostgreSQL 九. 索引</span>
            <span class="post-date" title="2019-08-16 15:24:20">2019/08/16</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190815_查询语句/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 八. 查询语句">PostgreSQL 八. 查询语句</span>
            <span class="post-date" title="2019-08-15 15:24:20">2019/08/15</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190813_插入更新删除数据/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：七. 插入，更新与删除数据">PostgreSQL：七. 插入，更新与删除数据</span>
            <span class="post-date" title="2019-08-13 15:24:20">2019/08/13</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190811_函数/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：六. PostgreSQL函数">PostgreSQL：六. PostgreSQL函数</span>
            <span class="post-date" title="2019-08-11 15:24:20">2019/08/11</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190810_数据类型和运算符/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：五. 数据类型和运算符">PostgreSQL：五. 数据类型和运算符</span>
            <span class="post-date" title="2019-08-10 15:24:20">2019/08/10</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190808_数据库的基本操作/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：三. 数据库的基本操作">PostgreSQL：三. 数据库的基本操作</span>
            <span class="post-date" title="2019-08-08 15:24:20">2019/08/08</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190807_安装和配置/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：二. PostgreSQL 11 的安装与配置">PostgreSQL：二. PostgreSQL 11 的安装与配置</span>
            <span class="post-date" title="2019-08-07 15:24:20">2019/08/07</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190806_postgresql介绍/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL介绍">PostgreSQL介绍</span>
            <span class="post-date" title="2019-08-06 15:24:20">2019/08/06</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190809_数据表的基本操作/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL介绍">PostgreSQL介绍</span>
            <span class="post-date" title="2019-08-06 15:24:20">2019/08/06</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/08/spider/cases/一个有意思的爬虫案例/"
           data-tag="爬虫,爬虫案例"
           data-author="" >
            <span class="post-title" title="一个有意思的爬虫案例">一个有意思的爬虫案例</span>
            <span class="post-date" title="2019-08-03 10:02:48">2019/08/03</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/08/python/python算法/14_算法-图/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-图">算法-图</span>
            <span class="post-date" title="2019-08-02 14:09:43">2019/08/02</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/08/python/python算法/13_算法-算法思想/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-算法思想">算法-算法思想</span>
            <span class="post-date" title="2019-08-01 14:23:41">2019/08/01</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/各种查找总结/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-各种查找总结">算法-各种查找总结</span>
            <span class="post-date" title="2019-07-31 14:50:23">2019/07/31</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/算法-各种树/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-各种树">算法-各种树</span>
            <span class="post-date" title="2019-07-30 13:35:15">2019/07/30</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/树和二叉树/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-树和二叉树">算法-树和二叉树</span>
            <span class="post-date" title="2019-07-29 13:31:19">2019/07/29</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/08_算法-堆/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-堆">算法-堆</span>
            <span class="post-date" title="2019-07-28 10:57:28">2019/07/28</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/07_算法-散列表/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-散列表（哈希表）">算法-散列表（哈希表）</span>
            <span class="post-date" title="2019-07-27 10:07:50">2019/07/27</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/06_算法-链表/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-链表">算法-链表</span>
            <span class="post-date" title="2019-07-26 09:45:12">2019/07/26</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/05_算法-队列/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-队列">算法-队列</span>
            <span class="post-date" title="2019-07-25 09:27:39">2019/07/25</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/04_算法-栈/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-栈">算法-栈</span>
            <span class="post-date" title="2019-07-25 09:14:17">2019/07/25</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/03_算法-线性表/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-线性表">算法-线性表</span>
            <span class="post-date" title="2019-07-24 17:00:13">2019/07/24</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/02_算法-数组/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-数组">算法-数组</span>
            <span class="post-date" title="2019-07-23 16:50:02">2019/07/23</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/python中区属性和方法的实例/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="python中区属性和方法的实例">python中区属性和方法的实例</span>
            <span class="post-date" title="2019-07-18 19:28:00">2019/07/18</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/用Python实现单例模式/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用Python实现单例模式">用Python实现单例模式</span>
            <span class="post-date" title="2019-07-18 15:59:39">2019/07/18</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/用python实现名片管理系统/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="用python实现名片管理系统">用python实现名片管理系统</span>
            <span class="post-date" title="2019-07-17 17:25:08">2019/07/17</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/一个案例弄懂python中的LEGB规则/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="一个案例弄懂python中的LEGB规则">一个案例弄懂python中的LEGB规则</span>
            <span class="post-date" title="2019-07-17 16:51:12">2019/07/17</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/turtle库各种案例进阶/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="turtle库各种案例进阶">turtle库各种案例进阶</span>
            <span class="post-date" title="2019-07-16 11:00:07">2019/07/16</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/各种排序总结/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法-各种排序">算法-各种排序</span>
            <span class="post-date" title="2019-07-15 14:39:45">2019/07/15</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/算法概述/"
           data-tag="python,python算法"
           data-author="" >
            <span class="post-title" title="算法概述和总结">算法概述和总结</span>
            <span class="post-date" title="2019-07-13 22:09:25">2019/07/13</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/算法和数据结构的经验/"
           data-tag="python,python算法"
           data-author="" >
            <span class="post-title" title="学习数据结构和算法的经验">学习数据结构和算法的经验</span>
            <span class="post-date" title="2019-07-13 22:09:25">2019/07/13</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/07/python/python算法/算法网站资料/"
           data-tag="python,算法"
           data-author="" >
            <span class="post-title" title="算法网站资料收藏">算法网站资料收藏</span>
            <span class="post-date" title="2019-07-13 19:13:58">2019/07/13</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/用python打印九九乘法表的7种方式/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="用python打印九九乘法表的7种方式">用python打印九九乘法表的7种方式</span>
            <span class="post-date" title="2019-07-13 08:08:54">2019/07/13</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/07/python/cases/turtle库各种案例基础/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="turtle库各种案例基础">turtle库各种案例基础</span>
            <span class="post-date" title="2019-07-12 13:50:19">2019/07/12</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/07/java/java案例/用java实现3种兔子小兔子问题/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="用java实现3种兔子小兔子问题">用java实现3种兔子小兔子问题</span>
            <span class="post-date" title="2019-07-09 19:20:49">2019/07/09</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/07/spider/cases/百度图片爬虫/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取百度图片并把图片存到本地">爬取百度图片并把图片存到本地</span>
            <span class="post-date" title="2019-07-04 10:35:00">2019/07/04</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2019/07/others/reading/绕口令/"
           data-tag="日常生活"
           data-author="" >
            <span class="post-title" title="绕口令">绕口令</span>
            <span class="post-date" title="2019-07-03 15:24:20">2019/07/03</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/07/spider/cases/有毒段子爬虫/"
           data-tag="爬虫,爬虫案例"
           data-author="" >
            <span class="post-title" title="爬取心灵毒鸡汤、你好污啊 网站数据并存入本地txt文件">爬取心灵毒鸡汤、你好污啊 网站数据并存入本地txt文件</span>
            <span class="post-date" title="2019-07-03 10:30:00">2019/07/03</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/6大设计原则/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="设计模式之6大设计原则详解">设计模式之6大设计原则详解</span>
            <span class="post-date" title="2019-06-29 01:30:00">2019/06/29</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2019/06/others/reading/毒鸡汤/"
           data-tag="日常生活"
           data-author="" >
            <span class="post-title" title="心灵毒鸡汤语录">心灵毒鸡汤语录</span>
            <span class="post-date" title="2019-06-28 15:24:20">2019/06/28</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/06/java/java案例/用Java语言弹窗判断IP地址是否合法/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="用Java语言弹窗判断IP地址是否合法">用Java语言弹窗判断IP地址是否合法</span>
            <span class="post-date" title="2019-06-28 15:04:53">2019/06/28</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/06/java/java案例/实现字符和Unicode码互换/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="实现字符和Unicode码互换">实现字符和Unicode码互换</span>
            <span class="post-date" title="2019-06-28 14:06:08">2019/06/28</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/06/java/java案例/java将一个正整数分解质因数/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java将一个正整数分解质因数">java将一个正整数分解质因数</span>
            <span class="post-date" title="2019-06-28 10:43:25">2019/06/28</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_状态模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="状态模式详解">状态模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_解释器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="解释器模式详解">解释器模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_责任链/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="责任链模式详解">责任链模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_访问者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="访问者模式详解">访问者模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190620_备忘录/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="备忘录模式详解">备忘录模式详解</span>
            <span class="post-date" title="2019-06-20 01:30:00">2019/06/20</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190619_中介者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="中介者模式详解">中介者模式详解</span>
            <span class="post-date" title="2019-06-19 01:30:00">2019/06/19</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190618_迭代器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="迭代器模式详解">迭代器模式详解</span>
            <span class="post-date" title="2019-06-18 01:30:00">2019/06/18</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/06/java/java案例/java为新员工分配部门/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java为新员工分配部门">java为新员工分配部门</span>
            <span class="post-date" title="2019-06-17 09:44:58">2019/06/17</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190617_命令模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="命令模式详解">命令模式详解</span>
            <span class="post-date" title="2019-06-17 01:30:00">2019/06/17</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2019/06/java/java算法/算法思想-迭代/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="算法思想-迭代">算法思想-迭代</span>
            <span class="post-date" title="2019-06-16 16:01:26">2019/06/16</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190614_模板方法/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="模板方法模式详解">模板方法模式详解</span>
            <span class="post-date" title="2019-06-14 01:30:00">2019/06/14</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2019/06/java/java案例/java用位运算的异或运算实现加密和解密的功能/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java用位运算的异或运算实现加密和解密的功能">java用位运算的异或运算实现加密和解密的功能</span>
            <span class="post-date" title="2019-06-13 17:50:52">2019/06/13</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190613_外观模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="外观模式详解">外观模式详解</span>
            <span class="post-date" title="2019-06-13 01:30:00">2019/06/13</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190613_享元模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="享元模式详解">享元模式详解</span>
            <span class="post-date" title="2019-06-13 01:30:00">2019/06/13</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/06/spider/selenium/隐式和显示等待/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="Selenium显示等待和隐式等待的区别">Selenium显示等待和隐式等待的区别</span>
            <span class="post-date" title="2019-06-12 10:35:00">2019/06/12</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190611_组合模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="组合模式详解">组合模式详解</span>
            <span class="post-date" title="2019-06-11 01:30:00">2019/06/11</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190611_桥接模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="桥接模式详解">桥接模式详解</span>
            <span class="post-date" title="2019-06-11 01:30:00">2019/06/11</span>
        </a>
        
        <a  class="全部文章 部署 jenkins "
           href="/2019/06/deploy/jenkins/genkins概述/"
           data-tag="部署,linux"
           data-author="" >
            <span class="post-title" title="jenkins概述">jenkins概述</span>
            <span class="post-date" title="2019-06-07 15:24:20">2019/06/07</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190605_适配器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="适配器模式详解">适配器模式详解</span>
            <span class="post-date" title="2019-06-05 01:30:00">2019/06/05</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/原型模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="原型模式详解">原型模式详解</span>
            <span class="post-date" title="2019-06-04 01:30:00">2019/06/04</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/代理模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="代理模式详解">代理模式详解</span>
            <span class="post-date" title="2019-06-03 01:30:00">2019/06/03</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190531_抽象工厂/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="抽象工厂模式详解">抽象工厂模式详解</span>
            <span class="post-date" title="2019-05-31 01:30:00">2019/05/31</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/工厂模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="工厂模式详解">工厂模式详解</span>
            <span class="post-date" title="2019-05-31 01:30:00">2019/05/31</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190530_装饰模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="装饰模式详解">装饰模式详解</span>
            <span class="post-date" title="2019-05-30 01:30:00">2019/05/30</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2019/05/spider/反爬逆向/请求头中需要加上Referer/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="请求头中需要加上Referer">请求头中需要加上Referer</span>
            <span class="post-date" title="2019-05-29 19:52:19">2019/05/29</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/建造者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="建造者模式详解">建造者模式详解</span>
            <span class="post-date" title="2019-05-29 01:30:00">2019/05/29</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/观察者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="观察者模式详解">观察者模式详解</span>
            <span class="post-date" title="2019-05-28 01:30:00">2019/05/28</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/策略模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="策略模式详解">策略模式详解</span>
            <span class="post-date" title="2019-05-27 01:30:00">2019/05/27</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/05/python/cases/python定时任务汇总/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="python定时任务汇总">python定时任务汇总</span>
            <span class="post-date" title="2019-05-26 10:35:00">2019/05/26</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/单例模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="7种单例模式详解">7种单例模式详解</span>
            <span class="post-date" title="2019-05-24 01:30:00">2019/05/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/设计模式汇总/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="java设计模式汇总">java设计模式汇总</span>
            <span class="post-date" title="2019-05-24 01:30:00">2019/05/24</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/05/database/mysql/用pymysql连接mysql数据库案例/"
           data-tag="数据处理,MySQL,python"
           data-author="" >
            <span class="post-title" title="用pymysql连接mysql数据库案例">用pymysql连接mysql数据库案例</span>
            <span class="post-date" title="2019-05-22 15:24:20">2019/05/22</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/05/python/cases/用python处理文本数据/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="用python处理文本数据">用python处理文本数据</span>
            <span class="post-date" title="2019-05-20 10:35:00">2019/05/20</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2019/05/python/python模块/argparse模块的介绍和使用/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="argparse模块的介绍和使用">argparse模块的介绍和使用</span>
            <span class="post-date" title="2019-05-19 19:22:17">2019/05/19</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/05/spider/selenium/selenium概述及网站参考/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="selenium概述及网站参考">selenium概述及网站参考</span>
            <span class="post-date" title="2019-05-18 10:35:00">2019/05/18</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2019/05/java/java基础/Java常用类库和API/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="Java常用类库和API">Java常用类库和API</span>
            <span class="post-date" title="2019-05-11 19:31:52">2019/05/11</span>
        </a>
        
        <a  class="全部文章 python web "
           href="/2019/04/python/web/flask/flask_案例_登录/"
           data-tag="python,flask"
           data-author="" >
            <span class="post-title" title="flask案例_登录和遍历操作">flask案例_登录和遍历操作</span>
            <span class="post-date" title="2019-04-20 10:35:00">2019/04/20</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/04/python/cases/python一行代码可以做的事/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="python一行代码可以做的事">python一行代码可以做的事</span>
            <span class="post-date" title="2019-04-18 15:24:20">2019/04/18</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/04/python/cases/用python去除list中重复的元素/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python去除list中重复的元素">用python去除list中重复的元素</span>
            <span class="post-date" title="2019-04-17 15:24:20">2019/04/17</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/04/python/cases/python3的各种经典案例_后/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python3的各种经典案例_后">python3的各种经典案例_后</span>
            <span class="post-date" title="2019-04-15 10:35:00">2019/04/15</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/04/python/cases/python3的各种经典案例_中/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python3的各种经典案例_中">python3的各种经典案例_中</span>
            <span class="post-date" title="2019-04-14 10:35:00">2019/04/14</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/04/python/cases/python3的各种经典案例_前/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="python3的各种经典案例_前">python3的各种经典案例_前</span>
            <span class="post-date" title="2019-04-13 10:35:00">2019/04/13</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2019/04/spider/反爬逆向/常见反爬虫策略及应对措施/"
           data-tag="python,爬虫,反爬逆向"
           data-author="" >
            <span class="post-title" title="常见反爬虫策略及应对措施">常见反爬虫策略及应对措施</span>
            <span class="post-date" title="2019-04-09 19:52:19">2019/04/09</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/04/spider/爬虫总结/PyExecJS库的副本/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="解析库pyquery">解析库pyquery</span>
            <span class="post-date" title="2019-04-08 20:37:51">2019/04/08</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/03/python/cases/用python统计字符串数量/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="用python统计字符串数量">用python统计字符串数量</span>
            <span class="post-date" title="2019-03-20 15:24:20">2019/03/20</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/03/python/cases/嵌套的列表和字典的处理/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="嵌套的列表和字典的处理">嵌套的列表和字典的处理</span>
            <span class="post-date" title="2019-03-19 15:24:20">2019/03/19</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/03/python/cases/实现数学案例汇总/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="实现数学案例汇总python">实现数学案例汇总python</span>
            <span class="post-date" title="2019-03-15 15:24:20">2019/03/15</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/时间处理/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python时间处理">python时间处理</span>
            <span class="post-date" title="2019-03-13 15:24:20">2019/03/13</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/打包/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python打包">python打包</span>
            <span class="post-date" title="2019-03-11 15:24:20">2019/03/11</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/发布模块/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python发布模块">python发布模块</span>
            <span class="post-date" title="2019-03-10 15:24:20">2019/03/10</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/python虚拟环境/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python虚拟环境">python虚拟环境</span>
            <span class="post-date" title="2019-03-06 15:24:20">2019/03/06</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/图形界面/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python图形界面">python图形界面</span>
            <span class="post-date" title="2019-03-05 15:24:20">2019/03/05</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/操作excel/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python操作excel">python操作excel</span>
            <span class="post-date" title="2019-03-04 15:24:20">2019/03/04</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/sqlchemy的使用/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="sqlalchemy的使用">sqlalchemy的使用</span>
            <span class="post-date" title="2019-03-03 15:24:20">2019/03/03</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/sqlalchemy一些概念/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="sqlalchemy的一些概念">sqlalchemy的一些概念</span>
            <span class="post-date" title="2019-03-02 15:24:20">2019/03/02</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/访问数据库/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python访问数据库">python访问数据库</span>
            <span class="post-date" title="2019-03-01 15:24:20">2019/03/01</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190228_网络编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python网络编程">python网络编程</span>
            <span class="post-date" title="2019-02-28 15:24:20">2019/02/28</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/文件操作/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python文件操作">python文件操作</span>
            <span class="post-date" title="2019-02-26 15:24:20">2019/02/26</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190225_进程和线程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python进程和线程">python进程和线程</span>
            <span class="post-date" title="2019-02-25 15:24:20">2019/02/25</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python正则表达式/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python正则表达式">python正则表达式</span>
            <span class="post-date" title="2019-02-23 15:24:20">2019/02/23</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/模块和包以及各种库/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python模块和包以及各种库">python模块和包以及各种库</span>
            <span class="post-date" title="2019-02-21 15:24:20">2019/02/21</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/面向对象编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python面向对象编程">python面向对象编程</span>
            <span class="post-date" title="2019-02-20 15:24:20">2019/02/20</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190219_错误,测试和调试/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python错误，测试和调试">python错误，测试和调试</span>
            <span class="post-date" title="2019-02-19 15:24:20">2019/02/19</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190218_函数式编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python函数式编程">python函数式编程</span>
            <span class="post-date" title="2019-02-18 15:24:20">2019/02/18</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/函数及其高级特性/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python函数及其高级特性">python函数及其高级特性</span>
            <span class="post-date" title="2019-02-17 15:24:20">2019/02/17</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/控制语句/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python控制语句">python控制语句</span>
            <span class="post-date" title="2019-02-16 15:24:20">2019/02/16</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/序列_字典和集合/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python序列_字典和集合">python序列_字典和集合</span>
            <span class="post-date" title="2019-02-15 19:24:20">2019/02/15</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/序列_列表和元组/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python序列_列表和元组">python序列_列表和元组</span>
            <span class="post-date" title="2019-02-15 15:24:20">2019/02/15</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/02/python/cases/用python实现udp网络程序发送接收数据/"
           data-tag="python案例"
           data-author="" >
            <span class="post-title" title="用python实现udp网络程序发送接收数据">用python实现udp网络程序发送接收数据</span>
            <span class="post-date" title="2019-02-14 15:24:20">2019/02/14</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python字符串和编码/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python字符串和编码">python字符串和编码</span>
            <span class="post-date" title="2019-02-14 15:24:20">2019/02/14</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python关键字和内置函数/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python关键字和内置函数">python关键字和内置函数</span>
            <span class="post-date" title="2019-02-13 15:24:20">2019/02/13</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/02/spider/爬虫总结/写爬虫遇到的各类较难的xpath汇总/"
           data-tag="python,爬虫总结"
           data-author="" >
            <span class="post-title" title="写爬虫遇到的各类较难的xpath汇总">写爬虫遇到的各类较难的xpath汇总</span>
            <span class="post-date" title="2019-02-13 10:29:57">2019/02/13</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/02_python变量和数据类型/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python变量和数据类型">python变量和数据类型</span>
            <span class="post-date" title="2019-02-12 15:24:20">2019/02/12</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/标识符和运算符/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python标识符和运算符">python标识符和运算符</span>
            <span class="post-date" title="2019-02-12 15:24:20">2019/02/12</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python的一些理解/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="关于python的一些理解">关于python的一些理解</span>
            <span class="post-date" title="2019-02-11 20:24:20">2019/02/11</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python3的安装/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python3的安装">python3的安装</span>
            <span class="post-date" title="2019-02-11 18:24:20">2019/02/11</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/python3简介/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python简介">python简介</span>
            <span class="post-date" title="2019-02-11 15:24:20">2019/02/11</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/01/spider/爬虫总结/webmagic介绍和相关网站/"
           data-tag="java,爬虫"
           data-author="" >
            <span class="post-title" title="webmagic介绍和相关网站">webmagic介绍和相关网站</span>
            <span class="post-date" title="2019-01-04 18:51:26">2019/01/04</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/01/spider/爬虫总结/java爬虫框架jsoup总结和使用/"
           data-tag="java,爬虫"
           data-author="" >
            <span class="post-title" title="java爬虫框架jsoup总结和使用">java爬虫框架jsoup总结和使用</span>
            <span class="post-date" title="2019-01-03 18:51:26">2019/01/03</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/01/spider/爬虫总结/java常用的爬虫框架/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="java常用的爬虫框架">java常用的爬虫框架</span>
            <span class="post-date" title="2019-01-02 18:51:26">2019/01/02</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫总结 "
           href="/2019/01/spider/爬虫总结/为什么选择java爬虫/"
           data-tag="java,爬虫"
           data-author="" >
            <span class="post-title" title="为什么选择java爬虫">为什么选择java爬虫</span>
            <span class="post-date" title="2019-01-01 18:51:26">2019/01/01</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2018/10/deploy/linux/linux解压和压缩命令/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="linux解压和压缩命令">linux解压和压缩命令</span>
            <span class="post-date" title="2018-10-17 15:24:20">2018/10/17</span>
        </a>
        
        <a  class="全部文章 其它 英语 "
           href="/2018/06/others/english/40篇短文掌握3500单词/"
           data-tag="英语"
           data-author="" >
            <span class="post-title" title="40篇短文掌握3500单词">40篇短文掌握3500单词</span>
            <span class="post-date" title="2018-06-27 01:30:00">2018/06/27</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2018/06/others/reading/36计/"
           data-tag="日常生活,36计解说"
           data-author="" >
            <span class="post-title" title="36计">36计</span>
            <span class="post-date" title="2018-06-23 15:24:20">2018/06/23</span>
        </a>
        
        <a  class="全部文章 其它 英语 "
           href="/2018/06/others/english/英语作文模板/"
           data-tag="英语"
           data-author="" >
            <span class="post-title" title="英语作文模板">英语作文模板</span>
            <span class="post-date" title="2018-06-22 01:30:00">2018/06/22</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2018/04/java/java案例/java验证登录信息的合法性/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java验证登录信息的合法性">java验证登录信息的合法性</span>
            <span class="post-date" title="2018-04-01 09:44:58">2018/04/01</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2018/03/java/java案例/java把控制台输入的内容写入到文件中/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java把控制台输入的内容写入到文件中">java把控制台输入的内容写入到文件中</span>
            <span class="post-date" title="2018-03-28 22:43:17">2018/03/28</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2018/03/java/java案例/用java实现Excel用户信息的导出/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="用java实现Excel用户信息的导出">用java实现Excel用户信息的导出</span>
            <span class="post-date" title="2018-03-26 22:43:17">2018/03/26</span>
        </a>
        
        <a  class="全部文章 前端 前端案例 "
           href="/2017/12/front/04cases/网页自动换肤/"
           data-tag="前端,前端案例"
           data-author="" >
            <span class="post-title" title="网页自动换肤">网页自动换肤</span>
            <span class="post-date" title="2017-12-06 15:24:20">2017/12/06</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/12/front/06jQuery/jQuery插件/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery插件">jQuery插件</span>
            <span class="post-date" title="2017-12-04 15:24:20">2017/12/04</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/12/front/06jQuery/jQuery_Ajac应用/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery_Ajac应用">jQuery_Ajac应用</span>
            <span class="post-date" title="2017-12-03 15:24:20">2017/12/03</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/12/front/06jQuery/jQuery表单操作/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery表单操作">jQuery表单操作</span>
            <span class="post-date" title="2017-12-01 15:24:20">2017/12/01</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/11/front/06jQuery/jQuery事件处理/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery事件处理">jQuery事件处理</span>
            <span class="post-date" title="2017-11-29 15:24:20">2017/11/29</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/11/front/06jQuery/jQuery元素操作/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery元素操作">jQuery元素操作</span>
            <span class="post-date" title="2017-11-28 15:24:20">2017/11/28</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/11/front/06jQuery/jQuery选择器/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery选择器">jQuery选择器</span>
            <span class="post-date" title="2017-11-26 15:24:20">2017/11/26</span>
        </a>
        
        <a  class="全部文章 前端 jQuery "
           href="/2017/11/front/06jQuery/jQuery概述/"
           data-tag="前端,jQuery"
           data-author="" >
            <span class="post-title" title="jQuery概述">jQuery概述</span>
            <span class="post-date" title="2017-11-25 15:24:20">2017/11/25</span>
        </a>
        
        <a  class="全部文章 前端 前端案例 "
           href="/2017/11/front/04cases/贪吃蛇案例/"
           data-tag="前端,前端案例"
           data-author="" >
            <span class="post-title" title="javascript_贪吃蛇案例">javascript_贪吃蛇案例</span>
            <span class="post-date" title="2017-11-24 15:24:20">2017/11/24</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript正则表达式/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript正则表达式">javascript正则表达式</span>
            <span class="post-date" title="2017-11-22 15:24:20">2017/11/22</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript垃圾回收机制/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript垃圾回收机制">javascript垃圾回收机制</span>
            <span class="post-date" title="2017-11-20 15:24:20">2017/11/20</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript面向对象编程/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript面向对象编程">javascript面向对象编程</span>
            <span class="post-date" title="2017-11-19 15:24:20">2017/11/19</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript_DOM和事件/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript_DOM和事件">javascript_DOM和事件</span>
            <span class="post-date" title="2017-11-18 15:24:20">2017/11/18</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascrpt_BOM操作/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript_BOM">javascript_BOM</span>
            <span class="post-date" title="2017-11-17 15:24:20">2017/11/17</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript内置对象/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript内置对象">javascript内置对象</span>
            <span class="post-date" title="2017-11-16 18:24:20">2017/11/16</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript对象/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript对象">javascript对象</span>
            <span class="post-date" title="2017-11-16 15:24:20">2017/11/16</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript函数和作用域/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript函数和作用域">javascript函数和作用域</span>
            <span class="post-date" title="2017-11-15 20:24:20">2017/11/15</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript数组/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript数组">javascript数组</span>
            <span class="post-date" title="2017-11-15 15:24:20">2017/11/15</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript流程控制/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript流程控制">javascript流程控制</span>
            <span class="post-date" title="2017-11-14 15:24:20">2017/11/14</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript运算符/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript运算符">javascript运算符</span>
            <span class="post-date" title="2017-11-13 15:24:20">2017/11/13</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript变量和数据类型/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript变量和数据类型">javascript变量和数据类型</span>
            <span class="post-date" title="2017-11-12 15:24:20">2017/11/12</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/javascript概述/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript概述">javascript概述</span>
            <span class="post-date" title="2017-11-11 15:24:20">2017/11/11</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2017/09/java/java算法/算法思想-穷举/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="算法思想-穷举">算法思想-穷举</span>
            <span class="post-date" title="2017-09-16 14:52:32">2017/09/16</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/09/java/java案例/java中断单层和双层循环/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java中断单层和双层循环">java中断单层和双层循环</span>
            <span class="post-date" title="2017-09-14 19:20:33">2017/09/14</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/09/java/java案例/java重定向输出流实现程序日志/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java重定向输出流实现程序日志">java重定向输出流实现程序日志</span>
            <span class="post-date" title="2017-09-11 19:20:33">2017/09/11</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/08/java/java案例/java界面实现字符串大小写的转换/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java界面实现字符串大小写的转换">java界面实现字符串大小写的转换</span>
            <span class="post-date" title="2017-08-17 19:20:33">2017/08/17</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/08/java/java案例/java界面得出一组数的最小值/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java界面得出一组数的最小值">java界面得出一组数的最小值</span>
            <span class="post-date" title="2017-08-14 19:20:33">2017/08/14</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/08/java/java案例/java界面进制转换/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java界面进制转换">java界面进制转换</span>
            <span class="post-date" title="2017-08-13 19:20:33">2017/08/13</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/08/java/java案例/java界面变换颜色/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java界面变换颜色">java界面变换颜色</span>
            <span class="post-date" title="2017-08-11 19:20:33">2017/08/11</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2017/08/java/java算法/用java排序/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现各种排序">用java实现各种排序</span>
            <span class="post-date" title="2017-08-02 12:30:47">2017/08/02</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/07/java/java案例/用java语言3种方式实现九九乘法表/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="用java语言3种方式实现九九乘法表">用java语言3种方式实现九九乘法表</span>
            <span class="post-date" title="2017-07-26 22:43:17">2017/07/26</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/07/others/computer/计算机网络比较重要的概念/"
           data-tag="其它,计算机"
           data-author="" >
            <span class="post-title" title="计算机网络比较重要的概念">计算机网络比较重要的概念</span>
            <span class="post-date" title="2017-07-23 15:24:20">2017/07/23</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/07/others/computer/数据结构C语言/"
           data-tag="其它,计算机"
           data-author="" >
            <span class="post-title" title="C语言-数据结构-排序汇总（代码可直接运行）">C语言-数据结构-排序汇总（代码可直接运行）</span>
            <span class="post-date" title="2017-07-23 15:24:20">2017/07/23</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/07/java/java案例/java使用Comparable接口自定义排序/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java使用Comparable接口自定义排序">java使用Comparable接口自定义排序</span>
            <span class="post-date" title="2017-07-01 19:20:33">2017/07/01</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/06/java/java案例/用java打印出杨辉三角形/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="用java打印出杨辉三角形">用java打印出杨辉三角形</span>
            <span class="post-date" title="2017-06-27 22:43:17">2017/06/27</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/06/java/java案例/java求其最大公约数和最小公倍数/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java求其最大公约数和最小公倍数">java求其最大公约数和最小公倍数</span>
            <span class="post-date" title="2017-06-26 22:43:17">2017/06/26</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/06/java/java案例/java数学案例总结/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java数学案例总结">java数学案例总结</span>
            <span class="post-date" title="2017-06-16 22:43:17">2017/06/16</span>
        </a>
        
        <a  class="全部文章 部署 linux "
           href="/2017/06/deploy/linux/操作系统介绍/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="操作系统介绍">操作系统介绍</span>
            <span class="post-date" title="2017-06-07 15:24:20">2017/06/07</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/05/java/java案例/java把小写金额转成大写金额/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java把小写金额转成大写金额">java把小写金额转成大写金额</span>
            <span class="post-date" title="2017-05-30 19:20:33">2017/05/30</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/05/java/java案例/java自动类型转换与强制类型转换/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java自动类型转换与强制类型转换">java自动类型转换与强制类型转换</span>
            <span class="post-date" title="2017-05-24 19:20:33">2017/05/24</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/05/others/computer/代码之髓--编程语言核心概念/"
           data-tag="其它,计算机"
           data-author="" >
            <span class="post-title" title="《代码之髓--编程语言核心概念》读后感">《代码之髓--编程语言核心概念》读后感</span>
            <span class="post-date" title="2017-05-20 22:19:19">2017/05/20</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/05/java/java案例/java打印图形/"
           data-tag="java,java案例,java打印图形"
           data-author="" >
            <span class="post-title" title="用java实现打印各种图形总结 (包括长方形 三角形 菱形 平行四边形等)">用java实现打印各种图形总结 (包括长方形 三角形 菱形 平行四边形等)</span>
            <span class="post-date" title="2017-05-17 23:19:19">2017/05/17</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java面向对象进阶/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java面向对象进阶">java面向对象进阶</span>
            <span class="post-date" title="2017-05-14 01:30:00">2017/05/14</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java面向对象基础/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="Java面向对象基础">Java面向对象基础</span>
            <span class="post-date" title="2017-05-12 01:30:00">2017/05/12</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java中GUI编程/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java中GUI编程">java中GUI编程</span>
            <span class="post-date" title="2017-05-09 01:30:00">2017/05/09</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java反射机制总结/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java反射机制总结">java反射机制总结</span>
            <span class="post-date" title="2017-05-07 01:30:00">2017/05/07</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java网络编程总结/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java网络编程总结">java网络编程总结</span>
            <span class="post-date" title="2017-05-05 01:30:00">2017/05/05</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2017/05/java/java算法/用java实现4种加密解密算法/"
           data-tag="java,算法"
           data-author="" >
            <span class="post-title" title="用java实现4种加密解密算法">用java实现4种加密解密算法</span>
            <span class="post-date" title="2017-05-05 01:30:00">2017/05/05</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/Java多线程总结/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="Java中的多线程总结">Java中的多线程总结</span>
            <span class="post-date" title="2017-05-03 01:30:00">2017/05/03</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/05/java/java基础/java枚举和注解/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java枚举和注解">java枚举和注解</span>
            <span class="post-date" title="2017-05-01 09:30:00">2017/05/01</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/Java中IO流/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="Java中IO流">Java中IO流</span>
            <span class="post-date" title="2017-04-29 01:30:00">2017/04/29</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/java泛型总结/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="Java中的泛型总结">Java中的泛型总结</span>
            <span class="post-date" title="2017-04-28 01:30:00">2017/04/28</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/Java集合框架总结/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java集合框架总结">java集合框架总结</span>
            <span class="post-date" title="2017-04-27 01:30:00">2017/04/27</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/java异常/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java异常">java异常</span>
            <span class="post-date" title="2017-04-27 01:30:00">2017/04/27</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/java核心类/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="java基础">java基础</span>
            <span class="post-date" title="2017-04-27 01:30:00">2017/04/27</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/04/java/java案例/java控制台输出学生的成绩/"
           data-tag="java,java案例"
           data-author="" >
            <span class="post-title" title="java控制台输出学生的成绩">java控制台输出学生的成绩</span>
            <span class="post-date" title="2017-04-26 22:43:17">2017/04/26</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/java数组/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java数组">java数组</span>
            <span class="post-date" title="2017-04-24 01:30:00">2017/04/24</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/字符串string类的/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java字符串String类">java字符串String类</span>
            <span class="post-date" title="2017-04-24 01:30:00">2017/04/24</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/运算和流程控制/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java运算和流程控制">java运算和流程控制</span>
            <span class="post-date" title="2017-04-23 01:30:00">2017/04/23</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/变量和数据类型/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java变量和数据类型">java变量和数据类型</span>
            <span class="post-date" title="2017-04-22 01:30:00">2017/04/22</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/java概述/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="java基础">java基础</span>
            <span class="post-date" title="2017-04-21 01:30:00">2017/04/21</span>
        </a>
        
        <a  class="全部文章 其它 工具 "
           href="/2017/04/others/tools/markdown中的一些操作/"
           data-tag="其它,工具"
           data-author="" >
            <span class="post-title" title="markdown中的一些操作">markdown中的一些操作</span>
            <span class="post-date" title="2017-04-20 20:00:20">2017/04/20</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-python/python优化/effective_python" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Effective Python（摘录）</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="python">python</a> > 
            
            <a  data-rel="python&lt;---&gt;python优化">python优化</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color4">python优化</a>
            
            <a class="color4">python基础</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2021-08-04 10:14:37'>2021-07-21 15:24</time>
        
    </div>
    <div class="article-meta">
        
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-培养Pythonic思维"><span class="toc-text">一. 培养Pythonic思维</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-查询自己使用的python版本"><span class="toc-text">1. 查询自己使用的python版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-遵循PEP8风格指南"><span class="toc-text">2. 遵循PEP8风格指南</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-了解bytes与str的区别"><span class="toc-text">3. 了解bytes与str的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-用支持插值的f-string取代C风格的格式字符串和str-format方法"><span class="toc-text">4. 用支持插值的f-string取代C风格的格式字符串和str.format方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-用辅助函数取代复杂的表达式"><span class="toc-text">5. 用辅助函数取代复杂的表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-把数据结构直接拆分到多个变量里，不要专门通过下标访问"><span class="toc-text">6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-尽量用enumerate取代range"><span class="toc-text">7. 尽量用enumerate取代range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-用zip函数同时遍历两个迭代器"><span class="toc-text">8. 用zip函数同时遍历两个迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-不要在for与while循环后面写else块"><span class="toc-text">9. 不要在for与while循环后面写else块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-用赋值表达式减少重复代码"><span class="toc-text">10. 用赋值表达式减少重复代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-列表与字典"><span class="toc-text">二. 列表与字典</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-学会对序列做切片"><span class="toc-text">11. 学会对序列做切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-不要在切片里同时-起止下标与步进"><span class="toc-text">12. 不要在切片里同时 起止下标与步进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-通过带星号的unpacking操作来捕获多个元素，不要用切片"><span class="toc-text">13. 通过带星号的unpacking操作来捕获多个元素，不要用切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-用sort方法的key参数来表示复杂的排序逻辑"><span class="toc-text">14. 用sort方法的key参数来表示复杂的排序逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-不要过分依赖给字典添加条目时所用的顺序"><span class="toc-text">15. 不要过分依赖给字典添加条目时所用的顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-用get处理键不在字典中的情况，不要使用in与KeyError"><span class="toc-text">16. 用get处理键不在字典中的情况，不要使用in与KeyError</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault"><span class="toc-text">17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-学会利用missing构造依赖键的默认值"><span class="toc-text">18. 学会利用missing构造依赖键的默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-不要把函数返回的多个数值拆分到三个以上的变量中"><span class="toc-text">19. 不要把函数返回的多个数值拆分到三个以上的变量中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-函数"><span class="toc-text">三. 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-遇到意外状况时应该抛出异常，不要返回None"><span class="toc-text">20. 遇到意外状况时应该抛出异常，不要返回None</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-了解如何在闭包里面使用外围作用域中的变量"><span class="toc-text">21. 了解如何在闭包里面使用外围作用域中的变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-用数量可变的位置参数给函数设计清晰的参数列表"><span class="toc-text">22. 用数量可变的位置参数给函数设计清晰的参数列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-用关键字参数来表示可选的行为"><span class="toc-text">23. 用关键字参数来表示可选的行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-用None和docstring来描述默认值会变的参数"><span class="toc-text">24. 用None和docstring来描述默认值会变的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表"><span class="toc-text">25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#26-用functools-wraps定义函数修饰器"><span class="toc-text">26. 用functools.wraps定义函数修饰器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-推导与生成"><span class="toc-text">四. 推导与生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#27-用列表推导取代map与filter"><span class="toc-text">27. 用列表推导取代map与filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28-控制推导逻辑的子表达式不要超过两个"><span class="toc-text">28. 控制推导逻辑的子表达式不要超过两个</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#29-用赋值表达式消除推导中的重复代码"><span class="toc-text">29. 用赋值表达式消除推导中的重复代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#30-不要让函数直接返回列表，应该让它逐个生成列表里的值"><span class="toc-text">30. 不要让函数直接返回列表，应该让它逐个生成列表里的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#31-谨慎地迭代函数所收到的参数"><span class="toc-text">31. 谨慎地迭代函数所收到的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-考虑用生成器表达式改写数据量较大的列表推导"><span class="toc-text">32. 考虑用生成器表达式改写数据量较大的列表推导</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-通过yield-from把多个生成器连起来用"><span class="toc-text">33. 通过yield from把多个生成器连起来用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-不要用send给生成器注入数据"><span class="toc-text">34. 不要用send给生成器注入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-不要通过throw变换生成器的状态"><span class="toc-text">35. 不要通过throw变换生成器的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#36-考虑用itertools拼装迭代器与生成器"><span class="toc-text">36. 考虑用itertools拼装迭代器与生成器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五-类与接口"><span class="toc-text">五. 类与接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#37-用组合起来的类来实现多层结构，不要用嵌套的内置类型"><span class="toc-text">37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#38-让简单的接口接受函数，而不是类的实例"><span class="toc-text">38. 让简单的接口接受函数，而不是类的实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#39-通过-classmethod多态来构造同一体系中的各类对象"><span class="toc-text">39. 通过@classmethod多态来构造同一体系中的各类对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#40-通过super初始化超类"><span class="toc-text">40. 通过super初始化超类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#41-考虑用mix-in类来表示可组合的功能"><span class="toc-text">41. 考虑用mix-in类来表示可组合的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-优先考虑用public属性表示应受保护的数据，不要用private属性表示"><span class="toc-text">42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-自定义的容器类型应该从collections-abc继承"><span class="toc-text">43. 自定义的容器类型应该从collections.abc继承</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六-元类与属性"><span class="toc-text">六. 元类与属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#44-用纯属性与修饰器取代旧式的setter与getter方法"><span class="toc-text">44. 用纯属性与修饰器取代旧式的setter与getter方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码"><span class="toc-text">45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#46-用描述符来改写需要复用的-property方法"><span class="toc-text">46. 用描述符来改写需要复用的@property方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#47-针对惰性属性使用-getattr-、-getattribute-及-setattr"><span class="toc-text">47. 针对惰性属性使用__getattr__、__getattribute__及 __setattr__</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#48-用init-subclass验证子类写得是否正确"><span class="toc-text">48. 用init_subclass验证子类写得是否正确</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#49-用init-subclass记录现有的子类"><span class="toc-text">49. 用init_subclass记录现有的子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#50-用-set-name-给类属性加注解"><span class="toc-text">50. 用__set_name__给类属性加注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><span class="toc-text">51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七-并发与并行"><span class="toc-text">七. 并发与并行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#52-用subprocess管理子进程"><span class="toc-text">52. 用subprocess管理子进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-可以用线程执行阻塞式I-O，但不要用它做并行计算"><span class="toc-text">53. 可以用线程执行阻塞式I/O，但不要用它做并行计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#54-利用Lock防止多个线程争用同一份数据"><span class="toc-text">54. 利用Lock防止多个线程争用同一份数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#55-用Queue来协调各线程之间的工作进度"><span class="toc-text">55. 用Queue来协调各线程之间的工作进度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#56-学会判断什么场合必须做并发"><span class="toc-text">56. 学会判断什么场合必须做并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#57-不要在每次fan-out时都新建一批Thread实例"><span class="toc-text">57. 不要在每次fan-out时都新建一批Thread实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#58-学会正确地重构代码，以便用Queue做并发"><span class="toc-text">58. 学会正确地重构代码，以便用Queue做并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"><span class="toc-text">59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#60-用协程实现高并发的I-O"><span class="toc-text">60. 用协程实现高并发的I/O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#61-学会用asyncio改写那些通过线程实现的I-O"><span class="toc-text">61. 学会用asyncio改写那些通过线程实现的I/O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-结合线程与协程，将代码顺利迁移到asyncio"><span class="toc-text">62. 结合线程与协程，将代码顺利迁移到asyncio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"><span class="toc-text">63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-考虑用concurrent-futures实现真正的并行计算"><span class="toc-text">64. 考虑用concurrent.futures实现真正的并行计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八-稳定与性能"><span class="toc-text">八. 稳定与性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#65-合理利用try-except-else-finally结构中的每个代码块"><span class="toc-text">65. 合理利用try/except/else/finally结构中的每个代码块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#66-考虑用contextlib和with语句来改写可复用的try-finally代码"><span class="toc-text">66. 考虑用contextlib和with语句来改写可复用的try/finally代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#67-用datetime模块处理本地时间，不要用time模块"><span class="toc-text">67. 用datetime模块处理本地时间，不要用time模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#68-用copyreg实现可靠的pickle操作"><span class="toc-text">68. 用copyreg实现可靠的pickle操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#69-在需要准确计算的场合，用decimal表示相应的数值"><span class="toc-text">69. 在需要准确计算的场合，用decimal表示相应的数值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#70-先分析性能，然后再优化"><span class="toc-text">70. 先分析性能，然后再优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#71-优先考虑用deque实现生产者-消费者队列"><span class="toc-text">71. 优先考虑用deque实现生产者-消费者队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-考虑用bisect搜索已排序的序列"><span class="toc-text">72. 考虑用bisect搜索已排序的序列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-学会使用heapq制作优先级队列"><span class="toc-text">73. 学会使用heapq制作优先级队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作"><span class="toc-text">74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九-测试与调试"><span class="toc-text">九. 测试与调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#75-通过repr字符串输出调试信息"><span class="toc-text">75. 通过repr字符串输出调试信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#76-在TestCase子类里验证相关的行为"><span class="toc-text">76. 在TestCase子类里验证相关的行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"><span class="toc-text">77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#78-用Mock来模拟受测代码所依赖的复杂函数"><span class="toc-text">78. 用Mock来模拟受测代码所依赖的复杂函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#79-把受测代码所依赖的系统封装起来，以便于模拟和测试"><span class="toc-text">79. 把受测代码所依赖的系统封装起来，以便于模拟和测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#80-考虑用pdb做交互调试"><span class="toc-text">80. 考虑用pdb做交互调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#81-用tracemalloc来掌握内存的使用与泄漏情况"><span class="toc-text">81. 用tracemalloc来掌握内存的使用与泄漏情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十-协作并发"><span class="toc-text">十. 协作并发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#82-学会寻找由其他Python开发者所构建的模块"><span class="toc-text">82. 学会寻找由其他Python开发者所构建的模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#83-用虚拟环境隔离项目，并重建依赖关系"><span class="toc-text">83. 用虚拟环境隔离项目，并重建依赖关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#84-每一个函数、类与模块都要写docstring"><span class="toc-text">84. 每一个函数、类与模块都要写docstring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#85-用包来安排模块，以提供稳固的API"><span class="toc-text">85. 用包来安排模块，以提供稳固的API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#86-考虑用模块级别的代码配置不同的部署环境"><span class="toc-text">86. 考虑用模块级别的代码配置不同的部署环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"><span class="toc-text">87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#88-用适当的方式打破循环依赖关系"><span class="toc-text">88. 用适当的方式打破循环依赖关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#89-重构时考虑通过warnings提醒开发者API已经发生变化"><span class="toc-text">89. 重构时考虑通过warnings提醒开发者API已经发生变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#90-考虑通过typing做静态分析，以消除bug"><span class="toc-text">90. 考虑通过typing做静态分析，以消除bug</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-5 i,
    .toc-level-5 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>静下心来去理解，收获颇多。</p>
<h2 id="一-培养Pythonic思维"><a href="#一-培养Pythonic思维" class="headerlink" title="一. 培养Pythonic思维"></a>一. 培养Pythonic思维</h2><h3 id="1-查询自己使用的python版本"><a href="#1-查询自己使用的python版本" class="headerlink" title="1. 查询自己使用的python版本"></a>1. 查询自己使用的python版本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">print(sys.version_info)</span><br><span class="line">print(sys.version)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码自动检查：https://pylint.org/  pip install pylint</span></span><br></pre></td></tr></table></figure>
<h3 id="2-遵循PEP8风格指南"><a href="#2-遵循PEP8风格指南" class="headerlink" title="2. 遵循PEP8风格指南"></a>2. 遵循PEP8风格指南</h3><p>官网：<a href="https://pep8.org/" target="_blank" rel="noopener">https://pep8.org/</a><br>中文翻译：<a href="https://www.cnblogs.com/bymo/p/9567140.html" target="_blank" rel="noopener">https://www.cnblogs.com/bymo/p/9567140.html</a></p>
<h3 id="3-了解bytes与str的区别"><a href="#3-了解bytes与str的区别" class="headerlink" title="3. 了解bytes与str的区别"></a>3. 了解bytes与str的区别</h3><p>bytes：bytes的实例包含原始的8个字节<br>str：str的实例包含Unicode字符bytes<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接受str或bytes,并总是返回str的方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_str</span><span class="params">(bytes_or_str)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bytes_or_str,bytes):</span><br><span class="line">        value = bytes_or_str.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = bytes_or_str</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接受str或bytes,并总是返回bytes的方法：</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_bytes</span><span class="params">(bytes_or_str)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bytes_or_str,str):</span><br><span class="line">        value = bytes_or_str.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = bytes_or_str</span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure></p>
<h3 id="4-用支持插值的f-string取代C风格的格式字符串和str-format方法"><a href="#4-用支持插值的f-string取代C风格的格式字符串和str-format方法" class="headerlink" title="4. 用支持插值的f-string取代C风格的格式字符串和str.format方法"></a>4. 用支持插值的f-string取代C风格的格式字符串和str.format方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pantry = [</span><br><span class="line">    (<span class="string">'avocados'</span>, <span class="number">1.25</span>),</span><br><span class="line">    (<span class="string">'bananas'</span>, <span class="number">2.5</span>),</span><br><span class="line">    (<span class="string">'cherries'</span>, <span class="number">15</span>),</span><br><span class="line">]</span><br><span class="line"><span class="keyword">for</span> i, (item, count) <span class="keyword">in</span> enumerate(pantry):</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;item.title():&lt;<span class="number">10</span>s&#125;</span> = <span class="subst">&#123;round(count)&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-用辅助函数取代复杂的表达式"><a href="#5-用辅助函数取代复杂的表达式" class="headerlink" title="5. 用辅助函数取代复杂的表达式"></a>5. 用辅助函数取代复杂的表达式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs</span><br><span class="line"></span><br><span class="line">my_values = parse_qs(<span class="string">'red=5&amp;blue=0&amp;green=3'</span>, keep_blank_values=<span class="literal">True</span>)</span><br><span class="line">print(repr(my_values))</span><br><span class="line"></span><br><span class="line">green_str = my_values.get(<span class="string">'green'</span>, [<span class="string">''</span>])</span><br><span class="line"><span class="keyword">if</span> green_str[<span class="number">0</span>]:</span><br><span class="line">    green = int(green_str[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    green = <span class="number">0</span></span><br><span class="line">print(<span class="string">f'Green:   <span class="subst">&#123;green!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_first_int</span><span class="params">(values, key, default=<span class="number">0</span>)</span>:</span></span><br><span class="line">    found = values.get(key, [<span class="string">''</span>])</span><br><span class="line">    <span class="keyword">if</span> found[<span class="number">0</span>]:</span><br><span class="line">        <span class="keyword">return</span> int(found[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">green = get_first_int(my_values, <span class="string">'green'</span>)</span><br><span class="line">print(<span class="string">f'Green:   <span class="subst">&#123;green!r&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-把数据结构直接拆分到多个变量里，不要专门通过下标访问"><a href="#6-把数据结构直接拆分到多个变量里，不要专门通过下标访问" class="headerlink" title="6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问"></a>6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">snacks = [(<span class="string">'bacon'</span>, <span class="number">350</span>), (<span class="string">'donut'</span>, <span class="number">240</span>), (<span class="string">'muffin'</span>, <span class="number">190</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(snacks)):</span><br><span class="line">    item = snacks[i]</span><br><span class="line">    name = item[<span class="number">0</span>]</span><br><span class="line">    calories = item[<span class="number">1</span>]</span><br><span class="line">    print(<span class="string">f'#<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>: <span class="subst">&#123;name&#125;</span> has <span class="subst">&#123;calories&#125;</span> calories'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rank, (name, calories) <span class="keyword">in</span> enumerate(snacks, <span class="number">1</span>):</span><br><span class="line">    print(<span class="string">f'#<span class="subst">&#123;rank&#125;</span>: <span class="subst">&#123;name&#125;</span> has <span class="subst">&#123;calories&#125;</span> calories'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="7-尽量用enumerate取代range"><a href="#7-尽量用enumerate取代range" class="headerlink" title="7. 尽量用enumerate取代range"></a>7. 尽量用enumerate取代range</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">flavor_list = [<span class="string">'vanilla'</span>, <span class="string">'chocolate'</span>, <span class="string">'pecan'</span>, <span class="string">'strawberry'</span>]</span><br><span class="line"><span class="keyword">for</span> flavor <span class="keyword">in</span> flavor_list:</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;flavor&#125;</span> is delicious'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(flavor_list)):</span><br><span class="line">    flavor = flavor_list[i]</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>: <span class="subst">&#123;flavor&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example </span></span><br><span class="line">it = enumerate(flavor_list)</span><br><span class="line">print(next(it))</span><br><span class="line">print(next(it))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, flavor <span class="keyword">in</span> enumerate(flavor_list):</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;flavor&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, flavor <span class="keyword">in</span> enumerate(flavor_list, <span class="number">2</span>):  <span class="comment"># 从2开始</span></span><br><span class="line">    print(<span class="string">f'enumerate <span class="subst">&#123;i&#125;</span>: <span class="subst">&#123;flavor&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="8-用zip函数同时遍历两个迭代器"><a href="#8-用zip函数同时遍历两个迭代器" class="headerlink" title="8. 用zip函数同时遍历两个迭代器"></a>8. 用zip函数同时遍历两个迭代器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">names = [<span class="string">'Cecilia'</span>, <span class="string">'Lise'</span>, <span class="string">'Marie'</span>]</span><br><span class="line">counts = [len(n) <span class="keyword">for</span> n <span class="keyword">in</span> names]</span><br><span class="line">print(counts, len(counts), len(names))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">longest_name = <span class="string">'None11'</span></span><br><span class="line">max_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(names)):</span><br><span class="line">    count = counts[i]</span><br><span class="line">    <span class="keyword">if</span> count &gt; max_count:</span><br><span class="line">        longest_name = names[i]</span><br><span class="line">        max_count = count</span><br><span class="line"></span><br><span class="line">print(longest_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">longest_name = <span class="literal">None</span></span><br><span class="line">max_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, name <span class="keyword">in</span> enumerate(names):</span><br><span class="line">    count = counts[i]</span><br><span class="line">    <span class="keyword">if</span> count &gt; max_count:</span><br><span class="line">        longest_name = name</span><br><span class="line">        max_count = count</span><br><span class="line"></span><br><span class="line">print(<span class="string">'--'</span>, longest_name)</span><br><span class="line"><span class="keyword">assert</span> longest_name == <span class="string">'Cecilia'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">longest_name = <span class="literal">None</span></span><br><span class="line">max_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> name, count <span class="keyword">in</span> zip(names, counts):</span><br><span class="line">    <span class="keyword">if</span> count &gt; max_count:</span><br><span class="line">        longest_name = name</span><br><span class="line">        max_count = count</span><br><span class="line"><span class="keyword">assert</span> longest_name == <span class="string">'Cecilia'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">names.append(<span class="string">'Rosalind'</span>)</span><br><span class="line"><span class="comment"># counts.append(8)</span></span><br><span class="line">print(<span class="string">f'names: <span class="subst">&#123;names&#125;</span>, counts: <span class="subst">&#123;counts&#125;</span>'</span>)</span><br><span class="line"><span class="keyword">for</span> name, count <span class="keyword">in</span> zip(names, counts):</span><br><span class="line">    print(name, count)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, count <span class="keyword">in</span> itertools.zip_longest(names, counts):</span><br><span class="line">    print(<span class="string">f'itertools: <span class="subst">&#123;name&#125;</span>: <span class="subst">&#123;count&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="9-不要在for与while循环后面写else块"><a href="#9-不要在for与while循环后面写else块" class="headerlink" title="9. 不要在for与while循环后面写else块"></a>9. 不要在for与while循环后面写else块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    print(<span class="string">'Loop'</span>, i)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Else block!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line">a = <span class="number">4</span></span><br><span class="line">b = <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, min(a, b) + <span class="number">1</span>):</span><br><span class="line">    print(<span class="string">'Testing'</span>, i)</span><br><span class="line">    <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">'Not coprime'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Coprime'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是应该的写法：方法一，只要发现某个方法成立，就立刻返回</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coprime</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, min(a, b) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> coprime(<span class="number">4</span>, <span class="number">9</span>)</span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> coprime(<span class="number">3</span>, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二，用变量记录循环过程中与没有碰到成立的情况，返回这个变量的值</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coprime_alternate</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    is_coprime = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, min(a, b) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">            is_coprime = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> is_coprime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> coprime_alternate(<span class="number">4</span>, <span class="number">9</span>)</span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> coprime_alternate(<span class="number">3</span>, <span class="number">6</span>)</span><br></pre></td></tr></table></figure>
<h3 id="10-用赋值表达式减少重复代码"><a href="#10-用赋值表达式减少重复代码" class="headerlink" title="10. 用赋值表达式减少重复代码"></a>10. 用赋值表达式减少重复代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">赋值表达式通过海象操作符(:=)给变量赋值，并且让这个值成为这个表达式的结构</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">FRUIT_TO_PICK = [</span><br><span class="line">    &#123;<span class="string">'apple'</span>: <span class="number">1</span>, <span class="string">'banana'</span>: <span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'lemon'</span>: <span class="number">2</span>, <span class="string">'lime'</span>: <span class="number">5</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'orange'</span>: <span class="number">3</span>, <span class="string">'melon'</span>: <span class="number">2</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pick_fruit</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> FRUIT_TO_PICK:</span><br><span class="line">        <span class="keyword">return</span> FRUIT_TO_PICK.pop(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_juice</span><span class="params">(fruit, count)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> [(fruit, count)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bottles = []</span><br><span class="line"><span class="keyword">while</span> fresh_fruit := pick_fruit():</span><br><span class="line">    <span class="keyword">for</span> fruit, count <span class="keyword">in</span> fresh_fruit.items():</span><br><span class="line">        batch = make_juice(fruit, count)</span><br><span class="line">        bottles.extend(batch)</span><br><span class="line"></span><br><span class="line">print(bottles)</span><br></pre></td></tr></table></figure>
<h2 id="二-列表与字典"><a href="#二-列表与字典" class="headerlink" title="二. 列表与字典"></a>二. 列表与字典</h2><h3 id="11-学会对序列做切片"><a href="#11-学会对序列做切片" class="headerlink" title="11. 学会对序列做切片"></a>11. 学会对序列做切片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>]</span><br><span class="line">print(<span class="string">'Middle two:  '</span>, a[<span class="number">3</span>:<span class="number">5</span>])</span><br><span class="line">print(<span class="string">'--:'</span>, a[<span class="number">-3</span>:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> a[:<span class="number">5</span>] == a[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line"><span class="keyword">assert</span> a[<span class="number">5</span>:] == a[<span class="number">5</span>:len(a)]</span><br><span class="line"></span><br><span class="line">print(a[<span class="number">2</span>:<span class="number">-1</span>])</span><br><span class="line">print(a[<span class="number">-3</span>:<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<h3 id="12-不要在切片里同时-起止下标与步进"><a href="#12-不要在切片里同时-起止下标与步进" class="headerlink" title="12. 不要在切片里同时 起止下标与步进"></a>12. 不要在切片里同时 起止下标与步进</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x = [<span class="string">'red'</span>, <span class="string">'orange'</span>, <span class="string">'yellow'</span>, <span class="string">'green'</span>, <span class="string">'blue'</span>, <span class="string">'purple'</span>]</span><br><span class="line">print(<span class="string">f'odds: <span class="subst">&#123;x[::<span class="number">2</span>]&#125;</span>'</span>)  <span class="comment"># odds: ['red', 'yellow', 'blue']</span></span><br><span class="line">print(<span class="string">f'evens: <span class="subst">&#123;x[<span class="number">1</span>::<span class="number">2</span>]&#125;</span>'</span>)  <span class="comment"># evens: ['orange', 'green', 'purple']</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">b'mongoose'</span>[::<span class="number">-1</span>])  <span class="comment"># b'esoognom'</span></span><br></pre></td></tr></table></figure>
<h3 id="13-通过带星号的unpacking操作来捕获多个元素，不要用切片"><a href="#13-通过带星号的unpacking操作来捕获多个元素，不要用切片" class="headerlink" title="13. 通过带星号的unpacking操作来捕获多个元素，不要用切片"></a>13. 通过带星号的unpacking操作来捕获多个元素，不要用切片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">car_inventory = &#123;</span><br><span class="line">    <span class="string">'Downtown'</span>: (<span class="string">'Silver Shadow'</span>, <span class="string">'Pinto'</span>, <span class="string">'DMC'</span>),</span><br><span class="line">    <span class="string">'Airport'</span>: (<span class="string">'Skyline'</span>, <span class="string">'Viper'</span>, <span class="string">'Gremlin'</span>, <span class="string">'Nova'</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">((loc1, (best1, *rest1)), (loc2, (best2, *rest2))) = car_inventory.items()</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'Best at <span class="subst">&#123;loc1&#125;</span> is <span class="subst">&#123;best1&#125;</span>, <span class="subst">&#123;len(rest1)&#125;</span> others'</span>)  <span class="comment"># Best at Downtown is Silver Shadow, 2 others</span></span><br><span class="line">print(<span class="string">f'Best at <span class="subst">&#123;loc2&#125;</span> is <span class="subst">&#123;best2&#125;</span>, <span class="subst">&#123;len(rest2)&#125;</span> others'</span>)  <span class="comment"># Best at Airport is Skyline, 3 others</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">short_list = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">first, second, *rest = short_list</span><br><span class="line">print(first, second, rest)  <span class="comment"># 3 1 2 []</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_csv</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">'Date'</span>, <span class="string">'Make'</span>, <span class="string">'Model'</span>, <span class="string">'Year'</span>, <span class="string">'Price'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">'2019-03-25'</span>, <span class="string">'Honda'</span>, <span class="string">'Fit'</span>, <span class="string">'2010'</span>, <span class="string">'$3400'</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="string">'2019-03-26'</span>, <span class="string">'Ford'</span>, <span class="string">'F150'</span>, <span class="string">'2008'</span>, <span class="string">'$2400'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all_csv_rows = list(generate_csv())</span><br><span class="line">print(all_csv_rows)</span><br><span class="line">print(<span class="string">'CSV Header:'</span>, all_csv_rows[<span class="number">0</span>])  <span class="comment"># CSV Header: ('Date', 'Make', 'Model', 'Year', 'Price')</span></span><br><span class="line">print(<span class="string">'Row count: '</span>, len(all_csv_rows[<span class="number">1</span>:]))  <span class="comment"># Row count:  6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line">it = generate_csv()</span><br><span class="line">header, *rows = it</span><br><span class="line">print(<span class="string">'CSV Header:'</span>, header)  <span class="comment"># CSV Header: ('Date', 'Make', 'Model', 'Year', 'Price')</span></span><br><span class="line">print(<span class="string">'Row count: '</span>, len(rows))  <span class="comment"># Row count:  6</span></span><br></pre></td></tr></table></figure>
<h3 id="14-用sort方法的key参数来表示复杂的排序逻辑"><a href="#14-用sort方法的key参数来表示复杂的排序逻辑" class="headerlink" title="14. 用sort方法的key参数来表示复杂的排序逻辑"></a>14. 用sort方法的key参数来表示复杂的排序逻辑</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">numbers = [<span class="number">93</span>, <span class="number">86</span>, <span class="number">11</span>, <span class="number">68</span>, <span class="number">70</span>]</span><br><span class="line">numbers.sort(reverse=<span class="literal">True</span>)  <span class="comment"># 由大到小排列</span></span><br><span class="line">print(numbers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tool</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, weight)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.weight = weight</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'Tool(<span class="subst">&#123;self.name!r&#125;</span>, <span class="subst">&#123;self.weight&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line">tools = [</span><br><span class="line">    Tool(<span class="string">'level'</span>, <span class="number">3.5</span>),</span><br><span class="line">    Tool(<span class="string">'hammer'</span>, <span class="number">1.25</span>),</span><br><span class="line">    Tool(<span class="string">'screwdriver'</span>, <span class="number">0.5</span>),</span><br><span class="line">    Tool(<span class="string">'chisel'</span>, <span class="number">0.25</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">print(<span class="string">'Unsorted:'</span>, repr(tools))</span><br><span class="line">tools.sort(key=<span class="keyword">lambda</span> x: x.name)</span><br><span class="line">print(<span class="string">'Sorted:  '</span>, tools)  <span class="comment"># [Tool('chisel', 0.25), Tool('hammer', 1.25), Tool('level', 3.5), Tool('screwdriver', 0.5)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">tools.sort(key=<span class="keyword">lambda</span> x: x.weight)</span><br><span class="line">print(<span class="string">'By weight:'</span>, tools)  <span class="comment"># [Tool('chisel', 0.25), Tool('screwdriver', 0.5), Tool('hammer', 1.25), Tool('level', 3.5)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">places = [<span class="string">'home'</span>, <span class="string">'work'</span>, <span class="string">'New York'</span>, <span class="string">'Paris'</span>]</span><br><span class="line">places.sort()</span><br><span class="line">print(<span class="string">'Case sensitive:  '</span>, places)  <span class="comment"># ['New York', 'Paris', 'home', 'work']</span></span><br><span class="line">places.sort(key=<span class="keyword">lambda</span> x: x.lower())</span><br><span class="line">print(<span class="string">'Case insensitive:'</span>, places)  <span class="comment"># ['home', 'New York', 'Paris', 'work']</span></span><br></pre></td></tr></table></figure>
<h3 id="15-不要过分依赖给字典添加条目时所用的顺序"><a href="#15-不要过分依赖给字典添加条目时所用的顺序" class="headerlink" title="15. 不要过分依赖给字典添加条目时所用的顺序"></a>15. 不要过分依赖给字典添加条目时所用的顺序</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">baby_names = &#123;</span><br><span class="line">    <span class="string">'cat'</span>: <span class="string">'kitten'</span>,</span><br><span class="line">    <span class="string">'dog'</span>: <span class="string">'puppy'</span>,</span><br><span class="line">&#125;</span><br><span class="line">print(baby_names)</span><br><span class="line"></span><br><span class="line">print(list(baby_names.keys()))</span><br><span class="line">print(list(baby_names.values()))</span><br><span class="line">print(list(baby_names.items()))  <span class="comment"># [('cat', 'kitten'), ('dog', 'puppy')]</span></span><br><span class="line">print(baby_names.popitem())  <span class="comment"># Last item inserted  : ('dog', 'puppy')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.alligator = <span class="string">'hatchling'</span></span><br><span class="line">        self.elephant = <span class="string">'calf'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = MyClass()</span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> a.__dict__.items():</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;key&#125;</span> = <span class="subst">&#123;value&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">votes = &#123;</span><br><span class="line">    <span class="string">'otter'</span>: <span class="number">1281</span>,</span><br><span class="line">    <span class="string">'polar bear'</span>: <span class="number">587</span>,</span><br><span class="line">    <span class="string">'fox'</span>: <span class="number">863</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">populate_ranks</span><span class="params">(votes, ranks)</span>:</span></span><br><span class="line">    names = list(votes.keys())</span><br><span class="line">    names.sort(key=votes.get, reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">for</span> i, name <span class="keyword">in</span> enumerate(names, <span class="number">1</span>):</span><br><span class="line">        ranks[name] = i</span><br><span class="line"></span><br><span class="line">ranks = &#123;&#125;</span><br><span class="line">populate_ranks(votes, ranks)</span><br><span class="line">print(ranks)  <span class="comment"># &#123;'otter': 1, 'fox': 2, 'polar bear': 3&#125;</span></span><br><span class="line">print(next(iter(ranks)))  <span class="comment"># otter</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> MutableMapping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SortedDict</span><span class="params">(MutableMapping)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.data[key]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        self.data[key] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self.data[key]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        keys = list(self.data.keys())</span><br><span class="line">        keys.sort()</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> keys:</span><br><span class="line">            <span class="keyword">yield</span> key</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my_dict = SortedDict()</span><br><span class="line">my_dict[<span class="string">'otter'</span>] = <span class="number">1</span></span><br><span class="line">my_dict[<span class="string">'cheeta'</span>] = <span class="number">2</span></span><br><span class="line">my_dict[<span class="string">'anteater'</span>] = <span class="number">3</span></span><br><span class="line">my_dict[<span class="string">'deer'</span>] = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> my_dict[<span class="string">'otter'</span>] == <span class="number">1</span></span><br><span class="line"><span class="keyword">assert</span> <span class="string">'cheeta'</span> <span class="keyword">in</span> my_dict</span><br><span class="line"><span class="keyword">del</span> my_dict[<span class="string">'cheeta'</span>]</span><br><span class="line"><span class="keyword">assert</span> <span class="string">'cheeta'</span> <span class="keyword">not</span> <span class="keyword">in</span> my_dict</span><br><span class="line"></span><br><span class="line">print(my_dict)</span><br><span class="line">expected = [(<span class="string">'anteater'</span>, <span class="number">3</span>), (<span class="string">'deer'</span>, <span class="number">4</span>), (<span class="string">'otter'</span>, <span class="number">1</span>)]</span><br><span class="line"><span class="keyword">assert</span> list(my_dict.items()) == expected</span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> isinstance(my_dict, dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line">sorted_ranks = SortedDict()</span><br><span class="line">populate_ranks(votes, sorted_ranks)</span><br><span class="line">print(sorted_ranks.data)  <span class="comment"># &#123;'otter': 1, 'fox': 2, 'polar bear': 3&#125;</span></span><br><span class="line">print(next(iter(sorted_ranks)))  <span class="comment"># fox</span></span><br></pre></td></tr></table></figure>
<h3 id="16-用get处理键不在字典中的情况，不要使用in与KeyError"><a href="#16-用get处理键不在字典中的情况，不要使用in与KeyError" class="headerlink" title="16. 用get处理键不在字典中的情况，不要使用in与KeyError"></a>16. 用get处理键不在字典中的情况，不要使用in与KeyError</h3><p>有4中方法处理键不在字典中的情况：in表达式，KeyError异常，get方法和setdefault方法。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">counters = &#123;</span><br><span class="line">    <span class="string">'pumpernickel'</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">'sourdough'</span>: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line">key = <span class="string">'multigrain'</span></span><br><span class="line">count = counters.get(key, <span class="number">0</span>)</span><br><span class="line">counters[key] = count + <span class="number">1</span></span><br><span class="line">print(counters)  <span class="comment"># &#123;'pumpernickel': 2, 'sourdough': 1, 'multigrain': 1&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">votes = &#123;</span><br><span class="line">    <span class="string">'baguette'</span>: [<span class="string">'Bob'</span>, <span class="string">'Alice'</span>],</span><br><span class="line">    <span class="string">'ciabatta'</span>: [<span class="string">'Coco'</span>, <span class="string">'Deb'</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">key = <span class="string">'brioche'</span></span><br><span class="line">who = <span class="string">'Elmer'</span></span><br><span class="line">print(<span class="string">f'votes pre: <span class="subst">&#123;votes&#125;</span>'</span>)  <span class="comment"># &#123;'baguette': ['Bob', 'Alice'], 'ciabatta': ['Coco', 'Deb']&#125;</span></span><br><span class="line"><span class="keyword">if</span> key <span class="keyword">in</span> votes:</span><br><span class="line">    names = votes[key]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    votes[key] = names = []</span><br><span class="line">    print(votes)  <span class="comment"># &#123;'baguette': ['Bob', 'Alice'], 'ciabatta': ['Coco', 'Deb'], 'brioche': []&#125;</span></span><br><span class="line"></span><br><span class="line">names.append(who)</span><br><span class="line">print(<span class="string">f'votes: <span class="subst">&#123;votes&#125;</span>'</span>)  <span class="comment"># &#123;'baguette': ['Bob', 'Alice'], 'ciabatta': ['Coco', 'Deb'], 'brioche': ['Elmer']&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key = <span class="string">'cornbread'</span></span><br><span class="line">who = <span class="string">'Kirk'</span></span><br><span class="line"></span><br><span class="line">names = votes.setdefault(key, [])</span><br><span class="line">names.append(who)</span><br><span class="line">print(votes)  <span class="comment"># &#123;'baguette': ['Bob', 'Alice'], 'ciabatta': ['Coco', 'Deb'], 'brioche': ['Elmer'], 'cornbread': ['Kirk']&#125;</span></span><br><span class="line"></span><br><span class="line">data = &#123;&#125;</span><br><span class="line">key = <span class="string">'foo'</span></span><br><span class="line">value = []</span><br><span class="line">data.setdefault(key, value)</span><br><span class="line">print(<span class="string">'Before:'</span>, data)  <span class="comment"># Before: &#123;'foo': []&#125;</span></span><br><span class="line">value.append(<span class="string">'hello'</span>)</span><br><span class="line">print(<span class="string">'After: '</span>, data)  <span class="comment"># After:  &#123;'foo': ['hello']&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault"><a href="#17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault" class="headerlink" title="17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault"></a>17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Visits</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, country, city)</span>:</span></span><br><span class="line">        city_set = self.data.setdefault(country, set())</span><br><span class="line">        city_set.add(city)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">visits = Visits()</span><br><span class="line">visits.add(<span class="string">'Russia'</span>, <span class="string">'Yekaterinburg'</span>)</span><br><span class="line">visits.add(<span class="string">'Tanzania'</span>, <span class="string">'Zanzibar'</span>)</span><br><span class="line">print(visits.data)  <span class="comment"># &#123;'Russia': &#123;'Yekaterinburg'&#125;, 'Tanzania': &#123;'Zanzibar'&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'-----------------------------'</span>)</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict  <span class="comment"># 推荐</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Visits</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data = defaultdict(set)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, country, city)</span>:</span></span><br><span class="line">        self.data[country].add(city)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">visits = Visits()</span><br><span class="line">visits.add(<span class="string">'England'</span>, <span class="string">'Bath'</span>)</span><br><span class="line">visits.add(<span class="string">'England'</span>, <span class="string">'London'</span>)</span><br><span class="line">print(visits.data)  <span class="comment"># defaultdict(&lt;class 'set'&gt;, &#123;'England': &#123;'Bath'&#125;, 'England1': &#123;'London'&#125;&#125;)</span></span><br></pre></td></tr></table></figure>
<h3 id="18-学会利用missing构造依赖键的默认值"><a href="#18-学会利用missing构造依赖键的默认值" class="headerlink" title="18. 学会利用missing构造依赖键的默认值"></a>18. 学会利用<strong>missing</strong>构造依赖键的默认值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">path = <span class="string">'account_9090.csv'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">b'image data here 9090'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_picture</span><span class="params">(profile_path)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> open(profile_path, <span class="string">'a+b'</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError:</span><br><span class="line">        print(<span class="string">f'Failed to open path <span class="subst">&#123;profile_path&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pictures</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__missing__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        value = open_picture(key)</span><br><span class="line">        self[key] = value</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">pictures = Pictures()</span><br><span class="line">handle = pictures[path]</span><br><span class="line">handle.seek(<span class="number">0</span>)</span><br><span class="line">image_data = handle.read()</span><br><span class="line">print(pictures)</span><br><span class="line">print(image_data)</span><br></pre></td></tr></table></figure>
<h3 id="19-不要把函数返回的多个数值拆分到三个以上的变量中"><a href="#19-不要把函数返回的多个数值拆分到三个以上的变量中" class="headerlink" title="19. 不要把函数返回的多个数值拆分到三个以上的变量中"></a>19. 不要把函数返回的多个数值拆分到三个以上的变量中</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_stats</span><span class="params">(numbers)</span>:</span></span><br><span class="line">    minimum = min(numbers)</span><br><span class="line">    maximum = max(numbers)</span><br><span class="line">    <span class="keyword">return</span> minimum, maximum</span><br><span class="line"></span><br><span class="line">lengths = [<span class="number">63</span>, <span class="number">73</span>, <span class="number">72</span>, <span class="number">60</span>, <span class="number">67</span>, <span class="number">66</span>, <span class="number">71</span>, <span class="number">61</span>, <span class="number">72</span>, <span class="number">70</span>]</span><br><span class="line"></span><br><span class="line">minimum, maximum = get_stats(lengths)  <span class="comment"># Two return values</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">f'Min: <span class="subst">&#123;minimum&#125;</span>, Max: <span class="subst">&#123;maximum&#125;</span>'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="三-函数"><a href="#三-函数" class="headerlink" title="三. 函数"></a>三. 函数</h2><h3 id="20-遇到意外状况时应该抛出异常，不要返回None"><a href="#20-遇到意外状况时应该抛出异常，不要返回None" class="headerlink" title="20. 遇到意外状况时应该抛出异常，不要返回None"></a>20. 遇到意外状况时应该抛出异常，不要返回None</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">careful_divide</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> a / b</span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> careful_divide(<span class="number">4</span>, <span class="number">2</span>) == <span class="number">2</span></span><br><span class="line"><span class="keyword">assert</span> careful_divide(<span class="number">0</span>, <span class="number">1</span>) == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> careful_divide(<span class="number">3</span>, <span class="number">6</span>) == <span class="number">0.5</span></span><br><span class="line"><span class="keyword">assert</span> careful_divide(<span class="number">1</span>, <span class="number">0</span>) == <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">careful_divide</span><span class="params">(a: float, b: float)</span> -&gt; float:</span></span><br><span class="line">    <span class="string">"""Divides a by b.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        ValueError: When the inputs cannot be divided.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> a / b</span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f'result: <span class="subst">&#123;e&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f'Invalid inputs: <span class="subst">&#123;e&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    result = careful_divide(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    print(<span class="string">f'result:'</span>)</span><br><span class="line">    <span class="keyword">pass</span>  <span class="comment"># Expected</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> careful_divide(<span class="number">1</span>, <span class="number">5</span>) == <span class="number">0.2</span></span><br></pre></td></tr></table></figure>
<h3 id="21-了解如何在闭包里面使用外围作用域中的变量"><a href="#21-了解如何在闭包里面使用外围作用域中的变量" class="headerlink" title="21. 了解如何在闭包里面使用外围作用域中的变量"></a>21. 了解如何在闭包里面使用外围作用域中的变量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sort_priority3</span><span class="params">(numbers, group)</span>:</span></span><br><span class="line">    found = <span class="literal">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">helper</span><span class="params">(x)</span>:</span></span><br><span class="line">        <span class="comment"># 把闭包里面的数据赋值给闭包外面的变量</span></span><br><span class="line">        <span class="keyword">nonlocal</span> found  <span class="comment"># Added</span></span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> group:</span><br><span class="line">            found = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="number">0</span>, x)</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1</span>, x)</span><br><span class="line">    numbers.sort(key=helper)</span><br><span class="line">    <span class="keyword">return</span> found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">numbers = [<span class="number">8</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>]</span><br><span class="line">group = &#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>&#125;</span><br><span class="line">found = sort_priority3(numbers, group)</span><br><span class="line"><span class="keyword">assert</span> found</span><br><span class="line"><span class="keyword">assert</span> numbers == [<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="string">'--------------下面是用辅助类来封装状态'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sorter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, group)</span>:</span></span><br><span class="line">        self.group = group</span><br><span class="line">        self.found = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> self.group:</span><br><span class="line">            self.found = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="number">0</span>, x)</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">1</span>, x)</span><br><span class="line"></span><br><span class="line">sorter = Sorter(group)</span><br><span class="line">numbers.sort(key=sorter)</span><br><span class="line"><span class="keyword">assert</span> sorter.found <span class="keyword">is</span> <span class="literal">True</span></span><br><span class="line"><span class="keyword">assert</span> numbers == [<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<h3 id="22-用数量可变的位置参数给函数设计清晰的参数列表"><a href="#22-用数量可变的位置参数给函数设计清晰的参数列表" class="headerlink" title="22. 用数量可变的位置参数给函数设计清晰的参数列表"></a>22. 用数量可变的位置参数给函数设计清晰的参数列表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(message, *values)</span>:</span>  <span class="comment"># The only difference</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> values:</span><br><span class="line">        print(message)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        values_str = <span class="string">', '</span>.join(str(x) <span class="keyword">for</span> x <span class="keyword">in</span> values)</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;message&#125;</span>: <span class="subst">&#123;values_str&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">log(<span class="string">'My numbers are'</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">log(<span class="string">'Hi there'</span>)  <span class="comment"># Much better</span></span><br></pre></td></tr></table></figure>
<h3 id="23-用关键字参数来表示可选的行为"><a href="#23-用关键字参数来表示可选的行为" class="headerlink" title="23. 用关键字参数来表示可选的行为"></a>23. 用关键字参数来表示可选的行为</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flow_rate</span><span class="params">(weight_diff, time_diff, period=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""流速：每秒的千克数"""</span></span><br><span class="line">    <span class="keyword">return</span> (weight_diff / time_diff) * period</span><br><span class="line"></span><br><span class="line">weight_diff = <span class="number">0.5</span></span><br><span class="line">time_diff = <span class="number">3</span></span><br><span class="line">flow = flow_rate(weight_diff, time_diff, period=<span class="number">2</span>)</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;flow:<span class="number">.3</span>&#125;</span> kg per second'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="24-用None和docstring来描述默认值会变的参数"><a href="#24-用None和docstring来描述默认值会变的参数" class="headerlink" title="24. 用None和docstring来描述默认值会变的参数"></a>24. 用None和docstring来描述默认值会变的参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(message, when=None)</span>:</span></span><br><span class="line">    <span class="string">"""Log a message with a timestamp.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        message: Message to print.</span></span><br><span class="line"><span class="string">        when: datetime of when the message occurred.</span></span><br><span class="line"><span class="string">            Defaults to the present time.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> when <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        when = datetime.now()</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;when&#125;</span>: <span class="subst">&#123;message&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example </span></span><br><span class="line">log(<span class="string">'Hi there!'</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">log(<span class="string">'Hello again!'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span><span class="params">(data, default=None)</span>:</span></span><br><span class="line">    <span class="string">"""Load JSON data from a string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        data: JSON data to decode.</span></span><br><span class="line"><span class="string">        default: Value to return if decoding fails.</span></span><br><span class="line"><span class="string">            Defaults to an empty dictionary.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> json.loads(data)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">if</span> default <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            default = &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo = decode(<span class="string">'bad data'</span>)</span><br><span class="line">foo[<span class="string">'stuff'</span>] = <span class="number">5</span></span><br><span class="line">bar = decode(<span class="string">'also bad'</span>)</span><br><span class="line">bar[<span class="string">'meep'</span>] = <span class="number">1</span></span><br><span class="line">print(<span class="string">'Foo:'</span>, foo)</span><br><span class="line">print(<span class="string">'Bar:'</span>, bar)</span><br><span class="line"><span class="keyword">assert</span> foo <span class="keyword">is</span> <span class="keyword">not</span> bar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_typed</span><span class="params">(message: str, when: Optional[datetime] = None)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="string">"""Log a message with a timestamp.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        message: Message to print.</span></span><br><span class="line"><span class="string">        when: datetime of when the message occurred.</span></span><br><span class="line"><span class="string">            Defaults to the present time.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> when <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        when = datetime.now()</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;when&#125;</span>: <span class="subst">&#123;message&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">log_typed(<span class="string">'Hi there!'</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">log_typed(<span class="string">'Hello again!'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表"><a href="#25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表" class="headerlink" title="25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表"></a>25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">safe_division_e</span><span class="params">(numerator, denominator,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ndigits=<span class="number">10</span>, *,                # Changed</span></span></span><br><span class="line"><span class="function"><span class="params">                    ignore_overflow=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ignore_zero_division=False)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        fraction = numerator / denominator        <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">return</span> round(fraction, ndigits)           <span class="comment"># Changed</span></span><br><span class="line">    <span class="keyword">except</span> OverflowError:</span><br><span class="line">        <span class="keyword">if</span> ignore_overflow:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">        <span class="keyword">if</span> ignore_zero_division:</span><br><span class="line">            <span class="keyword">return</span> float(<span class="string">'inf'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">result = safe_division_e(<span class="number">22</span>, <span class="number">7</span>)</span><br><span class="line">print(result)  <span class="comment"># 3.1428571429</span></span><br><span class="line"></span><br><span class="line">result = safe_division_e(<span class="number">22</span>, <span class="number">7</span>, <span class="number">5</span>)</span><br><span class="line">print(result)  <span class="comment"># 3.14286</span></span><br><span class="line"></span><br><span class="line">result = safe_division_e(<span class="number">22</span>, <span class="number">7</span>, ndigits=<span class="number">2</span>)</span><br><span class="line">print(result)  <span class="comment"># 3.14</span></span><br></pre></td></tr></table></figure>
<h3 id="26-用functools-wraps定义函数修饰器"><a href="#26-用functools-wraps定义函数修饰器" class="headerlink" title="26. 用functools.wraps定义函数修饰器"></a>26. 用functools.wraps定义函数修饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;func.__name__&#125;</span>(<span class="subst">&#123;args!r&#125;</span>, <span class="subst">&#123;kwargs!r&#125;</span>) '</span></span><br><span class="line">              <span class="string">f'-&gt; <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@trace</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fibonacci</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="string">"""Return the n-th Fibonacci number"""</span></span><br><span class="line">    <span class="keyword">if</span> n <span class="keyword">in</span> (<span class="number">0</span>, <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    <span class="keyword">return</span> fibonacci(n - <span class="number">2</span>) + fibonacci(n - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">help(fibonacci)</span><br><span class="line">print(pickle.dumps(fibonacci))</span><br></pre></td></tr></table></figure>
<h2 id="四-推导与生成"><a href="#四-推导与生成" class="headerlink" title="四. 推导与生成"></a>四. 推导与生成</h2><h3 id="27-用列表推导取代map与filter"><a href="#27-用列表推导取代map与filter" class="headerlink" title="27. 用列表推导取代map与filter"></a>27. 用列表推导取代map与filter</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a = range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">even_squares = [x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> a <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]</span><br><span class="line">print(even_squares)</span><br><span class="line"></span><br><span class="line">alt = map(<span class="keyword">lambda</span> x: x**<span class="number">2</span>, filter(<span class="keyword">lambda</span> x: x % <span class="number">2</span> == <span class="number">0</span>, a))</span><br><span class="line"><span class="keyword">assert</span> even_squares == list(alt)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典推导</span></span><br><span class="line">even_squares_dict = &#123;x: x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> a <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>&#125;</span><br><span class="line">threes_cubed_set = &#123;x**<span class="number">3</span> <span class="keyword">for</span> x <span class="keyword">in</span> a <span class="keyword">if</span> x % <span class="number">3</span> == <span class="number">0</span>&#125;</span><br><span class="line">print(even_squares_dict)</span><br><span class="line">print(threes_cubed_set)</span><br></pre></td></tr></table></figure>
<h3 id="28-控制推导逻辑的子表达式不要超过两个"><a href="#28-控制推导逻辑的子表达式不要超过两个" class="headerlink" title="28. 控制推导逻辑的子表达式不要超过两个"></a>28. 控制推导逻辑的子表达式不要超过两个</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">matrix = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]]</span><br><span class="line">flat = [x <span class="keyword">for</span> row <span class="keyword">in</span> matrix <span class="keyword">for</span> x <span class="keyword">in</span> row]</span><br><span class="line">print(flat)</span><br><span class="line"></span><br><span class="line">squared = [[x**<span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> row] <span class="keyword">for</span> row <span class="keyword">in</span> matrix]</span><br><span class="line">print(squared)</span><br></pre></td></tr></table></figure>
<h3 id="29-用赋值表达式消除推导中的重复代码"><a href="#29-用赋值表达式消除推导中的重复代码" class="headerlink" title="29. 用赋值表达式消除推导中的重复代码"></a>29. 用赋值表达式消除推导中的重复代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stock = &#123;</span><br><span class="line">    <span class="string">'nails'</span>: <span class="number">125</span>,</span><br><span class="line">    <span class="string">'screws'</span>: <span class="number">35</span>,</span><br><span class="line">    <span class="string">'wingnuts'</span>: <span class="number">8</span>,</span><br><span class="line">    <span class="string">'washers'</span>: <span class="number">24</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">order = [<span class="string">'screws'</span>, <span class="string">'wingnuts'</span>, <span class="string">'clips'</span>]</span><br><span class="line">found = ((name, batches) <span class="keyword">for</span> name <span class="keyword">in</span> order</span><br><span class="line">         <span class="keyword">if</span> (batches := get_batches(stock.get(name, <span class="number">0</span>), <span class="number">8</span>)))</span><br><span class="line">print(next(found))</span><br><span class="line">print(next(found))</span><br></pre></td></tr></table></figure>
<h3 id="30-不要让函数直接返回列表，应该让它逐个生成列表里的值"><a href="#30-不要让函数直接返回列表，应该让它逐个生成列表里的值" class="headerlink" title="30. 不要让函数直接返回列表，应该让它逐个生成列表里的值"></a>30. 不要让函数直接返回列表，应该让它逐个生成列表里的值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">address_lines = <span class="string">"""Four score and seven years</span></span><br><span class="line"><span class="string">ago our fathers brought forth on this</span></span><br><span class="line"><span class="string">continent a new nation, conceived in liberty,</span></span><br><span class="line"><span class="string">and dedicated to the proposition that all men</span></span><br><span class="line"><span class="string">are created equal."""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'address.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(address_lines)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'address.txt'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    it = index_file(f)</span><br><span class="line">    results = itertools.islice(it, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    print(list(results))</span><br></pre></td></tr></table></figure>
<h3 id="31-谨慎地迭代函数所收到的参数"><a href="#31-谨慎地迭代函数所收到的参数" class="headerlink" title="31. 谨慎地迭代函数所收到的参数"></a>31. 谨慎地迭代函数所收到的参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalize_defensive</span><span class="params">(numbers)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(numbers, Iterator):  <span class="comment"># Another way to check</span></span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Must supply a container'</span>)</span><br><span class="line">    total = sum(numbers)</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> numbers:</span><br><span class="line">        percent = <span class="number">100</span> * value / total</span><br><span class="line">        result.append(percent)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">visits = [<span class="number">15</span>, <span class="number">35</span>, <span class="number">80</span>]</span><br><span class="line">result = normalize_defensive(visits)  <span class="comment"># No error</span></span><br><span class="line">print(result, type(result))</span><br><span class="line"></span><br><span class="line">it = iter(visits)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    normalize_defensive(it)</span><br><span class="line"><span class="keyword">except</span> TypeError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="32-考虑用生成器表达式改写数据量较大的列表推导"><a href="#32-考虑用生成器表达式改写数据量较大的列表推导" class="headerlink" title="32. 考虑用生成器表达式改写数据量较大的列表推导"></a>32. 考虑用生成器表达式改写数据量较大的列表推导</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'my_file.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        f.write(<span class="string">'a'</span> * random.randint(<span class="number">0</span>, <span class="number">100</span>))</span><br><span class="line">        f.write(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">value = [len(x) <span class="keyword">for</span> x <span class="keyword">in</span> open(<span class="string">'my_file.txt'</span>)]</span><br><span class="line">print(value)</span><br><span class="line"></span><br><span class="line">it = (len(x) <span class="keyword">for</span> x <span class="keyword">in</span> open(<span class="string">'my_file.txt'</span>))</span><br><span class="line">print(it)</span><br><span class="line"></span><br><span class="line">print(next(it))</span><br><span class="line">print(next(it))</span><br><span class="line"></span><br><span class="line">roots = ((x, x**<span class="number">0.5</span>) <span class="keyword">for</span> x <span class="keyword">in</span> it)</span><br><span class="line">print(next(roots))</span><br></pre></td></tr></table></figure>
<h3 id="33-通过yield-from把多个生成器连起来用"><a href="#33-通过yield-from把多个生成器连起来用" class="headerlink" title="33. 通过yield from把多个生成器连起来用"></a>33. 通过yield from把多个生成器连起来用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">child</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>_000_000):</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> child():</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fast</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> child()</span><br><span class="line"></span><br><span class="line">baseline = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'for _ in slow(): pass'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">50</span>)</span><br><span class="line">print(<span class="string">f'Manual nesting <span class="subst">&#123;baseline:<span class="number">.2</span>f&#125;</span>s'</span>)</span><br><span class="line"></span><br><span class="line">comparison = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'for _ in fast(): pass'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">50</span>)</span><br><span class="line">print(<span class="string">f'Composed nesting <span class="subst">&#123;comparison:<span class="number">.2</span>f&#125;</span>s'</span>)</span><br><span class="line"></span><br><span class="line">reduction = -(comparison - baseline) / baseline</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;reduction:<span class="number">.1</span>%&#125;</span> less time'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="34-不要用send给生成器注入数据"><a href="#34-不要用send给生成器注入数据" class="headerlink" title="34. 不要用send给生成器注入数据"></a>34. 不要用send给生成器注入数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wave_cascading</span><span class="params">(amplitude_it, steps)</span>:</span></span><br><span class="line">    step_size = <span class="number">2</span> * math.pi / steps</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(steps):</span><br><span class="line">        radians = step * step_size</span><br><span class="line">        fraction = math.sin(radians)</span><br><span class="line">        amplitude = next(amplitude_it)  <span class="comment"># Get next input</span></span><br><span class="line">        output = amplitude * fraction</span><br><span class="line">        <span class="keyword">yield</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">complex_wave_cascading</span><span class="params">(amplitude_it)</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> wave_cascading(amplitude_it, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> wave_cascading(amplitude_it, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> wave_cascading(amplitude_it, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_cascading</span><span class="params">()</span>:</span></span><br><span class="line">    amplitudes = [<span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>]</span><br><span class="line">    it = complex_wave_cascading(iter(amplitudes))</span><br><span class="line">    <span class="keyword">for</span> amplitude <span class="keyword">in</span> amplitudes:</span><br><span class="line">        output = next(it)</span><br><span class="line">        <span class="keyword">if</span> output <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            print(<span class="string">f'Output is None'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">f'Output: <span class="subst">&#123;output:&gt;<span class="number">5.1</span>f&#125;</span>   <span class="subst">&#123;amplitude&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run_cascading()</span><br></pre></td></tr></table></figure>
<h3 id="35-不要通过throw变换生成器的状态"><a href="#35-不要通过throw变换生成器的状态" class="headerlink" title="35. 不要通过throw变换生成器的状态"></a>35. 不要通过throw变换生成器的状态</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">RESETS = [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Timer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, period)</span>:</span></span><br><span class="line">        self.current = period</span><br><span class="line">        self.period = period</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reset</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.current = self.period</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> self.current:</span><br><span class="line">            self.current -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">yield</span> self.current</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    timer = Timer(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> current <span class="keyword">in</span> timer:</span><br><span class="line">        <span class="keyword">if</span> RESETS.pop(<span class="number">0</span>):</span><br><span class="line">            timer.reset()</span><br><span class="line">        print(<span class="string">f'<span class="subst">&#123;current&#125;</span> ticks remaining'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run()</span><br></pre></td></tr></table></figure>
<h3 id="36-考虑用itertools拼装迭代器与生成器"><a href="#36-考虑用itertools拼装迭代器与生成器" class="headerlink" title="36. 考虑用itertools拼装迭代器与生成器"></a>36. 考虑用itertools拼装迭代器与生成器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">print(<span class="string">'------- 一. 连接多个迭代器'</span>)</span><br><span class="line"><span class="comment"># chain: 把多个迭代器从头到尾连成一个迭代器</span></span><br><span class="line">it = itertools.chain([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line">print(list(it))  <span class="comment"># [1, 2, 3, 4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># repeat:  不停的输出某个值</span></span><br><span class="line">it = itertools.repeat(<span class="string">'hello'</span>, <span class="number">3</span>)</span><br><span class="line">print(list(it))  <span class="comment"># ['hello', 'hello', 'hello']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># cycle: 循环的输出某段内容之间的元素</span></span><br><span class="line">it = itertools.cycle([<span class="number">1</span>, <span class="number">2</span>])</span><br><span class="line">result = [next(it) <span class="keyword">for</span> _ <span class="keyword">in</span> range (<span class="number">10</span>)]</span><br><span class="line">print(result)  <span class="comment"># [1, 2, 1, 2, 1, 2, 1, 2, 1, 2]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># tee: 让一个迭代器分裂成多个平行的迭代器</span></span><br><span class="line">it1, it2, it3 = itertools.tee([<span class="string">'first'</span>, <span class="string">'second'</span>], <span class="number">3</span>)</span><br><span class="line">print(list(it1))  <span class="comment"># ['first', 'second']</span></span><br><span class="line">print(list(it2))  <span class="comment"># ['first', 'second']</span></span><br><span class="line">print(list(it3))  <span class="comment"># ['first', 'second']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># zip_longest： 和zip函数类似，但会用默认值填充</span></span><br><span class="line">keys = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>]</span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">normal = list(zip(keys, values))</span><br><span class="line">print(<span class="string">'zip:        '</span>, normal)  <span class="comment"># zip:         [('one', 1), ('two', 2)]</span></span><br><span class="line"></span><br><span class="line">it = itertools.zip_longest(keys, values, fillvalue=<span class="string">'nope'</span>)</span><br><span class="line">longest = list(it)</span><br><span class="line">print(<span class="string">'zip_longest:'</span>, longest)  <span class="comment"># zip_longest: [('one', 1), ('two', 2), ('three', 'nope')]</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'------- 二. 过滤源迭代器中的元素'</span>)</span><br><span class="line"><span class="comment"># islice： 按照下标切割源迭代器</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">first_five = itertools.islice(values, <span class="number">5</span>)</span><br><span class="line">print(<span class="string">'First five: '</span>, list(first_five))  <span class="comment"># First five:  [1, 2, 3, 4, 5]</span></span><br><span class="line"></span><br><span class="line">middle_odds = itertools.islice(values, <span class="number">2</span>, <span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Middle odds:'</span>, list(middle_odds))  <span class="comment"># Middle odds: [3, 5, 7]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># takewhile: 一直从源迭代器里获取元素，直到返回false</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line">less_than_seven = <span class="keyword">lambda</span> x: x &lt; <span class="number">7</span></span><br><span class="line">it = itertools.takewhile(less_than_seven, values)</span><br><span class="line">print(list(it))  <span class="comment"># [1, 2, 3, 4, 5, 6]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># dropwhile: 一直跳过序列中的元素，直到返回true</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line">less_than_seven = <span class="keyword">lambda</span> x: x &lt; <span class="number">7</span></span><br><span class="line">it = itertools.dropwhile(less_than_seven, values)</span><br><span class="line">print(list(it))  <span class="comment"># [7, 8, 9, 10]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># filterfalse: 与内置的filter函数相反，输出false的那些元素</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line">evens = <span class="keyword">lambda</span> x: x % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">filter_result = filter(evens, values)</span><br><span class="line">print(<span class="string">'Filter:      '</span>, list(filter_result))  <span class="comment"># Filter:       [2, 4, 6, 8, 10]</span></span><br><span class="line"></span><br><span class="line">filter_false_result = itertools.filterfalse(evens, values)</span><br><span class="line">print(<span class="string">'Filter false:'</span>, list(filter_false_result))  <span class="comment"># Filter false: [1, 3, 5, 7, 9]</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'------- 三. 从源迭代器中的元素合成新的元素'</span>)</span><br><span class="line"><span class="comment"># accumulate： 从源迭代器中取出一个元素进行累加，和functools模块中的reduce函数其实是一样的</span></span><br><span class="line">values = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br><span class="line">sum_reduce = itertools.accumulate(values)</span><br><span class="line">print(<span class="string">'Sum:   '</span>, list(sum_reduce))  <span class="comment"># Sum:    [1, 3, 6, 10, 15, 21, 28, 36, 45, 55]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_modulo_20</span><span class="params">(first, second)</span>:</span></span><br><span class="line">    output = first + second</span><br><span class="line">    <span class="keyword">return</span> output % <span class="number">20</span></span><br><span class="line"></span><br><span class="line">modulo_reduce = itertools.accumulate(values, sum_modulo_20)</span><br><span class="line">print(<span class="string">'Modulo:'</span>, list(modulo_reduce))  <span class="comment"># Modulo: [1, 3, 6, 10, 15, 1, 8, 16, 5, 15]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># product： 从一个或多个源迭代器中获取元素，并计算笛卡尔积</span></span><br><span class="line">single = itertools.product([<span class="number">1</span>, <span class="number">2</span>], repeat=<span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Single:  '</span>, list(single))  <span class="comment"># Single:   [(1, 1), (1, 2), (2, 1), (2, 2)]</span></span><br><span class="line"></span><br><span class="line">multiple = itertools.product([<span class="number">1</span>, <span class="number">2</span>], [<span class="string">'a'</span>, <span class="string">'b'</span>])</span><br><span class="line">print(<span class="string">'Multiple:'</span>, list(multiple))  <span class="comment"># Multiple: [(1, 'a'), (1, 'b'), (2, 'a'), (2, 'b')]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># permutations： 输出迭代器中n个元素形成的每种 有序排列</span></span><br><span class="line">it = itertools.permutations([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="number">2</span>)</span><br><span class="line">print(<span class="string">f'permutations: <span class="subst">&#123;list(it)&#125;</span>'</span>)  <span class="comment"># permutations: [(1, 2), (1, 3), (2, 1), (2, 3), (3, 1), (3, 2)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># combinations： 输出迭代器中n个元素形成的每种 无序组合</span></span><br><span class="line">it = itertools.combinations([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], <span class="number">2</span>)</span><br><span class="line">print(list(it))  <span class="comment"># [(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># combinations_with_replacement：允许同一个元素在组合里多次出现</span></span><br><span class="line">it = itertools.combinations_with_replacement([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="number">2</span>)</span><br><span class="line">print(list(it))  <span class="comment"># [(1, 1), (1, 2), (1, 3), (2, 2), (2, 3), (3, 3)]</span></span><br></pre></td></tr></table></figure>
<h2 id="五-类与接口"><a href="#五-类与接口" class="headerlink" title="五. 类与接口"></a>五. 类与接口</h2><h3 id="37-用组合起来的类来实现多层结构，不要用嵌套的内置类型"><a href="#37-用组合起来的类来实现多层结构，不要用嵌套的内置类型" class="headerlink" title="37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型"></a>37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"></span><br><span class="line">Grade = namedtuple(<span class="string">'Grade'</span>, (<span class="string">'score'</span>, <span class="string">'weight'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._grades = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">report_grade</span><span class="params">(self, score, weight)</span>:</span></span><br><span class="line">        self._grades.append(Grade(score, weight))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">average_grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        total, total_weight = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> grade <span class="keyword">in</span> self._grades:</span><br><span class="line">            total += grade.score * grade.weight</span><br><span class="line">            total_weight += grade.weight</span><br><span class="line">        <span class="keyword">return</span> total / total_weight</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._subjects = defaultdict(Subject)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_subject</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._subjects[name]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">average_grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        total, count = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> subject <span class="keyword">in</span> self._subjects.values():</span><br><span class="line">            total += subject.average_grade()</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> total / count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gradebook</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._students = defaultdict(Student)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_student</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._students[name]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">book = Gradebook()</span><br><span class="line">albert = book.get_student(<span class="string">'Albert Einstein'</span>)</span><br><span class="line">math = albert.get_subject(<span class="string">'Math'</span>)</span><br><span class="line">math.report_grade(<span class="number">75</span>, <span class="number">0.05</span>)</span><br><span class="line">math.report_grade(<span class="number">65</span>, <span class="number">0.15</span>)</span><br><span class="line">math.report_grade(<span class="number">70</span>, <span class="number">0.80</span>)</span><br><span class="line">gym = albert.get_subject(<span class="string">'Gym'</span>)</span><br><span class="line">gym.report_grade(<span class="number">100</span>, <span class="number">0.40</span>)</span><br><span class="line">gym.report_grade(<span class="number">85</span>, <span class="number">0.60</span>)</span><br><span class="line">print(albert.average_grade())</span><br></pre></td></tr></table></figure>
<h3 id="38-让简单的接口接受函数，而不是类的实例"><a href="#38-让简单的接口接受函数，而不是类的实例" class="headerlink" title="38. 让简单的接口接受函数，而不是类的实例"></a>38. 让简单的接口接受函数，而不是类的实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">names = [<span class="string">'Socrates'</span>, <span class="string">'Archimedes'</span>, <span class="string">'Plato'</span>, <span class="string">'Aristotle'</span>]</span><br><span class="line">names.sort(key=len)</span><br><span class="line">print(names)  <span class="comment"># ['Plato', 'Socrates', 'Aristotle', 'Archimedes']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_missing</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Key added'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">current = &#123;<span class="string">'green'</span>: <span class="number">12</span>, <span class="string">'blue'</span>: <span class="number">3</span>&#125;</span><br><span class="line">increments = [</span><br><span class="line">    (<span class="string">'red'</span>, <span class="number">5</span>),</span><br><span class="line">    (<span class="string">'blue'</span>, <span class="number">17</span>),</span><br><span class="line">    (<span class="string">'orange'</span>, <span class="number">9</span>),</span><br><span class="line">]</span><br><span class="line">result = defaultdict(log_missing, current)</span><br><span class="line">print(<span class="string">'Before:'</span>, dict(result))  <span class="comment"># Before: &#123;'green': 12, 'blue': 3&#125;</span></span><br><span class="line"><span class="keyword">for</span> key, amount <span class="keyword">in</span> increments:</span><br><span class="line">    result[key] += amount</span><br><span class="line">print(<span class="string">'After: '</span>, dict(result))  <span class="comment"># After:  &#123;'green': 12, 'blue': 20, 'red': 5, 'orange': 9&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">increment_with_report</span><span class="params">(current, increments)</span>:</span></span><br><span class="line">    added_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">missing</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">nonlocal</span> added_count  <span class="comment"># Stateful closure</span></span><br><span class="line">        added_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    result = defaultdict(missing, current)</span><br><span class="line">    <span class="keyword">for</span> key, amount <span class="keyword">in</span> increments:</span><br><span class="line">        result[key] += amount</span><br><span class="line">    <span class="keyword">return</span> result, added_count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">result, count = increment_with_report(current, increments)</span><br><span class="line"><span class="keyword">assert</span> count == <span class="number">2</span></span><br><span class="line">print(result)  <span class="comment"># defaultdict(&lt;function increment_with_report.&lt;locals&gt;.missing at 0x7faa53a46ef0&gt;, &#123;'green': 12, 'blue': 20, 'red': 5, 'orange': 9&#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountMissing</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.added = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">missing</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.added += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">counter = CountMissing()</span><br><span class="line">result = defaultdict(counter.missing, current)  <span class="comment"># Method ref</span></span><br><span class="line"><span class="keyword">for</span> key, amount <span class="keyword">in</span> increments:</span><br><span class="line">    result[key] += amount</span><br><span class="line"><span class="keyword">assert</span> counter.added == <span class="number">2</span></span><br><span class="line">print(result)  <span class="comment"># defaultdict(&lt;bound method CountMissing.missing of &lt;__main__.CountMissing object at 0x7faa53ac7810&gt;&gt;, &#123;'green': 12, 'blue': 20, 'red': 5, 'orange': 9&#125;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterCountMissing</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.added = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.added += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">counter = BetterCountMissing()</span><br><span class="line"><span class="keyword">assert</span> counter() == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> callable(counter)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">counter = BetterCountMissing()</span><br><span class="line">result = defaultdict(counter, current)  <span class="comment"># Relies on __call__</span></span><br><span class="line"><span class="keyword">for</span> key, amount <span class="keyword">in</span> increments:</span><br><span class="line">    result[key] += amount</span><br><span class="line"><span class="keyword">assert</span> counter.added == <span class="number">2</span></span><br><span class="line">print(result)  <span class="comment"># defaultdict(&lt;__main__.BetterCountMissing object at 0x7faa53ac7990&gt;, &#123;'green': 12, 'blue': 20, 'red': 5, 'orange': 9&#125;)</span></span><br></pre></td></tr></table></figure>
<h3 id="39-通过-classmethod多态来构造同一体系中的各类对象"><a href="#39-通过-classmethod多态来构造同一体系中的各类对象" class="headerlink" title="39. 通过@classmethod多态来构造同一体系中的各类对象"></a>39. 通过@classmethod多态来构造同一体系中的各类对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InputData</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PathInputData</span><span class="params">(InputData)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.path = path</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.path) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, input_data)</span>:</span></span><br><span class="line">        self.input_data = input_data</span><br><span class="line">        self.result = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineCountWorker</span><span class="params">(Worker)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.input_data.read()</span><br><span class="line">        self.result = data.count(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        self.result += other.result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_inputs</span><span class="params">(data_dir)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> os.listdir(data_dir):</span><br><span class="line">        <span class="keyword">yield</span> PathInputData(os.path.join(data_dir, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_workers</span><span class="params">(input_list)</span>:</span></span><br><span class="line">    workers = []</span><br><span class="line">    <span class="keyword">for</span> input_data <span class="keyword">in</span> input_list:</span><br><span class="line">        workers.append(LineCountWorker(input_data))</span><br><span class="line">    <span class="keyword">return</span> workers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(workers)</span>:</span></span><br><span class="line">    threads = [Thread(target=w.map) <span class="keyword">for</span> w <span class="keyword">in</span> workers]</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads: thread.start()</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads: thread.join()</span><br><span class="line"></span><br><span class="line">    first, *rest = workers</span><br><span class="line">    <span class="keyword">for</span> worker <span class="keyword">in</span> rest:</span><br><span class="line">        first.reduce(worker)</span><br><span class="line">    <span class="keyword">return</span> first.result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mapreduce</span><span class="params">(data_dir)</span>:</span></span><br><span class="line">    inputs = generate_inputs(data_dir)</span><br><span class="line">    workers = create_workers(inputs)</span><br><span class="line">    <span class="keyword">return</span> execute(workers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_test_files</span><span class="params">(tmpdir)</span>:</span></span><br><span class="line">    os.makedirs(tmpdir)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        <span class="keyword">with</span> open(os.path.join(tmpdir, str(i)), <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">'\n'</span> * random.randint(<span class="number">0</span>, <span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">tmpdir = <span class="string">'test_inputs'</span></span><br><span class="line">write_test_files(tmpdir)</span><br><span class="line"></span><br><span class="line">result = mapreduce(tmpdir)</span><br><span class="line">print(<span class="string">f'There are <span class="subst">&#123;result&#125;</span> lines'</span>)  <span class="comment"># There are 4762 lines</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericInputData</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_inputs</span><span class="params">(cls, config)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PathInputData</span><span class="params">(GenericInputData)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.path = path</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.path) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_inputs</span><span class="params">(cls, config)</span>:</span></span><br><span class="line">        data_dir = config[<span class="string">'data_dir'</span>]</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> os.listdir(data_dir):</span><br><span class="line">            <span class="keyword">yield</span> cls(os.path.join(data_dir, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericWorker</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, input_data)</span>:</span></span><br><span class="line">        self.input_data = input_data</span><br><span class="line">        self.result = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_workers</span><span class="params">(cls, input_class, config)</span>:</span></span><br><span class="line">        workers = []</span><br><span class="line">        <span class="keyword">for</span> input_data <span class="keyword">in</span> input_class.generate_inputs(config):</span><br><span class="line">            workers.append(cls(input_data))</span><br><span class="line">        <span class="keyword">return</span> workers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LineCountWorker</span><span class="params">(GenericWorker)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">map</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = self.input_data.read()</span><br><span class="line">        self.result = data.count(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reduce</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        self.result += other.result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mapreduce</span><span class="params">(worker_class, input_class, config)</span>:</span></span><br><span class="line">    workers = worker_class.create_workers(input_class, config)</span><br><span class="line">    <span class="keyword">return</span> execute(workers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line">config = &#123;<span class="string">'data_dir'</span>: tmpdir&#125;</span><br><span class="line">result = mapreduce(LineCountWorker, PathInputData, config)</span><br><span class="line">print(<span class="string">f'There are <span class="subst">&#123;result&#125;</span> lines'</span>)  <span class="comment"># There are 4762 lines</span></span><br></pre></td></tr></table></figure>
<h3 id="40-通过super初始化超类"><a href="#40-通过super初始化超类" class="headerlink" title="40. 通过super初始化超类"></a>40. 通过super初始化超类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBaseClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyChildClass</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        MyBaseClass.__init__(self, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">times_two</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.value * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">foo = MyChildClass()</span><br><span class="line"><span class="keyword">assert</span> foo.times_two() == <span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimesTwo</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.value *= <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlusFive</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.value += <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OneWay</span><span class="params">(MyBaseClass, TimesTwo, PlusFive)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        MyBaseClass.__init__(self, value)</span><br><span class="line">        TimesTwo.__init__(self)</span><br><span class="line">        PlusFive.__init__(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">foo = OneWay(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'First ordering value is (5 * 2) + 5 ='</span>, foo.value)  <span class="comment"># First ordering value is (5 * 2) + 5 = 15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnotherWay</span><span class="params">(MyBaseClass, PlusFive, TimesTwo)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        MyBaseClass.__init__(self, value)</span><br><span class="line">        TimesTwo.__init__(self)</span><br><span class="line">        PlusFive.__init__(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">bar = AnotherWay(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'Second ordering value is'</span>, bar.value)  <span class="comment"># Second ordering value is 15</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimesSeven</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        MyBaseClass.__init__(self, value)</span><br><span class="line">        self.value *= <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlusNine</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        MyBaseClass.__init__(self, value)</span><br><span class="line">        self.value += <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThisWay</span><span class="params">(TimesSeven, PlusNine)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        TimesSeven.__init__(self, value)</span><br><span class="line">        PlusNine.__init__(self, value)</span><br><span class="line"></span><br><span class="line">foo = ThisWay(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'Should be (5 * 7) + 9 = 44 but is'</span>, foo.value)  <span class="comment"># Should be (5 * 7) + 9 = 44 but is 14</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBaseClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimesSevenCorrect</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super().__init__(value)</span><br><span class="line">        self.value *= <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlusNineCorrect</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super().__init__(value)</span><br><span class="line">        self.value += <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GoodWay</span><span class="params">(TimesSevenCorrect, PlusNineCorrect)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super().__init__(value)</span><br><span class="line"></span><br><span class="line">foo = GoodWay(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'Should be 7 * (5 + 9) = 98 and is'</span>, foo.value)  <span class="comment"># Should be 7 * (5 + 9) = 98 and is 98</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line">mro_str = <span class="string">'\n'</span>.join(repr(cls) <span class="keyword">for</span> cls <span class="keyword">in</span> GoodWay.mro())</span><br><span class="line">print(<span class="string">f'mro_str: <span class="subst">&#123;mro_str&#125;</span>'</span>)  <span class="comment"># &lt;class '__main__.GoodWay'&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExplicitTrisect</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super(ExplicitTrisect, self).__init__(value)</span><br><span class="line">        self.value /= <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> ExplicitTrisect(<span class="number">9</span>).value == <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AutomaticTrisect</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super(__class__, self).__init__(value)</span><br><span class="line">        self.value /= <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImplicitTrisect</span><span class="params">(MyBaseClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        super().__init__(value)</span><br><span class="line">        self.value /= <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> ExplicitTrisect(<span class="number">9</span>).value == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> AutomaticTrisect(<span class="number">9</span>).value == <span class="number">3</span></span><br><span class="line"><span class="keyword">assert</span> ImplicitTrisect(<span class="number">9</span>).value == <span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="41-考虑用mix-in类来表示可组合的功能"><a href="#41-考虑用mix-in类来表示可组合的功能" class="headerlink" title="41. 考虑用mix-in类来表示可组合的功能"></a>41. 考虑用mix-in类来表示可组合的功能</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToDictMixin</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_dict</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._traverse_dict(self.__dict__)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Example 2</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_traverse_dict</span><span class="params">(self, instance_dict)</span>:</span></span><br><span class="line">        output = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> instance_dict.items():</span><br><span class="line">            output[key] = self._traverse(key, value)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_traverse</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(value, ToDictMixin):</span><br><span class="line">            <span class="keyword">return</span> value.to_dict()</span><br><span class="line">        <span class="keyword">elif</span> isinstance(value, dict):</span><br><span class="line">            <span class="keyword">return</span> self._traverse_dict(value)</span><br><span class="line">        <span class="keyword">elif</span> isinstance(value, list):</span><br><span class="line">            <span class="keyword">return</span> [self._traverse(key, i) <span class="keyword">for</span> i <span class="keyword">in</span> value]</span><br><span class="line">        <span class="keyword">elif</span> hasattr(value, <span class="string">'__dict__'</span>):</span><br><span class="line">            <span class="keyword">return</span> self._traverse_dict(value.__dict__)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryTree</span><span class="params">(ToDictMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value, left=None, right=None)</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line">        self.left = left</span><br><span class="line">        self.right = right</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">tree = BinaryTree(<span class="number">10</span>, left=BinaryTree(<span class="number">7</span>, right=BinaryTree(<span class="number">9</span>)), right=BinaryTree(<span class="number">13</span>, left=BinaryTree(<span class="number">11</span>)))</span><br><span class="line"></span><br><span class="line">print(tree.to_dict())  <span class="comment"># &#123;'value': 10, 'left': &#123;'value': 7, 'left': None, 'right': &#123;'value': 9, 'left': None, 'right': None&#125;&#125;, 'right': &#123;'value': 13, 'left': &#123;'value': 11, 'left': None, 'right': None&#125;, 'right': None&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryTreeWithParent</span><span class="params">(BinaryTree)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value, left=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 right=None, parent=None)</span>:</span></span><br><span class="line">        super().__init__(value, left=left, right=right)</span><br><span class="line">        self.parent = parent</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Example 6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_traverse</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (isinstance(value, BinaryTreeWithParent) <span class="keyword">and</span></span><br><span class="line">                key == <span class="string">'parent'</span>):</span><br><span class="line">            <span class="keyword">return</span> value.value  <span class="comment"># Prevent cycles</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> super()._traverse(key, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">root = BinaryTreeWithParent(<span class="number">10</span>)</span><br><span class="line">root.left = BinaryTreeWithParent(<span class="number">7</span>, parent=root)</span><br><span class="line">root.left.right = BinaryTreeWithParent(<span class="number">9</span>, parent=root.left)</span><br><span class="line">print(root.to_dict())  <span class="comment"># &#123;'value': 10, 'left': &#123;'value': 7, 'left': None, 'right': &#123;'value': 9, 'left': None, 'right': None, 'parent': 7&#125;, 'parent': 10&#125;, 'right': None, 'parent': None&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NamedSubTree</span><span class="params">(ToDictMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, tree_with_parent)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.tree_with_parent = tree_with_parent</span><br><span class="line"></span><br><span class="line">my_tree = NamedSubTree(<span class="string">'foobar'</span>, root.left.right)</span><br><span class="line">print(<span class="string">f'my_tree.to_dict(): <span class="subst">&#123;my_tree.to_dict()&#125;</span>'</span>)  <span class="comment"># my_tree.to_dict(): &#123;'name': 'foobar', 'tree_with_parent': &#123;'value': 9, 'left': None, 'right': None, 'parent': 7&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonMixin</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_json</span><span class="params">(cls, data)</span>:</span></span><br><span class="line">        kwargs = json.loads(data)</span><br><span class="line">        <span class="keyword">return</span> cls(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_json</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(self.to_dict())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatacenterRack</span><span class="params">(ToDictMixin, JsonMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, switch=None, machines=None)</span>:</span></span><br><span class="line">        self.switch = Switch(**switch)</span><br><span class="line">        self.machines = [</span><br><span class="line">            Machine(**kwargs) <span class="keyword">for</span> kwargs <span class="keyword">in</span> machines]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Switch</span><span class="params">(ToDictMixin, JsonMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ports=None, speed=None)</span>:</span></span><br><span class="line">        self.ports = ports</span><br><span class="line">        self.speed = speed</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Machine</span><span class="params">(ToDictMixin, JsonMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cores=None, ram=None, disk=None)</span>:</span></span><br><span class="line">        self.cores = cores</span><br><span class="line">        self.ram = ram</span><br><span class="line">        self.disk = disk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line">serialized = <span class="string">"""&#123;</span></span><br><span class="line"><span class="string">    "switch": &#123;"ports": 5, "speed": 1e9&#125;,</span></span><br><span class="line"><span class="string">    "machines": [</span></span><br><span class="line"><span class="string">        &#123;"cores": 8, "ram": 32e9, "disk": 5e12&#125;,</span></span><br><span class="line"><span class="string">        &#123;"cores": 4, "ram": 16e9, "disk": 1e12&#125;,</span></span><br><span class="line"><span class="string">        &#123;"cores": 2, "ram": 4e9, "disk": 500e9&#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;"""</span></span><br><span class="line"></span><br><span class="line">deserialized = DatacenterRack.from_json(serialized)</span><br><span class="line">roundtrip = deserialized.to_json()</span><br><span class="line"><span class="keyword">assert</span> json.loads(serialized) == json.loads(roundtrip)</span><br></pre></td></tr></table></figure>
<h3 id="42-优先考虑用public属性表示应受保护的数据，不要用private属性表示"><a href="#42-优先考虑用public属性表示应受保护的数据，不要用private属性表示" class="headerlink" title="42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示"></a>42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._value = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(ApiClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self._value = <span class="string">'hello'</span>  <span class="comment"># Conflicts</span></span><br><span class="line"></span><br><span class="line">a = Child()</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;a.get()&#125;</span> and <span class="subst">&#123;a._value&#125;</span> should be different'</span>)  <span class="comment"># hello and hello should be different</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__value = <span class="number">5</span>       <span class="comment"># Double underscore</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.__value    <span class="comment"># Double underscore</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span><span class="params">(ApiClass)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self._value = <span class="string">'hello'</span>  <span class="comment"># OK!</span></span><br><span class="line"></span><br><span class="line">a = Child()</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;a.get()&#125;</span> and <span class="subst">&#123;a._value&#125;</span> are different'</span>)  <span class="comment"># 5 and hello are different</span></span><br></pre></td></tr></table></figure>
<h3 id="43-自定义的容器类型应该从collections-abc继承"><a href="#43-自定义的容器类型应该从collections-abc继承" class="headerlink" title="43. 自定义的容器类型应该从collections.abc继承"></a>43. 自定义的容器类型应该从collections.abc继承</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Sequence</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinaryNode</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value, left=None, right=None)</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line">        self.left = left</span><br><span class="line">        self.right = right</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexableNode</span><span class="params">(BinaryNode)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_traverse</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.left <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> self.left._traverse()</span><br><span class="line">        <span class="keyword">yield</span> self</span><br><span class="line">        <span class="keyword">if</span> self.right <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> self.right._traverse()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i, item <span class="keyword">in</span> enumerate(self._traverse()):</span><br><span class="line">            <span class="keyword">if</span> i == index:</span><br><span class="line">                <span class="keyword">return</span> item.value</span><br><span class="line">        <span class="keyword">raise</span> IndexError(<span class="string">f'Index <span class="subst">&#123;index&#125;</span> is out of range'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SequenceNode</span><span class="params">(IndexableNode)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> count, _ <span class="keyword">in</span> enumerate(self._traverse(), <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterNode</span><span class="params">(SequenceNode, Sequence)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tree = BetterNode(</span><br><span class="line">    <span class="number">10</span>,</span><br><span class="line">    left=BetterNode(</span><br><span class="line">        <span class="number">5</span>,</span><br><span class="line">        left=BetterNode(<span class="number">2</span>),</span><br><span class="line">        right=BetterNode(</span><br><span class="line">            <span class="number">6</span>,</span><br><span class="line">            right=BetterNode(<span class="number">7</span>))),</span><br><span class="line">    right=BetterNode(</span><br><span class="line">        <span class="number">15</span>,</span><br><span class="line">        left=BetterNode(<span class="number">11</span>))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Index of 7 is'</span>, tree.index(<span class="number">7</span>))  <span class="comment"># Index of 7 is 3</span></span><br><span class="line">print(<span class="string">'Count of 10 is'</span>, tree.count(<span class="number">10</span>))  <span class="comment"># Count of 10 is 1</span></span><br></pre></td></tr></table></figure>
<h2 id="六-元类与属性"><a href="#六-元类与属性" class="headerlink" title="六. 元类与属性"></a>六. 元类与属性</h2><h3 id="44-用纯属性与修饰器取代旧式的setter与getter方法"><a href="#44-用纯属性与修饰器取代旧式的setter与getter方法" class="headerlink" title="44. 用纯属性与修饰器取代旧式的setter与getter方法"></a>44. 用纯属性与修饰器取代旧式的setter与getter方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Resistor</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ohms)</span>:</span></span><br><span class="line">        self.ohms = ohms</span><br><span class="line">        self.voltage = <span class="number">0</span></span><br><span class="line">        self.current = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MysteriousResistor</span><span class="params">(Resistor)</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ohms</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.voltage = self._ohms * self.current</span><br><span class="line">        <span class="keyword">return</span> self._ohms</span><br><span class="line"></span><br><span class="line"><span class="meta">    @ohms.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ohms</span><span class="params">(self, ohms)</span>:</span></span><br><span class="line">        self._ohms = ohms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line">r7 = MysteriousResistor(<span class="number">10</span>)</span><br><span class="line">r7.current = <span class="number">0.01</span></span><br><span class="line">print(<span class="string">f'Before: <span class="subst">&#123;r7.voltage:<span class="number">.2</span>f&#125;</span>'</span>)  <span class="comment"># Before: 0.00</span></span><br><span class="line">print(r7.ohms)  <span class="comment"># 10</span></span><br><span class="line">print(<span class="string">f'After:  <span class="subst">&#123;r7.voltage:<span class="number">.2</span>f&#125;</span>'</span>)  <span class="comment"># After:  0.10</span></span><br></pre></td></tr></table></figure>
<h3 id="45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码"><a href="#45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码" class="headerlink" title="45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码"></a>45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bucket</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, period)</span>:</span></span><br><span class="line">        self.period_delta = timedelta(seconds=period)</span><br><span class="line">        self.reset_time = datetime.now()</span><br><span class="line">        self.quota = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'Bucket(quota=<span class="subst">&#123;self.quota&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line">bucket = Bucket(<span class="number">60</span>)</span><br><span class="line">print(bucket)  <span class="comment"># Bucket(quota=0)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span><span class="params">(bucket, amount)</span>:</span></span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">if</span> (now - bucket.reset_time) &gt; bucket.period_delta:</span><br><span class="line">        bucket.quota = <span class="number">0</span></span><br><span class="line">        bucket.reset_time = now</span><br><span class="line">    bucket.quota += amount</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deduct</span><span class="params">(bucket, amount)</span>:</span></span><br><span class="line">    now = datetime.now()</span><br><span class="line">    <span class="keyword">if</span> (now - bucket.reset_time) &gt; bucket.period_delta:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># Bucket hasn't been filled this period</span></span><br><span class="line">    <span class="keyword">if</span> bucket.quota - amount &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># Bucket was filled, but not enough</span></span><br><span class="line">    bucket.quota -= amount</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>       <span class="comment"># Bucket had enough, quota consumed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">bucket = Bucket(<span class="number">60</span>)</span><br><span class="line">fill(bucket, <span class="number">100</span>)</span><br><span class="line">print(bucket)  <span class="comment"># Bucket(quota=100)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">if</span> deduct(bucket, <span class="number">99</span>):</span><br><span class="line">    print(<span class="string">'Had 99 quota'</span>)  <span class="comment"># Had 99 quota</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Not enough for 99 quota'</span>)</span><br><span class="line">print(bucket)  <span class="comment"># Bucket(quota=1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">if</span> deduct(bucket, <span class="number">3</span>):</span><br><span class="line">    print(<span class="string">'Had 3 quota'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Not enough for 3 quota'</span>)  <span class="comment"># Not enough for 3 quota</span></span><br><span class="line">print(bucket)  <span class="comment"># Bucket(quota=1)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewBucket</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, period)</span>:</span></span><br><span class="line">        self.period_delta = timedelta(seconds=period)</span><br><span class="line">        self.reset_time = datetime.now()</span><br><span class="line">        self.max_quota = <span class="number">0</span></span><br><span class="line">        self.quota_consumed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="string">f'NewBucket(max_quota=<span class="subst">&#123;self.max_quota&#125;</span>, '</span></span><br><span class="line">                <span class="string">f'quota_consumed=<span class="subst">&#123;self.quota_consumed&#125;</span>)'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Example 8</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quota</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.max_quota - self.quota_consumed</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Example 9</span></span><br><span class="line"><span class="meta">    @quota.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">quota</span><span class="params">(self, amount)</span>:</span></span><br><span class="line">        delta = self.max_quota - amount</span><br><span class="line">        <span class="keyword">if</span> amount == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Quota being reset for a new period</span></span><br><span class="line">            self.quota_consumed = <span class="number">0</span></span><br><span class="line">            self.max_quota = <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> delta &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># Quota being filled during the period</span></span><br><span class="line">            self.max_quota = amount + self.quota_consumed</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># Quota being consumed during the period</span></span><br><span class="line">            self.quota_consumed = delta</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">bucket = NewBucket(<span class="number">60</span>)</span><br><span class="line">print(<span class="string">'Initial'</span>, bucket)  <span class="comment"># Initial NewBucket(max_quota=0, quota_consumed=0)</span></span><br><span class="line">fill(bucket, <span class="number">100</span>)</span><br><span class="line">print(<span class="string">'Filled'</span>, bucket)  <span class="comment"># Filled NewBucket(max_quota=100, quota_consumed=0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> deduct(bucket, <span class="number">99</span>):</span><br><span class="line">    print(<span class="string">'Had 99 quota'</span>)  <span class="comment"># Had 99 quota</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Not enough for 99 quota'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Now'</span>, bucket)  <span class="comment"># Now NewBucket(max_quota=100, quota_consumed=99)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> deduct(bucket, <span class="number">3</span>):</span><br><span class="line">    print(<span class="string">'Had 3 quota'</span>)  <span class="comment"># Not enough for 3 quota</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'Not enough for 3 quota'</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Still'</span>, bucket)  <span class="comment"># Still NewBucket(max_quota=100, quota_consumed=99)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line">bucket = NewBucket(<span class="number">6000</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">fill(bucket, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">100</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> deduct(bucket, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">100</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">10</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">90</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> deduct(bucket, <span class="number">20</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">100</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">30</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">70</span></span><br><span class="line"></span><br><span class="line">fill(bucket, <span class="number">50</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">150</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">30</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">120</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> deduct(bucket, <span class="number">40</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">150</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">70</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> deduct(bucket, <span class="number">81</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.max_quota == <span class="number">150</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota_consumed == <span class="number">70</span></span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">80</span></span><br><span class="line"></span><br><span class="line">bucket.reset_time += bucket.period_delta - timedelta(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">80</span></span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> deduct(bucket, <span class="number">79</span>)</span><br><span class="line"></span><br><span class="line">fill(bucket, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">assert</span> bucket.quota == <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h3 id="46-用描述符来改写需要复用的-property方法"><a href="#46-用描述符来改写需要复用的-property方法" class="headerlink" title="46. 用描述符来改写需要复用的@property方法"></a>46. 用描述符来改写需要复用的@property方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Homework</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._grade = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._grade</span><br><span class="line"></span><br><span class="line"><span class="meta">    @grade.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">grade</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= value &lt;= <span class="number">100</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">'Grade must be between 0 and 100'</span>)</span><br><span class="line">        self._grade = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">galileo = Homework()</span><br><span class="line">galileo.grade = <span class="number">95</span></span><br><span class="line"><span class="keyword">assert</span> galileo.grade == <span class="number">95</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exam</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._writing_grade = <span class="number">0</span></span><br><span class="line">        self._math_grade = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_check_grade</span><span class="params">(value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= value &lt;= <span class="number">100</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">'Grade must be between 0 and 100'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">writing_grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._writing_grade</span><br><span class="line"></span><br><span class="line"><span class="meta">    @writing_grade.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">writing_grade</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._check_grade(value)</span><br><span class="line">        self._writing_grade = value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">math_grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._math_grade</span><br><span class="line"></span><br><span class="line"><span class="meta">    @math_grade.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">math_grade</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        self._check_grade(value)</span><br><span class="line">        self._math_grade = value</span><br><span class="line"></span><br><span class="line">galileo = Exam()</span><br><span class="line">galileo.writing_grade = <span class="number">85</span></span><br><span class="line">galileo.math_grade = <span class="number">99</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> galileo.writing_grade == <span class="number">85</span></span><br><span class="line"><span class="keyword">assert</span> galileo.math_grade == <span class="number">99</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, instance_type)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exam</span>:</span></span><br><span class="line">    <span class="comment"># Class attributes</span></span><br><span class="line">    math_grade = Grade()</span><br><span class="line">    writing_grade = Grade()</span><br><span class="line">    science_grade = Grade()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">exam = Exam()</span><br><span class="line">exam.writing_grade = <span class="number">40</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">Exam.__dict__[<span class="string">'writing_grade'</span>].__set__(exam, <span class="number">40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line">exam.writing_grade</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">Exam.__dict__[<span class="string">'writing_grade'</span>].__get__(exam, Exam)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, instance_type)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= value &lt;= <span class="number">100</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">'Grade must be between 0 and 100'</span>)</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exam</span>:</span></span><br><span class="line">    math_grade = Grade()</span><br><span class="line">    writing_grade = Grade()</span><br><span class="line">    science_grade = Grade()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">first_exam = Exam()</span><br><span class="line">first_exam.writing_grade = <span class="number">82</span></span><br><span class="line">first_exam.science_grade = <span class="number">99</span></span><br><span class="line">print(<span class="string">'Writing'</span>, first_exam.writing_grade)  <span class="comment"># Writing 82</span></span><br><span class="line">print(<span class="string">'Science'</span>, first_exam.science_grade)  <span class="comment"># Science 99</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line">second_exam = Exam()</span><br><span class="line">second_exam.writing_grade = <span class="number">75</span></span><br><span class="line">print(<span class="string">f'Second <span class="subst">&#123;second_exam.writing_grade&#125;</span> is right'</span>)  <span class="comment"># Second 75 is right</span></span><br><span class="line">print(<span class="string">f'First  <span class="subst">&#123;first_exam.writing_grade&#125;</span> is wrong; should be 82'</span>)  <span class="comment"># First  75 is wrong; should be 82</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._values = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, instance_type)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">return</span> self._values.get(instance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= value &lt;= <span class="number">100</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(</span><br><span class="line">                <span class="string">'Grade must be between 0 and 100'</span>)</span><br><span class="line">        self._values[instance] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line"><span class="keyword">from</span> weakref <span class="keyword">import</span> WeakKeyDictionary</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._values = WeakKeyDictionary()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, instance_type)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">return</span> self._values.get(instance, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= value &lt;= <span class="number">100</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'Grade must be between 0 and 100'</span>)</span><br><span class="line">        self._values[instance] = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exam</span>:</span></span><br><span class="line">    math_grade = Grade()</span><br><span class="line">    writing_grade = Grade()</span><br><span class="line">    science_grade = Grade()</span><br><span class="line"></span><br><span class="line">first_exam = Exam()</span><br><span class="line">first_exam.writing_grade = <span class="number">82</span></span><br><span class="line">second_exam = Exam()</span><br><span class="line">second_exam.writing_grade = <span class="number">75</span></span><br><span class="line">print(<span class="string">f'First  <span class="subst">&#123;first_exam.writing_grade&#125;</span> is right'</span>)  <span class="comment"># First  82 is right</span></span><br><span class="line">print(<span class="string">f'Second <span class="subst">&#123;second_exam.writing_grade&#125;</span> is right'</span>)  <span class="comment"># Second 75 is right</span></span><br></pre></td></tr></table></figure>
<h3 id="47-针对惰性属性使用-getattr-、-getattribute-及-setattr"><a href="#47-针对惰性属性使用-getattr-、-getattribute-及-setattr" class="headerlink" title="47. 针对惰性属性使用__getattr__、__getattribute__及 __setattr__"></a>47. 针对惰性属性使用<code>__getattr__、__getattribute__及 __setattr__</code></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DictionaryRecord</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self._data = data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattribute__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="comment"># Prevent weird interactions with isinstance() used</span></span><br><span class="line">        <span class="comment"># by example code harness.</span></span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'__class__'</span>:</span><br><span class="line">            <span class="keyword">return</span> DictionaryRecord</span><br><span class="line">        print(<span class="string">f'* Called __getattribute__(<span class="subst">&#123;name!r&#125;</span>)'</span>)  <span class="comment"># * Called __getattribute__('foo')</span></span><br><span class="line">        data_dict = super().__getattribute__(<span class="string">'_data'</span>)</span><br><span class="line">        <span class="keyword">return</span> data_dict[name]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data = DictionaryRecord(&#123;<span class="string">'foo'</span>: <span class="number">3</span>&#125;)</span><br><span class="line">print(<span class="string">'foo: '</span>, data.foo)  <span class="comment"># foo:  3</span></span><br></pre></td></tr></table></figure>
<h3 id="48-用init-subclass验证子类写得是否正确"><a href="#48-用init-subclass验证子类写得是否正确" class="headerlink" title="48. 用init_subclass验证子类写得是否正确"></a>48. 用<strong>init_subclass</strong>验证子类写得是否正确</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidatePolygon</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(meta, name, bases, class_dict)</span>:</span></span><br><span class="line">        <span class="comment"># Only validate non-root classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_dict.get(<span class="string">'is_root'</span>):</span><br><span class="line">            <span class="keyword">if</span> class_dict[<span class="string">'sides'</span>] &lt; <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Polygons need 3+ sides'</span>)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(meta, name, bases, class_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Polygon</span><span class="params">(metaclass=ValidatePolygon)</span>:</span></span><br><span class="line">    is_root = <span class="literal">True</span></span><br><span class="line">    sides = <span class="literal">None</span>  <span class="comment"># Must be specified by subclasses</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateFilledPolygon</span><span class="params">(ValidatePolygon)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(meta, name, bases, class_dict)</span>:</span></span><br><span class="line">        <span class="comment"># Only validate non-root classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> class_dict.get(<span class="string">'is_root'</span>):</span><br><span class="line">            <span class="keyword">if</span> class_dict[<span class="string">'color'</span>] <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'red'</span>, <span class="string">'green'</span>):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">'Fill color must be supported'</span>)</span><br><span class="line">        <span class="keyword">return</span> super().__new__(meta, name, bases, class_dict)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilledPolygon</span><span class="params">(Polygon, metaclass=ValidateFilledPolygon)</span>:</span></span><br><span class="line">    is_root = <span class="literal">True</span></span><br><span class="line">    color = <span class="literal">None</span>  <span class="comment"># Must be specified by subclasses</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreenPentagon</span><span class="params">(FilledPolygon)</span>:</span></span><br><span class="line">    color = <span class="string">'green'</span></span><br><span class="line">    sides = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">greenie = GreenPentagon()</span><br><span class="line">print(greenie, type(greenie))  <span class="comment"># &lt;__main__.GreenPentagon object at 0x7fac8bccd8d0&gt; &lt;class '__main__.GreenPentagon'&gt;</span></span><br><span class="line">print(Polygon, type(Polygon))  <span class="comment"># &lt;class '__main__.Polygon'&gt; &lt;class '__main__.ValidatePolygon'&gt;</span></span><br><span class="line"><span class="keyword">assert</span> isinstance(greenie, Polygon)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是基本的菱形继承体系</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Top</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().__init_subclass__()</span><br><span class="line">        print(<span class="string">f'Top for <span class="subst">&#123;cls&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Left</span><span class="params">(Top)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().__init_subclass__()  <span class="comment">#</span></span><br><span class="line">        print(<span class="string">f'Left for <span class="subst">&#123;cls&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Right</span><span class="params">(Top)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().__init_subclass__()</span><br><span class="line">        print(<span class="string">f'Right for <span class="subst">&#123;cls&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bottom</span><span class="params">(Left, Right)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().__init_subclass__()</span><br><span class="line">        print(<span class="string">f'Bottom for <span class="subst">&#123;cls&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""打印结果如下：</span></span><br><span class="line"><span class="string">Top for &lt;class '__main__.Left'&gt;</span></span><br><span class="line"><span class="string">Top for &lt;class '__main__.Right'&gt;</span></span><br><span class="line"><span class="string">Top for &lt;class '__main__.Bottom'&gt;</span></span><br><span class="line"><span class="string">Right for &lt;class '__main__.Bottom'&gt;</span></span><br><span class="line"><span class="string">Left for &lt;class '__main__.Bottom'&gt;"""</span></span><br></pre></td></tr></table></figure>
<h3 id="49-用init-subclass记录现有的子类"><a href="#49-用init-subclass记录现有的子类" class="headerlink" title="49. 用init_subclass记录现有的子类"></a>49. 用<strong>init_subclass</strong>记录现有的子类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">registry = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_class</span><span class="params">(target_class)</span>:</span></span><br><span class="line">    registry[target_class.__name__] = target_class</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deserialize</span><span class="params">(data)</span>:</span></span><br><span class="line">    params = json.loads(data)</span><br><span class="line">    name = params[<span class="string">'class'</span>]</span><br><span class="line">    target_class = registry[name]</span><br><span class="line">    <span class="keyword">return</span> target_class(*params[<span class="string">'args'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterSerializable</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        self.args = args</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(&#123;</span><br><span class="line">            <span class="string">'class'</span>: self.__class__.__name__,</span><br><span class="line">            <span class="string">'args'</span>: self.args,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        name = self.__class__.__name__</span><br><span class="line">        args_str = <span class="string">', '</span>.join(str(x) <span class="keyword">for</span> x <span class="keyword">in</span> self.args)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'<span class="subst">&#123;name&#125;</span>(<span class="subst">&#123;args_str&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterRegisteredSerializable</span><span class="params">(BetterSerializable)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_subclass__</span><span class="params">(cls)</span>:</span></span><br><span class="line">        super().__init_subclass__()</span><br><span class="line">        register_class(cls)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vector1D</span><span class="params">(BetterRegisteredSerializable)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, magnitude)</span>:</span></span><br><span class="line">        super().__init__(magnitude)</span><br><span class="line">        self.magnitude = magnitude</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">before = Vector1D(<span class="number">6</span>)</span><br><span class="line">print(<span class="string">'Before:'</span>, before)  <span class="comment"># Before: Vector1D(6)</span></span><br><span class="line">data = before.serialize()</span><br><span class="line">print(<span class="string">'Serialized:'</span>, data)  <span class="comment"># Serialized: &#123;"class": "Vector1D", "args": [6]&#125;</span></span><br><span class="line">print(<span class="string">'After:     '</span>, deserialize(data))  <span class="comment"># After:      Vector1D(6)</span></span><br></pre></td></tr></table></figure>
<h3 id="50-用-set-name-给类属性加注解"><a href="#50-用-set-name-给类属性加注解" class="headerlink" title="50. 用__set_name__给类属性加注解"></a>50. 用<code>__set_name__</code>给类属性加注解</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.name = <span class="literal">None</span></span><br><span class="line">        self.internal_name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set_name__</span><span class="params">(self, owner, name)</span>:</span></span><br><span class="line">        <span class="comment"># Called on class creation for each descriptor</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.internal_name = <span class="string">'_'</span> + name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, instance_type)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">return</span> getattr(instance, self.internal_name, <span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        setattr(instance, self.internal_name, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedCustomer</span>:</span></span><br><span class="line">    first_name = Field()</span><br><span class="line">    last_name = Field()</span><br><span class="line">    prefix = Field()</span><br><span class="line">    suffix = Field()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cust = FixedCustomer()</span><br><span class="line">print(<span class="string">f'Before: <span class="subst">&#123;cust.first_name!r&#125;</span> <span class="subst">&#123;cust.__dict__&#125;</span>'</span>)  <span class="comment"># Before: '' &#123;&#125;</span></span><br><span class="line">cust.first_name = <span class="string">'Mersenne'</span></span><br><span class="line">print(<span class="string">f'After:  <span class="subst">&#123;cust.first_name!r&#125;</span> <span class="subst">&#123;cust.__dict__&#125;</span>'</span>)  <span class="comment"># After:  'Mersenne' &#123;'_first_name': 'Mersenne'&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><a href="#51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类" class="headerlink" title="51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"></a>51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line">trace_types = (</span><br><span class="line">    types.MethodType,</span><br><span class="line">    types.FunctionType,</span><br><span class="line">    types.BuiltinFunctionType,</span><br><span class="line">    types.BuiltinMethodType,</span><br><span class="line">    types.MethodDescriptorType,</span><br><span class="line">    types.ClassMethodDescriptorType)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace_func</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(func, <span class="string">'tracing'</span>):  <span class="comment"># Only decorate once</span></span><br><span class="line">        <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        result = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            result = e</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            print(<span class="string">f'<span class="subst">&#123;func.__name__&#125;</span>(<span class="subst">&#123;args!r&#125;</span>, <span class="subst">&#123;kwargs!r&#125;</span>) -&gt; <span class="subst">&#123;result!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">    wrapper.tracing = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_class_decorator</span><span class="params">(klass)</span>:</span></span><br><span class="line">    klass.extra_param = <span class="string">'hello'</span></span><br><span class="line">    <span class="keyword">return</span> klass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@my_class_decorator</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(MyClass)  <span class="comment"># &lt;class '__main__.MyClass'&gt;</span></span><br><span class="line">print(MyClass.extra_param)  <span class="comment"># hello</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(klass)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> dir(klass):</span><br><span class="line">        value = getattr(klass, key)</span><br><span class="line">        <span class="keyword">if</span> isinstance(value, trace_types):</span><br><span class="line">            wrapped = trace_func(value)</span><br><span class="line">            setattr(klass, key, wrapped)</span><br><span class="line">    <span class="keyword">return</span> klass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="meta">@trace</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TraceDict</span><span class="params">(dict)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">trace_dict = TraceDict([(<span class="string">'hi'</span>, <span class="number">1</span>)])</span><br><span class="line">trace_dict[<span class="string">'there'</span>] = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    trace_dict[<span class="string">'does not exist'</span>]</span><br><span class="line"><span class="keyword">except</span> KeyError:</span><br><span class="line">    <span class="keyword">pass</span>  <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherMeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@trace</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TraceDict</span><span class="params">(dict, metaclass=OtherMeta)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">trace_dict = TraceDict([(<span class="string">'hi'</span>, <span class="number">1</span>)])</span><br><span class="line">trace_dict[<span class="string">'there'</span>] = <span class="number">2</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    trace_dict[<span class="string">'does not exist'</span>]</span><br><span class="line"><span class="keyword">except</span> KeyError:</span><br><span class="line">    <span class="keyword">pass</span>  <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">&lt;class '__main__.MyClass'&gt;</span></span><br><span class="line"><span class="string">hello</span></span><br><span class="line"><span class="string">__new__((&lt;class '__main__.TraceDict'&gt;, [('hi', 1)]), &#123;&#125;) -&gt; &#123;&#125;</span></span><br><span class="line"><span class="string">__getitem__((&#123;'hi': 1, 'there': 2&#125;, 'does not exist'), &#123;&#125;) -&gt; KeyError('does not exist')</span></span><br><span class="line"><span class="string">__new__((&lt;class '__main__.TraceDict'&gt;, [('hi', 1)]), &#123;&#125;) -&gt; &#123;&#125;</span></span><br><span class="line"><span class="string">__getitem__((&#123;'hi': 1, 'there': 2&#125;, 'does not exist'), &#123;&#125;) -&gt; KeyError('does not exist')</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h2 id="七-并发与并行"><a href="#七-并发与并行" class="headerlink" title="七. 并发与并行"></a>七. 并发与并行</h2><h3 id="52-用subprocess管理子进程"><a href="#52-用subprocess管理子进程" class="headerlink" title="52. 用subprocess管理子进程"></a>52. 用subprocess管理子进程</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># Enable these lines to make this example work on Windows</span></span><br><span class="line"><span class="comment"># import os</span></span><br><span class="line"><span class="comment"># os.environ['COMSPEC'] = 'powershell'</span></span><br><span class="line"></span><br><span class="line">result = subprocess.run(</span><br><span class="line">    [<span class="string">'echo'</span>, <span class="string">'Hello from the child!'</span>],</span><br><span class="line">    capture_output=<span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># Enable this line to make this example work on Windows</span></span><br><span class="line">    <span class="comment"># shell=True,</span></span><br><span class="line">    encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">result.check_returncode()  <span class="comment"># No exception means it exited cleanly</span></span><br><span class="line">print(result.stdout)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="comment"># Use this line instead to make this example work on Windows</span></span><br><span class="line"><span class="comment"># proc = subprocess.Popen(['sleep', '1'], shell=True)</span></span><br><span class="line">proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'1'</span>])</span><br><span class="line"><span class="keyword">while</span> proc.poll() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    print(<span class="string">'Working...'</span>)</span><br><span class="line">    <span class="comment"># Some time-consuming work here</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Exit status'</span>, proc.poll())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">start = time.time()</span><br><span class="line">sleep_procs = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    <span class="comment"># Use this line instead to make this example work on Windows</span></span><br><span class="line">    <span class="comment"># proc = subprocess.Popen(['sleep', '1'], shell=True)</span></span><br><span class="line">    proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'1'</span>])</span><br><span class="line">    sleep_procs.append(proc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> sleep_procs:</span><br><span class="line">    proc.communicate()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">delta = end - start</span><br><span class="line">print(<span class="string">f'Finished in <span class="subst">&#123;delta:<span class="number">.3</span>&#125;</span> seconds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># On Windows, after installing OpenSSL, you may need to</span></span><br><span class="line"><span class="comment"># alias it in your PowerShell path with a command like:</span></span><br><span class="line"><span class="comment"># $env:path = $env:path + ";C:\Program Files\OpenSSL-Win64\bin"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_encrypt</span><span class="params">(data)</span>:</span></span><br><span class="line">    env = os.environ.copy()</span><br><span class="line">    env[<span class="string">'password'</span>] = <span class="string">'zf7ShyBhZOraQDdE/FiZpm/m/8f9X+M1'</span></span><br><span class="line">    proc = subprocess.Popen(</span><br><span class="line">        [<span class="string">'openssl'</span>, <span class="string">'enc'</span>, <span class="string">'-des3'</span>, <span class="string">'-pass'</span>, <span class="string">'env:password'</span>],</span><br><span class="line">        env=env,</span><br><span class="line">        stdin=subprocess.PIPE,</span><br><span class="line">        stdout=subprocess.PIPE)</span><br><span class="line">    proc.stdin.write(data)</span><br><span class="line">    proc.stdin.flush()  <span class="comment"># Ensure that the child gets input</span></span><br><span class="line">    <span class="keyword">return</span> proc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">procs = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    data = os.urandom(<span class="number">10</span>)</span><br><span class="line">    proc = run_encrypt(data)</span><br><span class="line">    procs.append(proc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> procs:</span><br><span class="line">    out, _ = proc.communicate()</span><br><span class="line">    print(<span class="string">f'out[-10:]  <span class="subst">&#123;out[<span class="number">-10</span>:]&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_hash</span><span class="params">(input_stdin)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> subprocess.Popen(</span><br><span class="line">        [<span class="string">'openssl'</span>, <span class="string">'dgst'</span>, <span class="string">'-whirlpool'</span>, <span class="string">'-binary'</span>],</span><br><span class="line">        stdin=input_stdin,</span><br><span class="line">        stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">encrypt_procs = []</span><br><span class="line">hash_procs = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">    data = os.urandom(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    encrypt_proc = run_encrypt(data)</span><br><span class="line">    encrypt_procs.append(encrypt_proc)</span><br><span class="line"></span><br><span class="line">    hash_proc = run_hash(encrypt_proc.stdout)</span><br><span class="line">    hash_procs.append(hash_proc)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure that the child consumes the input stream and</span></span><br><span class="line">    <span class="comment"># the communicate() method doesn't inadvertently steal</span></span><br><span class="line">    <span class="comment"># input from the child. Also lets SIGPIPE propagate to</span></span><br><span class="line">    <span class="comment"># the upstream process if the downstream process dies.</span></span><br><span class="line">    encrypt_proc.stdout.close()</span><br><span class="line">    encrypt_proc.stdout = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> encrypt_procs:</span><br><span class="line">    proc.communicate()</span><br><span class="line">    <span class="keyword">assert</span> proc.returncode == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> proc <span class="keyword">in</span> hash_procs:</span><br><span class="line">    out, _ = proc.communicate()</span><br><span class="line">    print(out[<span class="number">-10</span>:])</span><br><span class="line">    <span class="keyword">assert</span> proc.returncode == <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="comment"># Use this line instead to make this example work on Windows</span></span><br><span class="line"><span class="comment"># proc = subprocess.Popen(['sleep', '10'], shell=True)</span></span><br><span class="line">proc = subprocess.Popen([<span class="string">'sleep'</span>, <span class="string">'10'</span>])</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    proc.communicate(timeout=<span class="number">0.1</span>)</span><br><span class="line"><span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">    proc.terminate()</span><br><span class="line">    proc.wait()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Exit status'</span>, proc.poll())</span><br></pre></td></tr></table></figure>
<h3 id="53-可以用线程执行阻塞式I-O，但不要用它做并行计算"><a href="#53-可以用线程执行阻塞式I-O，但不要用它做并行计算" class="headerlink" title="53. 可以用线程执行阻塞式I/O，但不要用它做并行计算"></a>53. 可以用线程执行阻塞式I/O，但不要用它做并行计算</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">factorize</span><span class="params">(number)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, number + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> number % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">yield</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">numbers = [<span class="number">2139079</span>, <span class="number">1214759</span>, <span class="number">1516637</span>, <span class="number">1852285</span>]</span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">    list(factorize(number))</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">delta = end - start</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.4</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 0.4613 seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FactorizeThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, number)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.number = number</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.factors = list(factorize(self.number))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> number <span class="keyword">in</span> numbers:</span><br><span class="line">    thread = FactorizeThread(number)</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">delta = end - start</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 0.448 seconds</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_systemcall</span><span class="params">()</span>:</span></span><br><span class="line">    select.select([socket.socket()], [], [], <span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    slow_systemcall()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">delta = end - start</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds...'</span>)  <span class="comment"># Took 0.517 seconds...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line">start = time.time()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    thread = Thread(target=slow_systemcall)</span><br><span class="line">    thread.start()</span><br><span class="line">    threads.append(thread)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_helicopter_location</span><span class="params">(index)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    compute_helicopter_location(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">end = time.time()</span><br><span class="line">delta = end - start</span><br><span class="line">print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 0.102 seconds</span></span><br></pre></td></tr></table></figure>
<h3 id="54-利用Lock防止多个线程争用同一份数据"><a href="#54-利用Lock防止多个线程争用同一份数据" class="headerlink" title="54. 利用Lock防止多个线程争用同一份数据"></a>54. 利用Lock防止多个线程争用同一份数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span><span class="params">(self, offset)</span>:</span></span><br><span class="line">        self.count += offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">worker</span><span class="params">(sensor_index, how_many, counter)</span>:</span></span><br><span class="line">    <span class="comment"># I have a barrier in here so the workers synchronize</span></span><br><span class="line">    <span class="comment"># when they start counting, otherwise it's hard to get a race</span></span><br><span class="line">    <span class="comment"># because the overhead of starting a thread is high.</span></span><br><span class="line">    BARRIER.wait()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(how_many):</span><br><span class="line">        <span class="comment"># Read from the sensor</span></span><br><span class="line">        <span class="comment"># Nothing actually happens here, but this is where</span></span><br><span class="line">        <span class="comment"># the blocking I/O would go.</span></span><br><span class="line">        counter.increment(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Barrier</span><br><span class="line">BARRIER = Barrier(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">how_many = <span class="number">10</span>**<span class="number">5</span></span><br><span class="line">counter = Counter()</span><br><span class="line"></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    thread = Thread(target=worker,</span><br><span class="line">                    args=(i, how_many, counter))</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">expected = how_many * <span class="number">5</span></span><br><span class="line">found = counter.count</span><br><span class="line">print(<span class="string">f'Counter should be <span class="subst">&#123;expected&#125;</span>, got <span class="subst">&#123;found&#125;</span>'</span>)  <span class="comment"># Counter should be 500000, got 325923</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">counter.count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">value = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line">result = value + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="comment"># Running in Thread A</span></span><br><span class="line">value_a = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line"><span class="comment"># Context switch to Thread B</span></span><br><span class="line">value_b = getattr(counter, <span class="string">'count'</span>)</span><br><span class="line">result_b = value_b + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result_b)</span><br><span class="line"><span class="comment"># Context switch back to Thread A</span></span><br><span class="line">result_a = value_a + <span class="number">1</span></span><br><span class="line">setattr(counter, <span class="string">'count'</span>, result_a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockingCounter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.lock = Lock()</span><br><span class="line">        self.count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">increment</span><span class="params">(self, offset)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            self.count += offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line">BARRIER = Barrier(<span class="number">5</span>)</span><br><span class="line">counter = LockingCounter()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    thread = Thread(target=worker,</span><br><span class="line">                    args=(i, how_many, counter))</span><br><span class="line">    threads.append(thread)</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">expected = how_many * <span class="number">5</span></span><br><span class="line">found = counter.count</span><br><span class="line">print(<span class="string">f'Counter should be <span class="subst">&#123;expected&#125;</span>, got <span class="subst">&#123;found&#125;</span>'</span>)  <span class="comment"># Counter should be 500000, got 500000</span></span><br></pre></td></tr></table></figure>
<h3 id="55-用Queue来协调各线程之间的工作进度"><a href="#55-用Queue来协调各线程之间的工作进度" class="headerlink" title="55. 用Queue来协调各线程之间的工作进度"></a>55. 用Queue来协调各线程之间的工作进度</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(item)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyQueue</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.items = deque()</span><br><span class="line">        self.lock = Lock()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, item)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            self.items.append(item)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> self.items.popleft()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, in_queue, out_queue)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.in_queue = in_queue</span><br><span class="line">        self.out_queue = out_queue</span><br><span class="line">        self.polled_count = <span class="number">0</span></span><br><span class="line">        self.work_done = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            self.polled_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                item = self.in_queue.get()</span><br><span class="line">            <span class="keyword">except</span> IndexError:</span><br><span class="line">                time.sleep(<span class="number">0.01</span>)  <span class="comment"># No work to do</span></span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="comment"># The magic exit signal</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result = self.func(item)</span><br><span class="line">                self.out_queue.put(result)</span><br><span class="line">                self.work_done += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">download_queue = MyQueue()</span><br><span class="line">resize_queue = MyQueue()</span><br><span class="line">upload_queue = MyQueue()</span><br><span class="line">done_queue = MyQueue()</span><br><span class="line">threads = [</span><br><span class="line">    Worker(download, download_queue, resize_queue),</span><br><span class="line">    Worker(resize, resize_queue, upload_queue),</span><br><span class="line">    Worker(upload, upload_queue, done_queue),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="keyword">while</span> len(done_queue.items) &lt; <span class="number">1000</span>:</span><br><span class="line">    <span class="comment"># Do something useful while waiting</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"><span class="comment"># Stop all the threads by causing an exception in their</span></span><br><span class="line"><span class="comment"># run methods.</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.in_queue = <span class="literal">None</span></span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">processed = len(done_queue.items)</span><br><span class="line">polled = sum(t.polled_count <span class="keyword">for</span> t <span class="keyword">in</span> threads)</span><br><span class="line">print(<span class="string">f'Processed <span class="subst">&#123;processed&#125;</span> items after '</span></span><br><span class="line">      <span class="string">f'polling <span class="subst">&#123;polled&#125;</span> times'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line">my_queue = Queue()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Consumer waiting'</span>)</span><br><span class="line">    my_queue.get()              <span class="comment"># Runs after put() below</span></span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line">print(<span class="string">'Producer putting'</span>)</span><br><span class="line">my_queue.put(object())          <span class="comment"># Runs before get() above</span></span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line">my_queue = Queue(<span class="number">1</span>)             <span class="comment"># Buffer size of 1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.1</span>)             <span class="comment"># Wait</span></span><br><span class="line">    my_queue.get()              <span class="comment"># Runs second</span></span><br><span class="line">    print(<span class="string">'Consumer got 1'</span>)</span><br><span class="line">    my_queue.get()              <span class="comment"># Runs fourth</span></span><br><span class="line">    print(<span class="string">'Consumer got 2'</span>)</span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line">my_queue.put(object())          <span class="comment"># Runs first</span></span><br><span class="line">print(<span class="string">'Producer put 1'</span>)</span><br><span class="line">my_queue.put(object())          <span class="comment"># Runs third</span></span><br><span class="line">print(<span class="string">'Producer put 2'</span>)</span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line">in_queue = Queue()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Consumer waiting'</span>)</span><br><span class="line">    work = in_queue.get()       <span class="comment"># Done second</span></span><br><span class="line">    print(<span class="string">'Consumer working'</span>)</span><br><span class="line">    <span class="comment"># Doing work</span></span><br><span class="line">    print(<span class="string">'Consumer done'</span>)</span><br><span class="line">    in_queue.task_done()        <span class="comment"># Done third</span></span><br><span class="line"></span><br><span class="line">thread = Thread(target=consumer)</span><br><span class="line">thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 16</span></span><br><span class="line">print(<span class="string">'Producer putting'</span>)</span><br><span class="line">in_queue.put(object())         <span class="comment"># Done first</span></span><br><span class="line">print(<span class="string">'Producer waiting'</span>)</span><br><span class="line">in_queue.join()                <span class="comment"># Done fourth</span></span><br><span class="line">print(<span class="string">'Producer done'</span>)</span><br><span class="line">thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 17</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosableQueue</span><span class="params">(Queue)</span>:</span></span><br><span class="line">    SENTINEL = object()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.put(self.SENTINEL)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 18</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            item = self.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> item <span class="keyword">is</span> self.SENTINEL:</span><br><span class="line">                    <span class="keyword">return</span>  <span class="comment"># Cause the thread to exit</span></span><br><span class="line">                <span class="keyword">yield</span> item</span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                self.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 19</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoppableWorker</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func, in_queue, out_queue)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.func = func</span><br><span class="line">        self.in_queue = in_queue</span><br><span class="line">        self.out_queue = out_queue</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.in_queue:</span><br><span class="line">            result = self.func(item)</span><br><span class="line">            self.out_queue.put(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 20</span></span><br><span class="line">download_queue = ClosableQueue()</span><br><span class="line">resize_queue = ClosableQueue()</span><br><span class="line">upload_queue = ClosableQueue()</span><br><span class="line">done_queue = ClosableQueue()</span><br><span class="line">threads = [</span><br><span class="line">    StoppableWorker(download, download_queue, resize_queue),</span><br><span class="line">    StoppableWorker(resize, resize_queue, upload_queue),</span><br><span class="line">    StoppableWorker(upload, upload_queue, done_queue),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 21</span></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line">download_queue.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 22</span></span><br><span class="line">download_queue.join()</span><br><span class="line">resize_queue.close()</span><br><span class="line">resize_queue.join()</span><br><span class="line">upload_queue.close()</span><br><span class="line">upload_queue.join()</span><br><span class="line">print(done_queue.qsize(), <span class="string">'items finished'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 23</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_threads</span><span class="params">(count, *args)</span>:</span></span><br><span class="line">    threads = [StoppableWorker(*args) <span class="keyword">for</span> _ <span class="keyword">in</span> range(count)]</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.start()</span><br><span class="line">    <span class="keyword">return</span> threads</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_threads</span><span class="params">(closable_queue, threads)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> threads:</span><br><span class="line">        closable_queue.close()</span><br><span class="line"></span><br><span class="line">    closable_queue.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 24</span></span><br><span class="line">download_queue = ClosableQueue()</span><br><span class="line">resize_queue = ClosableQueue()</span><br><span class="line">upload_queue = ClosableQueue()</span><br><span class="line">done_queue = ClosableQueue()</span><br><span class="line"></span><br><span class="line">download_threads = start_threads(</span><br><span class="line">    <span class="number">3</span>, download, download_queue, resize_queue)</span><br><span class="line">resize_threads = start_threads(</span><br><span class="line">    <span class="number">4</span>, resize, resize_queue, upload_queue)</span><br><span class="line">upload_threads = start_threads(</span><br><span class="line">    <span class="number">5</span>, upload, upload_queue, done_queue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    download_queue.put(object())</span><br><span class="line"></span><br><span class="line">stop_threads(download_queue, download_threads)</span><br><span class="line">stop_threads(resize_queue, resize_threads)</span><br><span class="line">stop_threads(upload_queue, upload_threads)</span><br><span class="line"></span><br><span class="line">print(done_queue.qsize(), <span class="string">'items finished'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="56-学会判断什么场合必须做并发"><a href="#56-学会判断什么场合必须做并发" class="headerlink" title="56. 学会判断什么场合必须做并发"></a>56. 学会判断什么场合必须做并发</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">ALIVE = <span class="string">'*'</span></span><br><span class="line">EMPTY = <span class="string">'-'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        self.height = height</span><br><span class="line">        self.width = width</span><br><span class="line">        self.rows = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.height):</span><br><span class="line">            self.rows.append([EMPTY] * self.width)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.rows[y % self.height][x % self.width]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        self.rows[y % self.height][x % self.width] = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        output = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> self.rows:</span><br><span class="line">            <span class="keyword">for</span> cell <span class="keyword">in</span> row:</span><br><span class="line">                output += cell</span><br><span class="line">            output += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">grid = Grid(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">grid.set(<span class="number">0</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">1</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">2</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">print(grid)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">---*-----</span></span><br><span class="line"><span class="string">----*----</span></span><br><span class="line"><span class="string">--***----</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">---------</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_neighbors</span><span class="params">(y, x, get)</span>:</span></span><br><span class="line">    n_ = get(y - <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># North</span></span><br><span class="line">    ne = get(y - <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Northeast</span></span><br><span class="line">    e_ = get(y + <span class="number">0</span>, x + <span class="number">1</span>)  <span class="comment"># East</span></span><br><span class="line">    se = get(y + <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Southeast</span></span><br><span class="line">    s_ = get(y + <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># South</span></span><br><span class="line">    sw = get(y + <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Southwest</span></span><br><span class="line">    w_ = get(y + <span class="number">0</span>, x - <span class="number">1</span>)  <span class="comment"># West</span></span><br><span class="line">    nw = get(y - <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Northwest</span></span><br><span class="line">    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> neighbor_states:</span><br><span class="line">        <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">alive = &#123;(<span class="number">9</span>, <span class="number">5</span>), (<span class="number">9</span>, <span class="number">6</span>)&#125;</span><br><span class="line">seen = set()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_get</span><span class="params">(y, x)</span>:</span></span><br><span class="line">    position = (y, x)</span><br><span class="line">    seen.add(position)</span><br><span class="line">    <span class="keyword">return</span> ALIVE <span class="keyword">if</span> position <span class="keyword">in</span> alive <span class="keyword">else</span> EMPTY</span><br><span class="line"></span><br><span class="line">count = count_neighbors(<span class="number">10</span>, <span class="number">5</span>, fake_get)</span><br><span class="line"><span class="keyword">assert</span> count == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">expected_seen = &#123;</span><br><span class="line">    (<span class="number">9</span>, <span class="number">5</span>),  (<span class="number">9</span>, <span class="number">6</span>),  (<span class="number">10</span>, <span class="number">6</span>), (<span class="number">11</span>, <span class="number">6</span>),</span><br><span class="line">    (<span class="number">11</span>, <span class="number">5</span>), (<span class="number">11</span>, <span class="number">4</span>), (<span class="number">10</span>, <span class="number">4</span>), (<span class="number">9</span>, <span class="number">4</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">assert</span> seen == expected_seen</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_logic</span><span class="params">(state, neighbors)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">        <span class="keyword">if</span> neighbors &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too few</span></span><br><span class="line">        <span class="keyword">elif</span> neighbors &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too many</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> neighbors == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> ALIVE     <span class="comment"># Regenerate</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> game_logic(ALIVE, <span class="number">0</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(ALIVE, <span class="number">1</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(ALIVE, <span class="number">2</span>) == ALIVE</span><br><span class="line"><span class="keyword">assert</span> game_logic(ALIVE, <span class="number">3</span>) == ALIVE</span><br><span class="line"><span class="keyword">assert</span> game_logic(ALIVE, <span class="number">4</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(EMPTY, <span class="number">0</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(EMPTY, <span class="number">1</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(EMPTY, <span class="number">2</span>) == EMPTY</span><br><span class="line"><span class="keyword">assert</span> game_logic(EMPTY, <span class="number">3</span>) == ALIVE</span><br><span class="line"><span class="keyword">assert</span> game_logic(EMPTY, <span class="number">4</span>) == EMPTY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step_cell</span><span class="params">(y, x, get, set)</span>:</span></span><br><span class="line">    state = get(y, x)</span><br><span class="line">    neighbors = count_neighbors(y, x, get)</span><br><span class="line">    next_state = game_logic(state, neighbors)</span><br><span class="line">    set(y, x, next_state)</span><br><span class="line"></span><br><span class="line">alive = &#123;(<span class="number">10</span>, <span class="number">5</span>), (<span class="number">9</span>, <span class="number">5</span>), (<span class="number">9</span>, <span class="number">6</span>)&#125;</span><br><span class="line">new_state = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_get</span><span class="params">(y, x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ALIVE <span class="keyword">if</span> (y, x) <span class="keyword">in</span> alive <span class="keyword">else</span> EMPTY</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_set</span><span class="params">(y, x, state)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> new_state</span><br><span class="line">    new_state = state</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stay alive</span></span><br><span class="line">step_cell(<span class="number">10</span>, <span class="number">5</span>, fake_get, fake_set)</span><br><span class="line"><span class="keyword">assert</span> new_state == ALIVE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stay dead</span></span><br><span class="line">alive.remove((<span class="number">10</span>, <span class="number">5</span>))</span><br><span class="line">step_cell(<span class="number">10</span>, <span class="number">5</span>, fake_get, fake_set)</span><br><span class="line"><span class="keyword">assert</span> new_state == EMPTY</span><br><span class="line"></span><br><span class="line"><span class="comment"># Regenerate</span></span><br><span class="line">alive.add((<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">step_cell(<span class="number">10</span>, <span class="number">5</span>, fake_get, fake_set)</span><br><span class="line"><span class="keyword">assert</span> new_state == ALIVE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulate</span><span class="params">(grid)</span>:</span></span><br><span class="line">    next_grid = Grid(grid.height, grid.width)</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(grid.height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(grid.width):</span><br><span class="line">            step_cell(y, x, grid.get, next_grid.set)</span><br><span class="line">    <span class="keyword">return</span> next_grid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColumnPrinter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.columns = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.columns.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        row_count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> self.columns:</span><br><span class="line">            row_count = max(</span><br><span class="line">                row_count, len(data.splitlines()) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        rows = [<span class="string">''</span>] * row_count</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(row_count):</span><br><span class="line">            <span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(self.columns):</span><br><span class="line">                line = data.splitlines()[max(<span class="number">0</span>, j - <span class="number">1</span>)]</span><br><span class="line">                <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">                    padding = <span class="string">' '</span> * (len(line) // <span class="number">2</span>)</span><br><span class="line">                    rows[j] += padding + str(i) + padding</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rows[j] += line</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span>) &lt; len(self.columns):</span><br><span class="line">                    rows[j] += <span class="string">' | '</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'\n'</span>.join(rows)</span><br><span class="line"></span><br><span class="line">columns = ColumnPrinter()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    columns.append(str(grid))</span><br><span class="line">    grid = simulate(grid)</span><br><span class="line"></span><br><span class="line">print(columns)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    0     |     1     |     2     |     3     |     4    </span></span><br><span class="line"><span class="string">---*----- | --------- | --------- | --------- | ---------</span></span><br><span class="line"><span class="string">----*---- | --*-*---- | ----*---- | ---*----- | ----*----</span></span><br><span class="line"><span class="string">--***---- | ---**---- | --*-*---- | ----**--- | -----*---</span></span><br><span class="line"><span class="string">--------- | ---*----- | ---**---- | ---**---- | ---***---</span></span><br><span class="line"><span class="string">--------- | --------- | --------- | --------- | ---------</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<h3 id="57-不要在每次fan-out时都新建一批Thread实例"><a href="#57-不要在每次fan-out时都新建一批Thread实例" class="headerlink" title="57. 不要在每次fan-out时都新建一批Thread实例"></a>57. 不要在每次fan-out时都新建一批Thread实例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line">ALIVE = <span class="string">'*'</span></span><br><span class="line">EMPTY = <span class="string">'-'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        self.height = height</span><br><span class="line">        self.width = width</span><br><span class="line">        self.rows = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.height):</span><br><span class="line">            self.rows.append([EMPTY] * self.width)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.rows[y % self.height][x % self.width]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        self.rows[y % self.height][x % self.width] = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        output = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> self.rows:</span><br><span class="line">            <span class="keyword">for</span> cell <span class="keyword">in</span> row:</span><br><span class="line">                output += cell</span><br><span class="line">            output += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockingGrid</span><span class="params">(Grid)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        super().__init__(height, width)</span><br><span class="line">        self.lock = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().__str__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().get(y, x)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().set(y, x, state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_neighbors</span><span class="params">(y, x, get)</span>:</span></span><br><span class="line">    n_ = get(y - <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># North</span></span><br><span class="line">    ne = get(y - <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Northeast</span></span><br><span class="line">    e_ = get(y + <span class="number">0</span>, x + <span class="number">1</span>)  <span class="comment"># East</span></span><br><span class="line">    se = get(y + <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Southeast</span></span><br><span class="line">    s_ = get(y + <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># South</span></span><br><span class="line">    sw = get(y + <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Southwest</span></span><br><span class="line">    w_ = get(y + <span class="number">0</span>, x - <span class="number">1</span>)  <span class="comment"># West</span></span><br><span class="line">    nw = get(y - <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Northwest</span></span><br><span class="line">    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> neighbor_states:</span><br><span class="line">        <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="comment"># def game_logic(state, neighbors):</span></span><br><span class="line"><span class="comment">#     # Do some blocking input/output in here:</span></span><br><span class="line"><span class="comment">#     data = my_socket.recv(100)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_logic</span><span class="params">(state, neighbors)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">        <span class="keyword">if</span> neighbors &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too few</span></span><br><span class="line">        <span class="keyword">elif</span> neighbors &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too many</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> neighbors == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> ALIVE     <span class="comment"># Regenerate</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step_cell</span><span class="params">(y, x, get, set)</span>:</span></span><br><span class="line">    state = get(y, x)</span><br><span class="line">    neighbors = count_neighbors(y, x, get)</span><br><span class="line">    next_state = game_logic(state, neighbors)</span><br><span class="line">    set(y, x, next_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulate_threaded</span><span class="params">(grid)</span>:</span></span><br><span class="line">    next_grid = LockingGrid(grid.height, grid.width)</span><br><span class="line"></span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(grid.height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(grid.width):</span><br><span class="line">            args = (y, x, grid.get, next_grid.set)</span><br><span class="line">            thread = Thread(target=step_cell, args=args)</span><br><span class="line">            thread.start()  <span class="comment"># Fan out</span></span><br><span class="line">            threads.append(thread)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">        thread.join()       <span class="comment"># Fan in</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next_grid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColumnPrinter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.columns = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.columns.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        row_count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> self.columns:</span><br><span class="line">            row_count = max(</span><br><span class="line">                row_count, len(data.splitlines()) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        rows = [<span class="string">''</span>] * row_count</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(row_count):</span><br><span class="line">            <span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(self.columns):</span><br><span class="line">                line = data.splitlines()[max(<span class="number">0</span>, j - <span class="number">1</span>)]</span><br><span class="line">                <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">                    padding = <span class="string">' '</span> * (len(line) // <span class="number">2</span>)</span><br><span class="line">                    rows[j] += padding + str(i) + padding</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rows[j] += line</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span>) &lt; len(self.columns):</span><br><span class="line">                    rows[j] += <span class="string">' | '</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'\n'</span>.join(rows)</span><br><span class="line"></span><br><span class="line">grid = LockingGrid(<span class="number">5</span>, <span class="number">9</span>)            <span class="comment"># Changed</span></span><br><span class="line">grid.set(<span class="number">0</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">1</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">2</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line"></span><br><span class="line">columns = ColumnPrinter()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    columns.append(str(grid))</span><br><span class="line">    grid = simulate_threaded(grid)  <span class="comment"># Changed</span></span><br><span class="line"></span><br><span class="line">print(columns)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="comment"># def game_logic(state, neighbors):</span></span><br><span class="line"><span class="comment">#     raise OSError('Problem with I/O')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">fake_stderr = io.StringIO()</span><br><span class="line"><span class="keyword">with</span> contextlib.redirect_stderr(fake_stderr):</span><br><span class="line">    thread = Thread(target=game_logic, args=(ALIVE, <span class="number">3</span>))</span><br><span class="line">    thread.start()</span><br><span class="line">    thread.join()</span><br><span class="line"></span><br><span class="line">print(fake_stderr.getvalue())</span><br></pre></td></tr></table></figure>
<h3 id="58-学会正确地重构代码，以便用Queue做并发"><a href="#58-学会正确地重构代码，以便用Queue做并发" class="headerlink" title="58. 学会正确地重构代码，以便用Queue做并发"></a>58. 学会正确地重构代码，以便用Queue做并发</h3><p>把队列与一定数量的线程搭配起来，可以高效的实现fan-out（分派）与fan-in（归集）。</p>
<h3 id="59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"><a href="#59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现" class="headerlink" title="59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"></a>59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">ALIVE = <span class="string">'*'</span></span><br><span class="line">EMPTY = <span class="string">'-'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        self.height = height</span><br><span class="line">        self.width = width</span><br><span class="line">        self.rows = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.height):</span><br><span class="line">            self.rows.append([EMPTY] * self.width)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.rows[y % self.height][x % self.width]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        self.rows[y % self.height][x % self.width] = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        output = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> self.rows:</span><br><span class="line">            <span class="keyword">for</span> cell <span class="keyword">in</span> row:</span><br><span class="line">                output += cell</span><br><span class="line">            output += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockingGrid</span><span class="params">(Grid)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        super().__init__(height, width)</span><br><span class="line">        self.lock = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().__str__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().get(y, x)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            <span class="keyword">return</span> super().set(y, x, state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_neighbors</span><span class="params">(y, x, get)</span>:</span></span><br><span class="line">    n_ = get(y - <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># North</span></span><br><span class="line">    ne = get(y - <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Northeast</span></span><br><span class="line">    e_ = get(y + <span class="number">0</span>, x + <span class="number">1</span>)  <span class="comment"># East</span></span><br><span class="line">    se = get(y + <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Southeast</span></span><br><span class="line">    s_ = get(y + <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># South</span></span><br><span class="line">    sw = get(y + <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Southwest</span></span><br><span class="line">    w_ = get(y + <span class="number">0</span>, x - <span class="number">1</span>)  <span class="comment"># West</span></span><br><span class="line">    nw = get(y - <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Northwest</span></span><br><span class="line">    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> neighbor_states:</span><br><span class="line">        <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="comment"># def game_logic(state, neighbors):</span></span><br><span class="line"><span class="comment">#     # Do some blocking input/output in here:</span></span><br><span class="line"><span class="comment">#     data = my_socket.recv(100)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game_logic</span><span class="params">(state, neighbors)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">        <span class="keyword">if</span> neighbors &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too few</span></span><br><span class="line">        <span class="keyword">elif</span> neighbors &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too many</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> neighbors == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> ALIVE     <span class="comment"># Regenerate</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step_cell</span><span class="params">(y, x, get, set)</span>:</span></span><br><span class="line">    state = get(y, x)</span><br><span class="line">    neighbors = count_neighbors(y, x, get)</span><br><span class="line">    next_state = game_logic(state, neighbors)</span><br><span class="line">    set(y, x, next_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulate_pool</span><span class="params">(pool, grid)</span>:</span></span><br><span class="line">    next_grid = LockingGrid(grid.height, grid.width)</span><br><span class="line"></span><br><span class="line">    futures = []</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(grid.height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(grid.width):</span><br><span class="line">            args = (y, x, grid.get, next_grid.set)</span><br><span class="line">            future = pool.submit(step_cell, *args)  <span class="comment"># Fan out</span></span><br><span class="line">            futures.append(future)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> futures:</span><br><span class="line">        future.result()                             <span class="comment"># Fan in</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next_grid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColumnPrinter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.columns = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.columns.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        row_count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> self.columns:</span><br><span class="line">            row_count = max(</span><br><span class="line">                row_count, len(data.splitlines()) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        rows = [<span class="string">''</span>] * row_count</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(row_count):</span><br><span class="line">            <span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(self.columns):</span><br><span class="line">                line = data.splitlines()[max(<span class="number">0</span>, j - <span class="number">1</span>)]</span><br><span class="line">                <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">                    padding = <span class="string">' '</span> * (len(line) // <span class="number">2</span>)</span><br><span class="line">                    rows[j] += padding + str(i) + padding</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rows[j] += line</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span>) &lt; len(self.columns):</span><br><span class="line">                    rows[j] += <span class="string">' | '</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'\n'</span>.join(rows)</span><br><span class="line"></span><br><span class="line">grid = LockingGrid(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">grid.set(<span class="number">0</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">1</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">2</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line"></span><br><span class="line">columns = ColumnPrinter()</span><br><span class="line"><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> pool:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        columns.append(str(grid))</span><br><span class="line">        grid = simulate_pool(pool, grid)</span><br><span class="line"></span><br><span class="line">print(columns)</span><br></pre></td></tr></table></figure>
<h3 id="60-用协程实现高并发的I-O"><a href="#60-用协程实现高并发的I-O" class="headerlink" title="60. 用协程实现高并发的I/O"></a>60. 用协程实现高并发的I/O</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">ALIVE = <span class="string">'*'</span></span><br><span class="line">EMPTY = <span class="string">'-'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grid</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, height, width)</span>:</span></span><br><span class="line">        self.height = height</span><br><span class="line">        self.width = width</span><br><span class="line">        self.rows = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(self.height):</span><br><span class="line">            self.rows.append([EMPTY] * self.width)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, y, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.rows[y % self.height][x % self.width]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(self, y, x, state)</span>:</span></span><br><span class="line">        self.rows[y % self.height][x % self.width] = state</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        output = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> self.rows:</span><br><span class="line">            <span class="keyword">for</span> cell <span class="keyword">in</span> row:</span><br><span class="line">                output += cell</span><br><span class="line">            output += <span class="string">'\n'</span></span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count_neighbors</span><span class="params">(y, x, get)</span>:</span></span><br><span class="line">    n_ = get(y - <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># North</span></span><br><span class="line">    ne = get(y - <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Northeast</span></span><br><span class="line">    e_ = get(y + <span class="number">0</span>, x + <span class="number">1</span>)  <span class="comment"># East</span></span><br><span class="line">    se = get(y + <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Southeast</span></span><br><span class="line">    s_ = get(y + <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># South</span></span><br><span class="line">    sw = get(y + <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Southwest</span></span><br><span class="line">    w_ = get(y + <span class="number">0</span>, x - <span class="number">1</span>)  <span class="comment"># West</span></span><br><span class="line">    nw = get(y - <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Northwest</span></span><br><span class="line">    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> neighbor_states:</span><br><span class="line">        <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">game_logic</span><span class="params">(state, neighbors)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">        <span class="keyword">if</span> neighbors &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too few</span></span><br><span class="line">        <span class="keyword">elif</span> neighbors &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too many</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> neighbors == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> ALIVE     <span class="comment"># Regenerate</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">step_cell</span><span class="params">(y, x, get, set)</span>:</span></span><br><span class="line">    state = get(y, x)</span><br><span class="line">    neighbors = count_neighbors(y, x, get)</span><br><span class="line">    next_state = <span class="keyword">await</span> game_logic(state, neighbors)</span><br><span class="line">    set(y, x, next_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">simulate</span><span class="params">(grid)</span>:</span></span><br><span class="line">    next_grid = Grid(grid.height, grid.width)</span><br><span class="line"></span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(grid.height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> range(grid.width):</span><br><span class="line">            task = step_cell(</span><br><span class="line">                y, x, grid.get, next_grid.set)      <span class="comment"># Fan out</span></span><br><span class="line">            tasks.append(task)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*tasks)                    <span class="comment"># Fan in</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next_grid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColumnPrinter</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.columns = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.columns.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        row_count = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> self.columns:</span><br><span class="line">            row_count = max(</span><br><span class="line">                row_count, len(data.splitlines()) + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        rows = [<span class="string">''</span>] * row_count</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(row_count):</span><br><span class="line">            <span class="keyword">for</span> i, data <span class="keyword">in</span> enumerate(self.columns):</span><br><span class="line">                line = data.splitlines()[max(<span class="number">0</span>, j - <span class="number">1</span>)]</span><br><span class="line">                <span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">                    padding = <span class="string">' '</span> * (len(line) // <span class="number">2</span>)</span><br><span class="line">                    rows[j] += padding + str(i) + padding</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    rows[j] += line</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i + <span class="number">1</span>) &lt; len(self.columns):</span><br><span class="line">                    rows[j] += <span class="string">' | '</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'\n'</span>.join(rows)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">grid = Grid(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">grid.set(<span class="number">0</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">1</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">2</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line"></span><br><span class="line">columns = ColumnPrinter()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    columns.append(str(grid))</span><br><span class="line">    grid = asyncio.run(simulate(grid))   <span class="comment"># Run the event loop</span></span><br><span class="line"></span><br><span class="line">print(columns)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">count_neighbors</span><span class="params">(y, x, get)</span>:</span></span><br><span class="line">    n_ = get(y - <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># North</span></span><br><span class="line">    ne = get(y - <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Northeast</span></span><br><span class="line">    e_ = get(y + <span class="number">0</span>, x + <span class="number">1</span>)  <span class="comment"># East</span></span><br><span class="line">    se = get(y + <span class="number">1</span>, x + <span class="number">1</span>)  <span class="comment"># Southeast</span></span><br><span class="line">    s_ = get(y + <span class="number">1</span>, x + <span class="number">0</span>)  <span class="comment"># South</span></span><br><span class="line">    sw = get(y + <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Southwest</span></span><br><span class="line">    w_ = get(y + <span class="number">0</span>, x - <span class="number">1</span>)  <span class="comment"># West</span></span><br><span class="line">    nw = get(y - <span class="number">1</span>, x - <span class="number">1</span>)  <span class="comment"># Northwest</span></span><br><span class="line">    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> state <span class="keyword">in</span> neighbor_states:</span><br><span class="line">        <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">step_cell</span><span class="params">(y, x, get, set)</span>:</span></span><br><span class="line">    state = get(y, x)</span><br><span class="line">    neighbors = <span class="keyword">await</span> count_neighbors(y, x, get)</span><br><span class="line">    next_state = <span class="keyword">await</span> game_logic(state, neighbors)</span><br><span class="line">    set(y, x, next_state)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">game_logic</span><span class="params">(state, neighbors)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> state == ALIVE:</span><br><span class="line">        <span class="keyword">if</span> neighbors &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too few</span></span><br><span class="line">        <span class="keyword">elif</span> neighbors &gt; <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> EMPTY     <span class="comment"># Die: Too many</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> neighbors == <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> ALIVE     <span class="comment"># Regenerate</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br><span class="line"></span><br><span class="line">grid = Grid(<span class="number">5</span>, <span class="number">9</span>)</span><br><span class="line">grid.set(<span class="number">0</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">1</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">2</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">3</span>, ALIVE)</span><br><span class="line">grid.set(<span class="number">2</span>, <span class="number">4</span>, ALIVE)</span><br><span class="line"></span><br><span class="line">columns = ColumnPrinter()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">    columns.append(str(grid))</span><br><span class="line">    grid = asyncio.run(simulate(grid))</span><br><span class="line"></span><br><span class="line">print(columns)</span><br></pre></td></tr></table></figure>
<h3 id="61-学会用asyncio改写那些通过线程实现的I-O"><a href="#61-学会用asyncio改写那些通过线程实现的I-O" class="headerlink" title="61. 学会用asyncio改写那些通过线程实现的I/O"></a>61. 学会用asyncio改写那些通过线程实现的I/O</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EOFError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionBase</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, connection)</span>:</span></span><br><span class="line">        self.connection = connection</span><br><span class="line">        self.file = connection.makefile(<span class="string">'rb'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, command)</span>:</span></span><br><span class="line">        line = command + <span class="string">'\n'</span></span><br><span class="line">        data = line.encode()</span><br><span class="line">        self.connection.send(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span><span class="params">(self)</span>:</span></span><br><span class="line">        line = self.file.readline()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">raise</span> EOFError(<span class="string">'Connection closed'</span>)</span><br><span class="line">        <span class="keyword">return</span> line[:<span class="number">-1</span>].decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">WARMER = <span class="string">'Warmer'</span></span><br><span class="line">COLDER = <span class="string">'Colder'</span></span><br><span class="line">UNSURE = <span class="string">'Unsure'</span></span><br><span class="line">CORRECT = <span class="string">'Correct'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnknownCommandError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span><span class="params">(ConnectionBase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        super().__init__(*args)</span><br><span class="line">        self._clear_state(<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_clear_state</span><span class="params">(self, lower, upper)</span>:</span></span><br><span class="line">        self.lower = lower</span><br><span class="line">        self.upper = upper</span><br><span class="line">        self.secret = <span class="literal">None</span></span><br><span class="line">        self.guesses = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> command := self.receive():</span><br><span class="line">            parts = command.split(<span class="string">' '</span>)</span><br><span class="line">            <span class="keyword">if</span> parts[<span class="number">0</span>] == <span class="string">'PARAMS'</span>:</span><br><span class="line">                self.set_params(parts)</span><br><span class="line">            <span class="keyword">elif</span> parts[<span class="number">0</span>] == <span class="string">'NUMBER'</span>:</span><br><span class="line">                self.send_number()</span><br><span class="line">            <span class="keyword">elif</span> parts[<span class="number">0</span>] == <span class="string">'REPORT'</span>:</span><br><span class="line">                self.receive_report(parts)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> UnknownCommandError(command)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_params</span><span class="params">(self, parts)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> len(parts) == <span class="number">3</span></span><br><span class="line">        lower = int(parts[<span class="number">1</span>])</span><br><span class="line">        upper = int(parts[<span class="number">2</span>])</span><br><span class="line">        self._clear_state(lower, upper)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_guess</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.secret <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self.secret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            guess = random.randint(self.lower, self.upper)</span><br><span class="line">            <span class="keyword">if</span> guess <span class="keyword">not</span> <span class="keyword">in</span> self.guesses:</span><br><span class="line">                <span class="keyword">return</span> guess</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send_number</span><span class="params">(self)</span>:</span></span><br><span class="line">        guess = self.next_guess()</span><br><span class="line">        self.guesses.append(guess)</span><br><span class="line">        self.send(format(guess))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive_report</span><span class="params">(self, parts)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> len(parts) == <span class="number">2</span></span><br><span class="line">        decision = parts[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        last = self.guesses[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span> decision == CORRECT:</span><br><span class="line">            self.secret = last</span><br><span class="line"></span><br><span class="line">        print(<span class="string">f'Server: <span class="subst">&#123;last&#125;</span> is <span class="subst">&#123;decision&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">(ConnectionBase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        super().__init__(*args)</span><br><span class="line">        self._clear_state()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_clear_state</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.secret = <span class="literal">None</span></span><br><span class="line">        self.last_distance = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="meta">    @contextlib.contextmanager</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">session</span><span class="params">(self, lower, upper, secret)</span>:</span></span><br><span class="line">        print(<span class="string">f'Guess a number between <span class="subst">&#123;lower&#125;</span> and <span class="subst">&#123;upper&#125;</span>!'</span></span><br><span class="line">              <span class="string">f' Shhhhh, it\'s <span class="subst">&#123;secret&#125;</span>.'</span>)</span><br><span class="line">        self.secret = secret</span><br><span class="line">        self.send(<span class="string">f'PARAMS <span class="subst">&#123;lower&#125;</span> <span class="subst">&#123;upper&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._clear_state()</span><br><span class="line">            self.send(<span class="string">'PARAMS 0 -1'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request_numbers</span><span class="params">(self, count)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(count):</span><br><span class="line">            self.send(<span class="string">'NUMBER'</span>)</span><br><span class="line">            data = self.receive()</span><br><span class="line">            <span class="keyword">yield</span> int(data)</span><br><span class="line">            <span class="keyword">if</span> self.last_distance == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">report_outcome</span><span class="params">(self, number)</span>:</span></span><br><span class="line">        new_distance = math.fabs(number - self.secret)</span><br><span class="line">        decision = UNSURE</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_distance == <span class="number">0</span>:</span><br><span class="line">            decision = CORRECT</span><br><span class="line">        <span class="keyword">elif</span> self.last_distance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">elif</span> new_distance &lt; self.last_distance:</span><br><span class="line">            decision = WARMER</span><br><span class="line">        <span class="keyword">elif</span> new_distance &gt; self.last_distance:</span><br><span class="line">            decision = COLDER</span><br><span class="line"></span><br><span class="line">        self.last_distance = new_distance</span><br><span class="line"></span><br><span class="line">        self.send(<span class="string">f'REPORT <span class="subst">&#123;decision&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">return</span> decision</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_connection</span><span class="params">(connection)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> connection:</span><br><span class="line">        session = Session(connection)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            session.loop()</span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_server</span><span class="params">(address)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> socket.socket() <span class="keyword">as</span> listener:</span><br><span class="line">        <span class="comment"># Allow the port to be reused</span></span><br><span class="line">        listener.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        listener.bind(address)</span><br><span class="line">        listener.listen()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            connection, _ = listener.accept()</span><br><span class="line">            thread = Thread(target=handle_connection,</span><br><span class="line">                            args=(connection,),</span><br><span class="line">                            daemon=<span class="literal">True</span>)</span><br><span class="line">            thread.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_client</span><span class="params">(address)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> socket.create_connection(address) <span class="keyword">as</span> connection:</span><br><span class="line">        client = Client(connection)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> client.session(<span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>):</span><br><span class="line">            results = [(x, client.report_outcome(x))</span><br><span class="line">                       <span class="keyword">for</span> x <span class="keyword">in</span> client.request_numbers(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> client.session(<span class="number">10</span>, <span class="number">15</span>, <span class="number">12</span>):</span><br><span class="line">            <span class="keyword">for</span> number <span class="keyword">in</span> client.request_numbers(<span class="number">5</span>):</span><br><span class="line">                outcome = client.report_outcome(number)</span><br><span class="line">                results.append((number, outcome))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    address = (<span class="string">'127.0.0.1'</span>, <span class="number">1234</span>)</span><br><span class="line">    server_thread = Thread(</span><br><span class="line">        target=run_server, args=(address,), daemon=<span class="literal">True</span>)</span><br><span class="line">    server_thread.start()</span><br><span class="line"></span><br><span class="line">    results = run_client(address)</span><br><span class="line">    <span class="keyword">for</span> number, outcome <span class="keyword">in</span> results:</span><br><span class="line">        print(<span class="string">f'Client: <span class="subst">&#123;number&#125;</span> is <span class="subst">&#123;outcome&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncConnectionBase</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, reader, writer)</span>:</span>             <span class="comment"># Changed</span></span><br><span class="line">        self.reader = reader                        <span class="comment"># Changed</span></span><br><span class="line">        self.writer = writer                        <span class="comment"># Changed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, command)</span>:</span></span><br><span class="line">        line = command + <span class="string">'\n'</span></span><br><span class="line">        data = line.encode()</span><br><span class="line">        self.writer.write(data)                     <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">await</span> self.writer.drain()                   <span class="comment"># Changed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">receive</span><span class="params">(self)</span>:</span></span><br><span class="line">        line = <span class="keyword">await</span> self.reader.readline()         <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">raise</span> EOFError(<span class="string">'Connection closed'</span>)</span><br><span class="line">        <span class="keyword">return</span> line[:<span class="number">-1</span>].decode()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncSession</span><span class="params">(AsyncConnectionBase)</span>:</span>            <span class="comment"># Changed</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        super().__init__(*args)</span><br><span class="line">        self._clear_values(<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_clear_values</span><span class="params">(self, lower, upper)</span>:</span></span><br><span class="line">        self.lower = lower</span><br><span class="line">        self.upper = upper</span><br><span class="line">        self.secret = <span class="literal">None</span></span><br><span class="line">        self.guesses = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 16</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(self)</span>:</span>                           <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">while</span> command := <span class="keyword">await</span> self.receive():      <span class="comment"># Changed</span></span><br><span class="line">            parts = command.split(<span class="string">' '</span>)</span><br><span class="line">            <span class="keyword">if</span> parts[<span class="number">0</span>] == <span class="string">'PARAMS'</span>:</span><br><span class="line">                self.set_params(parts)</span><br><span class="line">            <span class="keyword">elif</span> parts[<span class="number">0</span>] == <span class="string">'NUMBER'</span>:</span><br><span class="line">                <span class="keyword">await</span> self.send_number()            <span class="comment"># Changed</span></span><br><span class="line">            <span class="keyword">elif</span> parts[<span class="number">0</span>] == <span class="string">'REPORT'</span>:</span><br><span class="line">                self.receive_report(parts)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> UnknownCommandError(command)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 17</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_params</span><span class="params">(self, parts)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> len(parts) == <span class="number">3</span></span><br><span class="line">        lower = int(parts[<span class="number">1</span>])</span><br><span class="line">        upper = int(parts[<span class="number">2</span>])</span><br><span class="line">        self._clear_values(lower, upper)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 18</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_guess</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.secret <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self.secret</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            guess = random.randint(self.lower, self.upper)</span><br><span class="line">            <span class="keyword">if</span> guess <span class="keyword">not</span> <span class="keyword">in</span> self.guesses:</span><br><span class="line">                <span class="keyword">return</span> guess</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">send_number</span><span class="params">(self)</span>:</span>                    <span class="comment"># Changed</span></span><br><span class="line">        guess = self.next_guess()</span><br><span class="line">        self.guesses.append(guess)</span><br><span class="line">        <span class="keyword">await</span> self.send(format(guess))              <span class="comment"># Changed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 19</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive_report</span><span class="params">(self, parts)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> len(parts) == <span class="number">2</span></span><br><span class="line">        decision = parts[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        last = self.guesses[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span> decision == CORRECT:</span><br><span class="line">            self.secret = last</span><br><span class="line"></span><br><span class="line">        print(<span class="string">f'Server: <span class="subst">&#123;last&#125;</span> is <span class="subst">&#123;decision&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 20</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncClient</span><span class="params">(AsyncConnectionBase)</span>:</span>             <span class="comment"># Changed</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        super().__init__(*args)</span><br><span class="line">        self._clear_state()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_clear_state</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.secret = <span class="literal">None</span></span><br><span class="line">        self.last_distance = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 21</span></span><br><span class="line"><span class="meta">    @contextlib.asynccontextmanager                 # Changed</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">session</span><span class="params">(self, lower, upper, secret)</span>:</span>  <span class="comment"># Changed</span></span><br><span class="line">        print(<span class="string">f'Guess a number between <span class="subst">&#123;lower&#125;</span> and <span class="subst">&#123;upper&#125;</span>!'</span></span><br><span class="line">              <span class="string">f' Shhhhh, it\'s <span class="subst">&#123;secret&#125;</span>.'</span>)</span><br><span class="line">        self.secret = secret</span><br><span class="line">        <span class="keyword">await</span> self.send(<span class="string">f'PARAMS <span class="subst">&#123;lower&#125;</span> <span class="subst">&#123;upper&#125;</span>'</span>)  <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self._clear_state()</span><br><span class="line">            <span class="keyword">await</span> self.send(<span class="string">'PARAMS 0 -1'</span>)          <span class="comment"># Changed</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 22</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request_numbers</span><span class="params">(self, count)</span>:</span>         <span class="comment"># Changed</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(count):</span><br><span class="line">            <span class="keyword">await</span> self.send(<span class="string">'NUMBER'</span>)               <span class="comment"># Changed</span></span><br><span class="line">            data = <span class="keyword">await</span> self.receive()             <span class="comment"># Changed</span></span><br><span class="line">            <span class="keyword">yield</span> int(data)</span><br><span class="line">            <span class="keyword">if</span> self.last_distance == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 23</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">report_outcome</span><span class="params">(self, number)</span>:</span>         <span class="comment"># Changed</span></span><br><span class="line">        new_distance = math.fabs(number - self.secret)</span><br><span class="line">        decision = UNSURE</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> new_distance == <span class="number">0</span>:</span><br><span class="line">            decision = CORRECT</span><br><span class="line">        <span class="keyword">elif</span> self.last_distance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">elif</span> new_distance &lt; self.last_distance:</span><br><span class="line">            decision = WARMER</span><br><span class="line">        <span class="keyword">elif</span> new_distance &gt; self.last_distance:</span><br><span class="line">            decision = COLDER</span><br><span class="line"></span><br><span class="line">        self.last_distance = new_distance</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> self.send(<span class="string">f'REPORT <span class="subst">&#123;decision&#125;</span>'</span>)       <span class="comment"># Changed</span></span><br><span class="line">        <span class="comment"># Make it so the output printing is in</span></span><br><span class="line">        <span class="comment"># the same order as the threaded version.</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)</span><br><span class="line">        <span class="keyword">return</span> decision</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 24</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle_async_connection</span><span class="params">(reader, writer)</span>:</span></span><br><span class="line">    session = AsyncSession(reader, writer)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">await</span> session.loop()</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_async_server</span><span class="params">(address)</span>:</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(</span><br><span class="line">        handle_async_connection, *address)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 25</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_async_client</span><span class="params">(address)</span>:</span></span><br><span class="line">    <span class="comment"># Wait for the server to listen before trying to connect</span></span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    streams = <span class="keyword">await</span> asyncio.open_connection(*address)   <span class="comment"># New</span></span><br><span class="line">    client = AsyncClient(*streams)                      <span class="comment"># New</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.session(<span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>):</span><br><span class="line">        results = [(x, <span class="keyword">await</span> client.report_outcome(x))</span><br><span class="line">                   <span class="keyword">async</span> <span class="keyword">for</span> x <span class="keyword">in</span> client.request_numbers(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> client.session(<span class="number">10</span>, <span class="number">15</span>, <span class="number">12</span>):</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> number <span class="keyword">in</span> client.request_numbers(<span class="number">5</span>):</span><br><span class="line">            outcome = <span class="keyword">await</span> client.report_outcome(number)</span><br><span class="line">            results.append((number, outcome))</span><br><span class="line"></span><br><span class="line">    _, writer = streams                                 <span class="comment"># New</span></span><br><span class="line">    writer.close()                                      <span class="comment"># New</span></span><br><span class="line">    <span class="keyword">await</span> writer.wait_closed()                          <span class="comment"># New</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 26</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main_async</span><span class="params">()</span>:</span></span><br><span class="line">    address = (<span class="string">'127.0.0.1'</span>, <span class="number">4321</span>)</span><br><span class="line"></span><br><span class="line">    server = run_async_server(address)</span><br><span class="line">    asyncio.create_task(server)</span><br><span class="line"></span><br><span class="line">    results = <span class="keyword">await</span> run_async_client(address)</span><br><span class="line">    <span class="keyword">for</span> number, outcome <span class="keyword">in</span> results:</span><br><span class="line">        print(<span class="string">f'Client: <span class="subst">&#123;number&#125;</span> is <span class="subst">&#123;outcome&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line">logging.getLogger().setLevel(logging.ERROR)</span><br><span class="line"></span><br><span class="line">asyncio.run(main_async())</span><br><span class="line"></span><br><span class="line">logging.getLogger().setLevel(logging.DEBUG)</span><br></pre></td></tr></table></figure>
<h3 id="62-结合线程与协程，将代码顺利迁移到asyncio"><a href="#62-结合线程与协程，将代码顺利迁移到asyncio" class="headerlink" title="62. 结合线程与协程，将代码顺利迁移到asyncio"></a>62. 结合线程与协程，将代码顺利迁移到asyncio</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoNewData</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readline</span><span class="params">(handle)</span>:</span></span><br><span class="line">    offset = handle.tell()</span><br><span class="line">    handle.seek(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">    length = handle.tell()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> length == offset:</span><br><span class="line">        <span class="keyword">raise</span> NoNewData</span><br><span class="line"></span><br><span class="line">    handle.seek(offset, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> handle.readline()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tail_file</span><span class="params">(handle, interval, write_func)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> handle.closed:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            line = readline(handle)</span><br><span class="line">        <span class="keyword">except</span> NoNewData:</span><br><span class="line">            time.sleep(interval)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            write_func(line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock, Thread</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_threads</span><span class="params">(handles, interval, output_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'wb'</span>) <span class="keyword">as</span> output:</span><br><span class="line">        lock = Lock()</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(data)</span>:</span></span><br><span class="line">            <span class="keyword">with</span> lock:</span><br><span class="line">                output.write(data)</span><br><span class="line"></span><br><span class="line">        threads = []</span><br><span class="line">        <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">            args = (handle, interval, write)</span><br><span class="line">            thread = Thread(target=tail_file, args=args)</span><br><span class="line">            thread.start()</span><br><span class="line">            threads.append(thread)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">            thread.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="comment"># This is all code to simulate the writers to the handles</span></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> TemporaryDirectory</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_random_data</span><span class="params">(path, write_count, interval)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(write_count):</span><br><span class="line">            time.sleep(random.random() * interval)</span><br><span class="line">            letters = random.choices(</span><br><span class="line">                string.ascii_lowercase, k=<span class="number">10</span>)</span><br><span class="line">            data = <span class="string">f'<span class="subst">&#123;path&#125;</span>-<span class="subst">&#123;i:<span class="number">02</span>&#125;</span>-<span class="subst">&#123;<span class="string">""</span>.join(letters)&#125;</span>\n'</span></span><br><span class="line">            f.write(data.encode())</span><br><span class="line">            f.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_write_threads</span><span class="params">(directory, file_count)</span>:</span></span><br><span class="line">    paths = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(file_count):</span><br><span class="line">        path = os.path.join(directory, str(i))</span><br><span class="line">        <span class="keyword">with</span> open(path, <span class="string">'w'</span>):</span><br><span class="line">            <span class="comment"># Make sure the file at this path will exist when</span></span><br><span class="line">            <span class="comment"># the reading thread tries to poll it.</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        paths.append(path)</span><br><span class="line">        args = (path, <span class="number">10</span>, <span class="number">0.1</span>)</span><br><span class="line">        thread = Thread(target=write_random_data, args=args)</span><br><span class="line">        thread.start()</span><br><span class="line">    <span class="keyword">return</span> paths</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_all</span><span class="params">(handles)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">        handle.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    tmpdir = TemporaryDirectory()</span><br><span class="line">    input_paths = start_write_threads(tmpdir.name, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    handles = []</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">        handle = open(path, <span class="string">'rb'</span>)</span><br><span class="line">        handles.append(handle)</span><br><span class="line"></span><br><span class="line">    Thread(target=close_all, args=(handles,)).start()</span><br><span class="line"></span><br><span class="line">    output_path = os.path.join(tmpdir.name, <span class="string">'merged'</span>)</span><br><span class="line">    <span class="keyword">return</span> tmpdir, input_paths, handles, output_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">confirm_merge</span><span class="params">(input_paths, output_path)</span>:</span></span><br><span class="line">    found = collections.defaultdict(list)</span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">                <span class="keyword">if</span> line.find(path.encode()) == <span class="number">0</span>:</span><br><span class="line">                    found[path].append(line)</span><br><span class="line"></span><br><span class="line">    expected = collections.defaultdict(list)</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">        <span class="keyword">with</span> open(path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            expected[path].extend(f.readlines())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key, expected_lines <span class="keyword">in</span> expected.items():</span><br><span class="line">        found_lines = found[key]</span><br><span class="line">        <span class="keyword">assert</span> expected_lines == found_lines, \</span><br><span class="line">            <span class="string">f'<span class="subst">&#123;expected_lines!r&#125;</span> == <span class="subst">&#123;found_lines!r&#125;</span>'</span></span><br><span class="line"></span><br><span class="line">input_paths = ...</span><br><span class="line">handles = ...</span><br><span class="line">output_path = ...</span><br><span class="line"></span><br><span class="line">tmpdir, input_paths, handles, output_path = setup()</span><br><span class="line"></span><br><span class="line">run_threads(handles, <span class="number">0.1</span>, output_path)</span><br><span class="line"></span><br><span class="line">confirm_merge(input_paths, output_path)</span><br><span class="line"></span><br><span class="line">tmpdir.cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Windows, a ProactorEventLoop can't be created within</span></span><br><span class="line"><span class="comment"># threads because it tries to register signal handlers. This</span></span><br><span class="line"><span class="comment"># is a work-around to always use the SelectorEventLoop policy</span></span><br><span class="line"><span class="comment"># instead. See: https://bugs.python.org/issue33792</span></span><br><span class="line">policy = asyncio.get_event_loop_policy()</span><br><span class="line">policy._loop_factory = asyncio.SelectorEventLoop</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_tasks_mixed</span><span class="params">(handles, interval, output_path)</span>:</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'wb'</span>) <span class="keyword">as</span> output:</span><br><span class="line">        <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_async</span><span class="params">(data)</span>:</span></span><br><span class="line">            output.write(data)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(data)</span>:</span></span><br><span class="line">            coro = write_async(data)</span><br><span class="line">            future = asyncio.run_coroutine_threadsafe(</span><br><span class="line">                coro, loop)</span><br><span class="line">            future.result()</span><br><span class="line"></span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">            task = loop.run_in_executor(</span><br><span class="line">                <span class="literal">None</span>, tail_file, handle, interval, write)</span><br><span class="line">            tasks.append(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">input_paths = ...</span><br><span class="line">handles = ...</span><br><span class="line">output_path = ...</span><br><span class="line"></span><br><span class="line">tmpdir, input_paths, handles, output_path = setup()</span><br><span class="line"></span><br><span class="line">asyncio.run(run_tasks_mixed(handles, <span class="number">0.1</span>, output_path))</span><br><span class="line"></span><br><span class="line">confirm_merge(input_paths, output_path)</span><br><span class="line"></span><br><span class="line">tmpdir.cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">tail_async</span><span class="params">(handle, interval, write_func)</span>:</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> handle.closed:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            line = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">                <span class="literal">None</span>, readline, handle)</span><br><span class="line">        <span class="keyword">except</span> NoNewData:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(interval)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> write_func(line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_tasks</span><span class="params">(handles, interval, output_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'wb'</span>) <span class="keyword">as</span> output:</span><br><span class="line">        <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_async</span><span class="params">(data)</span>:</span></span><br><span class="line">            output.write(data)</span><br><span class="line"></span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">            coro = tail_async(handle, interval, write_async)</span><br><span class="line">            task = asyncio.create_task(coro)</span><br><span class="line">            tasks.append(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">input_paths = ...</span><br><span class="line">handles = ...</span><br><span class="line">output_path = ...</span><br><span class="line"></span><br><span class="line">tmpdir, input_paths, handles, output_path = setup()</span><br><span class="line"></span><br><span class="line">asyncio.run(run_tasks(handles, <span class="number">0.1</span>, output_path))</span><br><span class="line"></span><br><span class="line">confirm_merge(input_paths, output_path)</span><br><span class="line"></span><br><span class="line">tmpdir.cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tail_file</span><span class="params">(handle, interval, write_func)</span>:</span></span><br><span class="line">    loop = asyncio.new_event_loop()</span><br><span class="line">    asyncio.set_event_loop(loop)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_async</span><span class="params">(data)</span>:</span></span><br><span class="line">        write_func(data)</span><br><span class="line"></span><br><span class="line">    coro = tail_async(handle, interval, write_async)</span><br><span class="line">    loop.run_until_complete(coro)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line">input_paths = ...</span><br><span class="line">handles = ...</span><br><span class="line">output_path = ...</span><br><span class="line"></span><br><span class="line">tmpdir, input_paths, handles, output_path = setup()</span><br><span class="line"></span><br><span class="line">run_threads(handles, <span class="number">0.1</span>, output_path)</span><br><span class="line"></span><br><span class="line">confirm_merge(input_paths, output_path)</span><br><span class="line"></span><br><span class="line">tmpdir.cleanup()</span><br></pre></td></tr></table></figure>
<h3 id="63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"><a href="#63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力" class="headerlink" title="63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"></a>63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力</h3><p>调用asyncio.run时，可以把debug参数设置成为true，这样可以知道哪些协程降低了事件循环的速度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="comment"># On Windows, a ProactorEventLoop can't be created within</span></span><br><span class="line"><span class="comment"># threads because it tries to register signal handlers. This</span></span><br><span class="line"><span class="comment"># is a work-around to always use the SelectorEventLoop policy</span></span><br><span class="line"><span class="comment"># instead. See: https://bugs.python.org/issue33792</span></span><br><span class="line">policy = asyncio.get_event_loop_policy()</span><br><span class="line">policy._loop_factory = asyncio.SelectorEventLoop</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_tasks</span><span class="params">(handles, interval, output_path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'wb'</span>) <span class="keyword">as</span> output:</span><br><span class="line">        <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_async</span><span class="params">(data)</span>:</span></span><br><span class="line">            output.write(data)</span><br><span class="line"></span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">            coro = tail_async(handle, interval, write_async)</span><br><span class="line">            task = asyncio.create_task(coro)</span><br><span class="line">            tasks.append(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">slow_coroutine</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">0.5</span>)  <span class="comment"># Simulating slow I/O</span></span><br><span class="line"></span><br><span class="line">asyncio.run(slow_coroutine(), debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WriteThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, output_path)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.output_path = output_path</span><br><span class="line">        self.output = <span class="literal">None</span></span><br><span class="line">        self.loop = asyncio.new_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        asyncio.set_event_loop(self.loop)</span><br><span class="line">        <span class="keyword">with</span> open(self.output_path, <span class="string">'wb'</span>) <span class="keyword">as</span> self.output:</span><br><span class="line">            self.loop.run_forever()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Run one final round of callbacks so the await on</span></span><br><span class="line">        <span class="comment"># stop() in another event loop will be resolved.</span></span><br><span class="line">        self.loop.run_until_complete(asyncio.sleep(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">real_write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.output.write(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        coro = self.real_write(data)</span><br><span class="line">        future = asyncio.run_coroutine_threadsafe(</span><br><span class="line">            coro, self.loop)</span><br><span class="line">        <span class="keyword">await</span> asyncio.wrap_future(future)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">real_stop</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.loop.stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></span><br><span class="line">        coro = self.real_stop()</span><br><span class="line">        future = asyncio.run_coroutine_threadsafe(</span><br><span class="line">            coro, self.loop)</span><br><span class="line">        <span class="keyword">await</span> asyncio.wrap_future(future)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">__aenter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        loop = asyncio.get_event_loop()</span><br><span class="line">        <span class="keyword">await</span> loop.run_in_executor(<span class="literal">None</span>, self.start)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">__aexit__</span><span class="params">(self, *_)</span>:</span></span><br><span class="line">        <span class="keyword">await</span> self.stop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoNewData</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readline</span><span class="params">(handle)</span>:</span></span><br><span class="line">    offset = handle.tell()</span><br><span class="line">    handle.seek(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">    length = handle.tell()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> length == offset:</span><br><span class="line">        <span class="keyword">raise</span> NoNewData</span><br><span class="line"></span><br><span class="line">    handle.seek(offset, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> handle.readline()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">tail_async</span><span class="params">(handle, interval, write_func)</span>:</span></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> handle.closed:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            line = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">                <span class="literal">None</span>, readline, handle)</span><br><span class="line">        <span class="keyword">except</span> NoNewData:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(interval)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">await</span> write_func(line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run_fully_async</span><span class="params">(handles, interval, output_path)</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> WriteThread(output_path) <span class="keyword">as</span> output:</span><br><span class="line">        tasks = []</span><br><span class="line">        <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">            coro = tail_async(handle, interval, output.write)</span><br><span class="line">            task = asyncio.create_task(coro)</span><br><span class="line">            tasks.append(task)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="comment"># This is all code to simulate the writers to the handles</span></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> TemporaryDirectory</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_random_data</span><span class="params">(path, write_count, interval)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(write_count):</span><br><span class="line">            time.sleep(random.random() * interval)</span><br><span class="line">            letters = random.choices(</span><br><span class="line">                string.ascii_lowercase, k=<span class="number">10</span>)</span><br><span class="line">            data = <span class="string">f'<span class="subst">&#123;path&#125;</span>-<span class="subst">&#123;i:<span class="number">02</span>&#125;</span>-<span class="subst">&#123;<span class="string">""</span>.join(letters)&#125;</span>\n'</span></span><br><span class="line">            f.write(data.encode())</span><br><span class="line">            f.flush()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_write_threads</span><span class="params">(directory, file_count)</span>:</span></span><br><span class="line">    paths = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(file_count):</span><br><span class="line">        path = os.path.join(directory, str(i))</span><br><span class="line">        <span class="keyword">with</span> open(path, <span class="string">'w'</span>):</span><br><span class="line">            <span class="comment"># Make sure the file at this path will exist when</span></span><br><span class="line">            <span class="comment"># the reading thread tries to poll it.</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        paths.append(path)</span><br><span class="line">        args = (path, <span class="number">10</span>, <span class="number">0.1</span>)</span><br><span class="line">        thread = Thread(target=write_random_data, args=args)</span><br><span class="line">        thread.start()</span><br><span class="line">    <span class="keyword">return</span> paths</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">close_all</span><span class="params">(handles)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> handle <span class="keyword">in</span> handles:</span><br><span class="line">        handle.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">()</span>:</span></span><br><span class="line">    tmpdir = TemporaryDirectory()</span><br><span class="line">    input_paths = start_write_threads(tmpdir.name, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    handles = []</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">        handle = open(path, <span class="string">'rb'</span>)</span><br><span class="line">        handles.append(handle)</span><br><span class="line"></span><br><span class="line">    Thread(target=close_all, args=(handles,)).start()</span><br><span class="line"></span><br><span class="line">    output_path = os.path.join(tmpdir.name, <span class="string">'merged'</span>)</span><br><span class="line">    <span class="keyword">return</span> tmpdir, input_paths, handles, output_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">confirm_merge</span><span class="params">(input_paths, output_path)</span>:</span></span><br><span class="line">    found = collections.defaultdict(list)</span><br><span class="line">    <span class="keyword">with</span> open(output_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">                <span class="keyword">if</span> line.find(path.encode()) == <span class="number">0</span>:</span><br><span class="line">                    found[path].append(line)</span><br><span class="line"></span><br><span class="line">    expected = collections.defaultdict(list)</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> input_paths:</span><br><span class="line">        <span class="keyword">with</span> open(path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            expected[path].extend(f.readlines())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> key, expected_lines <span class="keyword">in</span> expected.items():</span><br><span class="line">        found_lines = found[key]</span><br><span class="line">        <span class="keyword">assert</span> expected_lines == found_lines</span><br><span class="line"></span><br><span class="line">input_paths = ...</span><br><span class="line">handles = ...</span><br><span class="line">output_path = ...</span><br><span class="line"></span><br><span class="line">tmpdir, input_paths, handles, output_path = setup()</span><br><span class="line"></span><br><span class="line">asyncio.run(run_fully_async(handles, <span class="number">0.1</span>, output_path))</span><br><span class="line"></span><br><span class="line">confirm_merge(input_paths, output_path)</span><br><span class="line"></span><br><span class="line">tmpdir.cleanup()</span><br></pre></td></tr></table></figure>
<h3 id="64-考虑用concurrent-futures实现真正的并行计算"><a href="#64-考虑用concurrent-futures实现真正的并行计算" class="headerlink" title="64. 考虑用concurrent.futures实现真正的并行计算"></a>64. 考虑用concurrent.futures实现真正的并行计算</h3><ol>
<li>Run_thread.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">NUMBERS = [</span><br><span class="line">    (<span class="number">1963309</span>, <span class="number">2265973</span>), (<span class="number">2030677</span>, <span class="number">3814172</span>),</span><br><span class="line">    (<span class="number">1551645</span>, <span class="number">2229620</span>), (<span class="number">2039045</span>, <span class="number">2020802</span>),</span><br><span class="line">    (<span class="number">1823712</span>, <span class="number">1924928</span>), (<span class="number">2293129</span>, <span class="number">1020491</span>),</span><br><span class="line">    (<span class="number">1281238</span>, <span class="number">2273782</span>), (<span class="number">3823812</span>, <span class="number">4237281</span>),</span><br><span class="line">    (<span class="number">3812741</span>, <span class="number">4729139</span>), (<span class="number">1292391</span>, <span class="number">2123811</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(pair)</span>:</span></span><br><span class="line">    a, b = pair</span><br><span class="line">    low = min(a, b)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(low, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>, <span class="string">'Not reachable'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>    </span><br><span class="line">    start = time.time()</span><br><span class="line">    pool = ThreadPoolExecutor(max_workers=<span class="number">2</span>)</span><br><span class="line">    results = list(pool.map(gcd, NUMBERS))</span><br><span class="line">    end = time.time()</span><br><span class="line">    delta = end - start</span><br><span class="line">    print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 1.278 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Run_serial.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">NUMBERS = [</span><br><span class="line">    (<span class="number">1963309</span>, <span class="number">2265973</span>), (<span class="number">2030677</span>, <span class="number">3814172</span>),</span><br><span class="line">    (<span class="number">1551645</span>, <span class="number">2229620</span>), (<span class="number">2039045</span>, <span class="number">2020802</span>),</span><br><span class="line">    (<span class="number">1823712</span>, <span class="number">1924928</span>), (<span class="number">2293129</span>, <span class="number">1020491</span>),</span><br><span class="line">    (<span class="number">1281238</span>, <span class="number">2273782</span>), (<span class="number">3823812</span>, <span class="number">4237281</span>),</span><br><span class="line">    (<span class="number">3812741</span>, <span class="number">4729139</span>), (<span class="number">1292391</span>, <span class="number">2123811</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(pair)</span>:</span></span><br><span class="line">    a, b = pair</span><br><span class="line">    low = min(a, b)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(low, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>, <span class="string">'Not reachable'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    results = list(map(gcd, NUMBERS))</span><br><span class="line">    end = time.time()</span><br><span class="line">    delta = end - start</span><br><span class="line">    print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 1.204 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>run_parallel.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">NUMBERS = [</span><br><span class="line">    (<span class="number">1963309</span>, <span class="number">2265973</span>), (<span class="number">2030677</span>, <span class="number">3814172</span>),</span><br><span class="line">    (<span class="number">1551645</span>, <span class="number">2229620</span>), (<span class="number">2039045</span>, <span class="number">2020802</span>),</span><br><span class="line">    (<span class="number">1823712</span>, <span class="number">1924928</span>), (<span class="number">2293129</span>, <span class="number">1020491</span>),</span><br><span class="line">    (<span class="number">1281238</span>, <span class="number">2273782</span>), (<span class="number">3823812</span>, <span class="number">4237281</span>),</span><br><span class="line">    (<span class="number">3812741</span>, <span class="number">4729139</span>), (<span class="number">1292391</span>, <span class="number">2123811</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gcd</span><span class="params">(pair)</span>:</span></span><br><span class="line">    a, b = pair</span><br><span class="line">    low = min(a, b)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(low, <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span> <span class="keyword">and</span> b % i == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>, <span class="string">'Not reachable'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    pool = ProcessPoolExecutor(max_workers=<span class="number">2</span>)  <span class="comment"># The one change</span></span><br><span class="line">    results = list(pool.map(gcd, NUMBERS))</span><br><span class="line">    end = time.time()</span><br><span class="line">    delta = end - start</span><br><span class="line">    print(<span class="string">f'Took <span class="subst">&#123;delta:<span class="number">.3</span>f&#125;</span> seconds'</span>)  <span class="comment"># Took 0.635 seconds</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="八-稳定与性能"><a href="#八-稳定与性能" class="headerlink" title="八. 稳定与性能"></a>八. 稳定与性能</h2><h3 id="65-合理利用try-except-else-finally结构中的每个代码块"><a href="#65-合理利用try-except-else-finally结构中的每个代码块" class="headerlink" title="65. 合理利用try/except/else/finally结构中的每个代码块"></a>65. 合理利用try/except/else/finally结构中的每个代码块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">UNDEFINED = object()</span><br><span class="line">DIE_IN_ELSE_BLOCK = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">divide_json</span><span class="params">(path)</span>:</span></span><br><span class="line">    print(<span class="string">'* Opening file'</span>)</span><br><span class="line">    handle = open(path, <span class="string">'r+'</span>)   <span class="comment"># May raise OSError</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(<span class="string">'* Reading data'</span>)</span><br><span class="line">        data = handle.read()    <span class="comment"># May raise UnicodeDecodeError</span></span><br><span class="line">        print(<span class="string">'* Loading JSON data'</span>)</span><br><span class="line">        op = json.loads(data)   <span class="comment"># May raise ValueError</span></span><br><span class="line">        print(<span class="string">'* Performing calculation'</span>)</span><br><span class="line">        value = (</span><br><span class="line">            op[<span class="string">'numerator'</span>] /</span><br><span class="line">            op[<span class="string">'denominator'</span>])  <span class="comment"># May raise ZeroDivisionError</span></span><br><span class="line">    <span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f'* Handling ZeroDivisionError: <span class="subst">&#123;e&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">return</span> UNDEFINED</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'* Writing calculation'</span>)</span><br><span class="line">        op[<span class="string">'result'</span>] = value</span><br><span class="line">        result = json.dumps(op)</span><br><span class="line">        handle.seek(<span class="number">0</span>)          <span class="comment"># May raise OSError</span></span><br><span class="line">        <span class="keyword">if</span> DIE_IN_ELSE_BLOCK:</span><br><span class="line">            <span class="keyword">import</span> errno</span><br><span class="line">            <span class="keyword">import</span> os</span><br><span class="line">            <span class="keyword">raise</span> OSError(errno.ENOSPC, os.strerror(errno.ENOSPC))</span><br><span class="line">        handle.write(result)    <span class="comment"># May raise OSError</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        print(<span class="string">'* Calling close()'</span>)</span><br><span class="line">        handle.close()          <span class="comment"># Always runs</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">temp_path = <span class="string">'random_data.json'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(temp_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'&#123;"numerator": 1, "denominator": 10&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> divide_json(temp_path) == <span class="number">0.1</span></span><br></pre></td></tr></table></figure>
<h3 id="66-考虑用contextlib和with语句来改写可复用的try-finally代码"><a href="#66-考虑用contextlib和with语句来改写可复用的try-finally代码" class="headerlink" title="66. 考虑用contextlib和with语句来改写可复用的try/finally代码"></a>66. 考虑用contextlib和with语句来改写可复用的try/finally代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line">lock = Lock()</span><br><span class="line"><span class="keyword">with</span> lock:</span><br><span class="line">    <span class="comment"># Do something while maintaining an invariant</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">lock.acquire()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># Do something while maintaining an invariant</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    lock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.getLogger().setLevel(logging.WARNING)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_function</span><span class="params">()</span>:</span></span><br><span class="line">    logging.debug(<span class="string">'Some debug data'</span>)</span><br><span class="line">    logging.error(<span class="string">'Error log here'</span>)</span><br><span class="line">    logging.debug(<span class="string">'More debug data'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">my_function()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_logging</span><span class="params">(level)</span>:</span></span><br><span class="line">    logger = logging.getLogger()</span><br><span class="line">    old_level = logger.getEffectiveLevel()</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        logger.setLevel(old_level)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">with</span> debug_logging(logging.DEBUG):</span><br><span class="line">    print(<span class="string">'* Inside:'</span>)</span><br><span class="line">    my_function()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'* After:'</span>)</span><br><span class="line">my_function()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'my_output.txt'</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> handle:</span><br><span class="line">    handle.write(<span class="string">'This is some data!'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_level</span><span class="params">(level, name)</span>:</span></span><br><span class="line">    logger = logging.getLogger(name)</span><br><span class="line">    old_level = logger.getEffectiveLevel()</span><br><span class="line">    logger.setLevel(level)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> logger</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        logger.setLevel(old_level)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="keyword">with</span> log_level(logging.DEBUG, <span class="string">'my-log'</span>) <span class="keyword">as</span> logger:</span><br><span class="line">    logger.debug(<span class="string">f'This is a message for <span class="subst">&#123;logger.name&#125;</span>!'</span>)</span><br><span class="line">    logging.debug(<span class="string">'This will not print'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">logger = logging.getLogger(<span class="string">'my-log'</span>)</span><br><span class="line">logger.debug(<span class="string">'Debug will not print'</span>)</span><br><span class="line">logger.error(<span class="string">'Error will print'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="keyword">with</span> log_level(logging.DEBUG, <span class="string">'other-log'</span>) <span class="keyword">as</span> logger:</span><br><span class="line">    logger.debug(<span class="string">f'This is a message for <span class="subst">&#123;logger.name&#125;</span>!'</span>)</span><br><span class="line">    logging.debug(<span class="string">'This will not print'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="67-用datetime模块处理本地时间，不要用time模块"><a href="#67-用datetime模块处理本地时间，不要用time模块" class="headerlink" title="67. 用datetime模块处理本地时间，不要用time模块"></a>67. 用datetime模块处理本地时间，不要用time模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timezone</span><br><span class="line"></span><br><span class="line">now = datetime(<span class="number">2019</span>, <span class="number">3</span>, <span class="number">16</span>, <span class="number">22</span>, <span class="number">14</span>, <span class="number">35</span>)</span><br><span class="line">now_utc = now.replace(tzinfo=timezone.utc)</span><br><span class="line">now_local = now_utc.astimezone()</span><br><span class="line">print(now_local)  <span class="comment"># 2019-03-17 06:14:35+08:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">time_str = <span class="string">'2019-03-16 15:14:35'</span></span><br><span class="line">time_format = <span class="string">'%Y-%m-%d %H:%M:%S'</span></span><br><span class="line">now = datetime.strptime(time_str, time_format)</span><br><span class="line">time_tuple = now.timetuple()</span><br><span class="line">utc_now = time.mktime(time_tuple)</span><br><span class="line">print(utc_now)  <span class="comment"># 1552720475.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">import</span> pytz</span><br><span class="line"></span><br><span class="line">arrival_nyc = <span class="string">'2019-03-16 23:33:24'</span></span><br><span class="line">nyc_dt_naive = datetime.strptime(arrival_nyc, time_format)</span><br><span class="line">eastern = pytz.timezone(<span class="string">'US/Eastern'</span>)</span><br><span class="line">nyc_dt = eastern.localize(nyc_dt_naive)</span><br><span class="line">utc_dt = pytz.utc.normalize(nyc_dt.astimezone(pytz.utc))</span><br><span class="line">print(utc_dt)  <span class="comment"># 2019-03-17 03:33:24+00:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line">pacific = pytz.timezone(<span class="string">'US/Pacific'</span>)</span><br><span class="line">sf_dt = pacific.normalize(utc_dt.astimezone(pacific))</span><br><span class="line">print(sf_dt)  <span class="comment"># 2019-03-16 20:33:24-07:00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">nepal = pytz.timezone(<span class="string">'Asia/Katmandu'</span>)</span><br><span class="line">nepal_dt = nepal.normalize(utc_dt.astimezone(nepal))</span><br><span class="line">print(nepal_dt)  <span class="comment"># 2019-03-17 09:18:24+05:45</span></span><br></pre></td></tr></table></figure>
<h3 id="68-用copyreg实现可靠的pickle操作"><a href="#68-用copyreg实现可靠的pickle操作" class="headerlink" title="68. 用copyreg实现可靠的pickle操作"></a>68. 用copyreg实现可靠的pickle操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.level = <span class="number">0</span></span><br><span class="line">        self.lives = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">state = GameState()</span><br><span class="line">state.level += <span class="number">1</span>  <span class="comment"># Player beat a level</span></span><br><span class="line">state.lives -= <span class="number">1</span>  <span class="comment"># Player had to try again</span></span><br><span class="line"></span><br><span class="line">print(state.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">state_path = <span class="string">'game_state.bin'</span></span><br><span class="line"><span class="keyword">with</span> open(state_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(state, f)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="keyword">with</span> open(state_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    state_after = pickle.load(f)</span><br><span class="line"></span><br><span class="line">print(state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.level = <span class="number">0</span></span><br><span class="line">        self.lives = <span class="number">4</span></span><br><span class="line">        self.points = <span class="number">0</span>  <span class="comment"># New field</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">state = GameState()</span><br><span class="line">serialized = pickle.dumps(state)</span><br><span class="line">state_after = pickle.loads(serialized)</span><br><span class="line">print(state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">with</span> open(state_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    state_after = pickle.load(f)</span><br><span class="line"></span><br><span class="line">print(state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">assert</span> isinstance(state_after, GameState)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="number">0</span>, lives=<span class="number">4</span>, points=<span class="number">0</span>)</span>:</span></span><br><span class="line">        self.level = level</span><br><span class="line">        self.lives = lives</span><br><span class="line">        self.points = points</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pickle_game_state</span><span class="params">(game_state)</span>:</span></span><br><span class="line">    kwargs = game_state.__dict__</span><br><span class="line">    <span class="keyword">return</span> unpickle_game_state, (kwargs,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpickle_game_state</span><span class="params">(kwargs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> GameState(**kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="keyword">import</span> copyreg</span><br><span class="line"></span><br><span class="line">copyreg.pickle(GameState, pickle_game_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line">state = GameState()</span><br><span class="line">state.points += <span class="number">1000</span></span><br><span class="line">serialized = pickle.dumps(state)</span><br><span class="line">state_after = pickle.loads(serialized)</span><br><span class="line">print(state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="number">0</span>, lives=<span class="number">4</span>, points=<span class="number">0</span>, magic=<span class="number">5</span>)</span>:</span></span><br><span class="line">        self.level = level</span><br><span class="line">        self.lives = lives</span><br><span class="line">        self.points = points</span><br><span class="line">        self.magic = magic  <span class="comment"># New field</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line">print(<span class="string">'Before:'</span>, state.__dict__)</span><br><span class="line">state_after = pickle.loads(serialized)</span><br><span class="line">print(<span class="string">'After: '</span>, state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 16</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="number">0</span>, points=<span class="number">0</span>, magic=<span class="number">5</span>)</span>:</span></span><br><span class="line">        self.level = level</span><br><span class="line">        self.points = points</span><br><span class="line">        self.magic = magic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 17</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     pickle.loads(serialized)</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 18</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pickle_game_state</span><span class="params">(game_state)</span>:</span></span><br><span class="line">    kwargs = game_state.__dict__</span><br><span class="line">    kwargs[<span class="string">'version'</span>] = <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> unpickle_game_state, (kwargs,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 19</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unpickle_game_state</span><span class="params">(kwargs)</span>:</span></span><br><span class="line">    version = kwargs.pop(<span class="string">'version'</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> version == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">del</span> kwargs[<span class="string">'lives'</span>]</span><br><span class="line">    <span class="keyword">return</span> GameState(**kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 20</span></span><br><span class="line">copyreg.pickle(GameState, pickle_game_state)</span><br><span class="line">print(<span class="string">'Before:'</span>, state.__dict__)</span><br><span class="line">state_after = pickle.loads(serialized)</span><br><span class="line">print(<span class="string">'After: '</span>, state_after.__dict__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 21</span></span><br><span class="line">copyreg.dispatch_table.clear()</span><br><span class="line">state = GameState()</span><br><span class="line">serialized = pickle.dumps(state)</span><br><span class="line"><span class="keyword">del</span> GameState</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterGameState</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, level=<span class="number">0</span>, points=<span class="number">0</span>, magic=<span class="number">5</span>)</span>:</span></span><br><span class="line">        self.level = level</span><br><span class="line">        self.points = points</span><br><span class="line">        self.magic = magic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 22</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     pickle.loads(serialized)</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 23</span></span><br><span class="line">print(serialized)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 24</span></span><br><span class="line">copyreg.pickle(BetterGameState, pickle_game_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 25</span></span><br><span class="line">state = BetterGameState()</span><br><span class="line">serialized = pickle.dumps(state)</span><br><span class="line">print(serialized)</span><br></pre></td></tr></table></figure>
<h3 id="69-在需要准确计算的场合，用decimal表示相应的数值"><a href="#69-在需要准确计算的场合，用decimal表示相应的数值" class="headerlink" title="69. 在需要准确计算的场合，用decimal表示相应的数值"></a>69. 在需要准确计算的场合，用decimal表示相应的数值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">rate = <span class="number">1.45</span></span><br><span class="line">seconds = <span class="number">3</span>*<span class="number">60</span> + <span class="number">42</span></span><br><span class="line">cost = rate * seconds / <span class="number">60</span></span><br><span class="line">print(cost)  <span class="comment"># 5.364999999999999</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">print(round(cost, <span class="number">2</span>))  <span class="comment"># 5.36</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"></span><br><span class="line">rate = Decimal(<span class="string">'1.45'</span>)</span><br><span class="line">seconds = Decimal(<span class="number">3</span>*<span class="number">60</span> + <span class="number">42</span>)</span><br><span class="line">cost = rate * seconds / Decimal(<span class="number">60</span>)</span><br><span class="line">print(cost)  <span class="comment"># 5.365</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">print(Decimal(<span class="string">'1.45'</span>))  <span class="comment"># 1.45</span></span><br><span class="line">print(Decimal(<span class="number">1.45</span>))  <span class="comment"># 1.4499999999999999555910790149937383830547332763671875</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">print(<span class="string">'456'</span>)  <span class="comment"># 456</span></span><br><span class="line">print(<span class="number">456</span>)  <span class="comment"># 456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">rate = Decimal(<span class="string">'0.05'</span>)</span><br><span class="line">seconds = Decimal(<span class="string">'5'</span>)</span><br><span class="line">small_cost = rate * seconds / Decimal(<span class="number">60</span>)</span><br><span class="line">print(small_cost)  <span class="comment"># 0.004166666666666666666666666667</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">print(round(small_cost, <span class="number">2</span>))  <span class="comment"># 0.00</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> ROUND_UP</span><br><span class="line"></span><br><span class="line">rounded = cost.quantize(Decimal(<span class="string">'0.01'</span>), rounding=ROUND_UP)</span><br><span class="line">print(<span class="string">f'Rounded <span class="subst">&#123;cost&#125;</span> to <span class="subst">&#123;rounded&#125;</span>'</span>)  <span class="comment"># Rounded 5.365 to 5.37</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">rounded = small_cost.quantize(Decimal(<span class="string">'0.01'</span>), rounding=ROUND_UP)</span><br><span class="line">print(<span class="string">f'Rounded <span class="subst">&#123;small_cost&#125;</span> to <span class="subst">&#123;rounded&#125;</span>'</span>)  <span class="comment"># Rounded 0.004166666666666666666666666667 to 0.01</span></span><br></pre></td></tr></table></figure>
<h3 id="70-先分析性能，然后再优化"><a href="#70-先分析性能，然后再优化" class="headerlink" title="70. 先分析性能，然后再优化"></a>70. 先分析性能，然后再优化</h3><ol>
<li>优化python程序之前，一定要先分析它的性能，程序变慢的真正原因未必和我们想的一样；</li>
<li>可以通过Stats对象筛选出我们关心的结果。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertion_sort</span><span class="params">(data)</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> data:</span><br><span class="line">        insert_value(result, value)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_value</span><span class="params">(array, value)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i, existing <span class="keyword">in</span> enumerate(array):</span><br><span class="line">        <span class="keyword">if</span> existing &gt; value:</span><br><span class="line">            array.insert(i, value)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    array.append(value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line">max_size = <span class="number">10</span>**<span class="number">4</span></span><br><span class="line">data = [randint(<span class="number">0</span>, max_size) <span class="keyword">for</span> _ <span class="keyword">in</span> range(max_size)]</span><br><span class="line">test = <span class="keyword">lambda</span>: insertion_sort(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="keyword">from</span> cProfile <span class="keyword">import</span> Profile</span><br><span class="line"></span><br><span class="line">profiler = Profile()</span><br><span class="line">profiler.runcall(test)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">from</span> pstats <span class="keyword">import</span> Stats</span><br><span class="line"></span><br><span class="line">stats = Stats(profiler)</span><br><span class="line"><span class="comment"># stats = Stats(profiler, stream=STDOUT)</span></span><br><span class="line">stats.strip_dirs()</span><br><span class="line">stats.sort_stats(<span class="string">'cumulative'</span>)</span><br><span class="line">stats.print_stats()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> bisect_left</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_value</span><span class="params">(array, value)</span>:</span></span><br><span class="line">    i = bisect_left(array, value)</span><br><span class="line">    array.insert(i, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">profiler = Profile()</span><br><span class="line">profiler.runcall(test)</span><br><span class="line"><span class="comment"># stats = Stats(profiler, stream=STDOUT)</span></span><br><span class="line">stats.strip_dirs()</span><br><span class="line">stats.sort_stats(<span class="string">'cumulative'</span>)</span><br><span class="line">stats.print_stats()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_utility</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    c = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        c += a * b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">first_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">        my_utility(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">second_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        my_utility(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_program</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        first_func()</span><br><span class="line">        second_func()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">profiler = Profile()</span><br><span class="line">profiler.runcall(my_program)</span><br><span class="line"><span class="comment"># stats = Stats(profiler, stream=STDOUT)</span></span><br><span class="line">stats.strip_dirs()</span><br><span class="line">stats.sort_stats(<span class="string">'cumulative'</span>)</span><br><span class="line">stats.print_stats()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="comment"># stats = Stats(profiler, stream=STDOUT)</span></span><br><span class="line">stats.strip_dirs()</span><br><span class="line">stats.sort_stats(<span class="string">'cumulative'</span>)</span><br><span class="line">stats.print_callers()</span><br></pre></td></tr></table></figure>
<h3 id="71-优先考虑用deque实现生产者-消费者队列"><a href="#71-优先考虑用deque实现生产者-消费者队列" class="headerlink" title="71. 优先考虑用deque实现生产者-消费者队列"></a>71. 优先考虑用deque实现生产者-消费者队列</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Email</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sender, receiver, message)</span>:</span></span><br><span class="line">        self.sender = sender</span><br><span class="line">        self.receiver = receiver</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_emails</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'foo@example.com'</span>, <span class="string">'bar@example.com'</span>, <span class="string">'hello1'</span>)</span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'baz@example.com'</span>, <span class="string">'banana@example.com'</span>, <span class="string">'hello2'</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'meep@example.com'</span>, <span class="string">'butter@example.com'</span>, <span class="string">'hello3'</span>)</span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'stuff@example.com'</span>, <span class="string">'avocado@example.com'</span>, <span class="string">'hello4'</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'thingy@example.com'</span>, <span class="string">'orange@example.com'</span>, <span class="string">'hello5'</span>)</span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'roger@example.com'</span>, <span class="string">'bob@example.com'</span>, <span class="string">'hello6'</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">yield</span> Email(<span class="string">'peanut@example.com'</span>, <span class="string">'alice@example.com'</span>, <span class="string">'hello7'</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">EMAIL_IT = get_emails()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoEmailError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">try_receive_email</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># Returns an Email instance or raises NoEmailError</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        email = next(EMAIL_IT)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        email = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> email:</span><br><span class="line">        <span class="keyword">raise</span> NoEmailError</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f'Produced email: <span class="subst">&#123;email.message&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> email</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">produce_emails</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            email = try_receive_email()</span><br><span class="line">        <span class="keyword">except</span> NoEmailError:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queue.append(email)  <span class="comment"># Producer</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_one_email</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> queue:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    email = queue.pop(<span class="number">0</span>)  <span class="comment"># Consumer</span></span><br><span class="line">    <span class="comment"># Index the message for long-term archival</span></span><br><span class="line">    print(<span class="string">f'Consumed email: <span class="subst">&#123;email.message&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(queue, keep_running)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> keep_running():</span><br><span class="line">        produce_emails(queue)</span><br><span class="line">        consume_one_email(queue)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_test_end</span><span class="params">()</span>:</span></span><br><span class="line">    count=list(range(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">if</span> count:</span><br><span class="line">            count.pop()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_end_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">my_end_func = make_test_end()</span><br><span class="line">loop([], my_end_func)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_results</span><span class="params">(count, tests)</span>:</span></span><br><span class="line">    avg_iteration = sum(tests) / len(tests)</span><br><span class="line">    print(<span class="string">f'Count <span class="subst">&#123;count:&gt;<span class="number">5</span>,&#125;</span> takes <span class="subst">&#123;avg_iteration:<span class="number">.6</span>f&#125;</span>s'</span>)</span><br><span class="line">    <span class="keyword">return</span> count, avg_iteration</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_append_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(count):</span><br><span class="line">            queue.append(i)</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue = []'</span>,</span><br><span class="line">        stmt=<span class="string">'run(queue)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">1000</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_delta</span><span class="params">(before, after)</span>:</span></span><br><span class="line">    before_count, before_time = before</span><br><span class="line">    after_count, after_time = after</span><br><span class="line">    growth = <span class="number">1</span> + (after_count - before_count) / before_count</span><br><span class="line">    slowdown = <span class="number">1</span> + (after_time - before_time) / before_time</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;growth:&gt;<span class="number">4.1</span>f&#125;</span>x data size, <span class="subst">&#123;slowdown:&gt;<span class="number">4.1</span>f&#125;</span>x time'</span>)</span><br><span class="line"></span><br><span class="line">baseline = list_append_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">2</span>_000, <span class="number">3</span>_000, <span class="number">4</span>_000, <span class="number">5</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = list_append_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_pop_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> list(range(count))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            queue.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">'run(queue)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">1000</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">baseline = list_pop_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">2</span>_000, <span class="number">3</span>_000, <span class="number">4</span>_000, <span class="number">5</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = list_pop_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_one_email</span><span class="params">(queue)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> queue:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    email = queue.popleft()  <span class="comment"># Consumer</span></span><br><span class="line">    <span class="comment"># Process the email message</span></span><br><span class="line">    print(<span class="string">f'Consumed email: <span class="subst">&#123;email.message&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_end_func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">my_end_func = make_test_end()</span><br><span class="line">EMAIL_IT = get_emails()</span><br><span class="line">loop(collections.deque(), my_end_func)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deque_append_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> collections.deque()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(count):</span><br><span class="line">            queue.append(i)</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">'run(queue)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">1000</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line">baseline = deque_append_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">2</span>_000, <span class="number">3</span>_000, <span class="number">4</span>_000, <span class="number">5</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = deque_append_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dequeue_popleft_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="keyword">return</span> collections.deque(range(count))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            queue.popleft()</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">'run(queue)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">1000</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line">baseline = dequeue_popleft_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">2</span>_000, <span class="number">3</span>_000, <span class="number">4</span>_000, <span class="number">5</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = dequeue_popleft_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br></pre></td></tr></table></figure>
<h3 id="72-考虑用bisect搜索已排序的序列"><a href="#72-考虑用bisect搜索已排序的序列" class="headerlink" title="72. 考虑用bisect搜索已排序的序列"></a>72. 考虑用bisect搜索已排序的序列</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">data = list(range(<span class="number">10</span>**<span class="number">5</span>))</span><br><span class="line">index = data.index(<span class="number">91234</span>)</span><br><span class="line"><span class="keyword">assert</span> index == <span class="number">91234</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_closest</span><span class="params">(sequence, goal)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> index, value <span class="keyword">in</span> enumerate(sequence):</span><br><span class="line">        <span class="keyword">if</span> goal &lt; value:</span><br><span class="line">            <span class="keyword">return</span> index</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">f'<span class="subst">&#123;goal&#125;</span> is out of bounds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">index = find_closest(data, <span class="number">91234.56</span>)</span><br><span class="line"><span class="keyword">assert</span> index == <span class="number">91235</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    find_closest(data, <span class="number">100000000</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="keyword">pass</span>  <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3  python内置的bisect模块可以更好的搜索有序列表</span></span><br><span class="line"><span class="keyword">from</span> bisect <span class="keyword">import</span> bisect_left</span><br><span class="line"></span><br><span class="line">index = bisect_left(data, <span class="number">91234</span>)     <span class="comment"># Exact match</span></span><br><span class="line"><span class="keyword">assert</span> index == <span class="number">91234</span></span><br><span class="line"></span><br><span class="line">index = bisect_left(data, <span class="number">91234.56</span>)  <span class="comment"># Closest match</span></span><br><span class="line"><span class="keyword">assert</span> index == <span class="number">91235</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line">size = <span class="number">10</span>**<span class="number">5</span></span><br><span class="line">iterations = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">data = list(range(size))</span><br><span class="line">to_lookup = [random.randint(<span class="number">0</span>, size)</span><br><span class="line">             <span class="keyword">for</span> _ <span class="keyword">in</span> range(iterations)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_linear</span><span class="params">(data, to_lookup)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> to_lookup:</span><br><span class="line">        data.index(index)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_bisect</span><span class="params">(data, to_lookup)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> to_lookup:</span><br><span class="line">        bisect_left(data, index)</span><br><span class="line"></span><br><span class="line">baseline = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_linear(data, to_lookup)'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">10</span>)</span><br><span class="line">print(<span class="string">f'Linear search takes <span class="subst">&#123;baseline:<span class="number">.6</span>f&#125;</span>s'</span>)</span><br><span class="line"></span><br><span class="line">comparison = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_bisect(data, to_lookup)'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">10</span>)</span><br><span class="line">print(<span class="string">f'Bisect search takes <span class="subst">&#123;comparison:<span class="number">.6</span>f&#125;</span>s'</span>)</span><br><span class="line"></span><br><span class="line">slowdown = <span class="number">1</span> + ((baseline - comparison) / comparison)</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;slowdown:<span class="number">.1</span>f&#125;</span>x time'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="73-学会使用heapq制作优先级队列"><a href="#73-学会使用heapq制作优先级队列" class="headerlink" title="73. 学会使用heapq制作优先级队列"></a>73. 学会使用heapq制作优先级队列</h3><p>有时候，我们想根据元素的优先程度来排序，此时应该使用优先级队列。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title, due_date)</span>:</span></span><br><span class="line">        self.title = title</span><br><span class="line">        self.due_date = due_date</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_book</span><span class="params">(queue, book)</span>:</span></span><br><span class="line">    queue.append(book)</span><br><span class="line">    queue.sort(key=<span class="keyword">lambda</span> x: x.due_date, reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">queue = []</span><br><span class="line">add_book(queue, Book(<span class="string">'Don Quixote'</span>, <span class="string">'2019-06-07'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'Frankenstein'</span>, <span class="string">'2019-06-05'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'Les Misérables'</span>, <span class="string">'2019-06-08'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'War and Peace'</span>, <span class="string">'2019-06-03'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoOverdueBooks</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_overdue_book</span><span class="params">(queue, now)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> queue:</span><br><span class="line">        book = queue[<span class="number">-1</span>]</span><br><span class="line">        <span class="keyword">if</span> book.due_date &lt; now:</span><br><span class="line">            queue.pop()</span><br><span class="line">            <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NoOverdueBooks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">now = <span class="string">'2019-06-10'</span></span><br><span class="line"></span><br><span class="line">found = next_overdue_book(queue, now)</span><br><span class="line">print(found.title)</span><br><span class="line"></span><br><span class="line">found = next_overdue_book(queue, now)</span><br><span class="line">print(found.title)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">return_book</span><span class="params">(queue, book)</span>:</span></span><br><span class="line">    queue.remove(book)</span><br><span class="line"></span><br><span class="line">queue = []</span><br><span class="line">book = Book(<span class="string">'Treasure Island'</span>, <span class="string">'2019-06-04'</span>)</span><br><span class="line"></span><br><span class="line">add_book(queue, book)</span><br><span class="line">print(<span class="string">'Before return:'</span>, [x.title <span class="keyword">for</span> x <span class="keyword">in</span> queue])</span><br><span class="line"></span><br><span class="line">return_book(queue, book)</span><br><span class="line">print(<span class="string">'After return: '</span>, [x.title <span class="keyword">for</span> x <span class="keyword">in</span> queue])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    next_overdue_book(queue, now)</span><br><span class="line"><span class="keyword">except</span> NoOverdueBooks:</span><br><span class="line">    <span class="keyword">pass</span>          <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>  <span class="comment"># Doesn't happen</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_results</span><span class="params">(count, tests)</span>:</span></span><br><span class="line">    avg_iteration = sum(tests) / len(tests)</span><br><span class="line">    print(<span class="string">f'Count <span class="subst">&#123;count:&gt;<span class="number">5</span>,&#125;</span> takes <span class="subst">&#123;avg_iteration:<span class="number">.6</span>f&#125;</span>s'</span>)</span><br><span class="line">    <span class="keyword">return</span> count, avg_iteration</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_delta</span><span class="params">(before, after)</span>:</span></span><br><span class="line">    before_count, before_time = before</span><br><span class="line">    after_count, after_time = after</span><br><span class="line">    growth = <span class="number">1</span> + (after_count - before_count) / before_count</span><br><span class="line">    slowdown = <span class="number">1</span> + (after_time - before_time) / before_time</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;growth:&gt;<span class="number">4.1</span>f&#125;</span>x data size, <span class="subst">&#123;slowdown:&gt;<span class="number">4.1</span>f&#125;</span>x time'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_overdue_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        to_add = list(range(count))</span><br><span class="line">        random.shuffle(to_add)</span><br><span class="line">        <span class="keyword">return</span> [], to_add</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue, to_add)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> to_add:</span><br><span class="line">            queue.append(i)</span><br><span class="line">            queue.sort(reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            queue.pop()</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue, to_add = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">f'run(queue, to_add)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">100</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line">baseline = list_overdue_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">1</span>_500, <span class="number">2</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = list_overdue_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_return_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        queue = list(range(count))</span><br><span class="line">        random.shuffle(queue)</span><br><span class="line"></span><br><span class="line">        to_return = list(range(count))</span><br><span class="line">        random.shuffle(to_return)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue, to_return</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue, to_return)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> to_return:</span><br><span class="line">            queue.remove(i)</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue, to_return = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">f'run(queue, to_return)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">100</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">baseline = list_return_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">1</span>_500, <span class="number">2</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = list_return_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heappush</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_book</span><span class="params">(queue, book)</span>:</span></span><br><span class="line">    heappush(queue, book)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     queue = []</span></span><br><span class="line"><span class="comment">#     add_book(queue, Book('Little Women', '2019-06-05'))</span></span><br><span class="line"><span class="comment">#     add_book(queue, Book('The Time Machine', '2019-05-30'))</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"></span><br><span class="line"><span class="meta">@functools.total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title, due_date)</span>:</span></span><br><span class="line">        self.title = title</span><br><span class="line">        self.due_date = due_date</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.due_date &lt; other.due_date</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line">queue = []</span><br><span class="line">add_book(queue, Book(<span class="string">'Pride and Prejudice'</span>, <span class="string">'2019-06-01'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'The Time Machine'</span>, <span class="string">'2019-05-30'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'Crime and Punishment'</span>, <span class="string">'2019-06-06'</span>))</span><br><span class="line">add_book(queue, Book(<span class="string">'Wuthering Heights'</span>, <span class="string">'2019-06-12'</span>))</span><br><span class="line">print([b.title <span class="keyword">for</span> b <span class="keyword">in</span> queue])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line">queue = [</span><br><span class="line">    Book(<span class="string">'Pride and Prejudice'</span>, <span class="string">'2019-06-01'</span>),</span><br><span class="line">    Book(<span class="string">'The Time Machine'</span>, <span class="string">'2019-05-30'</span>),</span><br><span class="line">    Book(<span class="string">'Crime and Punishment'</span>, <span class="string">'2019-06-06'</span>),</span><br><span class="line">    Book(<span class="string">'Wuthering Heights'</span>, <span class="string">'2019-06-12'</span>),</span><br><span class="line">]</span><br><span class="line">queue.sort()</span><br><span class="line">print([b.title <span class="keyword">for</span> b <span class="keyword">in</span> queue])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 16</span></span><br><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heapify</span><br><span class="line"></span><br><span class="line">queue = [</span><br><span class="line">    Book(<span class="string">'Pride and Prejudice'</span>, <span class="string">'2019-06-01'</span>),</span><br><span class="line">    Book(<span class="string">'The Time Machine'</span>, <span class="string">'2019-05-30'</span>),</span><br><span class="line">    Book(<span class="string">'Crime and Punishment'</span>, <span class="string">'2019-06-06'</span>),</span><br><span class="line">    Book(<span class="string">'Wuthering Heights'</span>, <span class="string">'2019-06-12'</span>),</span><br><span class="line">]</span><br><span class="line">heapify(queue)</span><br><span class="line">print([b.title <span class="keyword">for</span> b <span class="keyword">in</span> queue])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 17</span></span><br><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heappop</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_overdue_book</span><span class="params">(queue, now)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> queue:</span><br><span class="line">        book = queue[<span class="number">0</span>]           <span class="comment"># Most overdue first</span></span><br><span class="line">        <span class="keyword">if</span> book.due_date &lt; now:</span><br><span class="line">            heappop(queue)        <span class="comment"># Remove the overdue book</span></span><br><span class="line">            <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NoOverdueBooks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 18</span></span><br><span class="line">now = <span class="string">'2019-06-02'</span></span><br><span class="line"></span><br><span class="line">book = next_overdue_book(queue, now)</span><br><span class="line">print(book.title)</span><br><span class="line"></span><br><span class="line">book = next_overdue_book(queue, now)</span><br><span class="line">print(book.title)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    next_overdue_book(queue, now)</span><br><span class="line"><span class="keyword">except</span> NoOverdueBooks:</span><br><span class="line">    <span class="keyword">pass</span>          <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>  <span class="comment"># Doesn't happen</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 19</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">heap_overdue_benchmark</span><span class="params">(count)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prepare</span><span class="params">()</span>:</span></span><br><span class="line">        to_add = list(range(count))</span><br><span class="line">        random.shuffle(to_add)</span><br><span class="line">        <span class="keyword">return</span> [], to_add</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(queue, to_add)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> to_add:</span><br><span class="line">            heappush(queue, i)</span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            heappop(queue)</span><br><span class="line"></span><br><span class="line">    tests = timeit.repeat(</span><br><span class="line">        setup=<span class="string">'queue, to_add = prepare()'</span>,</span><br><span class="line">        stmt=<span class="string">f'run(queue, to_add)'</span>,</span><br><span class="line">        globals=locals(),</span><br><span class="line">        repeat=<span class="number">100</span>,</span><br><span class="line">        number=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> print_results(count, tests)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 20</span></span><br><span class="line">baseline = heap_overdue_benchmark(<span class="number">500</span>)</span><br><span class="line"><span class="keyword">for</span> count <span class="keyword">in</span> (<span class="number">1</span>_000, <span class="number">1</span>_500, <span class="number">2</span>_000):</span><br><span class="line">    print()</span><br><span class="line">    comparison = heap_overdue_benchmark(count)</span><br><span class="line">    print_delta(baseline, comparison)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 21</span></span><br><span class="line"><span class="meta">@functools.total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, title, due_date)</span>:</span></span><br><span class="line">        self.title = title</span><br><span class="line">        self.due_date = due_date</span><br><span class="line">        self.returned = <span class="literal">False</span>  <span class="comment"># New field</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.due_date &lt; other.due_date</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 22</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">next_overdue_book</span><span class="params">(queue, now)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> queue:</span><br><span class="line">        book = queue[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> book.returned:</span><br><span class="line">            heappop(queue)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> book.due_date &lt; now:</span><br><span class="line">            heappop(queue)</span><br><span class="line">            <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> NoOverdueBooks</span><br><span class="line"></span><br><span class="line">queue = []</span><br><span class="line"></span><br><span class="line">book = Book(<span class="string">'Pride and Prejudice'</span>, <span class="string">'2019-06-01'</span>)</span><br><span class="line">add_book(queue, book)</span><br><span class="line"></span><br><span class="line">book = Book(<span class="string">'The Time Machine'</span>, <span class="string">'2019-05-30'</span>)</span><br><span class="line">add_book(queue, book)</span><br><span class="line">book.returned = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">book = Book(<span class="string">'Crime and Punishment'</span>, <span class="string">'2019-06-06'</span>)</span><br><span class="line">add_book(queue, book)</span><br><span class="line">book.returned = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">book = Book(<span class="string">'Wuthering Heights'</span>, <span class="string">'2019-06-12'</span>)</span><br><span class="line">add_book(queue, book)</span><br><span class="line"></span><br><span class="line">now = <span class="string">'2019-06-11'</span></span><br><span class="line"></span><br><span class="line">book = next_overdue_book(queue, now)</span><br><span class="line"><span class="keyword">assert</span> book.title == <span class="string">'Pride and Prejudice'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    next_overdue_book(queue, now)</span><br><span class="line"><span class="keyword">except</span> NoOverdueBooks:</span><br><span class="line">    <span class="keyword">pass</span>          <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span>  <span class="comment"># Doesn't happen</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 23</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">return_book</span><span class="params">(queue, book)</span>:</span></span><br><span class="line">    book.returned = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> book.returned</span><br><span class="line">return_book(queue, book)</span><br><span class="line"><span class="keyword">assert</span> book.returned</span><br></pre></td></tr></table></figure>
<h3 id="74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作"><a href="#74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作" class="headerlink" title="74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作"></a>74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timecode_to_index</span><span class="params">(video_id, timecode)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1234</span></span><br><span class="line">    <span class="comment"># Returns the byte offset in the video data</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request_chunk</span><span class="params">(video_id, byte_offset, size)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># Returns size bytes of video_id's data from the offset</span></span><br><span class="line"></span><br><span class="line">video_id = ...</span><br><span class="line">timecode = <span class="string">'01:09:14:28'</span></span><br><span class="line">byte_offset = timecode_to_index(video_id, timecode)</span><br><span class="line">size = <span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">video_data = request_chunk(video_id, byte_offset, size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NullSocket</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.handle = open(os.devnull, <span class="string">'wb'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">send</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.handle.write(data)</span><br><span class="line"></span><br><span class="line">socket = ...             <span class="comment"># socket connection to client</span></span><br><span class="line">video_data = ...         <span class="comment"># bytes containing data for video_id</span></span><br><span class="line">byte_offset = ...        <span class="comment"># Requested starting position</span></span><br><span class="line">size = <span class="number">20</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># Requested chunk size</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">socket = NullSocket()</span><br><span class="line">video_data = <span class="number">100</span> * os.urandom(<span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">byte_offset = <span class="number">1234</span></span><br><span class="line"></span><br><span class="line">chunk = video_data[byte_offset:byte_offset + size]</span><br><span class="line">socket.send(chunk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_test</span><span class="params">()</span>:</span></span><br><span class="line">    chunk = video_data[byte_offset:byte_offset + size]</span><br><span class="line">    <span class="comment"># Call socket.send(chunk), but ignoring for benchmark</span></span><br><span class="line"></span><br><span class="line">result = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_test()'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">100</span>) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;result:<span class="number">0.9</span>f&#125;</span> seconds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">data = <span class="string">b'shave and a haircut, two bits'</span></span><br><span class="line">view = memoryview(data)</span><br><span class="line">chunk = view[<span class="number">12</span>:<span class="number">19</span>]</span><br><span class="line">print(chunk)</span><br><span class="line">print(<span class="string">'Size:           '</span>, chunk.nbytes)</span><br><span class="line">print(<span class="string">'Data in view:   '</span>, chunk.tobytes())</span><br><span class="line">print(<span class="string">'Underlying data:'</span>, chunk.obj)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">video_view = memoryview(video_data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_test</span><span class="params">()</span>:</span></span><br><span class="line">    chunk = video_view[byte_offset:byte_offset + size]</span><br><span class="line">    <span class="comment"># Call socket.send(chunk), but ignoring for benchmark</span></span><br><span class="line"></span><br><span class="line">result = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_test()'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">100</span>) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;result:<span class="number">0.9</span>f&#125;</span> seconds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FakeSocket</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(self, size)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> video_view[byte_offset:byte_offset+size]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recv_into</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        source_data = video_view[byte_offset:byte_offset+size]</span><br><span class="line">        buffer[:] = source_data</span><br><span class="line"></span><br><span class="line">socket = ...        <span class="comment"># socket connection to the client</span></span><br><span class="line">video_cache = ...   <span class="comment"># Cache of incoming video stream</span></span><br><span class="line">byte_offset = ...   <span class="comment"># Incoming buffer position</span></span><br><span class="line">size = <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># Incoming chunk size</span></span><br><span class="line">socket = FakeSocket()</span><br><span class="line">video_cache = video_data[:]</span><br><span class="line">byte_offset = <span class="number">1234</span></span><br><span class="line"></span><br><span class="line">chunk = socket.recv(size)</span><br><span class="line">video_view = memoryview(video_cache)</span><br><span class="line">before = video_view[:byte_offset]</span><br><span class="line">after = video_view[byte_offset + size:]</span><br><span class="line">new_cache = <span class="string">b''</span>.join([before, chunk, after])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_test</span><span class="params">()</span>:</span></span><br><span class="line">    chunk = socket.recv(size)</span><br><span class="line">    before = video_view[:byte_offset]</span><br><span class="line">    after = video_view[byte_offset + size:]</span><br><span class="line">    new_cache = <span class="string">b''</span>.join([before, chunk, after])</span><br><span class="line"></span><br><span class="line">result = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_test()'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">100</span>) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;result:<span class="number">0.9</span>f&#125;</span> seconds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     my_bytes = b'hello'</span></span><br><span class="line"><span class="comment">#     my_bytes[0] = b'\x79'</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">my_array = bytearray(<span class="string">b'hello'</span>)</span><br><span class="line">my_array[<span class="number">0</span>] = <span class="number">0x79</span></span><br><span class="line">print(my_array)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">my_array = bytearray(<span class="string">b'row, row, row your boat'</span>)</span><br><span class="line">my_view = memoryview(my_array)</span><br><span class="line">write_view = my_view[<span class="number">3</span>:<span class="number">13</span>]</span><br><span class="line">write_view[:] = <span class="string">b'-10 bytes-'</span></span><br><span class="line">print(my_array)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line">video_array = bytearray(video_cache)</span><br><span class="line">write_view = memoryview(video_array)</span><br><span class="line">chunk = write_view[byte_offset:byte_offset + size]</span><br><span class="line">socket.recv_into(chunk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_test</span><span class="params">()</span>:</span></span><br><span class="line">    chunk = write_view[byte_offset:byte_offset + size]</span><br><span class="line">    socket.recv_into(chunk)</span><br><span class="line"></span><br><span class="line">result = timeit.timeit(</span><br><span class="line">    stmt=<span class="string">'run_test()'</span>,</span><br><span class="line">    globals=globals(),</span><br><span class="line">    number=<span class="number">100</span>) / <span class="number">100</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;result:<span class="number">0.9</span>f&#125;</span> seconds'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="九-测试与调试"><a href="#九-测试与调试" class="headerlink" title="九. 测试与调试"></a>九. 测试与调试</h2><h3 id="75-通过repr字符串输出调试信息"><a href="#75-通过repr字符串输出调试信息" class="headerlink" title="75. 通过repr字符串输出调试信息"></a>75. 通过repr字符串输出调试信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line">print(<span class="string">'foo bar'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">my_value = <span class="string">'foo bar'</span></span><br><span class="line">print(str(my_value))</span><br><span class="line">print(<span class="string">'%s'</span> % my_value)</span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;my_value&#125;</span>'</span>)</span><br><span class="line">print(format(my_value))</span><br><span class="line">print(my_value.__format__(<span class="string">'s'</span>))</span><br><span class="line">print(my_value.__str__())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">print(<span class="number">5</span>)</span><br><span class="line">print(<span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">int_value = <span class="number">5</span></span><br><span class="line">str_value = <span class="string">'5'</span></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;int_value&#125;</span> == <span class="subst">&#123;str_value&#125;</span> ?'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">a = <span class="string">'\x07'</span></span><br><span class="line">print(repr(a))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">b = eval(repr(a))</span><br><span class="line"><span class="keyword">assert</span> a == b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">print(repr(<span class="number">5</span>))</span><br><span class="line">print(repr(<span class="string">'5'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">print(<span class="string">'%r'</span> % <span class="number">5</span>)</span><br><span class="line">print(<span class="string">'%r'</span> % <span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">int_value = <span class="number">5</span></span><br><span class="line">str_value = <span class="string">'5'</span></span><br><span class="line">print(<span class="string">f'<span class="subst">&#123;int_value!r&#125;</span> != <span class="subst">&#123;str_value!r&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpaqueClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">obj = OpaqueClass(<span class="number">1</span>, <span class="string">'foo'</span>)</span><br><span class="line">print(obj)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'BetterClass(<span class="subst">&#123;self.x!r&#125;</span>, <span class="subst">&#123;self.y!r&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">obj = BetterClass(<span class="number">2</span>, <span class="string">'bar'</span>)</span><br><span class="line">print(obj)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line">obj = OpaqueClass(<span class="number">4</span>, <span class="string">'baz'</span>)</span><br><span class="line">print(obj.__dict__)</span><br></pre></td></tr></table></figure>
<h3 id="76-在TestCase子类里验证相关的行为"><a href="#76-在TestCase子类里验证相关的行为" class="headerlink" title="76. 在TestCase子类里验证相关的行为"></a>76. 在TestCase子类里验证相关的行为</h3><ol>
<li>Helper_test.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> TestCase, main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_squares</span><span class="params">(values)</span>:</span></span><br><span class="line">    cumulative = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> values:</span><br><span class="line">        cumulative += value ** <span class="number">2</span></span><br><span class="line">        <span class="keyword">yield</span> cumulative</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelperTestCase</span><span class="params">(TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify_complex_case</span><span class="params">(self, values, expected)</span>:</span></span><br><span class="line">        expect_it = iter(expected)</span><br><span class="line">        found_it = iter(sum_squares(values))</span><br><span class="line">        test_it = zip(expect_it, found_it)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, (expect, found) <span class="keyword">in</span> enumerate(test_it):</span><br><span class="line">            self.assertEqual(</span><br><span class="line">                expect,</span><br><span class="line">                found,</span><br><span class="line">                <span class="string">f'Index <span class="subst">&#123;i&#125;</span> is wrong'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Verify both generators are exhausted</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            next(expect_it)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.fail(<span class="string">'Expected longer than found'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            next(found_it)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.fail(<span class="string">'Found longer than expected'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_wrong_lengths</span><span class="params">(self)</span>:</span></span><br><span class="line">        values = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>]</span><br><span class="line">        expected = [</span><br><span class="line">            <span class="number">1.1</span>**<span class="number">2</span>,</span><br><span class="line">        ]</span><br><span class="line">        self.verify_complex_case(values, expected)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_wrong_results</span><span class="params">(self)</span>:</span></span><br><span class="line">        values = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>]</span><br><span class="line">        expected = [</span><br><span class="line">            <span class="number">1.1</span>**<span class="number">2</span>,</span><br><span class="line">            <span class="number">1.1</span>**<span class="number">2</span> + <span class="number">2.2</span>**<span class="number">2</span>,</span><br><span class="line">            <span class="number">1.1</span>**<span class="number">2</span> + <span class="number">2.2</span>**<span class="number">2</span> + <span class="number">3.3</span>**<span class="number">2</span> + <span class="number">4.4</span>**<span class="number">2</span>,</span><br><span class="line">        ]</span><br><span class="line">        self.verify_complex_case(values, expected)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Data_driven_test.py</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> TestCase, main</span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> to_str</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataDrivenTestCase</span><span class="params">(TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_good</span><span class="params">(self)</span>:</span></span><br><span class="line">        good_cases = [</span><br><span class="line">            (<span class="string">b'my bytes'</span>, <span class="string">'my bytes'</span>),</span><br><span class="line">            (<span class="string">'no error'</span>, <span class="string">b'no error'</span>),  <span class="comment"># This one will fail</span></span><br><span class="line">            (<span class="string">'other str'</span>, <span class="string">'other str'</span>),</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> value, expected <span class="keyword">in</span> good_cases:</span><br><span class="line">            <span class="keyword">with</span> self.subTest(value):</span><br><span class="line">                self.assertEqual(expected, to_str(value))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_bad</span><span class="params">(self)</span>:</span></span><br><span class="line">        bad_cases = [</span><br><span class="line">            (object(), TypeError),</span><br><span class="line">            (<span class="string">b'\xfa\xfa'</span>, UnicodeDecodeError),</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> value, exception <span class="keyword">in</span> bad_cases:</span><br><span class="line">            <span class="keyword">with</span> self.subTest(value):</span><br><span class="line">                <span class="keyword">with</span> self.assertRaises(exception):</span><br><span class="line">                    to_str(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"><a href="#77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰" class="headerlink" title="77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"></a>77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> TestCase, main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setUpModule</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'* Module setup'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tearDownModule</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'* Module clean-up'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntegrationTest</span><span class="params">(TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'* Test setup'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'* Test clean-up'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_end_to_end1</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'* Test 1'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_end_to_end2</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'* Test 2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h3 id="78-用Mock来模拟受测代码所依赖的复杂函数"><a href="#78-用Mock来模拟受测代码所依赖的复杂函数" class="headerlink" title="78. 用Mock来模拟受测代码所依赖的复杂函数"></a>78. 用Mock来模拟受测代码所依赖的复杂函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseConnection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseConnectionError</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_animals</span><span class="params">(database, species)</span>:</span></span><br><span class="line">    <span class="comment"># Query the Database</span></span><br><span class="line">    <span class="keyword">raise</span> DatabaseConnectionError(<span class="string">'Not connected'</span>)</span><br><span class="line">    <span class="comment"># Return a list of (name, last_mealtime) tuples</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     database = DatabaseConnection('localhost', '4444')</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     get_animals(database, 'Meerkat')</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock</span><br><span class="line"></span><br><span class="line">mock = Mock(spec=get_animals)</span><br><span class="line">expected = [</span><br><span class="line">    (<span class="string">'Spot'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">15</span>)),</span><br><span class="line">    (<span class="string">'Fluffy'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">30</span>)),</span><br><span class="line">    (<span class="string">'Jojo'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">45</span>)),</span><br><span class="line">]</span><br><span class="line">mock.return_value = expected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     mock.does_not_exist</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">database = object()</span><br><span class="line">result = mock(database, <span class="string">'Meerkat'</span>)</span><br><span class="line"><span class="keyword">assert</span> result == expected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line">mock.assert_called_once_with(database, <span class="string">'Meerkat'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     mock.assert_called_once_with(database, 'Giraffe')</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> ANY</span><br><span class="line"></span><br><span class="line">mock = Mock(spec=get_animals)</span><br><span class="line">mock(<span class="string">'database 1'</span>, <span class="string">'Rabbit'</span>)</span><br><span class="line">mock(<span class="string">'database 2'</span>, <span class="string">'Bison'</span>)</span><br><span class="line">mock(<span class="string">'database 3'</span>, <span class="string">'Meerkat'</span>)</span><br><span class="line"></span><br><span class="line">mock.assert_called_with(ANY, <span class="string">'Meerkat'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     class MyError(Exception):</span></span><br><span class="line"><span class="comment">#         pass</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     mock = Mock(spec=get_animals)</span></span><br><span class="line"><span class="comment">#     mock.side_effect = MyError('Whoops! Big problem')</span></span><br><span class="line"><span class="comment">#     result = mock(database, 'Meerkat')</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_food_period</span><span class="params">(database, species)</span>:</span></span><br><span class="line">    <span class="comment"># Query the Database</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># Return a time delta</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feed_animal</span><span class="params">(database, name, when)</span>:</span></span><br><span class="line">    <span class="comment"># Write to the Database</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rounds</span><span class="params">(database, species)</span>:</span></span><br><span class="line">    now = datetime.datetime.utcnow()</span><br><span class="line">    feeding_timedelta = get_food_period(database, species)</span><br><span class="line">    animals = get_animals(database, species)</span><br><span class="line">    fed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, last_mealtime <span class="keyword">in</span> animals:</span><br><span class="line">        <span class="keyword">if</span> (now - last_mealtime) &gt; feeding_timedelta:</span><br><span class="line">            feed_animal(database, name, now)</span><br><span class="line">            fed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rounds</span><span class="params">(database, species, *,</span></span></span><br><span class="line"><span class="function"><span class="params">              now_func=datetime.utcnow,</span></span></span><br><span class="line"><span class="function"><span class="params">              food_func=get_food_period,</span></span></span><br><span class="line"><span class="function"><span class="params">              animals_func=get_animals,</span></span></span><br><span class="line"><span class="function"><span class="params">              feed_func=feed_animal)</span>:</span></span><br><span class="line">    now = now_func()</span><br><span class="line">    feeding_timedelta = food_func(database, species)</span><br><span class="line">    animals = animals_func(database, species)</span><br><span class="line">    fed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, last_mealtime <span class="keyword">in</span> animals:</span><br><span class="line">        <span class="keyword">if</span> (now - last_mealtime) &gt; feeding_timedelta:</span><br><span class="line">            feed_func(database, name, now)</span><br><span class="line">            fed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">now_func = Mock(spec=datetime.utcnow)</span><br><span class="line">now_func.return_value = datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">food_func = Mock(spec=get_food_period)</span><br><span class="line">food_func.return_value = timedelta(hours=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">animals_func = Mock(spec=get_animals)</span><br><span class="line">animals_func.return_value = [</span><br><span class="line">    (<span class="string">'Spot'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">15</span>)),</span><br><span class="line">    (<span class="string">'Fluffy'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">30</span>)),</span><br><span class="line">    (<span class="string">'Jojo'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">45</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">feed_func = Mock(spec=feed_animal)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line">result = do_rounds(</span><br><span class="line">    database,</span><br><span class="line">    <span class="string">'Meerkat'</span>,</span><br><span class="line">    now_func=now_func,</span><br><span class="line">    food_func=food_func,</span><br><span class="line">    animals_func=animals_func,</span><br><span class="line">    feed_func=feed_func)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> result == <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 14</span></span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> call</span><br><span class="line"></span><br><span class="line">food_func.assert_called_once_with(database, <span class="string">'Meerkat'</span>)</span><br><span class="line"></span><br><span class="line">animals_func.assert_called_once_with(database, <span class="string">'Meerkat'</span>)</span><br><span class="line"></span><br><span class="line">feed_func.assert_has_calls(</span><br><span class="line">    [</span><br><span class="line">        call(database, <span class="string">'Spot'</span>, now_func.return_value),</span><br><span class="line">        call(database, <span class="string">'Fluffy'</span>, now_func.return_value),</span><br><span class="line">    ],</span><br><span class="line">    any_order=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 15</span></span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Outside patch:'</span>, get_animals)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> patch(<span class="string">'__main__.get_animals'</span>):</span><br><span class="line">    print(<span class="string">'Inside patch: '</span>, get_animals)</span><br><span class="line"></span><br><span class="line">print(<span class="string">'Outside again:'</span>, get_animals)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 16</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     fake_now = datetime(2019, 6, 5, 15, 45)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     with patch('datetime.datetime.utcnow'):</span></span><br><span class="line"><span class="comment">#         datetime.utcnow.return_value = fake_now</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 17</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_do_rounds_time</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> datetime.datetime.utcnow()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rounds</span><span class="params">(database, species)</span>:</span></span><br><span class="line">    now = get_do_rounds_time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> patch(<span class="string">'__main__.get_do_rounds_time'</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 18</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rounds</span><span class="params">(database, species, *, utcnow=datetime.utcnow)</span>:</span></span><br><span class="line">    now = utcnow()</span><br><span class="line">    feeding_timedelta = get_food_period(database, species)</span><br><span class="line">    animals = get_animals(database, species)</span><br><span class="line">    fed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, last_mealtime <span class="keyword">in</span> animals:</span><br><span class="line">        <span class="keyword">if</span> (now - last_mealtime) &gt; feeding_timedelta:</span><br><span class="line">            feed_animal(database, name, now)</span><br><span class="line">            fed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 19</span></span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> DEFAULT</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> patch.multiple(<span class="string">'__main__'</span>,</span><br><span class="line">                    autospec=<span class="literal">True</span>,</span><br><span class="line">                    get_food_period=DEFAULT,</span><br><span class="line">                    get_animals=DEFAULT,</span><br><span class="line">                    feed_animal=DEFAULT):</span><br><span class="line">    now_func = Mock(spec=datetime.utcnow)</span><br><span class="line">    now_func.return_value = datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">45</span>)</span><br><span class="line">    get_food_period.return_value = timedelta(hours=<span class="number">3</span>)</span><br><span class="line">    get_animals.return_value = [</span><br><span class="line">        (<span class="string">'Spot'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">15</span>)),</span><br><span class="line">        (<span class="string">'Fluffy'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">30</span>)),</span><br><span class="line">        (<span class="string">'Jojo'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">45</span>))</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 20</span></span><br><span class="line">    result = do_rounds(database, <span class="string">'Meerkat'</span>, utcnow=now_func)</span><br><span class="line">    <span class="keyword">assert</span> result == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    get_food_period.assert_called_once_with(database, <span class="string">'Meerkat'</span>)</span><br><span class="line">    get_animals.assert_called_once_with(database, <span class="string">'Meerkat'</span>)</span><br><span class="line">    feed_animal.assert_has_calls(</span><br><span class="line">        [</span><br><span class="line">            call(database, <span class="string">'Spot'</span>, now_func.return_value),</span><br><span class="line">            call(database, <span class="string">'Fluffy'</span>, now_func.return_value),</span><br><span class="line">        ],</span><br><span class="line">        any_order=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h3 id="79-把受测代码所依赖的系统封装起来，以便于模拟和测试"><a href="#79-把受测代码所依赖的系统封装起来，以便于模拟和测试" class="headerlink" title="79. 把受测代码所依赖的系统封装起来，以便于模拟和测试"></a>79. 把受测代码所依赖的系统封装起来，以便于模拟和测试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZooDatabase</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_animals</span><span class="params">(self, species)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_food_period</span><span class="params">(self, species)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">feed_animal</span><span class="params">(self, name, when)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_rounds</span><span class="params">(database, species, *, utcnow=datetime.utcnow)</span>:</span></span><br><span class="line">    now = utcnow()</span><br><span class="line">    feeding_timedelta = database.get_food_period(species)</span><br><span class="line">    animals = database.get_animals(species)</span><br><span class="line">    fed = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name, last_mealtime <span class="keyword">in</span> animals:</span><br><span class="line">        <span class="keyword">if</span> (now - last_mealtime) &gt;= feeding_timedelta:</span><br><span class="line">            database.feed_animal(name, now)</span><br><span class="line">            fed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fed</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> Mock</span><br><span class="line"></span><br><span class="line">database = Mock(spec=ZooDatabase)</span><br><span class="line">print(database.feed_animal)</span><br><span class="line">database.feed_animal()</span><br><span class="line">database.feed_animal.assert_any_call()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> call</span><br><span class="line"></span><br><span class="line">now_func = Mock(spec=datetime.utcnow)</span><br><span class="line">now_func.return_value = datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">45</span>)</span><br><span class="line"></span><br><span class="line">database = Mock(spec=ZooDatabase)</span><br><span class="line">database.get_food_period.return_value = timedelta(hours=<span class="number">3</span>)</span><br><span class="line">database.get_animals.return_value = [</span><br><span class="line">    (<span class="string">'Spot'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">11</span>, <span class="number">15</span>)),</span><br><span class="line">    (<span class="string">'Fluffy'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">30</span>)),</span><br><span class="line">    (<span class="string">'Jojo'</span>, datetime(<span class="number">2019</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">12</span>, <span class="number">55</span>))</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line">result = do_rounds(database, <span class="string">'Meerkat'</span>, utcnow=now_func)</span><br><span class="line"><span class="keyword">assert</span> result == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">database.get_food_period.assert_called_once_with(<span class="string">'Meerkat'</span>)</span><br><span class="line">database.get_animals.assert_called_once_with(<span class="string">'Meerkat'</span>)</span><br><span class="line">database.feed_animal.assert_has_calls(</span><br><span class="line">    [</span><br><span class="line">        call(<span class="string">'Spot'</span>, now_func.return_value),</span><br><span class="line">        call(<span class="string">'Fluffy'</span>, now_func.return_value),</span><br><span class="line">    ],</span><br><span class="line">    any_order=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Example 6</span></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"><span class="comment">#     database.bad_method_name()</span></span><br><span class="line"><span class="comment"># except:</span></span><br><span class="line"><span class="comment">#     logging.exception('Expected')</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#     assert False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line">DATABASE = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_database</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> DATABASE</span><br><span class="line">    <span class="keyword">if</span> DATABASE <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        DATABASE = ZooDatabase()</span><br><span class="line">    <span class="keyword">return</span> DATABASE</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(argv)</span>:</span></span><br><span class="line">    database = get_database()</span><br><span class="line">    species = argv[<span class="number">1</span>]</span><br><span class="line">    count = do_rounds(database, species)</span><br><span class="line">    print(<span class="string">f'Fed <span class="subst">&#123;count&#125;</span> <span class="subst">&#123;species&#125;</span>(s)'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> patch(<span class="string">'__main__.DATABASE'</span>, spec=ZooDatabase):</span><br><span class="line">    now = datetime.utcnow()</span><br><span class="line"></span><br><span class="line">    DATABASE.get_food_period.return_value = timedelta(hours=<span class="number">3</span>)</span><br><span class="line">    DATABASE.get_animals.return_value = [</span><br><span class="line">        (<span class="string">'Spot'</span>, now - timedelta(minutes=<span class="number">4.5</span>)),</span><br><span class="line">        (<span class="string">'Fluffy'</span>, now - timedelta(hours=<span class="number">3.25</span>)),</span><br><span class="line">        (<span class="string">'Jojo'</span>, now - timedelta(hours=<span class="number">3</span>)),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    fake_stdout = io.StringIO()</span><br><span class="line">    <span class="keyword">with</span> contextlib.redirect_stdout(fake_stdout):</span><br><span class="line">        main([<span class="string">'program name'</span>, <span class="string">'Meerkat'</span>])</span><br><span class="line"></span><br><span class="line">    found = fake_stdout.getvalue()</span><br><span class="line">    expected = <span class="string">'Fed 2 Meerkat(s)\n'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> found == expected</span><br></pre></td></tr></table></figure>
<h3 id="80-考虑用pdb做交互调试"><a href="#80-考虑用pdb做交互调试" class="headerlink" title="80. 考虑用pdb做交互调试"></a>80. 考虑用pdb做交互调试</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compute_rmse</span><span class="params">(observed, ideal)</span>:</span></span><br><span class="line">    total_err_2 = <span class="number">0</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> got, wanted <span class="keyword">in</span> zip(observed, ideal):</span><br><span class="line">        err_2 = (got - wanted) ** <span class="number">2</span></span><br><span class="line">        breakpoint()  <span class="comment"># Start the debugger here</span></span><br><span class="line">        total_err_2 += err_2</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    mean_err = total_err_2 / count</span><br><span class="line">    rmse = math.sqrt(mean_err)</span><br><span class="line">    <span class="keyword">return</span> rmse</span><br><span class="line"></span><br><span class="line">result = compute_rmse(</span><br><span class="line">    [<span class="number">1.8</span>, <span class="number">1.7</span>, <span class="number">3.2</span>, <span class="number">6</span>],</span><br><span class="line">    [<span class="number">2</span>, <span class="number">1.5</span>, <span class="number">3</span>, <span class="number">5</span>])</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>
<h3 id="81-用tracemalloc来掌握内存的使用与泄漏情况"><a href="#81-用tracemalloc来掌握内存的使用与泄漏情况" class="headerlink" title="81. 用tracemalloc来掌握内存的使用与泄漏情况"></a>81. 用tracemalloc来掌握内存的使用与泄漏情况</h3><ol>
<li>gc模块可以帮助我们了解垃圾回收器追踪到了哪些对象，但并不能告诉我们那些对象是如何分配的；</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"></span><br><span class="line">found_objects = gc.get_objects()</span><br><span class="line">print(<span class="string">'Before:'</span>, len(found_objects))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> waste_memory</span><br><span class="line"></span><br><span class="line">hold_reference = waste_memory.run()</span><br><span class="line"></span><br><span class="line">found_objects = gc.get_objects()</span><br><span class="line">print(<span class="string">'After: '</span>, len(found_objects))</span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> found_objects[:<span class="number">3</span>]:</span><br><span class="line">    print(repr(obj)[:<span class="number">100</span>])</span><br><span class="line"></span><br><span class="line">print(<span class="string">'...'</span>)</span><br></pre></td></tr></table></figure>
<ol>
<li>python内置的tracemalloc模块提供了一套强大的工具，可以帮助我们了解内存的使用情况，并且找到这些内存由那一行代码所分配。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tracemalloc</span><br><span class="line"></span><br><span class="line">tracemalloc.start(<span class="number">10</span>)                      <span class="comment"># Set stack depth</span></span><br><span class="line">time1 = tracemalloc.take_snapshot()        <span class="comment"># Before snapshot</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data = os.urandom(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        obj = MyObject()</span><br><span class="line">        values.append(obj)</span><br><span class="line">    <span class="keyword">return</span> values</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    deep_values = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        deep_values.append(get_data())</span><br><span class="line">    <span class="keyword">return</span> deep_values</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x = run()                     <span class="comment"># Usage to debug</span></span><br><span class="line">time2 = tracemalloc.take_snapshot()        <span class="comment"># After snapshot</span></span><br><span class="line"></span><br><span class="line">stats = time2.compare_to(time1, <span class="string">'lineno'</span>)  <span class="comment"># Compare snapshots</span></span><br><span class="line"><span class="keyword">for</span> stat <span class="keyword">in</span> stats[:<span class="number">3</span>]:</span><br><span class="line">    print(stat)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tracemalloc</span><br><span class="line"></span><br><span class="line">tracemalloc.start(<span class="number">10</span>)</span><br><span class="line">time1 = tracemalloc.take_snapshot()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObject</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.data = os.urandom(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        obj = MyObject()</span><br><span class="line">        values.append(obj)</span><br><span class="line">    <span class="keyword">return</span> values</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    deep_values = []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        deep_values.append(get_data())</span><br><span class="line">    <span class="keyword">return</span> deep_values</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x = run()</span><br><span class="line">time2 = tracemalloc.take_snapshot()</span><br><span class="line"></span><br><span class="line">stats = time2.compare_to(time1, <span class="string">'traceback'</span>)</span><br><span class="line">top = stats[<span class="number">0</span>]</span><br><span class="line">print(<span class="string">'Biggest offender is:'</span>)</span><br><span class="line">print(<span class="string">'\n'</span>.join(top.traceback.format()))</span><br></pre></td></tr></table></figure>
<h2 id="十-协作并发"><a href="#十-协作并发" class="headerlink" title="十. 协作并发"></a>十. 协作并发</h2><h3 id="82-学会寻找由其他Python开发者所构建的模块"><a href="#82-学会寻找由其他Python开发者所构建的模块" class="headerlink" title="82. 学会寻找由其他Python开发者所构建的模块"></a>82. 学会寻找由其他Python开发者所构建的模块</h3><p>python集中存放模块的地方：<a href="https://pypi.org" target="_blank" rel="noopener">https://pypi.org</a> 。</p>
<h3 id="83-用虚拟环境隔离项目，并重建依赖关系"><a href="#83-用虚拟环境隔离项目，并重建依赖关系" class="headerlink" title="83. 用虚拟环境隔离项目，并重建依赖关系"></a>83. 用虚拟环境隔离项目，并重建依赖关系</h3><p>通过pip show可以查看它的依赖关系：<code>python3 -m pip show flask</code>, 结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name: Flask</span><br><span class="line">Version: 2.0.1</span><br><span class="line">Summary: A simple framework for building complex web applications.</span><br><span class="line">Home-page: https://palletsprojects.com/p/flask</span><br><span class="line">Author: Armin Ronacher</span><br><span class="line">Author-email: armin.ronacher@active-4.com</span><br><span class="line">License: BSD-3-Clause</span><br><span class="line">Location: /usr/local/lib/python3.9/site-packages</span><br><span class="line">Requires: itsdangerous, click, Jinja2, Werkzeug</span><br><span class="line">Required-by:</span><br></pre></td></tr></table></figure>
<p>在命令行界面执行venv命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -m venv 虚拟环境名  # 创建虚拟环境</span><br><span class="line">source bin/activate 和 deactivate  # 启用和禁用该环境</span><br><span class="line">python3 -m pip install -r requirements.txt # 安装包</span><br></pre></td></tr></table></figure>
<h3 id="84-每一个函数、类与模块都要写docstring"><a href="#84-每一个函数、类与模块都要写docstring" class="headerlink" title="84. 每一个函数、类与模块都要写docstring"></a>84. 每一个函数、类与模块都要写docstring</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_anagrams</span><span class="params">(word, dictionary)</span>:</span></span><br><span class="line">    <span class="string">"""Find all anagrams for a word.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function only runs as fast as the test for</span></span><br><span class="line"><span class="string">    membership in the 'dictionary' container.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        word: String of the target word.</span></span><br><span class="line"><span class="string">        dictionary: collections.abc.Container with all</span></span><br><span class="line"><span class="string">            strings that are known to be actual words.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        List of anagrams that were found. Empty if</span></span><br><span class="line"><span class="string">        none were found.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    permutations = itertools.permutations(word, len(word))</span><br><span class="line">    possible = (<span class="string">''</span>.join(x) <span class="keyword">for</span> x <span class="keyword">in</span> permutations)</span><br><span class="line">    found = &#123;word <span class="keyword">for</span> word <span class="keyword">in</span> possible <span class="keyword">if</span> word <span class="keyword">in</span> dictionary&#125;</span><br><span class="line">    <span class="keyword">return</span> list(found)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> find_anagrams(<span class="string">'pancakes'</span>, [<span class="string">'scanpeak'</span>]) == [<span class="string">'scanpeak'</span>]</span><br></pre></td></tr></table></figure>
<h3 id="85-用包来安排模块，以提供稳固的API"><a href="#85-用包来安排模块，以提供稳固的API" class="headerlink" title="85. 用包来安排模块，以提供稳固的API"></a>85. 用包来安排模块，以提供稳固的API</h3><p>如我们想设计一个包，用来计算抛射物之间的碰撞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypackage/models.py</span></span><br><span class="line">__all__ = [<span class="string">'Projectile'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Projectile</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mass, velocity)</span>:</span></span><br><span class="line">        self.mass = mass</span><br><span class="line">        self.velocity = velocity</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypackage/utils.py</span></span><br><span class="line"><span class="keyword">from</span> . models <span class="keyword">import</span> Projectile</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'simulate_collision'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_dot_product</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulate_collision</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    after_a = Projectile(-a.mass, -a.velocity)</span><br><span class="line">    after_b = Projectile(-b.mass, -b.velocity)</span><br><span class="line">    <span class="keyword">return</span> after_a, after_b</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mypackage/__init__.py</span></span><br><span class="line">__all__ = []</span><br><span class="line"><span class="keyword">from</span> . models <span class="keyword">import</span> *</span><br><span class="line">__all__ += models.__all__</span><br><span class="line"><span class="keyword">from</span> . utils <span class="keyword">import</span> *</span><br><span class="line">__all__ += utils.__all__</span><br></pre></td></tr></table></figure>
<p>没有出现在<code>__all___</code>之中的，都不会随着<code>from mypackage import *</code>语句引入，对外部使用者隐藏了这些名字。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api_consumer.py</span></span><br><span class="line"><span class="keyword">from</span> mypackage <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">a = Projectile(<span class="number">1.5</span>, <span class="number">3</span>)</span><br><span class="line">b = Projectile(<span class="number">4</span>, <span class="number">1.7</span>)</span><br><span class="line">after_a, after_b = simulate_collision(a, b)</span><br><span class="line">print(after_a.__dict__, after_b.__dict__)  <span class="comment"># &#123;'mass': -1.5, 'velocity': -3&#125; &#123;'mass': -4, 'velocity': -1.7&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="86-考虑用模块级别的代码配置不同的部署环境"><a href="#86-考虑用模块级别的代码配置不同的部署环境" class="headerlink" title="86. 考虑用模块级别的代码配置不同的部署环境"></a>86. 考虑用模块级别的代码配置不同的部署环境</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestingDatabase</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealDatabase</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TESTING = <span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> TESTING:</span><br><span class="line">    Database = TestingDatabase</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    Database = RealDatabase</span><br></pre></td></tr></table></figure>
<h3 id="87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"><a href="#87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常" class="headerlink" title="87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"></a>87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="comment"># my_module.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">determine_weight</span><span class="params">(volume, density)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> density &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'Density must be positive'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    determine_weight(<span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">except</span> ValueError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line"><span class="comment"># my_module.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Error</span><span class="params">(Exception)</span>:</span></span><br><span class="line">    <span class="string">"""Base-class for all exceptions raised by this module."""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidDensityError</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="string">"""There was a problem with a provided density value."""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InvalidVolumeError</span><span class="params">(Error)</span>:</span></span><br><span class="line">    <span class="string">"""There was a problem with the provided weight value."""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">determine_weight</span><span class="params">(volume, density)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> density &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> InvalidDensityError(<span class="string">'Density must be positive'</span>)</span><br><span class="line">    <span class="keyword">if</span> volume &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> InvalidVolumeError(<span class="string">'Volume must be positive'</span>)</span><br><span class="line">    <span class="keyword">if</span> volume == <span class="number">0</span>:</span><br><span class="line">        density / volume</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">my_module</span>:</span></span><br><span class="line">    Error = Error</span><br><span class="line">    InvalidDensityError = InvalidDensityError</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">determine_weight</span><span class="params">(volume, density)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> density &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> InvalidDensityError(<span class="string">'Density must be positive'</span>)</span><br><span class="line">        <span class="keyword">if</span> volume &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> InvalidVolumeError(<span class="string">'Volume must be positive'</span>)</span><br><span class="line">        <span class="keyword">if</span> volume == <span class="number">0</span>:</span><br><span class="line">            density / volume</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    weight = my_module.determine_weight(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">except</span> my_module.Error:</span><br><span class="line">    logging.exception(<span class="string">'Unexpected error'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">SENTINEL = object()</span><br><span class="line">weight = SENTINEL</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    weight = my_module.determine_weight(<span class="number">-1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">except</span> my_module.InvalidDensityError:</span><br><span class="line">    weight = <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> my_module.Error:</span><br><span class="line">    logging.exception(<span class="string">'Bug in the calling code'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> weight <span class="keyword">is</span> SENTINEL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    weight = SENTINEL</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        weight = my_module.determine_weight(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> my_module.InvalidDensityError:</span><br><span class="line">        weight = <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> my_module.Error:</span><br><span class="line">        logging.exception(<span class="string">'Bug in the calling code'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        logging.exception(<span class="string">'Bug in the API code!'</span>)</span><br><span class="line">        <span class="keyword">raise</span>  <span class="comment"># Re-raise exception to the caller</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">assert</span> weight == <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    logging.exception(<span class="string">'Expected'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="comment"># my_module.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NegativeDensityError</span><span class="params">(InvalidDensityError)</span>:</span></span><br><span class="line">    <span class="string">"""A provided density value was negative."""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">determine_weight</span><span class="params">(volume, density)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> density &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> NegativeDensityError(<span class="string">'Density must be positive'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    my_module.NegativeDensityError = NegativeDensityError</span><br><span class="line">    my_module.determine_weight = determine_weight</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        weight = my_module.determine_weight(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">except</span> my_module.NegativeDensityError:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'Must supply non-negative density'</span>)</span><br><span class="line">    <span class="keyword">except</span> my_module.InvalidDensityError:</span><br><span class="line">        weight = <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> my_module.Error:</span><br><span class="line">        logging.exception(<span class="string">'Bug in the calling code'</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        logging.exception(<span class="string">'Bug in the API code!'</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    logging.exception(<span class="string">'Expected'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="88-用适当的方式打破循环依赖关系"><a href="#88-用适当的方式打破循环依赖关系" class="headerlink" title="88. 用适当的方式打破循环依赖关系"></a>88. 用适当的方式打破循环依赖关系</h3><ol>
<li><p>如果两个模块都要在开头引入对方，那就会形成循环依赖关系，可能会导致程序启动时崩溃；</p>
</li>
<li><p>想要打破循环依赖，最好的办法是把这两个模块都用到的代码重构到整个依赖的最底层；</p>
</li>
<li><p>如果不想大幅度重构代码，也不想让代码太复杂，最简单的方法就是通过动态引入来消除循环依赖关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dialog.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dialog</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Using this instead will break things</span></span><br><span class="line"><span class="comment"># save_dialog = Dialog(app.prefs.get('save_dir'))</span></span><br><span class="line">save_dialog = Dialog()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">import</span> app  <span class="comment"># Dynamic import  程序运行时才触发</span></span><br><span class="line">    save_dialog.save_dir = app.prefs.get(<span class="string">'save_dir'</span>)</span><br><span class="line">    print(<span class="string">'Showing the dialog!'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">import</span> dialog</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Prefs</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">prefs = Prefs()</span><br><span class="line">dialog.show()</span><br></pre></td></tr></table></figure>
<p>一般来说，还是应该尽量避免动态引入，因为import语句毕竟是有开销的，如果它出现在频繁执行的循环体里面，这种开销会更大。虽然如此，但是比大幅度修改整个程序要好。</p>
</li>
</ol>
<h3 id="89-重构时考虑通过warnings提醒开发者API已经发生变化"><a href="#89-重构时考虑通过warnings提醒开发者API已经发生变化" class="headerlink" title="89. 重构时考虑通过warnings提醒开发者API已经发生变化"></a>89. 重构时考虑通过warnings提醒开发者API已经发生变化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Example 1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_distance</span><span class="params">(speed, duration)</span>:</span></span><br><span class="line">    distance = speed * duration</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;distance&#125;</span> miles'</span>)</span><br><span class="line"></span><br><span class="line">print_distance(<span class="number">5</span>, <span class="number">2.5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 2</span></span><br><span class="line">print_distance(<span class="number">1000</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 3</span></span><br><span class="line">CONVERSIONS = &#123;</span><br><span class="line">    <span class="string">'mph'</span>: <span class="number">1.60934</span> / <span class="number">3600</span> * <span class="number">1000</span>,   <span class="comment"># m/s</span></span><br><span class="line">    <span class="string">'hours'</span>: <span class="number">3600</span>,                  <span class="comment"># seconds</span></span><br><span class="line">    <span class="string">'miles'</span>: <span class="number">1.60934</span> * <span class="number">1000</span>,        <span class="comment"># m</span></span><br><span class="line">    <span class="string">'meters'</span>: <span class="number">1</span>,                    <span class="comment"># m</span></span><br><span class="line">    <span class="string">'m/s'</span>: <span class="number">1</span>,                       <span class="comment"># m</span></span><br><span class="line">    <span class="string">'seconds'</span>: <span class="number">1</span>,                   <span class="comment"># s</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert</span><span class="params">(value, units)</span>:</span></span><br><span class="line">    rate = CONVERSIONS[units]</span><br><span class="line">    <span class="keyword">return</span> rate * value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">localize</span><span class="params">(value, units)</span>:</span></span><br><span class="line">    rate = CONVERSIONS[units]</span><br><span class="line">    <span class="keyword">return</span> value / rate</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_distance</span><span class="params">(speed, duration, *,</span></span></span><br><span class="line"><span class="function"><span class="params">                   speed_units=<span class="string">'mph'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                   time_units=<span class="string">'hours'</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                   distance_units=<span class="string">'miles'</span>)</span>:</span></span><br><span class="line">    norm_speed = convert(speed, speed_units)</span><br><span class="line">    norm_duration = convert(duration, time_units)</span><br><span class="line">    norm_distance = norm_speed * norm_duration</span><br><span class="line">    distance = localize(norm_distance, distance_units)</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;distance&#125;</span> <span class="subst">&#123;distance_units&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 4</span></span><br><span class="line">print_distance(<span class="number">1000</span>, <span class="number">3</span>,</span><br><span class="line">               speed_units=<span class="string">'meters'</span>,</span><br><span class="line">               time_units=<span class="string">'seconds'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 5</span></span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_distance</span><span class="params">(speed, duration, *,</span></span></span><br><span class="line"><span class="function"><span class="params">                   speed_units=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                   time_units=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                   distance_units=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> speed_units <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        warnings.warn(</span><br><span class="line">            <span class="string">'speed_units required'</span>, DeprecationWarning)</span><br><span class="line">        speed_units = <span class="string">'mph'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> time_units <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        warnings.warn(</span><br><span class="line">            <span class="string">'time_units required'</span>, DeprecationWarning)</span><br><span class="line">        time_units = <span class="string">'hours'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> distance_units <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        warnings.warn(</span><br><span class="line">            <span class="string">'distance_units required'</span>, DeprecationWarning)</span><br><span class="line">        distance_units = <span class="string">'miles'</span></span><br><span class="line"></span><br><span class="line">    norm_speed = convert(speed, speed_units)</span><br><span class="line">    norm_duration = convert(duration, time_units)</span><br><span class="line">    norm_distance = norm_speed * norm_duration</span><br><span class="line">    distance = localize(norm_distance, distance_units)</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;distance&#125;</span> <span class="subst">&#123;distance_units&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 6</span></span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">fake_stderr = io.StringIO()</span><br><span class="line"><span class="keyword">with</span> contextlib.redirect_stderr(fake_stderr):</span><br><span class="line">    print_distance(<span class="number">1000</span>, <span class="number">3</span>,</span><br><span class="line">                   speed_units=<span class="string">'meters'</span>,</span><br><span class="line">                   time_units=<span class="string">'seconds'</span>)</span><br><span class="line"></span><br><span class="line">print(fake_stderr.getvalue())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 7</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">require</span><span class="params">(name, value, default)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    warnings.warn(</span><br><span class="line">        <span class="string">f'<span class="subst">&#123;name&#125;</span> will be required soon, update your code'</span>,</span><br><span class="line">        DeprecationWarning,</span><br><span class="line">        stacklevel=<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_distance</span><span class="params">(speed, duration, *,</span></span></span><br><span class="line"><span class="function"><span class="params">                   speed_units=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                   time_units=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                   distance_units=None)</span>:</span></span><br><span class="line">    speed_units = require(<span class="string">'speed_units'</span>, speed_units, <span class="string">'mph'</span>)</span><br><span class="line">    time_units = require(<span class="string">'time_units'</span>, time_units, <span class="string">'hours'</span>)</span><br><span class="line">    distance_units = require(</span><br><span class="line">        <span class="string">'distance_units'</span>, distance_units, <span class="string">'miles'</span>)</span><br><span class="line"></span><br><span class="line">    norm_speed = convert(speed, speed_units)</span><br><span class="line">    norm_duration = convert(duration, time_units)</span><br><span class="line">    norm_distance = norm_speed * norm_duration</span><br><span class="line">    distance = localize(norm_distance, distance_units)</span><br><span class="line">    print(<span class="string">f'<span class="subst">&#123;distance&#125;</span> <span class="subst">&#123;distance_units&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 8</span></span><br><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">fake_stderr = io.StringIO()</span><br><span class="line"><span class="keyword">with</span> contextlib.redirect_stderr(fake_stderr):</span><br><span class="line">    print_distance(<span class="number">1000</span>, <span class="number">3</span>,</span><br><span class="line">                   speed_units=<span class="string">'meters'</span>,</span><br><span class="line">                   time_units=<span class="string">'seconds'</span>)</span><br><span class="line"></span><br><span class="line">print(fake_stderr.getvalue())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 9</span></span><br><span class="line">warnings.simplefilter(<span class="string">'error'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    warnings.warn(<span class="string">'This usage is deprecated'</span>,</span><br><span class="line">                  DeprecationWarning)</span><br><span class="line"><span class="keyword">except</span> DeprecationWarning:</span><br><span class="line">    <span class="keyword">pass</span>  <span class="comment"># Expected</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">warnings.resetwarnings()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 10</span></span><br><span class="line">warnings.resetwarnings()</span><br><span class="line"></span><br><span class="line">warnings.simplefilter(<span class="string">'ignore'</span>)</span><br><span class="line">warnings.warn(<span class="string">'This will not be printed to stderr'</span>)</span><br><span class="line"></span><br><span class="line">warnings.resetwarnings()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 11</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">fake_stderr = io.StringIO()</span><br><span class="line">handler = logging.StreamHandler(fake_stderr)</span><br><span class="line">formatter = logging.Formatter(</span><br><span class="line">    <span class="string">'%(asctime)-15s WARNING] %(message)s'</span>)</span><br><span class="line">handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">logging.captureWarnings(<span class="literal">True</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">'py.warnings'</span>)</span><br><span class="line">logger.addHandler(handler)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">warnings.resetwarnings()</span><br><span class="line">warnings.simplefilter(<span class="string">'default'</span>)</span><br><span class="line">warnings.warn(<span class="string">'This will go to the logs output'</span>)</span><br><span class="line"></span><br><span class="line">print(fake_stderr.getvalue())</span><br><span class="line"></span><br><span class="line">warnings.resetwarnings()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 12</span></span><br><span class="line"><span class="keyword">with</span> warnings.catch_warnings(record=<span class="literal">True</span>) <span class="keyword">as</span> found_warnings:</span><br><span class="line">    found = require(<span class="string">'my_arg'</span>, <span class="literal">None</span>, <span class="string">'fake units'</span>)</span><br><span class="line">    expected = <span class="string">'fake units'</span></span><br><span class="line">    <span class="keyword">assert</span> found == expected</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Example 13</span></span><br><span class="line"><span class="keyword">assert</span> len(found_warnings) == <span class="number">1</span></span><br><span class="line">single_warning = found_warnings[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">assert</span> str(single_warning.message) == (</span><br><span class="line">    <span class="string">'my_arg will be required soon, update your code'</span>)</span><br><span class="line"><span class="keyword">assert</span> single_warning.category == DeprecationWarning</span><br></pre></td></tr></table></figure>
<h3 id="90-考虑通过typing做静态分析，以消除bug"><a href="#90-考虑通过typing做静态分析，以消除bug" class="headerlink" title="90. 考虑通过typing做静态分析，以消除bug"></a>90. 考虑通过typing做静态分析，以消除bug</h3><p>typing模块：<a href="https://docs.python.org/3.8/library/typing.html" target="_blank" rel="noopener">https://docs.python.org/3.8/library/typing.html</a>。可以给变量，字段，函数与方法标注类型信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Callable, List, TypeVar</span><br><span class="line"></span><br><span class="line">Value = TypeVar(<span class="string">'Value'</span>)</span><br><span class="line">Func = Callable[[Value, Value], Value]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">combine</span><span class="params">(func: Func[Value], values: List[Value])</span> -&gt; Value:</span></span><br><span class="line">    <span class="keyword">assert</span> len(values) &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    result = values[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> next_value <span class="keyword">in</span> values[<span class="number">1</span>:]:</span><br><span class="line">        result = func(result, next_value)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Real = TypeVar(<span class="string">'Real'</span>, int, float)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x: Real, y: Real)</span> -&gt; Real:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inputs = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4j</span>]  <span class="comment"># Oops: included a complex number</span></span><br><span class="line">result = combine(add, inputs)</span><br><span class="line">print(result)  <span class="comment"># (6+4j)</span></span><br><span class="line"><span class="keyword">assert</span> result == <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>下面的python3.7开始支持，程序执行时，忽略类型注解里提到的值，于是就解决了提前引用的问题，而且程序在启动时的性能也会提升。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FirstClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value: SecondClass)</span> -&gt; <span class="keyword">None</span>:</span>  <span class="comment"># OK</span></span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecondClass</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, value: int)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">second = SecondClass(<span class="number">5</span>)</span><br><span class="line">print(second)  <span class="comment"># &lt;__main__.SecondClass object at 0x7fafc12cd4d0&gt;</span></span><br><span class="line">first = FirstClass(second)  </span><br><span class="line">print(first)  <span class="comment"># &lt;__main__.FirstClass object at 0x7fafc12cd510&gt;</span></span><br></pre></td></tr></table></figure>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎指出任何有错误或不够清晰的表达。欢迎邮件至 320479069@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>






    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="//cdn.jsdelivr.net/npm/mathjax@2.7.8/unpacked/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<input type="hidden" id="MathJax-js"
        value="//cdn.jsdelivr.net/npm/mathjax@2.7.8/unpacked/MathJax.js?config=TeX-MML-AM_CHTML">
</input>
    




    </div>
    <div class="copyright">
        <p class="footer-entry"><span class="miit">
                <img src="/img/gov.png" title="中华人民共和国工业和信息化部">
                <a href="http://beian.miit.gov.cn/">京ICP备20023773号-1</a>
        </span>
    
    ©2017-2021 CuiYonghua
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().trim().split('\n').length, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
        /* 渲染*/
        function HTMLDecode(text) {
            var temp = document.createElement("div");
            temp.innerHTML = text;
            var output = temp.innerText || temp.textContent;
            temp = null;
            return output;
        }
        if (window.mermaid){
            window.mermaid = null
        }
        $.getScript("//cdn.jsdelivr.net/npm/mermaid@8.4.2/dist/mermaid.min.js", function () {
            var mermaidOptions = JSON.parse(HTMLDecode("{&quot;theme&quot;:&quot;default&quot;,&quot;startOnLoad&quot;:true,&quot;flowchart&quot;:{&quot;useMaxWidth&quot;:true,&quot;htmlLabels&quot;:true}}"))
            if (window.mermaid) {
                mermaid.initialize(mermaidOptions)
                mermaid.contentLoaded()
            }
        })
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 592px;
    }
    .nav.fullscreen {
        margin-left: -592px;
    }
    .nav-left {
        width: 170px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 542px;
        }
        .nav.fullscreen {
            margin-left: -542px;
        }
        .nav-left {
            width: 150px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 542px;
            margin-left: -542px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
