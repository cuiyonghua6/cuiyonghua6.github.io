<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>Effective Python（摘录） | 崔永华的个人网站</title>
  <meta name="keywords" content=" python基础 , python优化 ">
  <meta name="description" content="Effective Python（摘录） | 崔永华的个人网站">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="分类">
<meta property="og:url" content="http://yoursite.com/categories/index.html">
<meta property="og:site_name" content="崔永华的个人网站">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-07-04T03:30:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="分类">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0"></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.1.0"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="undefined">
  <input class="theme_blog_path" value>
  <input id="theme_shortcut" value="true">
  <input id="theme_highlight_on" value="true">
  <input id="theme_code_copy" value="true">
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>崔永华</span>
</div>

<div class="icon">
    
        
            <a title="csdn"
               href="https://cuiyonghua.blog.csdn.net/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/cuiyonghua6"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="https://weibo.com/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/people/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/cuiyonghua"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="全部文章">全部文章
            
                <small>(165)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="爬虫">
                        <i class="fold iconfont icon-right"></i>
                        
                        爬虫
                        <small>(39)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="爬虫<--->pyppeteer">
                                        
                                        pyppeteer
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->scrapy">
                                        
                                        scrapy
                                        
                                            <small>(12
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->selenium">
                                        
                                        selenium
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->反爬逆向">
                                        
                                        反爬逆向
                                        
                                            <small>(7
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="爬虫<--->爬虫案例">
                                        
                                        爬虫案例
                                        
                                            <small>(14
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="数据处理">
                        <i class="fold iconfont icon-right"></i>
                        
                        数据处理
                        <small>(27)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="数据处理<--->ES">
                                        
                                        ES
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->hive">
                                        
                                        hive
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->MySQL">
                                        
                                        MySQL
                                        
                                            <small>(5
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="数据处理<--->PostgreSQL">
                                        
                                        PostgreSQL
                                        
                                            <small>(20
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="python">
                        <i class="fold iconfont icon-right"></i>
                        
                        python
                        <small>(41)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="python<--->python web">
                                        
                                        python web
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python优化">
                                        
                                        python优化
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python基础">
                                        
                                        python基础
                                        
                                            <small>(27
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python案例">
                                        
                                        python案例
                                        
                                            <small>(4
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python模块">
                                        
                                        python模块
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="python<--->python算法">
                                        
                                        python算法
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="前端">
                        <i class="fold iconfont icon-right"></i>
                        
                        前端
                        <small>(10)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="前端<--->javascript">
                                        
                                        javascript
                                        
                                            <small>(9
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="前端<--->前端案例">
                                        
                                        前端案例
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="部署">
                        
                        部署
                        <small>(2)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="java">
                        <i class="fold iconfont icon-right"></i>
                        
                        java
                        <small>(36)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="java<--->java基础">
                                        
                                        java基础
                                        
                                            <small>(8
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java案例">
                                        
                                        java案例
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java算法">
                                        
                                        java算法
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="java<--->java设计模式">
                                        
                                        java设计模式
                                        
                                            <small>(25
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="其它">
                        <i class="fold iconfont icon-right"></i>
                        
                        其它
                        <small>(9)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="其它<--->英语">
                                        
                                        英语
                                        
                                            <small>(2
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->计算机">
                                        
                                        计算机
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                                <li>
                                    <div data-rel="其它<--->读书">
                                        
                                        读书
                                        
                                            <small>(3
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
                <li>
                    <div data-rel="机器学习">
                        <i class="fold iconfont icon-right"></i>
                        
                        机器学习
                        <small>(1)</small>
                        
                    </div>
                    
                        <ul class="sub hide">
                            
                                <li>
                                    <div data-rel="机器学习<--->NLP">
                                        
                                        NLP
                                        
                                            <small>(1
                                                )</small>
                                        
                                    </div>
                                    
                                </li>
                            
                        </ul>
                    
                </li>
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">关于</a>
        
        <a style="width: 50%"
                
                                           class="friends">友链</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="165">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
            <li><a target="_blank" href="https://blog.wedaggo.com/">冯义万</a></li>
            
            <li><a target="_blank" href="https://xu-shaoyu.github.io/">徐绍玉</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>36计解说</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>C语言</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ES</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>fastapi</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>flask</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>hive</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>javascript</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java基础</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java打印图形</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java算法</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java设计模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>MySQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>NLP</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>PostgreSQL</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>pyppeteer</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python3</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python优化</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python基础</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>python案例</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>scrapy</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>selenium</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>代码雨</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>前端</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>反爬</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>排序</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数据处理</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>数据结构</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>日常生活</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>机器学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>概念</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>爬虫</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>网址</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>英语</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>英语作文模板</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>英语学习</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>计算机</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>计算机网络</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>读书</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 python python优化 "
           href="/2021/07/python/python优化/编写整洁的python代码/"
           data-tag="python基础,python优化"
           data-author="" >
            <span class="post-title" title="编写整洁的python代码（摘录）">编写整洁的python代码（摘录）</span>
            <span class="post-date" title="2021-07-26 15:24:20">2021/07/26</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/异步爬虫爬照片/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="异步爬虫爬照片">异步爬虫爬照片</span>
            <span class="post-date" title="2021-07-25 16:04:43">2021/07/25</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2021/07/python/python优化/python代码整洁之道/"
           data-tag="python基础,python优化"
           data-author="" >
            <span class="post-title" title="python3代码整洁之道（摘录）">python3代码整洁之道（摘录）</span>
            <span class="post-date" title="2021-07-24 15:24:20">2021/07/24</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2021/07/python/python优化/effective_python/"
           data-tag="python基础,python优化"
           data-author="" >
            <span class="post-title" title="Effective Python（摘录）">Effective Python（摘录）</span>
            <span class="post-date" title="2021-07-24 15:24:20">2021/07/24</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/爬取豆瓣top250数据/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="分别用多进程，多线程，协程爬取豆瓣top250数据">分别用多进程，多线程，协程爬取豆瓣top250数据</span>
            <span class="post-date" title="2021-07-19 20:34:53">2021/07/19</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/07/spider/cases/爬取九酷音乐/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取九酷音乐">爬取九酷音乐</span>
            <span class="post-date" title="2021-07-12 20:44:15">2021/07/12</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2021/06/spider/selenium/linux上安装selenium环境及测试/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="linux上安装selenium环境及测试">linux上安装selenium环境及测试</span>
            <span class="post-date" title="2021-06-24 19:03:22">2021/06/24</span>
        </a>
        
        <a  class="全部文章 其它 "
           href="/2021/03/others/个人网址/"
           data-tag="网址"
           data-author="" >
            <span class="post-title" title="阿里云网址记录">阿里云网址记录</span>
            <span class="post-date" title="2021-03-01 20:00:20">2021/03/01</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2021/01/spider/cases/PyExecJS库/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用python执行js代码：PyExecJS库">用python执行js代码：PyExecJS库</span>
            <span class="post-date" title="2021-01-07 20:37:51">2021/01/07</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/12/python/cases/将excel中的内容存入mysql/"
           data-tag="python,python案例"
           data-author="" >
            <span class="post-title" title="将excel中的内容存入mysql">将excel中的内容存入mysql</span>
            <span class="post-date" title="2020-12-02 15:24:20">2020/12/02</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/11/spider/cases/用requests+tkinter实现小型翻译器/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用requests+tkinter实现小型翻译器">用requests+tkinter实现小型翻译器</span>
            <span class="post-date" title="2020-11-30 20:43:06">2020/11/30</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/10/spider/cases/爬取阳光电影的链接/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取阳光电影的链接">爬取阳光电影的链接</span>
            <span class="post-date" title="2020-10-20 17:59:21">2020/10/20</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2020/10/python/cases/Python3代码雨/"
           data-tag="python,python案例,代码雨"
           data-author="" >
            <span class="post-title" title="用python实现代码雨">用python实现代码雨</span>
            <span class="post-date" title="2020-10-15 15:24:20">2020/10/15</span>
        </a>
        
        <a  class="全部文章 部署 "
           href="/2020/10/linux/20201012_vi/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="vi的常用指令">vi的常用指令</span>
            <span class="post-date" title="2020-10-12 15:24:20">2020/10/12</span>
        </a>
        
        <a  class="全部文章 其它 英语 "
           href="/2020/10/others/english/800_centence/"
           data-tag="英语"
           data-author="" >
            <span class="post-title" title="800个句子掌握7000单词">800个句子掌握7000单词</span>
            <span class="post-date" title="2020-10-11 01:30:00">2020/10/11</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2020/10/java/java基础/20201002_java9到14新特性/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="JDK9到14的重要新特性">JDK9到14的重要新特性</span>
            <span class="post-date" title="2020-10-02 23:19:19">2020/10/02</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2020/10/java/java基础/20201001_java8新特性/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="Java8新特性总结">Java8新特性总结</span>
            <span class="post-date" title="2020-10-01 23:19:19">2020/10/01</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/09/spider/反爬逆向/三种加密方式 sha1加密、MD5加密、Base64加密/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="三种加密方式 sha1加密、MD5加密、Base64加密">三种加密方式 sha1加密、MD5加密、Base64加密</span>
            <span class="post-date" title="2020-09-29 10:30:00">2020/09/29</span>
        </a>
        
        <a  class="全部文章 数据处理 hive "
           href="/2020/08/database/hive/hive操作/"
           data-tag="数据处理,hive"
           data-author="" >
            <span class="post-title" title="hive操作">hive操作</span>
            <span class="post-date" title="2020-08-13 15:24:20">2020/08/13</span>
        </a>
        
        <a  class="全部文章 python python优化 "
           href="/2020/07/python/python优化/定时任务/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python3代码编程规范">python3代码编程规范</span>
            <span class="post-date" title="2020-07-26 10:35:00">2020/07/26</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/07/spider/反爬逆向/Ajax动态刷新-有道翻译案例/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="Ajax动态刷新-有道翻译案例">Ajax动态刷新-有道翻译案例</span>
            <span class="post-date" title="2020-07-20 20:39:05">2020/07/20</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200715_ ajaxcrawl/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码12 - ajaxcrawl">scrapy源码12 - ajaxcrawl</span>
            <span class="post-date" title="2020-07-15 10:35:00">2020/07/15</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2020/07/database/mysql/20200713_mysql与pg用户管理对比/"
           data-tag="数据处理,PostgreSQL,MySQL"
           data-author="" >
            <span class="post-title" title="MySQL用户管理与PostgreSQL用户管理的对比">MySQL用户管理与PostgreSQL用户管理的对比</span>
            <span class="post-date" title="2020-07-13 15:24:20">2020/07/13</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200713_ webclient/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码11 - webclient">scrapy源码11 - webclient</span>
            <span class="post-date" title="2020-07-13 10:35:00">2020/07/13</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200712_tls/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码10 - tls">scrapy源码10 - tls</span>
            <span class="post-date" title="2020-07-12 10:35:00">2020/07/12</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200711_ downloadermiddleware/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码9 - downloadermiddleware">scrapy源码9 - downloadermiddleware</span>
            <span class="post-date" title="2020-07-11 10:35:00">2020/07/11</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200709_ contextfactory/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码8 - contextfactory">scrapy源码8 - contextfactory</span>
            <span class="post-date" title="2020-07-09 10:35:00">2020/07/09</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200708_downloader/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码7：downloader的源码分析">scrapy源码7：downloader的源码分析</span>
            <span class="post-date" title="2020-07-08 10:35:00">2020/07/08</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200707_deffer和parallel/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码6：deffer和parallel的源码分析">scrapy源码6：deffer和parallel的源码分析</span>
            <span class="post-date" title="2020-07-07 10:35:00">2020/07/07</span>
        </a>
        
        <a  class="全部文章 爬虫 pyppeteer "
           href="/2020/07/spider/pyppeteer/02_各种案例/"
           data-tag="python,pyppeteer"
           data-author="" >
            <span class="post-title" title="pyppeteer的各种案例">pyppeteer的各种案例</span>
            <span class="post-date" title="2020-07-06 10:30:00">2020/07/06</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200705_ middleware/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码5：middleware的源码分析">scrapy源码5：middleware的源码分析</span>
            <span class="post-date" title="2020-07-05 10:35:00">2020/07/05</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200704_ spidermw/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码4：spidermw的源码分析">scrapy源码4：spidermw的源码分析</span>
            <span class="post-date" title="2020-07-04 10:35:00">2020/07/04</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200703_ scraper/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码3：scraper的源码分析">scrapy源码3：scraper的源码分析</span>
            <span class="post-date" title="2020-07-03 10:35:00">2020/07/03</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/07/spider/scrapy/20200701_scheduler/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码2：scheduler的源码分析">scrapy源码2：scheduler的源码分析</span>
            <span class="post-date" title="2020-07-01 10:35:00">2020/07/01</span>
        </a>
        
        <a  class="全部文章 爬虫 scrapy "
           href="/2020/06/spider/scrapy/20200630_engine/"
           data-tag="python,爬虫,scrapy"
           data-author="" >
            <span class="post-title" title="scrapy源码1：engine的源码分析">scrapy源码1：engine的源码分析</span>
            <span class="post-date" title="2020-06-30 10:35:00">2020/06/30</span>
        </a>
        
        <a  class="全部文章 爬虫 pyppeteer "
           href="/2020/06/spider/pyppeteer/01_介绍及环境/"
           data-tag="python,pyppeteer"
           data-author="" >
            <span class="post-title" title="pyppeteer的环境搭建，常见参数及2个案例">pyppeteer的环境搭建，常见参数及2个案例</span>
            <span class="post-date" title="2020-06-28 10:30:00">2020/06/28</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/06/python/python模块/tqdm进度条模块详解/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="进度条模块tqdm详解">进度条模块tqdm详解</span>
            <span class="post-date" title="2020-06-17 19:22:17">2020/06/17</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/06/spider/cases/用4种方式爬取CSDN用户的全部文章/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用4种方式爬取CSDN用户的全部文章">用4种方式爬取CSDN用户的全部文章</span>
            <span class="post-date" title="2020-06-17 17:25:55">2020/06/17</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/06/spider/cases/用selenium爬取csdn博客并提取数据/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用selenium爬取csdn博客并提取数据">用selenium爬取csdn博客并提取数据</span>
            <span class="post-date" title="2020-06-15 16:42:38">2020/06/15</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2020/06/database/mysql/20200609_mysql报错1366/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="mysql报错：1366, Incorrect string value:for colum 的解决办法">mysql报错：1366, Incorrect string value:for colum 的解决办法</span>
            <span class="post-date" title="2020-06-09 15:24:20">2020/06/09</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/05/spider/cases/爬链家二手房存mongo/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用python爬取链家二手房信息，并把数据存入mongodb">用python爬取链家二手房信息，并把数据存入mongodb</span>
            <span class="post-date" title="2020-05-21 21:00:59">2020/05/21</span>
        </a>
        
        <a  class="全部文章 python python web "
           href="/2020/04/python/web/flask,tornado,fastapi的比较/"
           data-tag="python3,fastapi"
           data-author="" >
            <span class="post-title" title="flask,tornado,fastapi 的比较">flask,tornado,fastapi 的比较</span>
            <span class="post-date" title="2020-04-23 15:24:20">2020/04/23</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/03/spider/反爬逆向/基于Base64编码的反爬虫/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="基于Base64编码的反爬虫">基于Base64编码的反爬虫</span>
            <span class="post-date" title="2020-03-29 23:36:33">2020/03/29</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2020/03/spider/cases/用3种方式爬取动态网站华南粮网数据/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="用3种方式爬取动态网站华南粮网数据">用3种方式爬取动态网站华南粮网数据</span>
            <span class="post-date" title="2020-03-27 18:21:59">2020/03/27</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2020/03/python/python模块/collections模块/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python中好用的模块-collections">python中好用的模块-collections</span>
            <span class="post-date" title="2020-03-01 20:30:21">2020/03/01</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/02/spider/反爬逆向/请求参数中的mcode是按时间戳通过base64加密得来的/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="请求参数中的mcode是按时间戳通过base64加密得来的">请求参数中的mcode是按时间戳通过base64加密得来的</span>
            <span class="post-date" title="2020-02-29 19:58:44">2020/02/29</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2020/02/spider/反爬逆向/请求头中加X-Requested-With才能请求到数据/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="请求头中加X-Requested-With才能请求到数据">请求头中加X-Requested-With才能请求到数据</span>
            <span class="post-date" title="2020-02-29 19:56:03">2020/02/29</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/12/spider/cases/java常用的爬虫框架/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="java常用的爬虫框架">java常用的爬虫框架</span>
            <span class="post-date" title="2019-12-31 18:51:26">2019/12/31</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/12/spider/selenium/在爬虫框架scrapy中使用selenium/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="在爬虫框架scrapy中使用selenium">在爬虫框架scrapy中使用selenium</span>
            <span class="post-date" title="2019-12-27 20:29:35">2019/12/27</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/12/database/PostgreSql/20191220_对pg中json数据进行增删改/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="向PostgreSQL中json中加入某个字段 或者更新某个字段的SQL语句">向PostgreSQL中json中加入某个字段 或者更新某个字段的SQL语句</span>
            <span class="post-date" title="2019-12-20 15:24:20">2019/12/20</span>
        </a>
        
        <a  class="全部文章 python python模块 "
           href="/2019/11/python/python模块/python标准库主题/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="《Python3标准库》主题">《Python3标准库》主题</span>
            <span class="post-date" title="2019-11-07 13:29:07">2019/11/07</span>
        </a>
        
        <a  class="全部文章 数据处理 ES "
           href="/2019/11/database/es/es介绍及pyhton操作es/"
           data-tag="数据处理,ES"
           data-author="" >
            <span class="post-title" title="Elasticsearch的介绍 以及使用python操作es详细步骤">Elasticsearch的介绍 以及使用python操作es详细步骤</span>
            <span class="post-date" title="2019-11-01 15:24:20">2019/11/01</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/10/python/cases/面向对象扑克牌发牌程序/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="面向对象扑克牌发牌程序">面向对象扑克牌发牌程序</span>
            <span class="post-date" title="2019-10-29 22:43:29">2019/10/29</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/10/database/PostgreSql/20191008_更改数据/"
           data-tag="数据处理,PostgreSQL,MySQL"
           data-author="" >
            <span class="post-title" title="对数据库中的数据 进行增删改查用到的SQL语句">对数据库中的数据 进行增删改查用到的SQL语句</span>
            <span class="post-date" title="2019-10-08 15:24:20">2019/10/08</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/09/database/mysql/20190927_mysql更改数据/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="MySQL中增加，更新或删除 数据库中原数据的内容">MySQL中增加，更新或删除 数据库中原数据的内容</span>
            <span class="post-date" title="2019-09-27 15:24:20">2019/09/27</span>
        </a>
        
        <a  class="全部文章 数据处理 MySQL "
           href="/2019/09/database/mysql/20190921_每5分钟mysql的插入量/"
           data-tag="数据处理,MySQL"
           data-author="" >
            <span class="post-title" title="统计每5分钟，MySQL数据库中数据的插入量">统计每5分钟，MySQL数据库中数据的插入量</span>
            <span class="post-date" title="2019-09-21 15:24:20">2019/09/21</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/09/database/PostgreSql/20190909_查看pg内存/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="查询PostgreSQL占多大内存">查询PostgreSQL占多大内存</span>
            <span class="post-date" title="2019-09-09 15:24:20">2019/09/09</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190827_内部结构/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十八. 内部结构">PostgreSQL：十八. 内部结构</span>
            <span class="post-date" title="2019-08-27 15:24:20">2019/08/27</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190825_配置与监控/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十七. 服务器配置与数据库监控">PostgreSQL：十七. 服务器配置与数据库监控</span>
            <span class="post-date" title="2019-08-25 15:24:20">2019/08/25</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190824_高可用/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十六. 高可用、负载均衡和数据复制">PostgreSQL：十六. 高可用、负载均衡和数据复制</span>
            <span class="post-date" title="2019-08-24 15:24:20">2019/08/24</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190823_性能优化/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十五. 性能优化">PostgreSQL：十五. 性能优化</span>
            <span class="post-date" title="2019-08-23 15:24:20">2019/08/23</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190822_备份还原/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十四. 数据备份与还原">PostgreSQL：十四. 数据备份与还原</span>
            <span class="post-date" title="2019-08-22 15:24:20">2019/08/22</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190821_用户管理/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十三. PostgreSQL的用户管理">PostgreSQL：十三. PostgreSQL的用户管理</span>
            <span class="post-date" title="2019-08-21 15:24:20">2019/08/21</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190819_事务处理/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十二. 事务处理">PostgreSQL：十二. 事务处理</span>
            <span class="post-date" title="2019-08-19 15:24:20">2019/08/19</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190818_触发器/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：十一. 触发器">PostgreSQL：十一. 触发器</span>
            <span class="post-date" title="2019-08-18 15:24:20">2019/08/18</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190817_视图/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 十. 视图">PostgreSQL 十. 视图</span>
            <span class="post-date" title="2019-08-17 15:24:20">2019/08/17</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190816_索引/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 九. 索引">PostgreSQL 九. 索引</span>
            <span class="post-date" title="2019-08-16 15:24:20">2019/08/16</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190815_查询语句/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL 八. 查询语句">PostgreSQL 八. 查询语句</span>
            <span class="post-date" title="2019-08-15 15:24:20">2019/08/15</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190813_插入更新删除数据/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：七. 插入，更新与删除数据">PostgreSQL：七. 插入，更新与删除数据</span>
            <span class="post-date" title="2019-08-13 15:24:20">2019/08/13</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190811_函数/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：六. PostgreSQL函数">PostgreSQL：六. PostgreSQL函数</span>
            <span class="post-date" title="2019-08-11 15:24:20">2019/08/11</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190810_数据类型和运算符/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：五. 数据类型和运算符">PostgreSQL：五. 数据类型和运算符</span>
            <span class="post-date" title="2019-08-10 15:24:20">2019/08/10</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190808_数据库的基本操作/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：三. 数据库的基本操作">PostgreSQL：三. 数据库的基本操作</span>
            <span class="post-date" title="2019-08-08 15:24:20">2019/08/08</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190807_安装和配置/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL：二. PostgreSQL 11 的安装与配置">PostgreSQL：二. PostgreSQL 11 的安装与配置</span>
            <span class="post-date" title="2019-08-07 15:24:20">2019/08/07</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190806_postgresql介绍/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL介绍">PostgreSQL介绍</span>
            <span class="post-date" title="2019-08-06 15:24:20">2019/08/06</span>
        </a>
        
        <a  class="全部文章 数据处理 PostgreSQL "
           href="/2019/08/database/PostgreSql/20190809_数据表的基本操作/"
           data-tag="数据处理,PostgreSQL"
           data-author="" >
            <span class="post-title" title="PostgreSQL介绍">PostgreSQL介绍</span>
            <span class="post-date" title="2019-08-06 15:24:20">2019/08/06</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/07/spider/cases/百度图片爬虫/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="爬取百度图片并把图片存到本地">爬取百度图片并把图片存到本地</span>
            <span class="post-date" title="2019-07-04 10:35:00">2019/07/04</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2019/07/others/绕口令/"
           data-tag="日常生活"
           data-author="" >
            <span class="post-title" title="绕口令">绕口令</span>
            <span class="post-date" title="2019-07-03 15:24:20">2019/07/03</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/07/spider/cases/有毒段子爬虫/"
           data-tag="python"
           data-author="" >
            <span class="post-title" title="爬取心灵毒鸡汤、你好污啊 网站数据并存入本地txt文件">爬取心灵毒鸡汤、你好污啊 网站数据并存入本地txt文件</span>
            <span class="post-date" title="2019-07-03 10:30:00">2019/07/03</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190629_6大设计原则/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="设计模式之6大设计原则详解">设计模式之6大设计原则详解</span>
            <span class="post-date" title="2019-06-29 01:30:00">2019/06/29</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2019/06/others/毒鸡汤/"
           data-tag="日常生活"
           data-author="" >
            <span class="post-title" title="心灵毒鸡汤语录">心灵毒鸡汤语录</span>
            <span class="post-date" title="2019-06-28 15:24:20">2019/06/28</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_访问者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="访问者模式详解">访问者模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_责任链/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="责任链模式详解">责任链模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_状态模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="状态模式详解">状态模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190624_解释器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="解释器模式详解">解释器模式详解</span>
            <span class="post-date" title="2019-06-24 01:30:00">2019/06/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190620_备忘录/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="备忘录模式详解">备忘录模式详解</span>
            <span class="post-date" title="2019-06-20 01:30:00">2019/06/20</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190619_中介者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="中介者模式详解">中介者模式详解</span>
            <span class="post-date" title="2019-06-19 01:30:00">2019/06/19</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190618_迭代器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="迭代器模式详解">迭代器模式详解</span>
            <span class="post-date" title="2019-06-18 01:30:00">2019/06/18</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190617_命令模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="命令模式详解">命令模式详解</span>
            <span class="post-date" title="2019-06-17 01:30:00">2019/06/17</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190614_模板方法/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="模板方法模式详解">模板方法模式详解</span>
            <span class="post-date" title="2019-06-14 01:30:00">2019/06/14</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/06/spider/selenium/20190613_突破屏蔽/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="如何突破网站对selenium的屏蔽">如何突破网站对selenium的屏蔽</span>
            <span class="post-date" title="2019-06-13 10:35:00">2019/06/13</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190613_外观模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="外观模式详解">外观模式详解</span>
            <span class="post-date" title="2019-06-13 01:30:00">2019/06/13</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190613_享元模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="享元模式详解">享元模式详解</span>
            <span class="post-date" title="2019-06-13 01:30:00">2019/06/13</span>
        </a>
        
        <a  class="全部文章 爬虫 selenium "
           href="/2019/06/spider/selenium/20190612_隐式和显示等待/"
           data-tag="python,爬虫,selenium"
           data-author="" >
            <span class="post-title" title="Selenium显示等待和隐式等待的区别">Selenium显示等待和隐式等待的区别</span>
            <span class="post-date" title="2019-06-12 10:35:00">2019/06/12</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190611_桥接模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="桥接模式详解">桥接模式详解</span>
            <span class="post-date" title="2019-06-11 01:30:00">2019/06/11</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190611_组合模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="组合模式详解">组合模式详解</span>
            <span class="post-date" title="2019-06-11 01:30:00">2019/06/11</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190605_适配器/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="适配器模式详解">适配器模式详解</span>
            <span class="post-date" title="2019-06-05 01:30:00">2019/06/05</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190604_原型模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="原型模式详解">原型模式详解</span>
            <span class="post-date" title="2019-06-04 01:30:00">2019/06/04</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/06/java/java设计模式/20190603_代理模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="代理模式详解">代理模式详解</span>
            <span class="post-date" title="2019-06-03 01:30:00">2019/06/03</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190531_工厂模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="工厂模式详解">工厂模式详解</span>
            <span class="post-date" title="2019-05-31 01:30:00">2019/05/31</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190531_抽象工厂/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="抽象工厂模式详解">抽象工厂模式详解</span>
            <span class="post-date" title="2019-05-31 01:30:00">2019/05/31</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190530_装饰模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="装饰模式详解">装饰模式详解</span>
            <span class="post-date" title="2019-05-30 01:30:00">2019/05/30</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2019/05/spider/反爬逆向/请求头中需要加上Referer/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="请求头中需要加上Referer">请求头中需要加上Referer</span>
            <span class="post-date" title="2019-05-29 19:52:19">2019/05/29</span>
        </a>
        
        <a  class="全部文章 机器学习 NLP "
           href="/2019/05/nlp/ziranyuayn/"
           data-tag="机器学习,NLP"
           data-author="" >
            <span class="post-title" title="机器学习概述">机器学习概述</span>
            <span class="post-date" title="2019-05-29 01:30:00">2019/05/29</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190529_建造者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="建造者模式详解">建造者模式详解</span>
            <span class="post-date" title="2019-05-29 01:30:00">2019/05/29</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190528_观察者/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="观察者模式详解">观察者模式详解</span>
            <span class="post-date" title="2019-05-28 01:30:00">2019/05/28</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190527_策略模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="策略模式详解">策略模式详解</span>
            <span class="post-date" title="2019-05-27 01:30:00">2019/05/27</span>
        </a>
        
        <a  class="全部文章 python python案例 "
           href="/2019/05/python/cases/定时任务/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python定时任务汇总">python定时任务汇总</span>
            <span class="post-date" title="2019-05-26 10:35:00">2019/05/26</span>
        </a>
        
        <a  class="全部文章 python python算法 "
           href="/2019/05/python/python算法/定时任务/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="python定时任务汇总">python定时任务汇总</span>
            <span class="post-date" title="2019-05-26 10:35:00">2019/05/26</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190524_单例模式/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="7种单例模式详解">7种单例模式详解</span>
            <span class="post-date" title="2019-05-24 01:30:00">2019/05/24</span>
        </a>
        
        <a  class="全部文章 java java设计模式 "
           href="/2019/05/java/java设计模式/20190524_汇总/"
           data-tag="java,java设计模式"
           data-author="" >
            <span class="post-title" title="java设计模式汇总">java设计模式汇总</span>
            <span class="post-date" title="2019-05-24 01:30:00">2019/05/24</span>
        </a>
        
        <a  class="全部文章 python python web "
           href="/2019/04/python/web/flask_案例_登录/"
           data-tag="python,flask"
           data-author="" >
            <span class="post-title" title="flask案例_登录和遍历操作">flask案例_登录和遍历操作</span>
            <span class="post-date" title="2019-04-20 10:35:00">2019/04/20</span>
        </a>
        
        <a  class="全部文章 爬虫 反爬逆向 "
           href="/2019/04/spider/反爬逆向/常见反爬虫策略及应对措施/"
           data-tag="python,爬虫,反爬"
           data-author="" >
            <span class="post-title" title="常见反爬虫策略及应对措施">常见反爬虫策略及应对措施</span>
            <span class="post-date" title="2019-04-09 19:52:19">2019/04/09</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190313_时间处理/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python时间处理">python时间处理</span>
            <span class="post-date" title="2019-03-13 15:24:20">2019/03/13</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190311_打包/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python打包">python打包</span>
            <span class="post-date" title="2019-03-11 15:24:20">2019/03/11</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190310_发布模块/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python发布模块">python发布模块</span>
            <span class="post-date" title="2019-03-10 15:24:20">2019/03/10</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190307_python编码规范/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python编码规范">python编码规范</span>
            <span class="post-date" title="2019-03-08 15:24:20">2019/03/08</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190306_python虚拟环境/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python虚拟环境">python虚拟环境</span>
            <span class="post-date" title="2019-03-06 15:24:20">2019/03/06</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190305_图形界面/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python图形界面">python图形界面</span>
            <span class="post-date" title="2019-03-05 15:24:20">2019/03/05</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190304_操作excel/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python操作excel">python操作excel</span>
            <span class="post-date" title="2019-03-04 15:24:20">2019/03/04</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190303_sqlchemy的使用/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="sqlalchemy的使用">sqlalchemy的使用</span>
            <span class="post-date" title="2019-03-03 15:24:20">2019/03/03</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190302_sqlalchemy的一些概念/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="sqlalchemy的一些概念">sqlalchemy的一些概念</span>
            <span class="post-date" title="2019-03-02 15:24:20">2019/03/02</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/03/python/python基础/20190301_访问数据库/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python访问数据库">python访问数据库</span>
            <span class="post-date" title="2019-03-01 15:24:20">2019/03/01</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190228_网络编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python网络编程">python网络编程</span>
            <span class="post-date" title="2019-02-28 15:24:20">2019/02/28</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190226_文件操作/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python文件操作">python文件操作</span>
            <span class="post-date" title="2019-02-26 15:24:20">2019/02/26</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190225_进程和线程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python进程和线程">python进程和线程</span>
            <span class="post-date" title="2019-02-25 15:24:20">2019/02/25</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190223_python正则表达式/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python正则表达式">python正则表达式</span>
            <span class="post-date" title="2019-02-23 15:24:20">2019/02/23</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190222_时间处理汇总/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python时间处理汇总">python时间处理汇总</span>
            <span class="post-date" title="2019-02-22 15:24:20">2019/02/22</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190221_模块和包以及各种库/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python模块和包以及各种库">python模块和包以及各种库</span>
            <span class="post-date" title="2019-02-21 15:24:20">2019/02/21</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190220_面向对象编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python面向对象编程">python面向对象编程</span>
            <span class="post-date" title="2019-02-20 15:24:20">2019/02/20</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190219_错误,测试和调试/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python错误，测试和调试">python错误，测试和调试</span>
            <span class="post-date" title="2019-02-19 15:24:20">2019/02/19</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190218_函数式编程/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python函数式编程">python函数式编程</span>
            <span class="post-date" title="2019-02-18 15:24:20">2019/02/18</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190217_函数及其高级特性/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python函数及其高级特性">python函数及其高级特性</span>
            <span class="post-date" title="2019-02-17 15:24:20">2019/02/17</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190216_控制语句/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python控制语句">python控制语句</span>
            <span class="post-date" title="2019-02-16 15:24:20">2019/02/16</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190215_序列（列表，元组，字典，集合）/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python序列（列表，元组，字典，集合）">python序列（列表，元组，字典，集合）</span>
            <span class="post-date" title="2019-02-15 15:24:20">2019/02/15</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190214_python字符串和编码/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python字符串和编码">python字符串和编码</span>
            <span class="post-date" title="2019-02-14 15:24:20">2019/02/14</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190213_python关键字和内置函数/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python关键字和内置函数">python关键字和内置函数</span>
            <span class="post-date" title="2019-02-13 15:24:20">2019/02/13</span>
        </a>
        
        <a  class="全部文章 爬虫 爬虫案例 "
           href="/2019/02/spider/cases/写爬虫遇到的各类较难的xpath汇总/"
           data-tag="python,爬虫"
           data-author="" >
            <span class="post-title" title="写爬虫遇到的各类较难的xpath汇总">写爬虫遇到的各类较难的xpath汇总</span>
            <span class="post-date" title="2019-02-13 10:29:57">2019/02/13</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/02_python变量和数据类型/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python变量和数据类型">python变量和数据类型</span>
            <span class="post-date" title="2019-02-12 15:24:20">2019/02/12</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/20190212_python标识符和运算符/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python标识符和运算符">python标识符和运算符</span>
            <span class="post-date" title="2019-02-12 15:24:20">2019/02/12</span>
        </a>
        
        <a  class="全部文章 python python基础 "
           href="/2019/02/python/python基础/01_python简介/"
           data-tag="python基础"
           data-author="" >
            <span class="post-title" title="python简介">python简介</span>
            <span class="post-date" title="2019-02-11 15:24:20">2019/02/11</span>
        </a>
        
        <a  class="全部文章 其它 读书 "
           href="/2018/06/others/36计/"
           data-tag="日常生活,36计解说"
           data-author="" >
            <span class="post-title" title="36计">36计</span>
            <span class="post-date" title="2018-06-23 15:24:20">2018/06/23</span>
        </a>
        
        <a  class="全部文章 其它 英语 "
           href="/2018/06/others/english/四级作文/"
           data-tag="英语学习,英语作文模板"
           data-author="" >
            <span class="post-title" title="2018年上半年阅读总结">2018年上半年阅读总结</span>
            <span class="post-date" title="2018-06-22 01:30:00">2018/06/22</span>
        </a>
        
        <a  class="全部文章 前端 前端案例 "
           href="/2017/11/front/04cases/10贪吃蛇案例/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript_贪吃蛇案例">javascript_贪吃蛇案例</span>
            <span class="post-date" title="2017-11-24 15:24:20">2017/11/24</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/09正则表达式/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript正则表达式">javascript正则表达式</span>
            <span class="post-date" title="2017-11-22 15:24:20">2017/11/22</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/08函数进阶/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript函数进阶">javascript函数进阶</span>
            <span class="post-date" title="2017-11-20 15:24:20">2017/11/20</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/07面向对象编程/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript面向对象编程">javascript面向对象编程</span>
            <span class="post-date" title="2017-11-19 15:24:20">2017/11/19</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/06DOM和事件/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript DOM和事件">javascript DOM和事件</span>
            <span class="post-date" title="2017-11-18 15:24:20">2017/11/18</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/05BOM/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript BOM">javascript BOM</span>
            <span class="post-date" title="2017-11-17 15:24:20">2017/11/17</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/04对象和内置对象/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript对象和内置对象">javascript对象和内置对象</span>
            <span class="post-date" title="2017-11-16 15:24:20">2017/11/16</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/03数组函数作用域/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript数组函数作用域">javascript数组函数作用域</span>
            <span class="post-date" title="2017-11-15 15:24:20">2017/11/15</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/02流程控制/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript流程控制">javascript流程控制</span>
            <span class="post-date" title="2017-11-14 15:24:20">2017/11/14</span>
        </a>
        
        <a  class="全部文章 前端 javascript "
           href="/2017/11/front/03javascript/01语法基础/"
           data-tag="前端,javascript"
           data-author="" >
            <span class="post-title" title="javascript语法基础">javascript语法基础</span>
            <span class="post-date" title="2017-11-13 15:24:20">2017/11/13</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/07/others/computer/计算机网络比较重要的概念/"
           data-tag="计算机网络,概念"
           data-author="" >
            <span class="post-title" title="计算机网络比较重要的概念">计算机网络比较重要的概念</span>
            <span class="post-date" title="2017-07-23 15:24:20">2017/07/23</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/07/others/computer/数据结构C语言/"
           data-tag="数据结构,C语言,排序"
           data-author="" >
            <span class="post-title" title="C语言-数据结构-排序汇总（代码可直接运行）">C语言-数据结构-排序汇总（代码可直接运行）</span>
            <span class="post-date" title="2017-07-23 15:24:20">2017/07/23</span>
        </a>
        
        <a  class="全部文章 部署 "
           href="/2017/06/linux/20170607_操作系统介绍/"
           data-tag="linux"
           data-author="" >
            <span class="post-title" title="操作系统介绍">操作系统介绍</span>
            <span class="post-date" title="2017-06-07 15:24:20">2017/06/07</span>
        </a>
        
        <a  class="全部文章 其它 计算机 "
           href="/2017/05/others/computer/代码之髓--编程语言核心概念/"
           data-tag="读书,计算机"
           data-author="" >
            <span class="post-title" title="《代码之髓--编程语言核心概念》读后感">《代码之髓--编程语言核心概念》读后感</span>
            <span class="post-date" title="2017-05-20 22:19:19">2017/05/20</span>
        </a>
        
        <a  class="全部文章 java java案例 "
           href="/2017/05/java/java案例/java打印图形/"
           data-tag="java,java案例,java打印图形"
           data-author="" >
            <span class="post-title" title="用java实现打印各种图形总结 (包括长方形 三角形 菱形 平行四边形等)">用java实现打印各种图形总结 (包括长方形 三角形 菱形 平行四边形等)</span>
            <span class="post-date" title="2017-05-17 23:19:19">2017/05/17</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2017/05/java/java算法/20170505_概述/"
           data-tag="java,java算法"
           data-author="" >
            <span class="post-title" title="算法概述和总结">算法概述和总结</span>
            <span class="post-date" title="2017-05-05 01:30:00">2017/05/05</span>
        </a>
        
        <a  class="全部文章 java java算法 "
           href="/2017/05/java/java算法/20170504_java数据结构和算法/"
           data-tag="java,java算法"
           data-author="" >
            <span class="post-title" title="java数据结构和算法">java数据结构和算法</span>
            <span class="post-date" title="2017-05-04 01:30:00">2017/05/04</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/2017427_java核心类/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="java基础">java基础</span>
            <span class="post-date" title="2017-04-27 01:30:00">2017/04/27</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/2017424_数组和string类/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java数组">java数组</span>
            <span class="post-date" title="2017-04-24 01:30:00">2017/04/24</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/2017425_字符串string类的/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java字符串String类">java字符串String类</span>
            <span class="post-date" title="2017-04-24 01:30:00">2017/04/24</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/2017423_运算和流程控制/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java运算和流程控制">java运算和流程控制</span>
            <span class="post-date" title="2017-04-23 01:30:00">2017/04/23</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/2017422_变量和数据类型/"
           data-tag="java,java基础"
           data-author="" >
            <span class="post-title" title="java变量和数据类型">java变量和数据类型</span>
            <span class="post-date" title="2017-04-22 01:30:00">2017/04/22</span>
        </a>
        
        <a  class="全部文章 java java基础 "
           href="/2017/04/java/java基础/01_java基础/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="java基础">java基础</span>
            <span class="post-date" title="2017-04-21 01:30:00">2017/04/21</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-python/python优化/effective_python" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Effective Python（摘录）</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="python">python</a> > 
            
            <a  data-rel="python&lt;---&gt;python优化">python优化</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color4">python基础</a>
            
            <a class="color4">python优化</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2021-07-29 11:46:39'>2021-07-24 15:24</time>
        
    </div>
    <div class="article-meta">
        
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一-培养Pythonic思维"><span class="toc-text">一. 培养Pythonic思维</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-查询自己使用的python版本"><span class="toc-text">1. 查询自己使用的python版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-遵循PEP8风格指南"><span class="toc-text">2. 遵循PEP8风格指南</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-了解bytes与str的区别"><span class="toc-text">3. 了解bytes与str的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-用支持插值的f-string取代C风格的格式字符串和str-format方法"><span class="toc-text">4. 用支持插值的f-string取代C风格的格式字符串和str.format方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-用辅助函数取代复杂的表达式"><span class="toc-text">5. 用辅助函数取代复杂的表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-把数据结构直接拆分到多个变量里，不要专门通过下标访问"><span class="toc-text">6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-尽量用enumerate取代range"><span class="toc-text">7. 尽量用enumerate取代range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-用zip函数同时遍历两个迭代器"><span class="toc-text">8. 用zip函数同时遍历两个迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-不要在for与while循环后面写else块"><span class="toc-text">9. 不要在for与while循环后面写else块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-用赋值表达式减少重复代码"><span class="toc-text">10. 用赋值表达式减少重复代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二-列表与字典"><span class="toc-text">二. 列表与字典</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-学会对序列做切片"><span class="toc-text">11. 学会对序列做切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-不要在切片里同时-起止下标与步进"><span class="toc-text">12. 不要在切片里同时 起止下标与步进</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-通过带星号的unpacking操作来捕获多个元素，不要用切片"><span class="toc-text">13. 通过带星号的unpacking操作来捕获多个元素，不要用切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-用sort方法的key参数来表示复杂的排序逻辑"><span class="toc-text">14. 用sort方法的key参数来表示复杂的排序逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-不要过分依赖给字典添加条目时所用的顺序"><span class="toc-text">15. 不要过分依赖给字典添加条目时所用的顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-用get处理键不在字典中的情况，不要使用in与KeyError"><span class="toc-text">16. 用get处理键不在字典中的情况，不要使用in与KeyError</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault"><span class="toc-text">17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-学会利用missing构造依赖键的默认值"><span class="toc-text">18. 学会利用missing构造依赖键的默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-不要把函数返回的多个数值拆分到三个以上的变量中"><span class="toc-text">19. 不要把函数返回的多个数值拆分到三个以上的变量中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三-函数"><span class="toc-text">三. 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-遇到意外状况时应该抛出异常，不要返回None"><span class="toc-text">20. 遇到意外状况时应该抛出异常，不要返回None</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-了解如何在闭包里面使用外围作用域中的变量"><span class="toc-text">21. 了解如何在闭包里面使用外围作用域中的变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-用数量可变的位置参数给函数设计清晰的参数列表"><span class="toc-text">22. 用数量可变的位置参数给函数设计清晰的参数列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#23-用关键字参数来表示可选的行为"><span class="toc-text">23. 用关键字参数来表示可选的行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#24-用None和docstring来描述默认值会变的参数"><span class="toc-text">24. 用None和docstring来描述默认值会变的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表"><span class="toc-text">25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#26-用functools-wraps定义函数修饰器"><span class="toc-text">26. 用functools.wraps定义函数修饰器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四-推导与生成"><span class="toc-text">四. 推导与生成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#27-用列表推导取代map与filter"><span class="toc-text">27. 用列表推导取代map与filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#28-控制推导逻辑的子表达式不要超过两个"><span class="toc-text">28. 控制推导逻辑的子表达式不要超过两个</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#29-用赋值表达式消除推导中的重复代码"><span class="toc-text">29. 用赋值表达式消除推导中的重复代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#30-不要让函数直接返回列表，应该让它逐个生成列表里的值"><span class="toc-text">30. 不要让函数直接返回列表，应该让它逐个生成列表里的值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#31-谨慎地迭代函数所收到的参数"><span class="toc-text">31. 谨慎地迭代函数所收到的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-考虑用生成器表达式改写数据量较大的列表推导"><span class="toc-text">32. 考虑用生成器表达式改写数据量较大的列表推导</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-通过yield-from把多个生成器连起来用"><span class="toc-text">33. 通过yield from把多个生成器连起来用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-不要用send给生成器注入数据"><span class="toc-text">34. 不要用send给生成器注入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-不要通过throw变换生成器的状态"><span class="toc-text">35. 不要通过throw变换生成器的状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#36-考虑用itertools拼装迭代器与生成器"><span class="toc-text">36. 考虑用itertools拼装迭代器与生成器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五-类与接口"><span class="toc-text">五. 类与接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#37-用组合起来的类来实现多层结构，不要用嵌套的内置类型"><span class="toc-text">37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#38-让简单的接口接受函数，而不是类的实例"><span class="toc-text">38. 让简单的接口接受函数，而不是类的实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#39-通过-classmethod多态来构造同一体系中的各类对象"><span class="toc-text">39. 通过@classmethod多态来构造同一体系中的各类对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#40-通过super初始化超类"><span class="toc-text">40. 通过super初始化超类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#41-考虑用mix-in类来表示可组合的功能"><span class="toc-text">41. 考虑用mix-in类来表示可组合的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-优先考虑用public属性表示应受保护的数据，不要用private属性表示"><span class="toc-text">42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-自定义的容器类型应该从collections-abc继承"><span class="toc-text">43. 自定义的容器类型应该从collections.abc继承</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#六-元类与属性"><span class="toc-text">六. 元类与属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#44-用纯属性与修饰器取代旧式的setter与getter方法"><span class="toc-text">44. 用纯属性与修饰器取代旧式的setter与getter方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码"><span class="toc-text">45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#46-用描述符来改写需要复用的-property方法"><span class="toc-text">46. 用描述符来改写需要复用的@property方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#47-针对惰性属性使用-getattr-、-getattribute-及-setattr"><span class="toc-text">47. 针对惰性属性使用__getattr__、__getattribute__及 __setattr__</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#48-用init-subclass验证子类写得是否正确"><span class="toc-text">48. 用init_subclass验证子类写得是否正确</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#49-用init-subclass记录现有的子类"><span class="toc-text">49. 用init_subclass记录现有的子类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#50-用-set-name-给类属性加注解"><span class="toc-text">50. 用__set_name__给类属性加注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><span class="toc-text">51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#七-并发与并行"><span class="toc-text">七. 并发与并行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#52-用subprocess管理子进程"><span class="toc-text">52. 用subprocess管理子进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#53-可以用线程执行阻塞式I-O，但不要用它做并行计算"><span class="toc-text">53. 可以用线程执行阻塞式I/O，但不要用它做并行计算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#54-利用Lock防止多个线程争用同一份数据"><span class="toc-text">54. 利用Lock防止多个线程争用同一份数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#55-用Queue来协调各线程之间的工作进度"><span class="toc-text">55. 用Queue来协调各线程之间的工作进度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#56-学会判断什么场合必须做并发"><span class="toc-text">56. 学会判断什么场合必须做并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#57-不要在每次fan-out时都新建一批Thread实例"><span class="toc-text">57. 不要在每次fan-out时都新建一批Thread实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#58-学会正确地重构代码，以便用Queue做并发"><span class="toc-text">58. 学会正确地重构代码，以便用Queue做并发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"><span class="toc-text">59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#60-用协程实现高并发的I-O"><span class="toc-text">60. 用协程实现高并发的I/O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#61-学会用asyncio改写那些通过线程实现的I-O"><span class="toc-text">61. 学会用asyncio改写那些通过线程实现的I/O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#62-结合线程与协程，将代码顺利迁移到asyncio"><span class="toc-text">62. 结合线程与协程，将代码顺利迁移到asyncio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"><span class="toc-text">63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#64-考虑用concurrent-futures实现真正的并行计算"><span class="toc-text">64. 考虑用concurrent.futures实现真正的并行计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#八-稳定与性能"><span class="toc-text">八. 稳定与性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#65-合理利用try-except-else-finally结构中的每个代码块"><span class="toc-text">65. 合理利用try/except/else/finally结构中的每个代码块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#66-考虑用contextlib和with语句来改写可复用的try-finally代码"><span class="toc-text">66. 考虑用contextlib和with语句来改写可复用的try/finally代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#67-用datetime模块处理本地时间，不要用time模块"><span class="toc-text">67. 用datetime模块处理本地时间，不要用time模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#68-用copyreg实现可靠的pickle操作"><span class="toc-text">68. 用copyreg实现可靠的pickle操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#69-在需要准确计算的场合，用decimal表示相应的数值"><span class="toc-text">69. 在需要准确计算的场合，用decimal表示相应的数值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#70-先分析性能，然后再优化"><span class="toc-text">70. 先分析性能，然后再优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#71-优先考虑用deque实现生产者-消费者队列"><span class="toc-text">71. 优先考虑用deque实现生产者-消费者队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-考虑用bisect搜索已排序的序列"><span class="toc-text">72. 考虑用bisect搜索已排序的序列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-学会使用heapq制作优先级队列"><span class="toc-text">73. 学会使用heapq制作优先级队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作"><span class="toc-text">74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#九-测试与调试"><span class="toc-text">九. 测试与调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#75-通过repr字符串输出调试信息"><span class="toc-text">75. 通过repr字符串输出调试信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#76-在TestCase子类里验证相关的行为"><span class="toc-text">76. 在TestCase子类里验证相关的行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"><span class="toc-text">77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#78-用Mock来模拟受测代码所依赖的复杂函数"><span class="toc-text">78. 用Mock来模拟受测代码所依赖的复杂函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#79-把受测代码所依赖的系统封装起来，以便于模拟和测试"><span class="toc-text">79. 把受测代码所依赖的系统封装起来，以便于模拟和测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#80-考虑用pdb做交互调试"><span class="toc-text">80. 考虑用pdb做交互调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#81-用tracemalloc来掌握内存的使用与泄漏情况"><span class="toc-text">81. 用tracemalloc来掌握内存的使用与泄漏情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#十-协作并发"><span class="toc-text">十. 协作并发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#82-学会寻找由其他Python开发者所构建的模块"><span class="toc-text">82. 学会寻找由其他Python开发者所构建的模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#83-用虚拟环境隔离项目，并重建依赖关系"><span class="toc-text">83. 用虚拟环境隔离项目，并重建依赖关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#84-每一个函数、类与模块都要写docstring"><span class="toc-text">84. 每一个函数、类与模块都要写docstring</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#85-用包来安排模块，以提供稳固的API"><span class="toc-text">85. 用包来安排模块，以提供稳固的API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#86-考虑用模块级别的代码配置不同的部署环境"><span class="toc-text">86. 考虑用模块级别的代码配置不同的部署环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"><span class="toc-text">87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#88-用适当的方式打破循环依赖关系"><span class="toc-text">88. 用适当的方式打破循环依赖关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#89-重构时考虑通过warnings提醒开发者API已经发生变化"><span class="toc-text">89. 重构时考虑通过warnings提醒开发者API已经发生变化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#90-考虑通过typing做静态分析，以消除bug"><span class="toc-text">90. 考虑通过typing做静态分析，以消除bug</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>静下心来去理解，收获颇多。</p>
<h2 id="一-培养Pythonic思维"><a href="#一-培养Pythonic思维" class="headerlink" title="一. 培养Pythonic思维"></a>一. 培养Pythonic思维</h2><h3 id="1-查询自己使用的python版本"><a href="#1-查询自己使用的python版本" class="headerlink" title="1. 查询自己使用的python版本"></a>1. 查询自己使用的python版本</h3><pre><code class="python">import sys
print(sys.version_info)
print(sys.version)

# 代码自动检查：https://pylint.org/  pip install pylint 
</code></pre>
<h3 id="2-遵循PEP8风格指南"><a href="#2-遵循PEP8风格指南" class="headerlink" title="2. 遵循PEP8风格指南"></a>2. 遵循PEP8风格指南</h3><p>官网：<a href="https://pep8.org/" target="_blank" rel="noopener">https://pep8.org/</a><br>中文翻译：<a href="https://www.cnblogs.com/bymo/p/9567140.html" target="_blank" rel="noopener">https://www.cnblogs.com/bymo/p/9567140.html</a></p>
<h3 id="3-了解bytes与str的区别"><a href="#3-了解bytes与str的区别" class="headerlink" title="3. 了解bytes与str的区别"></a>3. 了解bytes与str的区别</h3><p>bytes：bytes的实例包含原始的8个字节<br>str：str的实例包含Unicode字符bytes</p>
<pre><code class="python"># 接受str或bytes,并总是返回str的方法
def to_str(bytes_or_str):
    if isinstance(bytes_or_str,bytes):
        value = bytes_or_str.decode(&#39;utf-8&#39;)
    else:
        value = bytes_or_str
    return value

# 接受str或bytes,并总是返回bytes的方法：
def to_bytes(bytes_or_str):
    if isinstance(bytes_or_str,str):
        value = bytes_or_str.encode(&#39;utf-8&#39;)
    else:
        value = bytes_or_str
    return value
</code></pre>
<h3 id="4-用支持插值的f-string取代C风格的格式字符串和str-format方法"><a href="#4-用支持插值的f-string取代C风格的格式字符串和str-format方法" class="headerlink" title="4. 用支持插值的f-string取代C风格的格式字符串和str.format方法"></a>4. 用支持插值的f-string取代C风格的格式字符串和str.format方法</h3><pre><code class="python">pantry = [
    (&#39;avocados&#39;, 1.25),
    (&#39;bananas&#39;, 2.5),
    (&#39;cherries&#39;, 15),
]
for i, (item, count) in enumerate(pantry):
    print(f&#39;{i+1}: {item.title():&lt;10s} = {round(count)}&#39;)
</code></pre>
<h3 id="5-用辅助函数取代复杂的表达式"><a href="#5-用辅助函数取代复杂的表达式" class="headerlink" title="5. 用辅助函数取代复杂的表达式"></a>5. 用辅助函数取代复杂的表达式</h3><pre><code class="python">from urllib.parse import parse_qs

my_values = parse_qs(&#39;red=5&amp;blue=0&amp;green=3&#39;, keep_blank_values=True)
print(repr(my_values))

green_str = my_values.get(&#39;green&#39;, [&#39;&#39;])
if green_str[0]:
    green = int(green_str[0])
else:
    green = 0
print(f&#39;Green:   {green!r}&#39;)


def get_first_int(values, key, default=0):
    found = values.get(key, [&#39;&#39;])
    if found[0]:
        return int(found[0])
    return default


green = get_first_int(my_values, &#39;green&#39;)
print(f&#39;Green:   {green!r}&#39;)
</code></pre>
<h3 id="6-把数据结构直接拆分到多个变量里，不要专门通过下标访问"><a href="#6-把数据结构直接拆分到多个变量里，不要专门通过下标访问" class="headerlink" title="6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问"></a>6. 把数据结构直接拆分到多个变量里，不要专门通过下标访问</h3><pre><code class="python">snacks = [(&#39;bacon&#39;, 350), (&#39;donut&#39;, 240), (&#39;muffin&#39;, 190)]
for i in range(len(snacks)):
    item = snacks[i]
    name = item[0]
    calories = item[1]
    print(f&#39;#{i + 1}: {name} has {calories} calories&#39;)


for rank, (name, calories) in enumerate(snacks, 1):
    print(f&#39;#{rank}: {name} has {calories} calories&#39;)
</code></pre>
<h3 id="7-尽量用enumerate取代range"><a href="#7-尽量用enumerate取代range" class="headerlink" title="7. 尽量用enumerate取代range"></a>7. 尽量用enumerate取代range</h3><pre><code class="python">flavor_list = [&#39;vanilla&#39;, &#39;chocolate&#39;, &#39;pecan&#39;, &#39;strawberry&#39;]
for flavor in flavor_list:
    print(f&#39;{flavor} is delicious&#39;)


for i in range(len(flavor_list)):
    flavor = flavor_list[i]
    print(f&#39;{i + 1}: {flavor}&#39;)


# Example 
it = enumerate(flavor_list)
print(next(it))
print(next(it))


for i, flavor in enumerate(flavor_list):
    print(f&#39;{i}: {flavor}&#39;)


for i, flavor in enumerate(flavor_list, 2):  # 从2开始
    print(f&#39;enumerate {i}: {flavor}&#39;)

</code></pre>
<h3 id="8-用zip函数同时遍历两个迭代器"><a href="#8-用zip函数同时遍历两个迭代器" class="headerlink" title="8. 用zip函数同时遍历两个迭代器"></a>8. 用zip函数同时遍历两个迭代器</h3><pre><code class="python"># Example 1
names = [&#39;Cecilia&#39;, &#39;Lise&#39;, &#39;Marie&#39;]
counts = [len(n) for n in names]
print(counts, len(counts), len(names))


# Example 2
longest_name = &#39;None11&#39;
max_count = 0

for i in range(len(names)):
    count = counts[i]
    if count &gt; max_count:
        longest_name = names[i]
        max_count = count

print(longest_name)


# Example 3
longest_name = None
max_count = 0
for i, name in enumerate(names):
    count = counts[i]
    if count &gt; max_count:
        longest_name = name
        max_count = count

print(&#39;--&#39;, longest_name)
assert longest_name == &#39;Cecilia&#39;


# Example 4
longest_name = None
max_count = 0
for name, count in zip(names, counts):
    if count &gt; max_count:
        longest_name = name
        max_count = count
assert longest_name == &#39;Cecilia&#39;


# Example 5
names.append(&#39;Rosalind&#39;)
# counts.append(8)
print(f&#39;names: {names}, counts: {counts}&#39;)
for name, count in zip(names, counts):
    print(name, count)


# Example 6
import itertools

for name, count in itertools.zip_longest(names, counts):
    print(f&#39;itertools: {name}: {count}&#39;)
</code></pre>
<h3 id="9-不要在for与while循环后面写else块"><a href="#9-不要在for与while循环后面写else块" class="headerlink" title="9. 不要在for与while循环后面写else块"></a>9. 不要在for与while循环后面写else块</h3><pre><code class="python"># Example 1
for i in range(3):
    print(&#39;Loop&#39;, i)
else:
    print(&#39;Else block!&#39;)

# Example
a = 4
b = 9

for i in range(2, min(a, b) + 1):
    print(&#39;Testing&#39;, i)
    if a % i == 0 and b % i == 0:
        print(&#39;Not coprime&#39;)
        break
else:
    print(&#39;Coprime&#39;)


# 下面是应该的写法：方法一，只要发现某个方法成立，就立刻返回
def coprime(a, b):
    for i in range(2, min(a, b) + 1):
        if a % i == 0 and b % i == 0:
            return False
    return True


assert coprime(4, 9)
assert not coprime(3, 6)


# 方法二，用变量记录循环过程中与没有碰到成立的情况，返回这个变量的值
def coprime_alternate(a, b):
    is_coprime = True
    for i in range(2, min(a, b) + 1):
        if a % i == 0 and b % i == 0:
            is_coprime = False
            break
    return is_coprime


assert coprime_alternate(4, 9)
assert not coprime_alternate(3, 6)

</code></pre>
<h3 id="10-用赋值表达式减少重复代码"><a href="#10-用赋值表达式减少重复代码" class="headerlink" title="10. 用赋值表达式减少重复代码"></a>10. 用赋值表达式减少重复代码</h3><pre><code class="python"># -*- encoding: utf-8 -*-
&quot;&quot;&quot;
赋值表达式通过海象操作符(:=)给变量赋值，并且让这个值成为这个表达式的结构
&quot;&quot;&quot;

FRUIT_TO_PICK = [
    {&#39;apple&#39;: 1, &#39;banana&#39;: 3},
    {&#39;lemon&#39;: 2, &#39;lime&#39;: 5},
    {&#39;orange&#39;: 3, &#39;melon&#39;: 2},
]


def pick_fruit():
    if FRUIT_TO_PICK:
        return FRUIT_TO_PICK.pop(0)
    else:
        return []


def make_juice(fruit, count):
    return [(fruit, count)]


bottles = []
while fresh_fruit := pick_fruit():
    for fruit, count in fresh_fruit.items():
        batch = make_juice(fruit, count)
        bottles.extend(batch)

print(bottles)
</code></pre>
<h2 id="二-列表与字典"><a href="#二-列表与字典" class="headerlink" title="二. 列表与字典"></a>二. 列表与字典</h2><h3 id="11-学会对序列做切片"><a href="#11-学会对序列做切片" class="headerlink" title="11. 学会对序列做切片"></a>11. 学会对序列做切片</h3><pre><code class="python">a = [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;]
print(&#39;Middle two:  &#39;, a[3:5])
print(&#39;--:&#39;, a[-3:-1])

assert a[:5] == a[0:5]
assert a[5:] == a[5:len(a)]

print(a[2:-1])
print(a[-3:-1])
</code></pre>
<h3 id="12-不要在切片里同时-起止下标与步进"><a href="#12-不要在切片里同时-起止下标与步进" class="headerlink" title="12. 不要在切片里同时 起止下标与步进"></a>12. 不要在切片里同时 起止下标与步进</h3><pre><code class="python">x = [&#39;red&#39;, &#39;orange&#39;, &#39;yellow&#39;, &#39;green&#39;, &#39;blue&#39;, &#39;purple&#39;]
print(f&#39;odds: {x[::2]}&#39;)  # odds: [&#39;red&#39;, &#39;yellow&#39;, &#39;blue&#39;]
print(f&#39;evens: {x[1::2]}&#39;)  # evens: [&#39;orange&#39;, &#39;green&#39;, &#39;purple&#39;]

print(b&#39;mongoose&#39;[::-1])  # b&#39;esoognom&#39;
</code></pre>
<h3 id="13-通过带星号的unpacking操作来捕获多个元素，不要用切片"><a href="#13-通过带星号的unpacking操作来捕获多个元素，不要用切片" class="headerlink" title="13. 通过带星号的unpacking操作来捕获多个元素，不要用切片"></a>13. 通过带星号的unpacking操作来捕获多个元素，不要用切片</h3><pre><code class="python">car_inventory = {
    &#39;Downtown&#39;: (&#39;Silver Shadow&#39;, &#39;Pinto&#39;, &#39;DMC&#39;),
    &#39;Airport&#39;: (&#39;Skyline&#39;, &#39;Viper&#39;, &#39;Gremlin&#39;, &#39;Nova&#39;),
}

((loc1, (best1, *rest1)), (loc2, (best2, *rest2))) = car_inventory.items()

print(f&#39;Best at {loc1} is {best1}, {len(rest1)} others&#39;)  # Best at Downtown is Silver Shadow, 2 others
print(f&#39;Best at {loc2} is {best2}, {len(rest2)} others&#39;)  # Best at Airport is Skyline, 3 others


short_list = [1, 2]
first, second, *rest = short_list
print(first, second, rest)  # 3 1 2 []


def generate_csv():
    yield &#39;Date&#39;, &#39;Make&#39;, &#39;Model&#39;, &#39;Year&#39;, &#39;Price&#39;
    for i in range(3):
        yield &#39;2019-03-25&#39;, &#39;Honda&#39;, &#39;Fit&#39;, &#39;2010&#39;, &#39;$3400&#39;
        yield &#39;2019-03-26&#39;, &#39;Ford&#39;, &#39;F150&#39;, &#39;2008&#39;, &#39;$2400&#39;


all_csv_rows = list(generate_csv())
print(all_csv_rows)
print(&#39;CSV Header:&#39;, all_csv_rows[0])  # CSV Header: (&#39;Date&#39;, &#39;Make&#39;, &#39;Model&#39;, &#39;Year&#39;, &#39;Price&#39;)
print(&#39;Row count: &#39;, len(all_csv_rows[1:]))  # Row count:  6

# Example 12
it = generate_csv()
header, *rows = it
print(&#39;CSV Header:&#39;, header)  # CSV Header: (&#39;Date&#39;, &#39;Make&#39;, &#39;Model&#39;, &#39;Year&#39;, &#39;Price&#39;)
print(&#39;Row count: &#39;, len(rows))  # Row count:  6
</code></pre>
<h3 id="14-用sort方法的key参数来表示复杂的排序逻辑"><a href="#14-用sort方法的key参数来表示复杂的排序逻辑" class="headerlink" title="14. 用sort方法的key参数来表示复杂的排序逻辑"></a>14. 用sort方法的key参数来表示复杂的排序逻辑</h3><pre><code class="python">numbers = [93, 86, 11, 68, 70]
numbers.sort(reverse=True)  # 由大到小排列
print(numbers)


# Example 2
class Tool:
    def __init__(self, name, weight):
        self.name = name
        self.weight = weight

    def __repr__(self):
        return f&#39;Tool({self.name!r}, {self.weight})&#39;

tools = [
    Tool(&#39;level&#39;, 3.5),
    Tool(&#39;hammer&#39;, 1.25),
    Tool(&#39;screwdriver&#39;, 0.5),
    Tool(&#39;chisel&#39;, 0.25),
]

# Example 4
print(&#39;Unsorted:&#39;, repr(tools))
tools.sort(key=lambda x: x.name)
print(&#39;Sorted:  &#39;, tools)  # [Tool(&#39;chisel&#39;, 0.25), Tool(&#39;hammer&#39;, 1.25), Tool(&#39;level&#39;, 3.5), Tool(&#39;screwdriver&#39;, 0.5)]


# Example 5
tools.sort(key=lambda x: x.weight)
print(&#39;By weight:&#39;, tools)  # [Tool(&#39;chisel&#39;, 0.25), Tool(&#39;screwdriver&#39;, 0.5), Tool(&#39;hammer&#39;, 1.25), Tool(&#39;level&#39;, 3.5)]


# Example 6
places = [&#39;home&#39;, &#39;work&#39;, &#39;New York&#39;, &#39;Paris&#39;]
places.sort()
print(&#39;Case sensitive:  &#39;, places)  # [&#39;New York&#39;, &#39;Paris&#39;, &#39;home&#39;, &#39;work&#39;]
places.sort(key=lambda x: x.lower())
print(&#39;Case insensitive:&#39;, places)  # [&#39;home&#39;, &#39;New York&#39;, &#39;Paris&#39;, &#39;work&#39;]


</code></pre>
<h3 id="15-不要过分依赖给字典添加条目时所用的顺序"><a href="#15-不要过分依赖给字典添加条目时所用的顺序" class="headerlink" title="15. 不要过分依赖给字典添加条目时所用的顺序"></a>15. 不要过分依赖给字典添加条目时所用的顺序</h3><pre><code class="python">baby_names = {
    &#39;cat&#39;: &#39;kitten&#39;,
    &#39;dog&#39;: &#39;puppy&#39;,
}
print(baby_names)

print(list(baby_names.keys()))
print(list(baby_names.values()))
print(list(baby_names.items()))  # [(&#39;cat&#39;, &#39;kitten&#39;), (&#39;dog&#39;, &#39;puppy&#39;)]
print(baby_names.popitem())  # Last item inserted  : (&#39;dog&#39;, &#39;puppy&#39;)


class MyClass:
    def __init__(self):
        self.alligator = &#39;hatchling&#39;
        self.elephant = &#39;calf&#39;


a = MyClass()
for key, value in a.__dict__.items():
    print(f&#39;{key} = {value}&#39;)


# Example 9
votes = {
    &#39;otter&#39;: 1281,
    &#39;polar bear&#39;: 587,
    &#39;fox&#39;: 863,
}


def populate_ranks(votes, ranks):
    names = list(votes.keys())
    names.sort(key=votes.get, reverse=True)
    for i, name in enumerate(names, 1):
        ranks[name] = i

ranks = {}
populate_ranks(votes, ranks)
print(ranks)  # {&#39;otter&#39;: 1, &#39;fox&#39;: 2, &#39;polar bear&#39;: 3}
print(next(iter(ranks)))  # otter


from collections.abc import MutableMapping


class SortedDict(MutableMapping):
    def __init__(self):
        self.data = {}

    def __getitem__(self, key):
        return self.data[key]

    def __setitem__(self, key, value):
        self.data[key] = value

    def __delitem__(self, key):
        del self.data[key]

    def __iter__(self):
        keys = list(self.data.keys())
        keys.sort()
        for key in keys:
            yield key

    def __len__(self):
        return len(self.data)


my_dict = SortedDict()
my_dict[&#39;otter&#39;] = 1
my_dict[&#39;cheeta&#39;] = 2
my_dict[&#39;anteater&#39;] = 3
my_dict[&#39;deer&#39;] = 4

assert my_dict[&#39;otter&#39;] == 1
assert &#39;cheeta&#39; in my_dict
del my_dict[&#39;cheeta&#39;]
assert &#39;cheeta&#39; not in my_dict

print(my_dict)
expected = [(&#39;anteater&#39;, 3), (&#39;deer&#39;, 4), (&#39;otter&#39;, 1)]
assert list(my_dict.items()) == expected
assert not isinstance(my_dict, dict)


# Example 14
sorted_ranks = SortedDict()
populate_ranks(votes, sorted_ranks)
print(sorted_ranks.data)  # {&#39;otter&#39;: 1, &#39;fox&#39;: 2, &#39;polar bear&#39;: 3}
print(next(iter(sorted_ranks)))  # fox
</code></pre>
<h3 id="16-用get处理键不在字典中的情况，不要使用in与KeyError"><a href="#16-用get处理键不在字典中的情况，不要使用in与KeyError" class="headerlink" title="16. 用get处理键不在字典中的情况，不要使用in与KeyError"></a>16. 用get处理键不在字典中的情况，不要使用in与KeyError</h3><p>有4中方法处理键不在字典中的情况：in表达式，KeyError异常，get方法和setdefault方法。</p>
<pre><code class="python">
counters = {
    &#39;pumpernickel&#39;: 2,
    &#39;sourdough&#39;: 1,
}
key = &#39;multigrain&#39;
count = counters.get(key, 0)
counters[key] = count + 1
print(counters)  # {&#39;pumpernickel&#39;: 2, &#39;sourdough&#39;: 1, &#39;multigrain&#39;: 1}


votes = {
    &#39;baguette&#39;: [&#39;Bob&#39;, &#39;Alice&#39;],
    &#39;ciabatta&#39;: [&#39;Coco&#39;, &#39;Deb&#39;],
}

key = &#39;brioche&#39;
who = &#39;Elmer&#39;
print(f&#39;votes pre: {votes}&#39;)  # {&#39;baguette&#39;: [&#39;Bob&#39;, &#39;Alice&#39;], &#39;ciabatta&#39;: [&#39;Coco&#39;, &#39;Deb&#39;]}
if key in votes:
    names = votes[key]
else:
    votes[key] = names = []
    print(votes)  # {&#39;baguette&#39;: [&#39;Bob&#39;, &#39;Alice&#39;], &#39;ciabatta&#39;: [&#39;Coco&#39;, &#39;Deb&#39;], &#39;brioche&#39;: []}

names.append(who)
print(f&#39;votes: {votes}&#39;)  # {&#39;baguette&#39;: [&#39;Bob&#39;, &#39;Alice&#39;], &#39;ciabatta&#39;: [&#39;Coco&#39;, &#39;Deb&#39;], &#39;brioche&#39;: [&#39;Elmer&#39;]}


key = &#39;cornbread&#39;
who = &#39;Kirk&#39;

names = votes.setdefault(key, [])
names.append(who)
print(votes)  # {&#39;baguette&#39;: [&#39;Bob&#39;, &#39;Alice&#39;], &#39;ciabatta&#39;: [&#39;Coco&#39;, &#39;Deb&#39;], &#39;brioche&#39;: [&#39;Elmer&#39;], &#39;cornbread&#39;: [&#39;Kirk&#39;]}

data = {}
key = &#39;foo&#39;
value = []
data.setdefault(key, value)
print(&#39;Before:&#39;, data)  # Before: {&#39;foo&#39;: []}
value.append(&#39;hello&#39;)
print(&#39;After: &#39;, data)  # After:  {&#39;foo&#39;: [&#39;hello&#39;]}
</code></pre>
<h3 id="17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault"><a href="#17-用defaultdict处理内部状态中缺失的元素，而不要用setdefault" class="headerlink" title="17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault"></a>17. 用defaultdict处理内部状态中缺失的元素，而不要用setdefault</h3><pre><code class="python">class Visits:
    def __init__(self):
        self.data = {}

    def add(self, country, city):
        city_set = self.data.setdefault(country, set())
        city_set.add(city)


visits = Visits()
visits.add(&#39;Russia&#39;, &#39;Yekaterinburg&#39;)
visits.add(&#39;Tanzania&#39;, &#39;Zanzibar&#39;)
print(visits.data)  # {&#39;Russia&#39;: {&#39;Yekaterinburg&#39;}, &#39;Tanzania&#39;: {&#39;Zanzibar&#39;}}

print(&#39;-----------------------------&#39;)
from collections import defaultdict  # 推荐


class Visits:
    def __init__(self):
        self.data = defaultdict(set)

    def add(self, country, city):
        self.data[country].add(city)


visits = Visits()
visits.add(&#39;England&#39;, &#39;Bath&#39;)
visits.add(&#39;England&#39;, &#39;London&#39;)
print(visits.data)  # defaultdict(&lt;class &#39;set&#39;&gt;, {&#39;England&#39;: {&#39;Bath&#39;}, &#39;England1&#39;: {&#39;London&#39;}})

</code></pre>
<h3 id="18-学会利用missing构造依赖键的默认值"><a href="#18-学会利用missing构造依赖键的默认值" class="headerlink" title="18. 学会利用missing构造依赖键的默认值"></a>18. 学会利用<strong>missing</strong>构造依赖键的默认值</h3><pre><code class="python">path = &#39;account_9090.csv&#39;

with open(path, &#39;wb&#39;) as f:
    f.write(b&#39;image data here 9090&#39;)

def open_picture(profile_path):
    try:
        return open(profile_path, &#39;a+b&#39;)
    except OSError:
        print(f&#39;Failed to open path {profile_path}&#39;)
        raise

class Pictures(dict):
    def __missing__(self, key):
        value = open_picture(key)
        self[key] = value
        return value

pictures = Pictures()
handle = pictures[path]
handle.seek(0)
image_data = handle.read()
print(pictures)
print(image_data)

</code></pre>
<h3 id="19-不要把函数返回的多个数值拆分到三个以上的变量中"><a href="#19-不要把函数返回的多个数值拆分到三个以上的变量中" class="headerlink" title="19. 不要把函数返回的多个数值拆分到三个以上的变量中"></a>19. 不要把函数返回的多个数值拆分到三个以上的变量中</h3><pre><code class="python">def get_stats(numbers):
    minimum = min(numbers)
    maximum = max(numbers)
    return minimum, maximum

lengths = [63, 73, 72, 60, 67, 66, 71, 61, 72, 70]

minimum, maximum = get_stats(lengths)  # Two return values

print(f&#39;Min: {minimum}, Max: {maximum}&#39;)
</code></pre>
<h2 id="三-函数"><a href="#三-函数" class="headerlink" title="三. 函数"></a>三. 函数</h2><h3 id="20-遇到意外状况时应该抛出异常，不要返回None"><a href="#20-遇到意外状况时应该抛出异常，不要返回None" class="headerlink" title="20. 遇到意外状况时应该抛出异常，不要返回None"></a>20. 遇到意外状况时应该抛出异常，不要返回None</h3><pre><code class="python">def careful_divide(a, b):
    try:
        return a / b
    except ZeroDivisionError:
        return None

assert careful_divide(4, 2) == 2
assert careful_divide(0, 1) == 0
assert careful_divide(3, 6) == 0.5
assert careful_divide(1, 0) == None

def careful_divide(a: float, b: float) -&gt; float:
    &quot;&quot;&quot;Divides a by b.

    Raises:
        ValueError: When the inputs cannot be divided.
    &quot;&quot;&quot;
    try:
        return a / b
    except ZeroDivisionError as e:
        print(f&#39;result: {e}&#39;)
        raise ValueError(f&#39;Invalid inputs: {e}&#39;)

try:
    result = careful_divide(1, 0)
    assert False
except ValueError:
    print(f&#39;result:&#39;)
    pass  # Expected

assert careful_divide(1, 5) == 0.2
</code></pre>
<h3 id="21-了解如何在闭包里面使用外围作用域中的变量"><a href="#21-了解如何在闭包里面使用外围作用域中的变量" class="headerlink" title="21. 了解如何在闭包里面使用外围作用域中的变量"></a>21. 了解如何在闭包里面使用外围作用域中的变量</h3><pre><code class="python">

def sort_priority3(numbers, group):
    found = False
    def helper(x):
        # 把闭包里面的数据赋值给闭包外面的变量
        nonlocal found  # Added
        if x in group:
            found = True
            return (0, x)
        return (1, x)
    numbers.sort(key=helper)
    return found


numbers = [8, 3, 1, 2, 5, 4, 7, 6]
group = {2, 3, 5, 7}
found = sort_priority3(numbers, group)
assert found
assert numbers == [2, 3, 5, 7, 1, 4, 6, 8]


print(&#39;--------------下面是用辅助类来封装状态&#39;)
class Sorter:
    def __init__(self, group):
        self.group = group
        self.found = False

    def __call__(self, x):
        if x in self.group:
            self.found = True
            return (0, x)
        return (1, x)

sorter = Sorter(group)
numbers.sort(key=sorter)
assert sorter.found is True
assert numbers == [2, 3, 5, 7, 1, 4, 6, 8]
</code></pre>
<h3 id="22-用数量可变的位置参数给函数设计清晰的参数列表"><a href="#22-用数量可变的位置参数给函数设计清晰的参数列表" class="headerlink" title="22. 用数量可变的位置参数给函数设计清晰的参数列表"></a>22. 用数量可变的位置参数给函数设计清晰的参数列表</h3><pre><code class="python">def log(message, *values):  # The only difference
    if not values:
        print(message)
    else:
        values_str = &#39;, &#39;.join(str(x) for x in values)
        print(f&#39;{message}: {values_str}&#39;)

log(&#39;My numbers are&#39;, 1, 2)
log(&#39;Hi there&#39;)  # Much better
</code></pre>
<h3 id="23-用关键字参数来表示可选的行为"><a href="#23-用关键字参数来表示可选的行为" class="headerlink" title="23. 用关键字参数来表示可选的行为"></a>23. 用关键字参数来表示可选的行为</h3><pre><code class="python">def flow_rate(weight_diff, time_diff, period=1):
    &quot;&quot;&quot;流速：每秒的千克数&quot;&quot;&quot;
    return (weight_diff / time_diff) * period

weight_diff = 0.5
time_diff = 3
flow = flow_rate(weight_diff, time_diff, period=2)
print(f&#39;{flow:.3} kg per second&#39;)
</code></pre>
<h3 id="24-用None和docstring来描述默认值会变的参数"><a href="#24-用None和docstring来描述默认值会变的参数" class="headerlink" title="24. 用None和docstring来描述默认值会变的参数"></a>24. 用None和docstring来描述默认值会变的参数</h3><pre><code class="python">import json
from time import sleep
from datetime import datetime
from typing import Optional

def log(message, when=None):
    &quot;&quot;&quot;Log a message with a timestamp.

    Args:
        message: Message to print.
        when: datetime of when the message occurred.
            Defaults to the present time.
    &quot;&quot;&quot;
    if when is None:
        when = datetime.now()
    print(f&#39;{when}: {message}&#39;)


# Example 
log(&#39;Hi there!&#39;)
sleep(0.1)
log(&#39;Hello again!&#39;)


def decode(data, default=None):
    &quot;&quot;&quot;Load JSON data from a string.

    Args:
        data: JSON data to decode.
        default: Value to return if decoding fails.
            Defaults to an empty dictionary.
    &quot;&quot;&quot;
    try:
        return json.loads(data)
    except ValueError:
        if default is None:
            default = {}
        return default


foo = decode(&#39;bad data&#39;)
foo[&#39;stuff&#39;] = 5
bar = decode(&#39;also bad&#39;)
bar[&#39;meep&#39;] = 1
print(&#39;Foo:&#39;, foo)
print(&#39;Bar:&#39;, bar)
assert foo is not bar


def log_typed(message: str, when: Optional[datetime] = None) -&gt; None:
    &quot;&quot;&quot;Log a message with a timestamp.

    Args:
        message: Message to print.
        when: datetime of when the message occurred.
            Defaults to the present time.
    &quot;&quot;&quot;
    if when is None:
        when = datetime.now()
    print(f&#39;{when}: {message}&#39;)

log_typed(&#39;Hi there!&#39;)
sleep(0.1)
log_typed(&#39;Hello again!&#39;)
</code></pre>
<h3 id="25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表"><a href="#25-用只能以关键字-和只能按位置传入的参数来设计清晰的参数列表" class="headerlink" title="25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表"></a>25. 用只能以关键字 和只能按位置传入的参数来设计清晰的参数列表</h3><pre><code class="python">def safe_division_e(numerator, denominator,
                    ndigits=10, *,                # Changed
                    ignore_overflow=False,
                    ignore_zero_division=False):
    try:
        fraction = numerator / denominator        # Changed
        return round(fraction, ndigits)           # Changed
    except OverflowError:
        if ignore_overflow:
            return 0
        else:
            raise
    except ZeroDivisionError:
        if ignore_zero_division:
            return float(&#39;inf&#39;)
        else:
            raise


result = safe_division_e(22, 7)
print(result)  # 3.1428571429

result = safe_division_e(22, 7, 5)
print(result)  # 3.14286

result = safe_division_e(22, 7, ndigits=2)
print(result)  # 3.14
</code></pre>
<h3 id="26-用functools-wraps定义函数修饰器"><a href="#26-用functools-wraps定义函数修饰器" class="headerlink" title="26. 用functools.wraps定义函数修饰器"></a>26. 用functools.wraps定义函数修饰器</h3><pre><code class="python">import pickle
from functools import wraps


def trace(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        result = func(*args, **kwargs)
        print(f&#39;{func.__name__}({args!r}, {kwargs!r}) &#39;
              f&#39;-&gt; {result!r}&#39;)
        return result
    return wrapper

@trace
def fibonacci(n):
    &quot;&quot;&quot;Return the n-th Fibonacci number&quot;&quot;&quot;
    if n in (0, 1):
        return n
    return fibonacci(n - 2) + fibonacci(n - 1)


help(fibonacci)
print(pickle.dumps(fibonacci))

</code></pre>
<h2 id="四-推导与生成"><a href="#四-推导与生成" class="headerlink" title="四. 推导与生成"></a>四. 推导与生成</h2><h3 id="27-用列表推导取代map与filter"><a href="#27-用列表推导取代map与filter" class="headerlink" title="27. 用列表推导取代map与filter"></a>27. 用列表推导取代map与filter</h3><pre><code class="python">a = range(1, 10)
even_squares = [x**2 for x in a if x % 2 == 0]
print(even_squares)

alt = map(lambda x: x**2, filter(lambda x: x % 2 == 0, a))
assert even_squares == list(alt)


# 字典推导
even_squares_dict = {x: x**2 for x in a if x % 2 == 0}
threes_cubed_set = {x**3 for x in a if x % 3 == 0}
print(even_squares_dict)
print(threes_cubed_set)
</code></pre>
<h3 id="28-控制推导逻辑的子表达式不要超过两个"><a href="#28-控制推导逻辑的子表达式不要超过两个" class="headerlink" title="28. 控制推导逻辑的子表达式不要超过两个"></a>28. 控制推导逻辑的子表达式不要超过两个</h3><pre><code class="python">matrix = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
flat = [x for row in matrix for x in row]
print(flat)

squared = [[x**2 for x in row] for row in matrix]
print(squared)
</code></pre>
<h3 id="29-用赋值表达式消除推导中的重复代码"><a href="#29-用赋值表达式消除推导中的重复代码" class="headerlink" title="29. 用赋值表达式消除推导中的重复代码"></a>29. 用赋值表达式消除推导中的重复代码</h3><pre><code class="python">stock = {
    &#39;nails&#39;: 125,
    &#39;screws&#39;: 35,
    &#39;wingnuts&#39;: 8,
    &#39;washers&#39;: 24,
}

order = [&#39;screws&#39;, &#39;wingnuts&#39;, &#39;clips&#39;]
found = ((name, batches) for name in order
         if (batches := get_batches(stock.get(name, 0), 8)))
print(next(found))
print(next(found))
</code></pre>
<h3 id="30-不要让函数直接返回列表，应该让它逐个生成列表里的值"><a href="#30-不要让函数直接返回列表，应该让它逐个生成列表里的值" class="headerlink" title="30. 不要让函数直接返回列表，应该让它逐个生成列表里的值"></a>30. 不要让函数直接返回列表，应该让它逐个生成列表里的值</h3><pre><code class="python">address_lines = &quot;&quot;&quot;Four score and seven years
ago our fathers brought forth on this
continent a new nation, conceived in liberty,
and dedicated to the proposition that all men
are created equal.&quot;&quot;&quot;

with open(&#39;address.txt&#39;, &#39;w&#39;) as f:
    f.write(address_lines)

import itertools
with open(&#39;address.txt&#39;, &#39;r&#39;) as f:
    it = index_file(f)
    results = itertools.islice(it, 0, 10)
    print(list(results))
</code></pre>
<h3 id="31-谨慎地迭代函数所收到的参数"><a href="#31-谨慎地迭代函数所收到的参数" class="headerlink" title="31. 谨慎地迭代函数所收到的参数"></a>31. 谨慎地迭代函数所收到的参数</h3><pre><code class="python">from collections.abc import Iterator


def normalize_defensive(numbers):
    if isinstance(numbers, Iterator):  # Another way to check
        raise TypeError(&#39;Must supply a container&#39;)
    total = sum(numbers)
    result = []
    for value in numbers:
        percent = 100 * value / total
        result.append(percent)
    return result

visits = [15, 35, 80]
result = normalize_defensive(visits)  # No error
print(result, type(result))

it = iter(visits)
try:
    normalize_defensive(it)
except TypeError:
    pass
else:
    assert False
</code></pre>
<h3 id="32-考虑用生成器表达式改写数据量较大的列表推导"><a href="#32-考虑用生成器表达式改写数据量较大的列表推导" class="headerlink" title="32. 考虑用生成器表达式改写数据量较大的列表推导"></a>32. 考虑用生成器表达式改写数据量较大的列表推导</h3><pre><code class="python">import random

with open(&#39;my_file.txt&#39;, &#39;w&#39;) as f:
    for _ in range(10):
        f.write(&#39;a&#39; * random.randint(0, 100))
        f.write(&#39;\n&#39;)

value = [len(x) for x in open(&#39;my_file.txt&#39;)]
print(value)

it = (len(x) for x in open(&#39;my_file.txt&#39;))
print(it)

print(next(it))
print(next(it))

roots = ((x, x**0.5) for x in it)
print(next(roots))
</code></pre>
<h3 id="33-通过yield-from把多个生成器连起来用"><a href="#33-通过yield-from把多个生成器连起来用" class="headerlink" title="33. 通过yield from把多个生成器连起来用"></a>33. 通过yield from把多个生成器连起来用</h3><pre><code class="python">import timeit

def child():
    for i in range(1_000_000):
        yield i

def slow():
    for i in child():
        yield i

def fast():
    yield from child()

baseline = timeit.timeit(
    stmt=&#39;for _ in slow(): pass&#39;,
    globals=globals(),
    number=50)
print(f&#39;Manual nesting {baseline:.2f}s&#39;)

comparison = timeit.timeit(
    stmt=&#39;for _ in fast(): pass&#39;,
    globals=globals(),
    number=50)
print(f&#39;Composed nesting {comparison:.2f}s&#39;)

reduction = -(comparison - baseline) / baseline
print(f&#39;{reduction:.1%} less time&#39;)
</code></pre>
<h3 id="34-不要用send给生成器注入数据"><a href="#34-不要用send给生成器注入数据" class="headerlink" title="34. 不要用send给生成器注入数据"></a>34. 不要用send给生成器注入数据</h3><pre><code class="python">import math


def wave_cascading(amplitude_it, steps):
    step_size = 2 * math.pi / steps
    for step in range(steps):
        radians = step * step_size
        fraction = math.sin(radians)
        amplitude = next(amplitude_it)  # Get next input
        output = amplitude * fraction
        yield output


def complex_wave_cascading(amplitude_it):
    yield from wave_cascading(amplitude_it, 3)
    yield from wave_cascading(amplitude_it, 4)
    yield from wave_cascading(amplitude_it, 5)


def run_cascading():
    amplitudes = [7, 7, 7, 2, 2, 2, 2, 10, 10, 10, 10, 10]
    it = complex_wave_cascading(iter(amplitudes))
    for amplitude in amplitudes:
        output = next(it)
        if output is None:
            print(f&#39;Output is None&#39;)
        else:
            print(f&#39;Output: {output:&gt;5.1f}   {amplitude}&#39;)


run_cascading()
</code></pre>
<h3 id="35-不要通过throw变换生成器的状态"><a href="#35-不要通过throw变换生成器的状态" class="headerlink" title="35. 不要通过throw变换生成器的状态"></a>35. 不要通过throw变换生成器的状态</h3><pre><code class="python">RESETS = [False, False, True, False, True, False, False, False, False, False, False, False, False]


class Timer:
    def __init__(self, period):
        self.current = period
        self.period = period

    def reset(self):
        self.current = self.period

    def __iter__(self):
        while self.current:
            self.current -= 1
            yield self.current


def run():
    timer = Timer(4)
    for current in timer:
        if RESETS.pop(0):
            timer.reset()
        print(f&#39;{current} ticks remaining&#39;)


run()
</code></pre>
<h3 id="36-考虑用itertools拼装迭代器与生成器"><a href="#36-考虑用itertools拼装迭代器与生成器" class="headerlink" title="36. 考虑用itertools拼装迭代器与生成器"></a>36. 考虑用itertools拼装迭代器与生成器</h3><pre><code class="python">import itertools

print(&#39;------- 一. 连接多个迭代器&#39;)
# chain: 把多个迭代器从头到尾连成一个迭代器
it = itertools.chain([1, 2, 3], [4, 5, 6])
print(list(it))  # [1, 2, 3, 4, 5, 6]


# repeat:  不停的输出某个值
it = itertools.repeat(&#39;hello&#39;, 3)
print(list(it))  # [&#39;hello&#39;, &#39;hello&#39;, &#39;hello&#39;]


# cycle: 循环的输出某段内容之间的元素
it = itertools.cycle([1, 2])
result = [next(it) for _ in range (10)]
print(result)  # [1, 2, 1, 2, 1, 2, 1, 2, 1, 2]


# tee: 让一个迭代器分裂成多个平行的迭代器
it1, it2, it3 = itertools.tee([&#39;first&#39;, &#39;second&#39;], 3)
print(list(it1))  # [&#39;first&#39;, &#39;second&#39;]
print(list(it2))  # [&#39;first&#39;, &#39;second&#39;]
print(list(it3))  # [&#39;first&#39;, &#39;second&#39;]


# zip_longest： 和zip函数类似，但会用默认值填充
keys = [&#39;one&#39;, &#39;two&#39;, &#39;three&#39;]
values = [1, 2]

normal = list(zip(keys, values))
print(&#39;zip:        &#39;, normal)  # zip:         [(&#39;one&#39;, 1), (&#39;two&#39;, 2)]

it = itertools.zip_longest(keys, values, fillvalue=&#39;nope&#39;)
longest = list(it)
print(&#39;zip_longest:&#39;, longest)  # zip_longest: [(&#39;one&#39;, 1), (&#39;two&#39;, 2), (&#39;three&#39;, &#39;nope&#39;)]

print(&#39;------- 二. 过滤源迭代器中的元素&#39;)
# islice： 按照下标切割源迭代器
values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

first_five = itertools.islice(values, 5)
print(&#39;First five: &#39;, list(first_five))  # First five:  [1, 2, 3, 4, 5]

middle_odds = itertools.islice(values, 2, 8, 2)
print(&#39;Middle odds:&#39;, list(middle_odds))  # Middle odds: [3, 5, 7]


# takewhile: 一直从源迭代器里获取元素，直到返回false
values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
less_than_seven = lambda x: x &lt; 7
it = itertools.takewhile(less_than_seven, values)
print(list(it))  # [1, 2, 3, 4, 5, 6]


# dropwhile: 一直跳过序列中的元素，直到返回true
values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
less_than_seven = lambda x: x &lt; 7
it = itertools.dropwhile(less_than_seven, values)
print(list(it))  # [7, 8, 9, 10]


# filterfalse: 与内置的filter函数相反，输出false的那些元素
values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
evens = lambda x: x % 2 == 0

filter_result = filter(evens, values)
print(&#39;Filter:      &#39;, list(filter_result))  # Filter:       [2, 4, 6, 8, 10]

filter_false_result = itertools.filterfalse(evens, values)
print(&#39;Filter false:&#39;, list(filter_false_result))  # Filter false: [1, 3, 5, 7, 9]

print(&#39;------- 三. 从源迭代器中的元素合成新的元素&#39;)
# accumulate： 从源迭代器中取出一个元素进行累加，和functools模块中的reduce函数其实是一样的
values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
sum_reduce = itertools.accumulate(values)
print(&#39;Sum:   &#39;, list(sum_reduce))  # Sum:    [1, 3, 6, 10, 15, 21, 28, 36, 45, 55]

def sum_modulo_20(first, second):
    output = first + second
    return output % 20

modulo_reduce = itertools.accumulate(values, sum_modulo_20)
print(&#39;Modulo:&#39;, list(modulo_reduce))  # Modulo: [1, 3, 6, 10, 15, 1, 8, 16, 5, 15]


# product： 从一个或多个源迭代器中获取元素，并计算笛卡尔积
single = itertools.product([1, 2], repeat=2)
print(&#39;Single:  &#39;, list(single))  # Single:   [(1, 1), (1, 2), (2, 1), (2, 2)]

multiple = itertools.product([1, 2], [&#39;a&#39;, &#39;b&#39;])
print(&#39;Multiple:&#39;, list(multiple))  # Multiple: [(1, &#39;a&#39;), (1, &#39;b&#39;), (2, &#39;a&#39;), (2, &#39;b&#39;)]


# permutations： 输出迭代器中n个元素形成的每种 有序排列
it = itertools.permutations([1, 2, 3], 2)
print(f&#39;permutations: {list(it)}&#39;)  # permutations: [(1, 2), (1, 3), (2, 1), (2, 3), (3, 1), (3, 2)]


# combinations： 输出迭代器中n个元素形成的每种 无序组合
it = itertools.combinations([1, 2, 3, 4], 2)
print(list(it))  # [(1, 2), (1, 3), (1, 4), (2, 3), (2, 4), (3, 4)]


# combinations_with_replacement：允许同一个元素在组合里多次出现
it = itertools.combinations_with_replacement([1, 2, 3], 2)
print(list(it))  # [(1, 1), (1, 2), (1, 3), (2, 2), (2, 3), (3, 3)]
</code></pre>
<h2 id="五-类与接口"><a href="#五-类与接口" class="headerlink" title="五. 类与接口"></a>五. 类与接口</h2><h3 id="37-用组合起来的类来实现多层结构，不要用嵌套的内置类型"><a href="#37-用组合起来的类来实现多层结构，不要用嵌套的内置类型" class="headerlink" title="37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型"></a>37. 用组合起来的类来实现多层结构，不要用嵌套的内置类型</h3><pre><code class="python">from collections import defaultdict
from collections import namedtuple

Grade = namedtuple(&#39;Grade&#39;, (&#39;score&#39;, &#39;weight&#39;))


class Subject:
    def __init__(self):
        self._grades = []

    def report_grade(self, score, weight):
        self._grades.append(Grade(score, weight))

    def average_grade(self):
        total, total_weight = 0, 0
        for grade in self._grades:
            total += grade.score * grade.weight
            total_weight += grade.weight
        return total / total_weight


class Student:
    def __init__(self):
        self._subjects = defaultdict(Subject)

    def get_subject(self, name):
        return self._subjects[name]

    def average_grade(self):
        total, count = 0, 0
        for subject in self._subjects.values():
            total += subject.average_grade()
            count += 1
        return total / count


class Gradebook:
    def __init__(self):
        self._students = defaultdict(Student)

    def get_student(self, name):
        return self._students[name]


book = Gradebook()
albert = book.get_student(&#39;Albert Einstein&#39;)
math = albert.get_subject(&#39;Math&#39;)
math.report_grade(75, 0.05)
math.report_grade(65, 0.15)
math.report_grade(70, 0.80)
gym = albert.get_subject(&#39;Gym&#39;)
gym.report_grade(100, 0.40)
gym.report_grade(85, 0.60)
print(albert.average_grade())
</code></pre>
<h3 id="38-让简单的接口接受函数，而不是类的实例"><a href="#38-让简单的接口接受函数，而不是类的实例" class="headerlink" title="38. 让简单的接口接受函数，而不是类的实例"></a>38. 让简单的接口接受函数，而不是类的实例</h3><pre><code class="python">
# Example 1
names = [&#39;Socrates&#39;, &#39;Archimedes&#39;, &#39;Plato&#39;, &#39;Aristotle&#39;]
names.sort(key=len)
print(names)  # [&#39;Plato&#39;, &#39;Socrates&#39;, &#39;Aristotle&#39;, &#39;Archimedes&#39;]


# Example 2
def log_missing():
    print(&#39;Key added&#39;)
    return 0


# Example 3
from collections import defaultdict

current = {&#39;green&#39;: 12, &#39;blue&#39;: 3}
increments = [
    (&#39;red&#39;, 5),
    (&#39;blue&#39;, 17),
    (&#39;orange&#39;, 9),
]
result = defaultdict(log_missing, current)
print(&#39;Before:&#39;, dict(result))  # Before: {&#39;green&#39;: 12, &#39;blue&#39;: 3}
for key, amount in increments:
    result[key] += amount
print(&#39;After: &#39;, dict(result))  # After:  {&#39;green&#39;: 12, &#39;blue&#39;: 20, &#39;red&#39;: 5, &#39;orange&#39;: 9}


# Example 4
def increment_with_report(current, increments):
    added_count = 0

    def missing():
        nonlocal added_count  # Stateful closure
        added_count += 1
        return 0

    result = defaultdict(missing, current)
    for key, amount in increments:
        result[key] += amount
    return result, added_count


# Example 5
result, count = increment_with_report(current, increments)
assert count == 2
print(result)  # defaultdict(&lt;function increment_with_report.&lt;locals&gt;.missing at 0x7faa53a46ef0&gt;, {&#39;green&#39;: 12, &#39;blue&#39;: 20, &#39;red&#39;: 5, &#39;orange&#39;: 9})


# Example 6
class CountMissing:
    def __init__(self):
        self.added = 0

    def missing(self):
        self.added += 1
        return 0


# Example 7
counter = CountMissing()
result = defaultdict(counter.missing, current)  # Method ref
for key, amount in increments:
    result[key] += amount
assert counter.added == 2
print(result)  # defaultdict(&lt;bound method CountMissing.missing of &lt;__main__.CountMissing object at 0x7faa53ac7810&gt;&gt;, {&#39;green&#39;: 12, &#39;blue&#39;: 20, &#39;red&#39;: 5, &#39;orange&#39;: 9})


# Example 8
class BetterCountMissing:
    def __init__(self):
        self.added = 0

    def __call__(self):
        self.added += 1
        return 0

counter = BetterCountMissing()
assert counter() == 0
assert callable(counter)


# Example 9
counter = BetterCountMissing()
result = defaultdict(counter, current)  # Relies on __call__
for key, amount in increments:
    result[key] += amount
assert counter.added == 2
print(result)  # defaultdict(&lt;__main__.BetterCountMissing object at 0x7faa53ac7990&gt;, {&#39;green&#39;: 12, &#39;blue&#39;: 20, &#39;red&#39;: 5, &#39;orange&#39;: 9})

</code></pre>
<h3 id="39-通过-classmethod多态来构造同一体系中的各类对象"><a href="#39-通过-classmethod多态来构造同一体系中的各类对象" class="headerlink" title="39. 通过@classmethod多态来构造同一体系中的各类对象"></a>39. 通过@classmethod多态来构造同一体系中的各类对象</h3><pre><code class="python"># Example 1
class InputData:
    def read(self):
        raise NotImplementedError


# Example 2
class PathInputData(InputData):
    def __init__(self, path):
        super().__init__()
        self.path = path

    def read(self):
        with open(self.path) as f:
            return f.read()


# Example 3
class Worker:
    def __init__(self, input_data):
        self.input_data = input_data
        self.result = None

    def map(self):
        raise NotImplementedError

    def reduce(self, other):
        raise NotImplementedError


# Example 4
class LineCountWorker(Worker):
    def map(self):
        data = self.input_data.read()
        self.result = data.count(&#39;\n&#39;)

    def reduce(self, other):
        self.result += other.result


# Example 5
import os

def generate_inputs(data_dir):
    for name in os.listdir(data_dir):
        yield PathInputData(os.path.join(data_dir, name))


# Example 6
def create_workers(input_list):
    workers = []
    for input_data in input_list:
        workers.append(LineCountWorker(input_data))
    return workers


# Example 7
from threading import Thread

def execute(workers):
    threads = [Thread(target=w.map) for w in workers]
    for thread in threads: thread.start()
    for thread in threads: thread.join()

    first, *rest = workers
    for worker in rest:
        first.reduce(worker)
    return first.result


# Example 8
def mapreduce(data_dir):
    inputs = generate_inputs(data_dir)
    workers = create_workers(inputs)
    return execute(workers)


# Example 9
import os
import random

def write_test_files(tmpdir):
    os.makedirs(tmpdir)
    for i in range(100):
        with open(os.path.join(tmpdir, str(i)), &#39;w&#39;) as f:
            f.write(&#39;\n&#39; * random.randint(0, 100))

tmpdir = &#39;test_inputs&#39;
write_test_files(tmpdir)

result = mapreduce(tmpdir)
print(f&#39;There are {result} lines&#39;)  # There are 4762 lines


# Example 10
class GenericInputData:
    def read(self):
        raise NotImplementedError

    @classmethod
    def generate_inputs(cls, config):
        raise NotImplementedError


# Example 11
class PathInputData(GenericInputData):
    def __init__(self, path):
        super().__init__()
        self.path = path

    def read(self):
        with open(self.path) as f:
            return f.read()

    @classmethod
    def generate_inputs(cls, config):
        data_dir = config[&#39;data_dir&#39;]
        for name in os.listdir(data_dir):
            yield cls(os.path.join(data_dir, name))


# Example 12
class GenericWorker:
    def __init__(self, input_data):
        self.input_data = input_data
        self.result = None

    def map(self):
        raise NotImplementedError

    def reduce(self, other):
        raise NotImplementedError

    @classmethod
    def create_workers(cls, input_class, config):
        workers = []
        for input_data in input_class.generate_inputs(config):
            workers.append(cls(input_data))
        return workers


# Example 13
class LineCountWorker(GenericWorker):
    def map(self):
        data = self.input_data.read()
        self.result = data.count(&#39;\n&#39;)

    def reduce(self, other):
        self.result += other.result


# Example 14
def mapreduce(worker_class, input_class, config):
    workers = worker_class.create_workers(input_class, config)
    return execute(workers)


# Example 15
config = {&#39;data_dir&#39;: tmpdir}
result = mapreduce(LineCountWorker, PathInputData, config)
print(f&#39;There are {result} lines&#39;)  # There are 4762 lines
</code></pre>
<h3 id="40-通过super初始化超类"><a href="#40-通过super初始化超类" class="headerlink" title="40. 通过super初始化超类"></a>40. 通过super初始化超类</h3><pre><code class="python">
# Example 1
class MyBaseClass:
    def __init__(self, value):
        self.value = value

class MyChildClass(MyBaseClass):
    def __init__(self):
        MyBaseClass.__init__(self, 5)

    def times_two(self):
        return self.value * 2

foo = MyChildClass()
assert foo.times_two() == 10


# Example 2
class TimesTwo:
    def __init__(self):
        self.value *= 2

class PlusFive:
    def __init__(self):
        self.value += 5


# Example 3
class OneWay(MyBaseClass, TimesTwo, PlusFive):
    def __init__(self, value):
        MyBaseClass.__init__(self, value)
        TimesTwo.__init__(self)
        PlusFive.__init__(self)


# Example 4
foo = OneWay(5)
print(&#39;First ordering value is (5 * 2) + 5 =&#39;, foo.value)  # First ordering value is (5 * 2) + 5 = 15


# Example 5
class AnotherWay(MyBaseClass, PlusFive, TimesTwo):
    def __init__(self, value):
        MyBaseClass.__init__(self, value)
        TimesTwo.__init__(self)
        PlusFive.__init__(self)


# Example 6
bar = AnotherWay(5)
print(&#39;Second ordering value is&#39;, bar.value)  # Second ordering value is 15


# Example 7
class TimesSeven(MyBaseClass):
    def __init__(self, value):
        MyBaseClass.__init__(self, value)
        self.value *= 7

class PlusNine(MyBaseClass):
    def __init__(self, value):
        MyBaseClass.__init__(self, value)
        self.value += 9


# Example 8
class ThisWay(TimesSeven, PlusNine):
    def __init__(self, value):
        TimesSeven.__init__(self, value)
        PlusNine.__init__(self, value)

foo = ThisWay(5)
print(&#39;Should be (5 * 7) + 9 = 44 but is&#39;, foo.value)  # Should be (5 * 7) + 9 = 44 but is 14


# Example 9
class MyBaseClass:
    def __init__(self, value):
        self.value = value

class TimesSevenCorrect(MyBaseClass):
    def __init__(self, value):
        super().__init__(value)
        self.value *= 7

class PlusNineCorrect(MyBaseClass):
    def __init__(self, value):
        super().__init__(value)
        self.value += 9


# Example 10
class GoodWay(TimesSevenCorrect, PlusNineCorrect):
    def __init__(self, value):
        super().__init__(value)

foo = GoodWay(5)
print(&#39;Should be 7 * (5 + 9) = 98 and is&#39;, foo.value)  # Should be 7 * (5 + 9) = 98 and is 98


# Example 11
mro_str = &#39;\n&#39;.join(repr(cls) for cls in GoodWay.mro())
print(f&#39;mro_str: {mro_str}&#39;)  # &lt;class &#39;__main__.GoodWay&#39;&gt;


# Example 12
class ExplicitTrisect(MyBaseClass):
    def __init__(self, value):
        super(ExplicitTrisect, self).__init__(value)
        self.value /= 3
assert ExplicitTrisect(9).value == 3


# Example 13
class AutomaticTrisect(MyBaseClass):
    def __init__(self, value):
        super(__class__, self).__init__(value)
        self.value /= 3

class ImplicitTrisect(MyBaseClass):
    def __init__(self, value):
        super().__init__(value)
        self.value /= 3

assert ExplicitTrisect(9).value == 3
assert AutomaticTrisect(9).value == 3
assert ImplicitTrisect(9).value == 3

</code></pre>
<h3 id="41-考虑用mix-in类来表示可组合的功能"><a href="#41-考虑用mix-in类来表示可组合的功能" class="headerlink" title="41. 考虑用mix-in类来表示可组合的功能"></a>41. 考虑用mix-in类来表示可组合的功能</h3><pre><code class="python"># Example 1
class ToDictMixin:
    def to_dict(self):
        return self._traverse_dict(self.__dict__)

    # Example 2
    def _traverse_dict(self, instance_dict):
        output = {}
        for key, value in instance_dict.items():
            output[key] = self._traverse(key, value)
        return output

    def _traverse(self, key, value):
        if isinstance(value, ToDictMixin):
            return value.to_dict()
        elif isinstance(value, dict):
            return self._traverse_dict(value)
        elif isinstance(value, list):
            return [self._traverse(key, i) for i in value]
        elif hasattr(value, &#39;__dict__&#39;):
            return self._traverse_dict(value.__dict__)
        else:
            return value


# Example 3
class BinaryTree(ToDictMixin):
    def __init__(self, value, left=None, right=None):
        self.value = value
        self.left = left
        self.right = right


# Example 4
tree = BinaryTree(10, left=BinaryTree(7, right=BinaryTree(9)), right=BinaryTree(13, left=BinaryTree(11)))

print(tree.to_dict())  # {&#39;value&#39;: 10, &#39;left&#39;: {&#39;value&#39;: 7, &#39;left&#39;: None, &#39;right&#39;: {&#39;value&#39;: 9, &#39;left&#39;: None, &#39;right&#39;: None}}, &#39;right&#39;: {&#39;value&#39;: 13, &#39;left&#39;: {&#39;value&#39;: 11, &#39;left&#39;: None, &#39;right&#39;: None}, &#39;right&#39;: None}}


# Example 5
class BinaryTreeWithParent(BinaryTree):
    def __init__(self, value, left=None,
                 right=None, parent=None):
        super().__init__(value, left=left, right=right)
        self.parent = parent

    # Example 6
    def _traverse(self, key, value):
        if (isinstance(value, BinaryTreeWithParent) and
                key == &#39;parent&#39;):
            return value.value  # Prevent cycles
        else:
            return super()._traverse(key, value)


# Example 7
root = BinaryTreeWithParent(10)
root.left = BinaryTreeWithParent(7, parent=root)
root.left.right = BinaryTreeWithParent(9, parent=root.left)
print(root.to_dict())  # {&#39;value&#39;: 10, &#39;left&#39;: {&#39;value&#39;: 7, &#39;left&#39;: None, &#39;right&#39;: {&#39;value&#39;: 9, &#39;left&#39;: None, &#39;right&#39;: None, &#39;parent&#39;: 7}, &#39;parent&#39;: 10}, &#39;right&#39;: None, &#39;parent&#39;: None}


# Example 8
class NamedSubTree(ToDictMixin):
    def __init__(self, name, tree_with_parent):
        self.name = name
        self.tree_with_parent = tree_with_parent

my_tree = NamedSubTree(&#39;foobar&#39;, root.left.right)
print(f&#39;my_tree.to_dict(): {my_tree.to_dict()}&#39;)  # my_tree.to_dict(): {&#39;name&#39;: &#39;foobar&#39;, &#39;tree_with_parent&#39;: {&#39;value&#39;: 9, &#39;left&#39;: None, &#39;right&#39;: None, &#39;parent&#39;: 7}}


# Example 9
import json

class JsonMixin:
    @classmethod
    def from_json(cls, data):
        kwargs = json.loads(data)
        return cls(**kwargs)

    def to_json(self):
        return json.dumps(self.to_dict())


# Example 10
class DatacenterRack(ToDictMixin, JsonMixin):
    def __init__(self, switch=None, machines=None):
        self.switch = Switch(**switch)
        self.machines = [
            Machine(**kwargs) for kwargs in machines]

class Switch(ToDictMixin, JsonMixin):
    def __init__(self, ports=None, speed=None):
        self.ports = ports
        self.speed = speed

class Machine(ToDictMixin, JsonMixin):
    def __init__(self, cores=None, ram=None, disk=None):
        self.cores = cores
        self.ram = ram
        self.disk = disk


# Example 11
serialized = &quot;&quot;&quot;{
    &quot;switch&quot;: {&quot;ports&quot;: 5, &quot;speed&quot;: 1e9},
    &quot;machines&quot;: [
        {&quot;cores&quot;: 8, &quot;ram&quot;: 32e9, &quot;disk&quot;: 5e12},
        {&quot;cores&quot;: 4, &quot;ram&quot;: 16e9, &quot;disk&quot;: 1e12},
        {&quot;cores&quot;: 2, &quot;ram&quot;: 4e9, &quot;disk&quot;: 500e9}
    ]
}&quot;&quot;&quot;

deserialized = DatacenterRack.from_json(serialized)
roundtrip = deserialized.to_json()
assert json.loads(serialized) == json.loads(roundtrip)

</code></pre>
<h3 id="42-优先考虑用public属性表示应受保护的数据，不要用private属性表示"><a href="#42-优先考虑用public属性表示应受保护的数据，不要用private属性表示" class="headerlink" title="42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示"></a>42. 优先考虑用public属性表示应受保护的数据，不要用private属性表示</h3><pre><code class="python">class ApiClass:
    def __init__(self):
        self._value = 5

    def get(self):
        return self._value

class Child(ApiClass):
    def __init__(self):
        super().__init__()
        self._value = &#39;hello&#39;  # Conflicts

a = Child()
print(f&#39;{a.get()} and {a._value} should be different&#39;)  # hello and hello should be different


# Example 15
class ApiClass:
    def __init__(self):
        self.__value = 5       # Double underscore

    def get(self):
        return self.__value    # Double underscore

class Child(ApiClass):
    def __init__(self):
        super().__init__()
        self._value = &#39;hello&#39;  # OK!

a = Child()
print(f&#39;{a.get()} and {a._value} are different&#39;)  # 5 and hello are different
</code></pre>
<h3 id="43-自定义的容器类型应该从collections-abc继承"><a href="#43-自定义的容器类型应该从collections-abc继承" class="headerlink" title="43. 自定义的容器类型应该从collections.abc继承"></a>43. 自定义的容器类型应该从collections.abc继承</h3><pre><code class="python">from collections.abc import Sequence


class BinaryNode:
    def __init__(self, value, left=None, right=None):
        self.value = value
        self.left = left
        self.right = right


class IndexableNode(BinaryNode):
    def _traverse(self):
        if self.left is not None:
            yield from self.left._traverse()
        yield self
        if self.right is not None:
            yield from self.right._traverse()

    def __getitem__(self, index):
        for i, item in enumerate(self._traverse()):
            if i == index:
                return item.value
        raise IndexError(f&#39;Index {index} is out of range&#39;)


class SequenceNode(IndexableNode):
    def __len__(self):
        for count, _ in enumerate(self._traverse(), 1):
            pass
        return count


class BetterNode(SequenceNode, Sequence):
    pass


tree = BetterNode(
    10,
    left=BetterNode(
        5,
        left=BetterNode(2),
        right=BetterNode(
            6,
            right=BetterNode(7))),
    right=BetterNode(
        15,
        left=BetterNode(11))
)

print(&#39;Index of 7 is&#39;, tree.index(7))  # Index of 7 is 3
print(&#39;Count of 10 is&#39;, tree.count(10))  # Count of 10 is 1
</code></pre>
<h2 id="六-元类与属性"><a href="#六-元类与属性" class="headerlink" title="六. 元类与属性"></a>六. 元类与属性</h2><h3 id="44-用纯属性与修饰器取代旧式的setter与getter方法"><a href="#44-用纯属性与修饰器取代旧式的setter与getter方法" class="headerlink" title="44. 用纯属性与修饰器取代旧式的setter与getter方法"></a>44. 用纯属性与修饰器取代旧式的setter与getter方法</h3><pre><code class="python">class Resistor:
    def __init__(self, ohms):
        self.ohms = ohms
        self.voltage = 0
        self.current = 0


class MysteriousResistor(Resistor):
    @property
    def ohms(self):
        self.voltage = self._ohms * self.current
        return self._ohms

    @ohms.setter
    def ohms(self, ohms):
        self._ohms = ohms


# Example
r7 = MysteriousResistor(10)
r7.current = 0.01
print(f&#39;Before: {r7.voltage:.2f}&#39;)  # Before: 0.00
print(r7.ohms)  # 10
print(f&#39;After:  {r7.voltage:.2f}&#39;)  # After:  0.10

</code></pre>
<h3 id="45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码"><a href="#45-考虑用-property实现新的属性访问逻辑，不要急着重构原有的代码" class="headerlink" title="45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码"></a>45. 考虑用@property实现新的属性访问逻辑，不要急着重构原有的代码</h3><pre><code class="python"># Example 1
from datetime import datetime, timedelta

class Bucket:
    def __init__(self, period):
        self.period_delta = timedelta(seconds=period)
        self.reset_time = datetime.now()
        self.quota = 0

    def __repr__(self):
        return f&#39;Bucket(quota={self.quota})&#39;

bucket = Bucket(60)
print(bucket)  # Bucket(quota=0)


# Example 2
def fill(bucket, amount):
    now = datetime.now()
    if (now - bucket.reset_time) &gt; bucket.period_delta:
        bucket.quota = 0
        bucket.reset_time = now
    bucket.quota += amount


# Example 3
def deduct(bucket, amount):
    now = datetime.now()
    if (now - bucket.reset_time) &gt; bucket.period_delta:
        return False  # Bucket hasn&#39;t been filled this period
    if bucket.quota - amount &lt; 0:
        return False  # Bucket was filled, but not enough
    bucket.quota -= amount
    return True       # Bucket had enough, quota consumed


# Example 4
bucket = Bucket(60)
fill(bucket, 100)
print(bucket)  # Bucket(quota=100)


# Example 5
if deduct(bucket, 99):
    print(&#39;Had 99 quota&#39;)  # Had 99 quota
else:
    print(&#39;Not enough for 99 quota&#39;)
print(bucket)  # Bucket(quota=1)


# Example 6
if deduct(bucket, 3):
    print(&#39;Had 3 quota&#39;)
else:
    print(&#39;Not enough for 3 quota&#39;)  # Not enough for 3 quota
print(bucket)  # Bucket(quota=1)


# Example 7
class NewBucket:
    def __init__(self, period):
        self.period_delta = timedelta(seconds=period)
        self.reset_time = datetime.now()
        self.max_quota = 0
        self.quota_consumed = 0

    def __repr__(self):
        return (f&#39;NewBucket(max_quota={self.max_quota}, &#39;
                f&#39;quota_consumed={self.quota_consumed})&#39;)

    # Example 8
    @property
    def quota(self):
        return self.max_quota - self.quota_consumed

    # Example 9
    @quota.setter
    def quota(self, amount):
        delta = self.max_quota - amount
        if amount == 0:
            # Quota being reset for a new period
            self.quota_consumed = 0
            self.max_quota = 0
        elif delta &lt; 0:
            # Quota being filled during the period
            self.max_quota = amount + self.quota_consumed
        else:
            # Quota being consumed during the period
            self.quota_consumed = delta


# Example 10
bucket = NewBucket(60)
print(&#39;Initial&#39;, bucket)  # Initial NewBucket(max_quota=0, quota_consumed=0)
fill(bucket, 100)
print(&#39;Filled&#39;, bucket)  # Filled NewBucket(max_quota=100, quota_consumed=0)

if deduct(bucket, 99):
    print(&#39;Had 99 quota&#39;)  # Had 99 quota
else:
    print(&#39;Not enough for 99 quota&#39;)

print(&#39;Now&#39;, bucket)  # Now NewBucket(max_quota=100, quota_consumed=99)

if deduct(bucket, 3):
    print(&#39;Had 3 quota&#39;)  # Not enough for 3 quota
else:
    print(&#39;Not enough for 3 quota&#39;)

print(&#39;Still&#39;, bucket)  # Still NewBucket(max_quota=100, quota_consumed=99)


# Example 11
bucket = NewBucket(6000)
assert bucket.max_quota == 0
assert bucket.quota_consumed == 0
assert bucket.quota == 0

fill(bucket, 100)
assert bucket.max_quota == 100
assert bucket.quota_consumed == 0
assert bucket.quota == 100

assert deduct(bucket, 10)
assert bucket.max_quota == 100
assert bucket.quota_consumed == 10
assert bucket.quota == 90

assert deduct(bucket, 20)
assert bucket.max_quota == 100
assert bucket.quota_consumed == 30
assert bucket.quota == 70

fill(bucket, 50)
assert bucket.max_quota == 150
assert bucket.quota_consumed == 30
assert bucket.quota == 120

assert deduct(bucket, 40)
assert bucket.max_quota == 150
assert bucket.quota_consumed == 70
assert bucket.quota == 80

assert not deduct(bucket, 81)
assert bucket.max_quota == 150
assert bucket.quota_consumed == 70
assert bucket.quota == 80

bucket.reset_time += bucket.period_delta - timedelta(1)
assert bucket.quota == 80
assert not deduct(bucket, 79)

fill(bucket, 1)
assert bucket.quota == 1

</code></pre>
<h3 id="46-用描述符来改写需要复用的-property方法"><a href="#46-用描述符来改写需要复用的-property方法" class="headerlink" title="46. 用描述符来改写需要复用的@property方法"></a>46. 用描述符来改写需要复用的@property方法</h3><pre><code class="python">
# Example 1
class Homework:
    def __init__(self):
        self._grade = 0

    @property
    def grade(self):
        return self._grade

    @grade.setter
    def grade(self, value):
        if not (0 &lt;= value &lt;= 100):
            raise ValueError(
                &#39;Grade must be between 0 and 100&#39;)
        self._grade = value


# Example 2
galileo = Homework()
galileo.grade = 95
assert galileo.grade == 95


# Example 3
class Exam:
    def __init__(self):
        self._writing_grade = 0
        self._math_grade = 0

    @staticmethod
    def _check_grade(value):
        if not (0 &lt;= value &lt;= 100):
            raise ValueError(
                &#39;Grade must be between 0 and 100&#39;)


# Example 4
    @property
    def writing_grade(self):
        return self._writing_grade

    @writing_grade.setter
    def writing_grade(self, value):
        self._check_grade(value)
        self._writing_grade = value

    @property
    def math_grade(self):
        return self._math_grade

    @math_grade.setter
    def math_grade(self, value):
        self._check_grade(value)
        self._math_grade = value

galileo = Exam()
galileo.writing_grade = 85
galileo.math_grade = 99

assert galileo.writing_grade == 85
assert galileo.math_grade == 99


# Example 5
class Grade:
    def __get__(self, instance, instance_type):
        pass

    def __set__(self, instance, value):
        pass

class Exam:
    # Class attributes
    math_grade = Grade()
    writing_grade = Grade()
    science_grade = Grade()


# Example 6
exam = Exam()
exam.writing_grade = 40


# Example 7
Exam.__dict__[&#39;writing_grade&#39;].__set__(exam, 40)


# Example 8
exam.writing_grade


# Example 9
Exam.__dict__[&#39;writing_grade&#39;].__get__(exam, Exam)


# Example 10
class Grade:
    def __init__(self):
        self._value = 0

    def __get__(self, instance, instance_type):
        return self._value

    def __set__(self, instance, value):
        if not (0 &lt;= value &lt;= 100):
            raise ValueError(
                &#39;Grade must be between 0 and 100&#39;)
        self._value = value


# Example 11
class Exam:
    math_grade = Grade()
    writing_grade = Grade()
    science_grade = Grade()


first_exam = Exam()
first_exam.writing_grade = 82
first_exam.science_grade = 99
print(&#39;Writing&#39;, first_exam.writing_grade)  # Writing 82
print(&#39;Science&#39;, first_exam.science_grade)  # Science 99


# Example 12
second_exam = Exam()
second_exam.writing_grade = 75
print(f&#39;Second {second_exam.writing_grade} is right&#39;)  # Second 75 is right
print(f&#39;First  {first_exam.writing_grade} is wrong; should be 82&#39;)  # First  75 is wrong; should be 82


# Example 13
class Grade:
    def __init__(self):
        self._values = {}

    def __get__(self, instance, instance_type):
        if instance is None:
            return self
        return self._values.get(instance, 0)

    def __set__(self, instance, value):
        if not (0 &lt;= value &lt;= 100):
            raise ValueError(
                &#39;Grade must be between 0 and 100&#39;)
        self._values[instance] = value


# Example 14
from weakref import WeakKeyDictionary

class Grade:
    def __init__(self):
        self._values = WeakKeyDictionary()

    def __get__(self, instance, instance_type):
        if instance is None:
            return self
        return self._values.get(instance, 0)

    def __set__(self, instance, value):
        if not (0 &lt;= value &lt;= 100):
            raise ValueError(&#39;Grade must be between 0 and 100&#39;)
        self._values[instance] = value


# Example 15
class Exam:
    math_grade = Grade()
    writing_grade = Grade()
    science_grade = Grade()

first_exam = Exam()
first_exam.writing_grade = 82
second_exam = Exam()
second_exam.writing_grade = 75
print(f&#39;First  {first_exam.writing_grade} is right&#39;)  # First  82 is right
print(f&#39;Second {second_exam.writing_grade} is right&#39;)  # Second 75 is right

</code></pre>
<h3 id="47-针对惰性属性使用-getattr-、-getattribute-及-setattr"><a href="#47-针对惰性属性使用-getattr-、-getattribute-及-setattr" class="headerlink" title="47. 针对惰性属性使用__getattr__、__getattribute__及 __setattr__"></a>47. 针对惰性属性使用<code>__getattr__、__getattribute__及 __setattr__</code></h3><pre><code class="python">class DictionaryRecord:
    def __init__(self, data):
        self._data = data

    def __getattribute__(self, name):
        # Prevent weird interactions with isinstance() used
        # by example code harness.
        if name == &#39;__class__&#39;:
            return DictionaryRecord
        print(f&#39;* Called __getattribute__({name!r})&#39;)  # * Called __getattribute__(&#39;foo&#39;)
        data_dict = super().__getattribute__(&#39;_data&#39;)
        return data_dict[name]


data = DictionaryRecord({&#39;foo&#39;: 3})
print(&#39;foo: &#39;, data.foo)  # foo:  3
</code></pre>
<h3 id="48-用init-subclass验证子类写得是否正确"><a href="#48-用init-subclass验证子类写得是否正确" class="headerlink" title="48. 用init_subclass验证子类写得是否正确"></a>48. 用<strong>init_subclass</strong>验证子类写得是否正确</h3><pre><code class="python">class ValidatePolygon(type):
    def __new__(meta, name, bases, class_dict):
        # Only validate non-root classes
        if not class_dict.get(&#39;is_root&#39;):
            if class_dict[&#39;sides&#39;] &lt; 3:
                raise ValueError(&#39;Polygons need 3+ sides&#39;)
        return type.__new__(meta, name, bases, class_dict)


class Polygon(metaclass=ValidatePolygon):
    is_root = True
    sides = None  # Must be specified by subclasses


class ValidateFilledPolygon(ValidatePolygon):
    def __new__(meta, name, bases, class_dict):
        # Only validate non-root classes
        if not class_dict.get(&#39;is_root&#39;):
            if class_dict[&#39;color&#39;] not in (&#39;red&#39;, &#39;green&#39;):
                raise ValueError(&#39;Fill color must be supported&#39;)
        return super().__new__(meta, name, bases, class_dict)


class FilledPolygon(Polygon, metaclass=ValidateFilledPolygon):
    is_root = True
    color = None  # Must be specified by subclasses


# Example 9
class GreenPentagon(FilledPolygon):
    color = &#39;green&#39;
    sides = 5


greenie = GreenPentagon()
print(greenie, type(greenie))  # &lt;__main__.GreenPentagon object at 0x7fac8bccd8d0&gt; &lt;class &#39;__main__.GreenPentagon&#39;&gt;
print(Polygon, type(Polygon))  # &lt;class &#39;__main__.Polygon&#39;&gt; &lt;class &#39;__main__.ValidatePolygon&#39;&gt;
assert isinstance(greenie, Polygon)


# 下面是基本的菱形继承体系
class Top:
    def __init_subclass__(cls):
        super().__init_subclass__()
        print(f&#39;Top for {cls}&#39;)


class Left(Top):
    def __init_subclass__(cls):
        super().__init_subclass__()  #
        print(f&#39;Left for {cls}&#39;)


class Right(Top):
    def __init_subclass__(cls):
        super().__init_subclass__()
        print(f&#39;Right for {cls}&#39;)


class Bottom(Left, Right):
    def __init_subclass__(cls):
        super().__init_subclass__()
        print(f&#39;Bottom for {cls}&#39;)


&quot;&quot;&quot;打印结果如下：
Top for &lt;class &#39;__main__.Left&#39;&gt;
Top for &lt;class &#39;__main__.Right&#39;&gt;
Top for &lt;class &#39;__main__.Bottom&#39;&gt;
Right for &lt;class &#39;__main__.Bottom&#39;&gt;
Left for &lt;class &#39;__main__.Bottom&#39;&gt;&quot;&quot;&quot;
</code></pre>
<h3 id="49-用init-subclass记录现有的子类"><a href="#49-用init-subclass记录现有的子类" class="headerlink" title="49. 用init_subclass记录现有的子类"></a>49. 用<strong>init_subclass</strong>记录现有的子类</h3><pre><code class="python">import json
registry = {}


def register_class(target_class):
    registry[target_class.__name__] = target_class


def deserialize(data):
    params = json.loads(data)
    name = params[&#39;class&#39;]
    target_class = registry[name]
    return target_class(*params[&#39;args&#39;])


class BetterSerializable:
    def __init__(self, *args):
        self.args = args

    def serialize(self):
        return json.dumps({
            &#39;class&#39;: self.__class__.__name__,
            &#39;args&#39;: self.args,
        })

    def __repr__(self):
        name = self.__class__.__name__
        args_str = &#39;, &#39;.join(str(x) for x in self.args)
        return f&#39;{name}({args_str})&#39;


class BetterRegisteredSerializable(BetterSerializable):
    def __init_subclass__(cls):
        super().__init_subclass__()
        register_class(cls)


class Vector1D(BetterRegisteredSerializable):
    def __init__(self, magnitude):
        super().__init__(magnitude)
        self.magnitude = magnitude


before = Vector1D(6)
print(&#39;Before:&#39;, before)  # Before: Vector1D(6)
data = before.serialize()
print(&#39;Serialized:&#39;, data)  # Serialized: {&quot;class&quot;: &quot;Vector1D&quot;, &quot;args&quot;: [6]}
print(&#39;After:     &#39;, deserialize(data))  # After:      Vector1D(6)
</code></pre>
<h3 id="50-用-set-name-给类属性加注解"><a href="#50-用-set-name-给类属性加注解" class="headerlink" title="50. 用__set_name__给类属性加注解"></a>50. 用<code>__set_name__</code>给类属性加注解</h3><pre><code class="python">class Field:
    def __init__(self):
        self.name = None
        self.internal_name = None

    def __set_name__(self, owner, name):
        # Called on class creation for each descriptor
        self.name = name
        self.internal_name = &#39;_&#39; + name

    def __get__(self, instance, instance_type):
        if instance is None:
            return self
        return getattr(instance, self.internal_name, &#39;&#39;)

    def __set__(self, instance, value):
        setattr(instance, self.internal_name, value)


# Example
class FixedCustomer:
    first_name = Field()
    last_name = Field()
    prefix = Field()
    suffix = Field()


cust = FixedCustomer()
print(f&#39;Before: {cust.first_name!r} {cust.__dict__}&#39;)  # Before: &#39;&#39; {}
cust.first_name = &#39;Mersenne&#39;
print(f&#39;After:  {cust.first_name!r} {cust.__dict__}&#39;)  # After:  &#39;Mersenne&#39; {&#39;_first_name&#39;: &#39;Mersenne&#39;}
</code></pre>
<h3 id="51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"><a href="#51-优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类" class="headerlink" title="51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类"></a>51. 优先考虑通过类修饰器来提供可组合的扩充功能，不要使用元类</h3><pre><code class="python">import types
from functools import wraps

trace_types = (
    types.MethodType,
    types.FunctionType,
    types.BuiltinFunctionType,
    types.BuiltinMethodType,
    types.MethodDescriptorType,
    types.ClassMethodDescriptorType)


def trace_func(func):
    if hasattr(func, &#39;tracing&#39;):  # Only decorate once
        return func

    @wraps(func)
    def wrapper(*args, **kwargs):
        result = None
        try:
            result = func(*args, **kwargs)
            return result
        except Exception as e:
            result = e
            raise
        finally:
            print(f&#39;{func.__name__}({args!r}, {kwargs!r}) -&gt; {result!r}&#39;)

    wrapper.tracing = True
    return wrapper


# Example
def my_class_decorator(klass):
    klass.extra_param = &#39;hello&#39;
    return klass


@my_class_decorator
class MyClass:
    pass


print(MyClass)  # &lt;class &#39;__main__.MyClass&#39;&gt;
print(MyClass.extra_param)  # hello


# Example
def trace(klass):
    for key in dir(klass):
        value = getattr(klass, key)
        if isinstance(value, trace_types):
            wrapped = trace_func(value)
            setattr(klass, key, wrapped)
    return klass


# Example
@trace
class TraceDict(dict):
    pass

trace_dict = TraceDict([(&#39;hi&#39;, 1)])
trace_dict[&#39;there&#39;] = 2

try:
    trace_dict[&#39;does not exist&#39;]
except KeyError:
    pass  # Expected
else:
    assert False


# Example 11
class OtherMeta(type):
    pass


@trace
class TraceDict(dict, metaclass=OtherMeta):
    pass


trace_dict = TraceDict([(&#39;hi&#39;, 1)])
trace_dict[&#39;there&#39;] = 2
try:
    trace_dict[&#39;does not exist&#39;]
except KeyError:
    pass  # Expected
else:
    assert False


&quot;&quot;&quot;
&lt;class &#39;__main__.MyClass&#39;&gt;
hello
__new__((&lt;class &#39;__main__.TraceDict&#39;&gt;, [(&#39;hi&#39;, 1)]), {}) -&gt; {}
__getitem__(({&#39;hi&#39;: 1, &#39;there&#39;: 2}, &#39;does not exist&#39;), {}) -&gt; KeyError(&#39;does not exist&#39;)
__new__((&lt;class &#39;__main__.TraceDict&#39;&gt;, [(&#39;hi&#39;, 1)]), {}) -&gt; {}
__getitem__(({&#39;hi&#39;: 1, &#39;there&#39;: 2}, &#39;does not exist&#39;), {}) -&gt; KeyError(&#39;does not exist&#39;)
&quot;&quot;&quot;
</code></pre>
<h2 id="七-并发与并行"><a href="#七-并发与并行" class="headerlink" title="七. 并发与并行"></a>七. 并发与并行</h2><h3 id="52-用subprocess管理子进程"><a href="#52-用subprocess管理子进程" class="headerlink" title="52. 用subprocess管理子进程"></a>52. 用subprocess管理子进程</h3><pre><code class="python">
# Example 1
import subprocess
# Enable these lines to make this example work on Windows
# import os
# os.environ[&#39;COMSPEC&#39;] = &#39;powershell&#39;

result = subprocess.run(
    [&#39;echo&#39;, &#39;Hello from the child!&#39;],
    capture_output=True,
    # Enable this line to make this example work on Windows
    # shell=True,
    encoding=&#39;utf-8&#39;)

result.check_returncode()  # No exception means it exited cleanly
print(result.stdout)


# Example 2
# Use this line instead to make this example work on Windows
# proc = subprocess.Popen([&#39;sleep&#39;, &#39;1&#39;], shell=True)
proc = subprocess.Popen([&#39;sleep&#39;, &#39;1&#39;])
while proc.poll() is None:
    print(&#39;Working...&#39;)
    # Some time-consuming work here
    import time
    time.sleep(0.3)

print(&#39;Exit status&#39;, proc.poll())


# Example 3
import time

start = time.time()
sleep_procs = []
for _ in range(10):
    # Use this line instead to make this example work on Windows
    # proc = subprocess.Popen([&#39;sleep&#39;, &#39;1&#39;], shell=True)
    proc = subprocess.Popen([&#39;sleep&#39;, &#39;1&#39;])
    sleep_procs.append(proc)


# Example 4
for proc in sleep_procs:
    proc.communicate()

end = time.time()
delta = end - start
print(f&#39;Finished in {delta:.3} seconds&#39;)


# Example 5
import os
# On Windows, after installing OpenSSL, you may need to
# alias it in your PowerShell path with a command like:
# $env:path = $env:path + &quot;;C:\Program Files\OpenSSL-Win64\bin&quot;

def run_encrypt(data):
    env = os.environ.copy()
    env[&#39;password&#39;] = &#39;zf7ShyBhZOraQDdE/FiZpm/m/8f9X+M1&#39;
    proc = subprocess.Popen(
        [&#39;openssl&#39;, &#39;enc&#39;, &#39;-des3&#39;, &#39;-pass&#39;, &#39;env:password&#39;],
        env=env,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE)
    proc.stdin.write(data)
    proc.stdin.flush()  # Ensure that the child gets input
    return proc


# Example 6
procs = []
for _ in range(3):
    data = os.urandom(10)
    proc = run_encrypt(data)
    procs.append(proc)


# Example 7
for proc in procs:
    out, _ = proc.communicate()
    print(f&#39;out[-10:]  {out[-10:]}&#39;)


# Example 8
def run_hash(input_stdin):
    return subprocess.Popen(
        [&#39;openssl&#39;, &#39;dgst&#39;, &#39;-whirlpool&#39;, &#39;-binary&#39;],
        stdin=input_stdin,
        stdout=subprocess.PIPE)


# Example 9
encrypt_procs = []
hash_procs = []
for _ in range(3):
    data = os.urandom(100)

    encrypt_proc = run_encrypt(data)
    encrypt_procs.append(encrypt_proc)

    hash_proc = run_hash(encrypt_proc.stdout)
    hash_procs.append(hash_proc)

    # Ensure that the child consumes the input stream and
    # the communicate() method doesn&#39;t inadvertently steal
    # input from the child. Also lets SIGPIPE propagate to
    # the upstream process if the downstream process dies.
    encrypt_proc.stdout.close()
    encrypt_proc.stdout = None


# Example 10
for proc in encrypt_procs:
    proc.communicate()
    assert proc.returncode == 0

for proc in hash_procs:
    out, _ = proc.communicate()
    print(out[-10:])
    assert proc.returncode == 0


# Example 11
# Use this line instead to make this example work on Windows
# proc = subprocess.Popen([&#39;sleep&#39;, &#39;10&#39;], shell=True)
proc = subprocess.Popen([&#39;sleep&#39;, &#39;10&#39;])
try:
    proc.communicate(timeout=0.1)
except subprocess.TimeoutExpired:
    proc.terminate()
    proc.wait()

print(&#39;Exit status&#39;, proc.poll())

</code></pre>
<h3 id="53-可以用线程执行阻塞式I-O，但不要用它做并行计算"><a href="#53-可以用线程执行阻塞式I-O，但不要用它做并行计算" class="headerlink" title="53. 可以用线程执行阻塞式I/O，但不要用它做并行计算"></a>53. 可以用线程执行阻塞式I/O，但不要用它做并行计算</h3><pre><code class="python">
# Example 1
def factorize(number):
    for i in range(1, number + 1):
        if number % i == 0:
            yield i


# Example 2
import time

numbers = [2139079, 1214759, 1516637, 1852285]
start = time.time()

for number in numbers:
    list(factorize(number))

end = time.time()
delta = end - start
print(f&#39;Took {delta:.4f} seconds&#39;)  # Took 0.4613 seconds


# Example 3
from threading import Thread


class FactorizeThread(Thread):
    def __init__(self, number):
        super().__init__()
        self.number = number

    def run(self):
        self.factors = list(factorize(self.number))


# Example 4
start = time.time()

threads = []
for number in numbers:
    thread = FactorizeThread(number)
    thread.start()
    threads.append(thread)


# Example 5
for thread in threads:
    thread.join()

end = time.time()
delta = end - start
print(f&#39;Took {delta:.3f} seconds&#39;)  # Took 0.448 seconds


# Example 6
import select
import socket

def slow_systemcall():
    select.select([socket.socket()], [], [], 0.1)


# Example 7
start = time.time()

for _ in range(5):
    slow_systemcall()

end = time.time()
delta = end - start
print(f&#39;Took {delta:.3f} seconds...&#39;)  # Took 0.517 seconds...


# Example 8
start = time.time()

threads = []
for _ in range(5):
    thread = Thread(target=slow_systemcall)
    thread.start()
    threads.append(thread)


# Example 9
def compute_helicopter_location(index):
    pass


for i in range(5):
    compute_helicopter_location(i)

for thread in threads:
    thread.join()

end = time.time()
delta = end - start
print(f&#39;Took {delta:.3f} seconds&#39;)  # Took 0.102 seconds

</code></pre>
<h3 id="54-利用Lock防止多个线程争用同一份数据"><a href="#54-利用Lock防止多个线程争用同一份数据" class="headerlink" title="54. 利用Lock防止多个线程争用同一份数据"></a>54. 利用Lock防止多个线程争用同一份数据</h3><pre><code class="python">
# Example 1
class Counter:
    def __init__(self):
        self.count = 0

    def increment(self, offset):
        self.count += offset


# Example 2
def worker(sensor_index, how_many, counter):
    # I have a barrier in here so the workers synchronize
    # when they start counting, otherwise it&#39;s hard to get a race
    # because the overhead of starting a thread is high.
    BARRIER.wait()
    for _ in range(how_many):
        # Read from the sensor
        # Nothing actually happens here, but this is where
        # the blocking I/O would go.
        counter.increment(1)


# Example 3
from threading import Barrier
BARRIER = Barrier(5)
from threading import Thread

how_many = 10**5
counter = Counter()

threads = []
for i in range(5):
    thread = Thread(target=worker,
                    args=(i, how_many, counter))
    threads.append(thread)
    thread.start()

for thread in threads:
    thread.join()

expected = how_many * 5
found = counter.count
print(f&#39;Counter should be {expected}, got {found}&#39;)  # Counter should be 500000, got 325923


# Example 4
counter.count += 1


# Example 5
value = getattr(counter, &#39;count&#39;)
result = value + 1
setattr(counter, &#39;count&#39;, result)


# Example 6
# Running in Thread A
value_a = getattr(counter, &#39;count&#39;)
# Context switch to Thread B
value_b = getattr(counter, &#39;count&#39;)
result_b = value_b + 1
setattr(counter, &#39;count&#39;, result_b)
# Context switch back to Thread A
result_a = value_a + 1
setattr(counter, &#39;count&#39;, result_a)


# Example 7
from threading import Lock

class LockingCounter:
    def __init__(self):
        self.lock = Lock()
        self.count = 0

    def increment(self, offset):
        with self.lock:
            self.count += offset


# Example 8
BARRIER = Barrier(5)
counter = LockingCounter()

for i in range(5):
    thread = Thread(target=worker,
                    args=(i, how_many, counter))
    threads.append(thread)
    thread.start()

for thread in threads:
    thread.join()

expected = how_many * 5
found = counter.count
print(f&#39;Counter should be {expected}, got {found}&#39;)  # Counter should be 500000, got 500000

</code></pre>
<h3 id="55-用Queue来协调各线程之间的工作进度"><a href="#55-用Queue来协调各线程之间的工作进度" class="headerlink" title="55. 用Queue来协调各线程之间的工作进度"></a>55. 用Queue来协调各线程之间的工作进度</h3><pre><code class="python">
# Example 1
def download(item):
    return item

def resize(item):
    return item

def upload(item):
    return item


# Example 2
from collections import deque
from threading import Lock

class MyQueue:
    def __init__(self):
        self.items = deque()
        self.lock = Lock()


# Example 3
    def put(self, item):
        with self.lock:
            self.items.append(item)


# Example 4
    def get(self):
        with self.lock:
            return self.items.popleft()


# Example 5
from threading import Thread
import time

class Worker(Thread):
    def __init__(self, func, in_queue, out_queue):
        super().__init__()
        self.func = func
        self.in_queue = in_queue
        self.out_queue = out_queue
        self.polled_count = 0
        self.work_done = 0


# Example 6
    def run(self):
        while True:
            self.polled_count += 1
            try:
                item = self.in_queue.get()
            except IndexError:
                time.sleep(0.01)  # No work to do
            except AttributeError:
                # The magic exit signal
                return
            else:
                result = self.func(item)
                self.out_queue.put(result)
                self.work_done += 1


# Example 7
download_queue = MyQueue()
resize_queue = MyQueue()
upload_queue = MyQueue()
done_queue = MyQueue()
threads = [
    Worker(download, download_queue, resize_queue),
    Worker(resize, resize_queue, upload_queue),
    Worker(upload, upload_queue, done_queue),
]


# Example 8
for thread in threads:
    thread.start()

for _ in range(1000):
    download_queue.put(object())


# Example 9
while len(done_queue.items) &lt; 1000:
    # Do something useful while waiting
    time.sleep(0.1)
# Stop all the threads by causing an exception in their
# run methods.
for thread in threads:
    thread.in_queue = None
    thread.join()


# Example 10
processed = len(done_queue.items)
polled = sum(t.polled_count for t in threads)
print(f&#39;Processed {processed} items after &#39;
      f&#39;polling {polled} times&#39;)


# Example 11
from queue import Queue

my_queue = Queue()

def consumer():
    print(&#39;Consumer waiting&#39;)
    my_queue.get()              # Runs after put() below
    print(&#39;Consumer done&#39;)

thread = Thread(target=consumer)
thread.start()


# Example 12
print(&#39;Producer putting&#39;)
my_queue.put(object())          # Runs before get() above
print(&#39;Producer done&#39;)
thread.join()


# Example 13
my_queue = Queue(1)             # Buffer size of 1

def consumer():
    time.sleep(0.1)             # Wait
    my_queue.get()              # Runs second
    print(&#39;Consumer got 1&#39;)
    my_queue.get()              # Runs fourth
    print(&#39;Consumer got 2&#39;)
    print(&#39;Consumer done&#39;)

thread = Thread(target=consumer)
thread.start()


# Example 14
my_queue.put(object())          # Runs first
print(&#39;Producer put 1&#39;)
my_queue.put(object())          # Runs third
print(&#39;Producer put 2&#39;)
print(&#39;Producer done&#39;)
thread.join()


# Example 15
in_queue = Queue()

def consumer():
    print(&#39;Consumer waiting&#39;)
    work = in_queue.get()       # Done second
    print(&#39;Consumer working&#39;)
    # Doing work
    print(&#39;Consumer done&#39;)
    in_queue.task_done()        # Done third

thread = Thread(target=consumer)
thread.start()


# Example 16
print(&#39;Producer putting&#39;)
in_queue.put(object())         # Done first
print(&#39;Producer waiting&#39;)
in_queue.join()                # Done fourth
print(&#39;Producer done&#39;)
thread.join()


# Example 17
class ClosableQueue(Queue):
    SENTINEL = object()

    def close(self):
        self.put(self.SENTINEL)


# Example 18
    def __iter__(self):
        while True:
            item = self.get()
            try:
                if item is self.SENTINEL:
                    return  # Cause the thread to exit
                yield item
            finally:
                self.task_done()


# Example 19
class StoppableWorker(Thread):
    def __init__(self, func, in_queue, out_queue):
        super().__init__()
        self.func = func
        self.in_queue = in_queue
        self.out_queue = out_queue

    def run(self):
        for item in self.in_queue:
            result = self.func(item)
            self.out_queue.put(result)


# Example 20
download_queue = ClosableQueue()
resize_queue = ClosableQueue()
upload_queue = ClosableQueue()
done_queue = ClosableQueue()
threads = [
    StoppableWorker(download, download_queue, resize_queue),
    StoppableWorker(resize, resize_queue, upload_queue),
    StoppableWorker(upload, upload_queue, done_queue),
]


# Example 21
for thread in threads:
    thread.start()

for _ in range(1000):
    download_queue.put(object())

download_queue.close()


# Example 22
download_queue.join()
resize_queue.close()
resize_queue.join()
upload_queue.close()
upload_queue.join()
print(done_queue.qsize(), &#39;items finished&#39;)

for thread in threads:
    thread.join()


# Example 23
def start_threads(count, *args):
    threads = [StoppableWorker(*args) for _ in range(count)]
    for thread in threads:
        thread.start()
    return threads

def stop_threads(closable_queue, threads):
    for _ in threads:
        closable_queue.close()

    closable_queue.join()

    for thread in threads:
        thread.join()


# Example 24
download_queue = ClosableQueue()
resize_queue = ClosableQueue()
upload_queue = ClosableQueue()
done_queue = ClosableQueue()

download_threads = start_threads(
    3, download, download_queue, resize_queue)
resize_threads = start_threads(
    4, resize, resize_queue, upload_queue)
upload_threads = start_threads(
    5, upload, upload_queue, done_queue)

for _ in range(1000):
    download_queue.put(object())

stop_threads(download_queue, download_threads)
stop_threads(resize_queue, resize_threads)
stop_threads(upload_queue, upload_threads)

print(done_queue.qsize(), &#39;items finished&#39;)

</code></pre>
<h3 id="56-学会判断什么场合必须做并发"><a href="#56-学会判断什么场合必须做并发" class="headerlink" title="56. 学会判断什么场合必须做并发"></a>56. 学会判断什么场合必须做并发</h3><pre><code class="python">
# Example 1
ALIVE = &#39;*&#39;
EMPTY = &#39;-&#39;


# Example 2
class Grid:
    def __init__(self, height, width):
        self.height = height
        self.width = width
        self.rows = []
        for _ in range(self.height):
            self.rows.append([EMPTY] * self.width)

    def get(self, y, x):
        return self.rows[y % self.height][x % self.width]

    def set(self, y, x, state):
        self.rows[y % self.height][x % self.width] = state

    def __str__(self):
        output = &#39;&#39;
        for row in self.rows:
            for cell in row:
                output += cell
            output += &#39;\n&#39;
        return output


# Example 3
grid = Grid(5, 9)
grid.set(0, 3, ALIVE)
grid.set(1, 4, ALIVE)
grid.set(2, 2, ALIVE)
grid.set(2, 3, ALIVE)
grid.set(2, 4, ALIVE)
print(grid)
&quot;&quot;&quot;
---*-----
----*----
--***----
---------
---------
&quot;&quot;&quot;


# Example 4
def count_neighbors(y, x, get):
    n_ = get(y - 1, x + 0)  # North
    ne = get(y - 1, x + 1)  # Northeast
    e_ = get(y + 0, x + 1)  # East
    se = get(y + 1, x + 1)  # Southeast
    s_ = get(y + 1, x + 0)  # South
    sw = get(y + 1, x - 1)  # Southwest
    w_ = get(y + 0, x - 1)  # West
    nw = get(y - 1, x - 1)  # Northwest
    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]
    count = 0
    for state in neighbor_states:
        if state == ALIVE:
            count += 1
    return count


alive = {(9, 5), (9, 6)}
seen = set()

def fake_get(y, x):
    position = (y, x)
    seen.add(position)
    return ALIVE if position in alive else EMPTY

count = count_neighbors(10, 5, fake_get)
assert count == 2

expected_seen = {
    (9, 5),  (9, 6),  (10, 6), (11, 6),
    (11, 5), (11, 4), (10, 4), (9, 4)
}
assert seen == expected_seen


# Example 5
def game_logic(state, neighbors):
    if state == ALIVE:
        if neighbors &lt; 2:
            return EMPTY     # Die: Too few
        elif neighbors &gt; 3:
            return EMPTY     # Die: Too many
    else:
        if neighbors == 3:
            return ALIVE     # Regenerate
    return state

assert game_logic(ALIVE, 0) == EMPTY
assert game_logic(ALIVE, 1) == EMPTY
assert game_logic(ALIVE, 2) == ALIVE
assert game_logic(ALIVE, 3) == ALIVE
assert game_logic(ALIVE, 4) == EMPTY
assert game_logic(EMPTY, 0) == EMPTY
assert game_logic(EMPTY, 1) == EMPTY
assert game_logic(EMPTY, 2) == EMPTY
assert game_logic(EMPTY, 3) == ALIVE
assert game_logic(EMPTY, 4) == EMPTY


# Example 6
def step_cell(y, x, get, set):
    state = get(y, x)
    neighbors = count_neighbors(y, x, get)
    next_state = game_logic(state, neighbors)
    set(y, x, next_state)

alive = {(10, 5), (9, 5), (9, 6)}
new_state = None

def fake_get(y, x):
    return ALIVE if (y, x) in alive else EMPTY

def fake_set(y, x, state):
    global new_state
    new_state = state

# Stay alive
step_cell(10, 5, fake_get, fake_set)
assert new_state == ALIVE

# Stay dead
alive.remove((10, 5))
step_cell(10, 5, fake_get, fake_set)
assert new_state == EMPTY

# Regenerate
alive.add((10, 6))
step_cell(10, 5, fake_get, fake_set)
assert new_state == ALIVE


# Example 7
def simulate(grid):
    next_grid = Grid(grid.height, grid.width)
    for y in range(grid.height):
        for x in range(grid.width):
            step_cell(y, x, grid.get, next_grid.set)
    return next_grid


# Example 8
class ColumnPrinter:
    def __init__(self):
        self.columns = []

    def append(self, data):
        self.columns.append(data)

    def __str__(self):
        row_count = 1
        for data in self.columns:
            row_count = max(
                row_count, len(data.splitlines()) + 1)

        rows = [&#39;&#39;] * row_count
        for j in range(row_count):
            for i, data in enumerate(self.columns):
                line = data.splitlines()[max(0, j - 1)]
                if j == 0:
                    padding = &#39; &#39; * (len(line) // 2)
                    rows[j] += padding + str(i) + padding
                else:
                    rows[j] += line

                if (i + 1) &lt; len(self.columns):
                    rows[j] += &#39; | &#39;

        return &#39;\n&#39;.join(rows)

columns = ColumnPrinter()
for i in range(5):
    columns.append(str(grid))
    grid = simulate(grid)

print(columns)
&quot;&quot;&quot;
    0     |     1     |     2     |     3     |     4    
---*----- | --------- | --------- | --------- | ---------
----*---- | --*-*---- | ----*---- | ---*----- | ----*----
--***---- | ---**---- | --*-*---- | ----**--- | -----*---
--------- | ---*----- | ---**---- | ---**---- | ---***---
--------- | --------- | --------- | --------- | ---------
&quot;&quot;&quot;


</code></pre>
<h3 id="57-不要在每次fan-out时都新建一批Thread实例"><a href="#57-不要在每次fan-out时都新建一批Thread实例" class="headerlink" title="57. 不要在每次fan-out时都新建一批Thread实例"></a>57. 不要在每次fan-out时都新建一批Thread实例</h3><pre><code class="python">

# Example 1
from threading import Lock

ALIVE = &#39;*&#39;
EMPTY = &#39;-&#39;

class Grid:
    def __init__(self, height, width):
        self.height = height
        self.width = width
        self.rows = []
        for _ in range(self.height):
            self.rows.append([EMPTY] * self.width)

    def get(self, y, x):
        return self.rows[y % self.height][x % self.width]

    def set(self, y, x, state):
        self.rows[y % self.height][x % self.width] = state

    def __str__(self):
        output = &#39;&#39;
        for row in self.rows:
            for cell in row:
                output += cell
            output += &#39;\n&#39;
        return output

class LockingGrid(Grid):
    def __init__(self, height, width):
        super().__init__(height, width)
        self.lock = Lock()

    def __str__(self):
        with self.lock:
            return super().__str__()

    def get(self, y, x):
        with self.lock:
            return super().get(y, x)

    def set(self, y, x, state):
        with self.lock:
            return super().set(y, x, state)


# Example 2
from threading import Thread

def count_neighbors(y, x, get):
    n_ = get(y - 1, x + 0)  # North
    ne = get(y - 1, x + 1)  # Northeast
    e_ = get(y + 0, x + 1)  # East
    se = get(y + 1, x + 1)  # Southeast
    s_ = get(y + 1, x + 0)  # South
    sw = get(y + 1, x - 1)  # Southwest
    w_ = get(y + 0, x - 1)  # West
    nw = get(y - 1, x - 1)  # Northwest
    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]
    count = 0
    for state in neighbor_states:
        if state == ALIVE:
            count += 1
    return count

# def game_logic(state, neighbors):
#     # Do some blocking input/output in here:
#     data = my_socket.recv(100)

def game_logic(state, neighbors):
    if state == ALIVE:
        if neighbors &lt; 2:
            return EMPTY     # Die: Too few
        elif neighbors &gt; 3:
            return EMPTY     # Die: Too many
    else:
        if neighbors == 3:
            return ALIVE     # Regenerate
    return state

def step_cell(y, x, get, set):
    state = get(y, x)
    neighbors = count_neighbors(y, x, get)
    next_state = game_logic(state, neighbors)
    set(y, x, next_state)

def simulate_threaded(grid):
    next_grid = LockingGrid(grid.height, grid.width)

    threads = []
    for y in range(grid.height):
        for x in range(grid.width):
            args = (y, x, grid.get, next_grid.set)
            thread = Thread(target=step_cell, args=args)
            thread.start()  # Fan out
            threads.append(thread)

    for thread in threads:
        thread.join()       # Fan in

    return next_grid


# Example 3
class ColumnPrinter:
    def __init__(self):
        self.columns = []

    def append(self, data):
        self.columns.append(data)

    def __str__(self):
        row_count = 1
        for data in self.columns:
            row_count = max(
                row_count, len(data.splitlines()) + 1)

        rows = [&#39;&#39;] * row_count
        for j in range(row_count):
            for i, data in enumerate(self.columns):
                line = data.splitlines()[max(0, j - 1)]
                if j == 0:
                    padding = &#39; &#39; * (len(line) // 2)
                    rows[j] += padding + str(i) + padding
                else:
                    rows[j] += line

                if (i + 1) &lt; len(self.columns):
                    rows[j] += &#39; | &#39;

        return &#39;\n&#39;.join(rows)

grid = LockingGrid(5, 9)            # Changed
grid.set(0, 3, ALIVE)
grid.set(1, 4, ALIVE)
grid.set(2, 2, ALIVE)
grid.set(2, 3, ALIVE)
grid.set(2, 4, ALIVE)

columns = ColumnPrinter()
for i in range(5):
    columns.append(str(grid))
    grid = simulate_threaded(grid)  # Changed

print(columns)


# Example 4
# def game_logic(state, neighbors):
#     raise OSError(&#39;Problem with I/O&#39;)


# Example 5
import contextlib
import io

fake_stderr = io.StringIO()
with contextlib.redirect_stderr(fake_stderr):
    thread = Thread(target=game_logic, args=(ALIVE, 3))
    thread.start()
    thread.join()

print(fake_stderr.getvalue())

</code></pre>
<h3 id="58-学会正确地重构代码，以便用Queue做并发"><a href="#58-学会正确地重构代码，以便用Queue做并发" class="headerlink" title="58. 学会正确地重构代码，以便用Queue做并发"></a>58. 学会正确地重构代码，以便用Queue做并发</h3><p>把队列与一定数量的线程搭配起来，可以高效的实现fan-out（分派）与fan-in（归集）。</p>
<h3 id="59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"><a href="#59-如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现" class="headerlink" title="59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现"></a>59. 如果必须用线程做并发，那就考虑通过ThreadPoolExecutor实现</h3><pre><code class="python"># Example 1
ALIVE = &#39;*&#39;
EMPTY = &#39;-&#39;

class Grid:
    def __init__(self, height, width):
        self.height = height
        self.width = width
        self.rows = []
        for _ in range(self.height):
            self.rows.append([EMPTY] * self.width)

    def get(self, y, x):
        return self.rows[y % self.height][x % self.width]

    def set(self, y, x, state):
        self.rows[y % self.height][x % self.width] = state

    def __str__(self):
        output = &#39;&#39;
        for row in self.rows:
            for cell in row:
                output += cell
            output += &#39;\n&#39;
        return output

from threading import Lock

class LockingGrid(Grid):
    def __init__(self, height, width):
        super().__init__(height, width)
        self.lock = Lock()

    def __str__(self):
        with self.lock:
            return super().__str__()

    def get(self, y, x):
        with self.lock:
            return super().get(y, x)

    def set(self, y, x, state):
        with self.lock:
            return super().set(y, x, state)

def count_neighbors(y, x, get):
    n_ = get(y - 1, x + 0)  # North
    ne = get(y - 1, x + 1)  # Northeast
    e_ = get(y + 0, x + 1)  # East
    se = get(y + 1, x + 1)  # Southeast
    s_ = get(y + 1, x + 0)  # South
    sw = get(y + 1, x - 1)  # Southwest
    w_ = get(y + 0, x - 1)  # West
    nw = get(y - 1, x - 1)  # Northwest
    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]
    count = 0
    for state in neighbor_states:
        if state == ALIVE:
            count += 1
    return count

# def game_logic(state, neighbors):
#     # Do some blocking input/output in here:
#     data = my_socket.recv(100)

def game_logic(state, neighbors):
    if state == ALIVE:
        if neighbors &lt; 2:
            return EMPTY     # Die: Too few
        elif neighbors &gt; 3:
            return EMPTY     # Die: Too many
    else:
        if neighbors == 3:
            return ALIVE     # Regenerate
    return state

def step_cell(y, x, get, set):
    state = get(y, x)
    neighbors = count_neighbors(y, x, get)
    next_state = game_logic(state, neighbors)
    set(y, x, next_state)


# Example 2
from concurrent.futures import ThreadPoolExecutor

def simulate_pool(pool, grid):
    next_grid = LockingGrid(grid.height, grid.width)

    futures = []
    for y in range(grid.height):
        for x in range(grid.width):
            args = (y, x, grid.get, next_grid.set)
            future = pool.submit(step_cell, *args)  # Fan out
            futures.append(future)

    for future in futures:
        future.result()                             # Fan in

    return next_grid


# Example 3
class ColumnPrinter:
    def __init__(self):
        self.columns = []

    def append(self, data):
        self.columns.append(data)

    def __str__(self):
        row_count = 1
        for data in self.columns:
            row_count = max(
                row_count, len(data.splitlines()) + 1)

        rows = [&#39;&#39;] * row_count
        for j in range(row_count):
            for i, data in enumerate(self.columns):
                line = data.splitlines()[max(0, j - 1)]
                if j == 0:
                    padding = &#39; &#39; * (len(line) // 2)
                    rows[j] += padding + str(i) + padding
                else:
                    rows[j] += line

                if (i + 1) &lt; len(self.columns):
                    rows[j] += &#39; | &#39;

        return &#39;\n&#39;.join(rows)

grid = LockingGrid(5, 9)
grid.set(0, 3, ALIVE)
grid.set(1, 4, ALIVE)
grid.set(2, 2, ALIVE)
grid.set(2, 3, ALIVE)
grid.set(2, 4, ALIVE)

columns = ColumnPrinter()
with ThreadPoolExecutor(max_workers=10) as pool:
    for i in range(5):
        columns.append(str(grid))
        grid = simulate_pool(pool, grid)

print(columns)
</code></pre>
<h3 id="60-用协程实现高并发的I-O"><a href="#60-用协程实现高并发的I-O" class="headerlink" title="60. 用协程实现高并发的I/O"></a>60. 用协程实现高并发的I/O</h3><pre><code class="python">import logging
# Example 1
ALIVE = &#39;*&#39;
EMPTY = &#39;-&#39;

class Grid:
    def __init__(self, height, width):
        self.height = height
        self.width = width
        self.rows = []
        for _ in range(self.height):
            self.rows.append([EMPTY] * self.width)

    def get(self, y, x):
        return self.rows[y % self.height][x % self.width]

    def set(self, y, x, state):
        self.rows[y % self.height][x % self.width] = state

    def __str__(self):
        output = &#39;&#39;
        for row in self.rows:
            for cell in row:
                output += cell
            output += &#39;\n&#39;
        return output

def count_neighbors(y, x, get):
    n_ = get(y - 1, x + 0)  # North
    ne = get(y - 1, x + 1)  # Northeast
    e_ = get(y + 0, x + 1)  # East
    se = get(y + 1, x + 1)  # Southeast
    s_ = get(y + 1, x + 0)  # South
    sw = get(y + 1, x - 1)  # Southwest
    w_ = get(y + 0, x - 1)  # West
    nw = get(y - 1, x - 1)  # Northwest
    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]
    count = 0
    for state in neighbor_states:
        if state == ALIVE:
            count += 1
    return count

async def game_logic(state, neighbors):
    if state == ALIVE:
        if neighbors &lt; 2:
            return EMPTY     # Die: Too few
        elif neighbors &gt; 3:
            return EMPTY     # Die: Too many
    else:
        if neighbors == 3:
            return ALIVE     # Regenerate
    return state


# Example 2
async def step_cell(y, x, get, set):
    state = get(y, x)
    neighbors = count_neighbors(y, x, get)
    next_state = await game_logic(state, neighbors)
    set(y, x, next_state)


# Example 3
import asyncio

async def simulate(grid):
    next_grid = Grid(grid.height, grid.width)

    tasks = []
    for y in range(grid.height):
        for x in range(grid.width):
            task = step_cell(
                y, x, grid.get, next_grid.set)      # Fan out
            tasks.append(task)

    await asyncio.gather(*tasks)                    # Fan in

    return next_grid


# Example 4
class ColumnPrinter:
    def __init__(self):
        self.columns = []

    def append(self, data):
        self.columns.append(data)

    def __str__(self):
        row_count = 1
        for data in self.columns:
            row_count = max(
                row_count, len(data.splitlines()) + 1)

        rows = [&#39;&#39;] * row_count
        for j in range(row_count):
            for i, data in enumerate(self.columns):
                line = data.splitlines()[max(0, j - 1)]
                if j == 0:
                    padding = &#39; &#39; * (len(line) // 2)
                    rows[j] += padding + str(i) + padding
                else:
                    rows[j] += line

                if (i + 1) &lt; len(self.columns):
                    rows[j] += &#39; | &#39;

        return &#39;\n&#39;.join(rows)


grid = Grid(5, 9)
grid.set(0, 3, ALIVE)
grid.set(1, 4, ALIVE)
grid.set(2, 2, ALIVE)
grid.set(2, 3, ALIVE)
grid.set(2, 4, ALIVE)

columns = ColumnPrinter()
for i in range(5):
    columns.append(str(grid))
    grid = asyncio.run(simulate(grid))   # Run the event loop

print(columns)


# Example 6
async def count_neighbors(y, x, get):
    n_ = get(y - 1, x + 0)  # North
    ne = get(y - 1, x + 1)  # Northeast
    e_ = get(y + 0, x + 1)  # East
    se = get(y + 1, x + 1)  # Southeast
    s_ = get(y + 1, x + 0)  # South
    sw = get(y + 1, x - 1)  # Southwest
    w_ = get(y + 0, x - 1)  # West
    nw = get(y - 1, x - 1)  # Northwest
    neighbor_states = [n_, ne, e_, se, s_, sw, w_, nw]
    count = 0
    for state in neighbor_states:
        if state == ALIVE:
            count += 1
    return count

async def step_cell(y, x, get, set):
    state = get(y, x)
    neighbors = await count_neighbors(y, x, get)
    next_state = await game_logic(state, neighbors)
    set(y, x, next_state)

async def game_logic(state, neighbors):
    if state == ALIVE:
        if neighbors &lt; 2:
            return EMPTY     # Die: Too few
        elif neighbors &gt; 3:
            return EMPTY     # Die: Too many
    else:
        if neighbors == 3:
            return ALIVE     # Regenerate
    return state

grid = Grid(5, 9)
grid.set(0, 3, ALIVE)
grid.set(1, 4, ALIVE)
grid.set(2, 2, ALIVE)
grid.set(2, 3, ALIVE)
grid.set(2, 4, ALIVE)

columns = ColumnPrinter()
for i in range(5):
    columns.append(str(grid))
    grid = asyncio.run(simulate(grid))

print(columns)

</code></pre>
<h3 id="61-学会用asyncio改写那些通过线程实现的I-O"><a href="#61-学会用asyncio改写那些通过线程实现的I-O" class="headerlink" title="61. 学会用asyncio改写那些通过线程实现的I/O"></a>61. 学会用asyncio改写那些通过线程实现的I/O</h3><pre><code class="python">import logging
# Example 1
class EOFError(Exception):
    pass

class ConnectionBase:
    def __init__(self, connection):
        self.connection = connection
        self.file = connection.makefile(&#39;rb&#39;)

    def send(self, command):
        line = command + &#39;\n&#39;
        data = line.encode()
        self.connection.send(data)

    def receive(self):
        line = self.file.readline()
        if not line:
            raise EOFError(&#39;Connection closed&#39;)
        return line[:-1].decode()


# Example 2
import random

WARMER = &#39;Warmer&#39;
COLDER = &#39;Colder&#39;
UNSURE = &#39;Unsure&#39;
CORRECT = &#39;Correct&#39;

class UnknownCommandError(Exception):
    pass

class Session(ConnectionBase):
    def __init__(self, *args):
        super().__init__(*args)
        self._clear_state(None, None)

    def _clear_state(self, lower, upper):
        self.lower = lower
        self.upper = upper
        self.secret = None
        self.guesses = []


# Example 3
    def loop(self):
        while command := self.receive():
            parts = command.split(&#39; &#39;)
            if parts[0] == &#39;PARAMS&#39;:
                self.set_params(parts)
            elif parts[0] == &#39;NUMBER&#39;:
                self.send_number()
            elif parts[0] == &#39;REPORT&#39;:
                self.receive_report(parts)
            else:
                raise UnknownCommandError(command)


# Example 4
    def set_params(self, parts):
        assert len(parts) == 3
        lower = int(parts[1])
        upper = int(parts[2])
        self._clear_state(lower, upper)


# Example 5
    def next_guess(self):
        if self.secret is not None:
            return self.secret

        while True:
            guess = random.randint(self.lower, self.upper)
            if guess not in self.guesses:
                return guess

    def send_number(self):
        guess = self.next_guess()
        self.guesses.append(guess)
        self.send(format(guess))


# Example 6
    def receive_report(self, parts):
        assert len(parts) == 2
        decision = parts[1]

        last = self.guesses[-1]
        if decision == CORRECT:
            self.secret = last

        print(f&#39;Server: {last} is {decision}&#39;)


# Example 7
import contextlib
import math

class Client(ConnectionBase):
    def __init__(self, *args):
        super().__init__(*args)
        self._clear_state()

    def _clear_state(self):
        self.secret = None
        self.last_distance = None


# Example 8
    @contextlib.contextmanager
    def session(self, lower, upper, secret):
        print(f&#39;Guess a number between {lower} and {upper}!&#39;
              f&#39; Shhhhh, it\&#39;s {secret}.&#39;)
        self.secret = secret
        self.send(f&#39;PARAMS {lower} {upper}&#39;)
        try:
            yield
        finally:
            self._clear_state()
            self.send(&#39;PARAMS 0 -1&#39;)


# Example 9
    def request_numbers(self, count):
        for _ in range(count):
            self.send(&#39;NUMBER&#39;)
            data = self.receive()
            yield int(data)
            if self.last_distance == 0:
                return


# Example 10
    def report_outcome(self, number):
        new_distance = math.fabs(number - self.secret)
        decision = UNSURE

        if new_distance == 0:
            decision = CORRECT
        elif self.last_distance is None:
            pass
        elif new_distance &lt; self.last_distance:
            decision = WARMER
        elif new_distance &gt; self.last_distance:
            decision = COLDER

        self.last_distance = new_distance

        self.send(f&#39;REPORT {decision}&#39;)
        return decision


# Example 11
import socket
from threading import Thread

def handle_connection(connection):
    with connection:
        session = Session(connection)
        try:
            session.loop()
        except EOFError:
            pass

def run_server(address):
    with socket.socket() as listener:
        # Allow the port to be reused
        listener.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        listener.bind(address)
        listener.listen()
        while True:
            connection, _ = listener.accept()
            thread = Thread(target=handle_connection,
                            args=(connection,),
                            daemon=True)
            thread.start()


# Example 12
def run_client(address):
    with socket.create_connection(address) as connection:
        client = Client(connection)

        with client.session(1, 5, 3):
            results = [(x, client.report_outcome(x))
                       for x in client.request_numbers(5)]

        with client.session(10, 15, 12):
            for number in client.request_numbers(5):
                outcome = client.report_outcome(number)
                results.append((number, outcome))

    return results


# Example 13
def main():
    address = (&#39;127.0.0.1&#39;, 1234)
    server_thread = Thread(
        target=run_server, args=(address,), daemon=True)
    server_thread.start()

    results = run_client(address)
    for number, outcome in results:
        print(f&#39;Client: {number} is {outcome}&#39;)

main()


# Example 14
class AsyncConnectionBase:
    def __init__(self, reader, writer):             # Changed
        self.reader = reader                        # Changed
        self.writer = writer                        # Changed

    async def send(self, command):
        line = command + &#39;\n&#39;
        data = line.encode()
        self.writer.write(data)                     # Changed
        await self.writer.drain()                   # Changed

    async def receive(self):
        line = await self.reader.readline()         # Changed
        if not line:
            raise EOFError(&#39;Connection closed&#39;)
        return line[:-1].decode()


# Example 15
class AsyncSession(AsyncConnectionBase):            # Changed
    def __init__(self, *args):
        super().__init__(*args)
        self._clear_values(None, None)

    def _clear_values(self, lower, upper):
        self.lower = lower
        self.upper = upper
        self.secret = None
        self.guesses = []


# Example 16
    async def loop(self):                           # Changed
        while command := await self.receive():      # Changed
            parts = command.split(&#39; &#39;)
            if parts[0] == &#39;PARAMS&#39;:
                self.set_params(parts)
            elif parts[0] == &#39;NUMBER&#39;:
                await self.send_number()            # Changed
            elif parts[0] == &#39;REPORT&#39;:
                self.receive_report(parts)
            else:
                raise UnknownCommandError(command)


# Example 17
    def set_params(self, parts):
        assert len(parts) == 3
        lower = int(parts[1])
        upper = int(parts[2])
        self._clear_values(lower, upper)


# Example 18
    def next_guess(self):
        if self.secret is not None:
            return self.secret

        while True:
            guess = random.randint(self.lower, self.upper)
            if guess not in self.guesses:
                return guess

    async def send_number(self):                    # Changed
        guess = self.next_guess()
        self.guesses.append(guess)
        await self.send(format(guess))              # Changed


# Example 19
    def receive_report(self, parts):
        assert len(parts) == 2
        decision = parts[1]

        last = self.guesses[-1]
        if decision == CORRECT:
            self.secret = last

        print(f&#39;Server: {last} is {decision}&#39;)


# Example 20
class AsyncClient(AsyncConnectionBase):             # Changed
    def __init__(self, *args):
        super().__init__(*args)
        self._clear_state()

    def _clear_state(self):
        self.secret = None
        self.last_distance = None


# Example 21
    @contextlib.asynccontextmanager                 # Changed
    async def session(self, lower, upper, secret):  # Changed
        print(f&#39;Guess a number between {lower} and {upper}!&#39;
              f&#39; Shhhhh, it\&#39;s {secret}.&#39;)
        self.secret = secret
        await self.send(f&#39;PARAMS {lower} {upper}&#39;)  # Changed
        try:
            yield
        finally:
            self._clear_state()
            await self.send(&#39;PARAMS 0 -1&#39;)          # Changed


# Example 22
    async def request_numbers(self, count):         # Changed
        for _ in range(count):
            await self.send(&#39;NUMBER&#39;)               # Changed
            data = await self.receive()             # Changed
            yield int(data)
            if self.last_distance == 0:
                return


# Example 23
    async def report_outcome(self, number):         # Changed
        new_distance = math.fabs(number - self.secret)
        decision = UNSURE

        if new_distance == 0:
            decision = CORRECT
        elif self.last_distance is None:
            pass
        elif new_distance &lt; self.last_distance:
            decision = WARMER
        elif new_distance &gt; self.last_distance:
            decision = COLDER

        self.last_distance = new_distance

        await self.send(f&#39;REPORT {decision}&#39;)       # Changed
        # Make it so the output printing is in
        # the same order as the threaded version.
        await asyncio.sleep(0.01)
        return decision


# Example 24
import asyncio

async def handle_async_connection(reader, writer):
    session = AsyncSession(reader, writer)
    try:
        await session.loop()
    except EOFError:
        pass

async def run_async_server(address):
    server = await asyncio.start_server(
        handle_async_connection, *address)
    async with server:
        await server.serve_forever()


# Example 25
async def run_async_client(address):
    # Wait for the server to listen before trying to connect
    await asyncio.sleep(0.1)

    streams = await asyncio.open_connection(*address)   # New
    client = AsyncClient(*streams)                      # New

    async with client.session(1, 5, 3):
        results = [(x, await client.report_outcome(x))
                   async for x in client.request_numbers(5)]

    async with client.session(10, 15, 12):
        async for number in client.request_numbers(5):
            outcome = await client.report_outcome(number)
            results.append((number, outcome))

    _, writer = streams                                 # New
    writer.close()                                      # New
    await writer.wait_closed()                          # New

    return results


# Example 26
async def main_async():
    address = (&#39;127.0.0.1&#39;, 4321)

    server = run_async_server(address)
    asyncio.create_task(server)

    results = await run_async_client(address)
    for number, outcome in results:
        print(f&#39;Client: {number} is {outcome}&#39;)

logging.getLogger().setLevel(logging.ERROR)

asyncio.run(main_async())

logging.getLogger().setLevel(logging.DEBUG)

</code></pre>
<h3 id="62-结合线程与协程，将代码顺利迁移到asyncio"><a href="#62-结合线程与协程，将代码顺利迁移到asyncio" class="headerlink" title="62. 结合线程与协程，将代码顺利迁移到asyncio"></a>62. 结合线程与协程，将代码顺利迁移到asyncio</h3><pre><code class="python">

# Example 1
class NoNewData(Exception):
    pass

def readline(handle):
    offset = handle.tell()
    handle.seek(0, 2)
    length = handle.tell()

    if length == offset:
        raise NoNewData

    handle.seek(offset, 0)
    return handle.readline()


# Example 2
import time

def tail_file(handle, interval, write_func):
    while not handle.closed:
        try:
            line = readline(handle)
        except NoNewData:
            time.sleep(interval)
        else:
            write_func(line)


# Example 3
from threading import Lock, Thread

def run_threads(handles, interval, output_path):
    with open(output_path, &#39;wb&#39;) as output:
        lock = Lock()
        def write(data):
            with lock:
                output.write(data)

        threads = []
        for handle in handles:
            args = (handle, interval, write)
            thread = Thread(target=tail_file, args=args)
            thread.start()
            threads.append(thread)

        for thread in threads:
            thread.join()


# Example 4
# This is all code to simulate the writers to the handles
import collections
import os
import random
import string
from tempfile import TemporaryDirectory

def write_random_data(path, write_count, interval):
    with open(path, &#39;wb&#39;) as f:
        for i in range(write_count):
            time.sleep(random.random() * interval)
            letters = random.choices(
                string.ascii_lowercase, k=10)
            data = f&#39;{path}-{i:02}-{&quot;&quot;.join(letters)}\n&#39;
            f.write(data.encode())
            f.flush()

def start_write_threads(directory, file_count):
    paths = []
    for i in range(file_count):
        path = os.path.join(directory, str(i))
        with open(path, &#39;w&#39;):
            # Make sure the file at this path will exist when
            # the reading thread tries to poll it.
            pass
        paths.append(path)
        args = (path, 10, 0.1)
        thread = Thread(target=write_random_data, args=args)
        thread.start()
    return paths

def close_all(handles):
    time.sleep(1)
    for handle in handles:
        handle.close()

def setup():
    tmpdir = TemporaryDirectory()
    input_paths = start_write_threads(tmpdir.name, 5)

    handles = []
    for path in input_paths:
        handle = open(path, &#39;rb&#39;)
        handles.append(handle)

    Thread(target=close_all, args=(handles,)).start()

    output_path = os.path.join(tmpdir.name, &#39;merged&#39;)
    return tmpdir, input_paths, handles, output_path


# Example 5
def confirm_merge(input_paths, output_path):
    found = collections.defaultdict(list)
    with open(output_path, &#39;rb&#39;) as f:
        for line in f:
            for path in input_paths:
                if line.find(path.encode()) == 0:
                    found[path].append(line)

    expected = collections.defaultdict(list)
    for path in input_paths:
        with open(path, &#39;rb&#39;) as f:
            expected[path].extend(f.readlines())

    for key, expected_lines in expected.items():
        found_lines = found[key]
        assert expected_lines == found_lines, \
            f&#39;{expected_lines!r} == {found_lines!r}&#39;

input_paths = ...
handles = ...
output_path = ...

tmpdir, input_paths, handles, output_path = setup()

run_threads(handles, 0.1, output_path)

confirm_merge(input_paths, output_path)

tmpdir.cleanup()


# Example 6
import asyncio

# On Windows, a ProactorEventLoop can&#39;t be created within
# threads because it tries to register signal handlers. This
# is a work-around to always use the SelectorEventLoop policy
# instead. See: https://bugs.python.org/issue33792
policy = asyncio.get_event_loop_policy()
policy._loop_factory = asyncio.SelectorEventLoop

async def run_tasks_mixed(handles, interval, output_path):
    loop = asyncio.get_event_loop()

    with open(output_path, &#39;wb&#39;) as output:
        async def write_async(data):
            output.write(data)

        def write(data):
            coro = write_async(data)
            future = asyncio.run_coroutine_threadsafe(
                coro, loop)
            future.result()

        tasks = []
        for handle in handles:
            task = loop.run_in_executor(
                None, tail_file, handle, interval, write)
            tasks.append(task)

        await asyncio.gather(*tasks)


# Example 7
input_paths = ...
handles = ...
output_path = ...

tmpdir, input_paths, handles, output_path = setup()

asyncio.run(run_tasks_mixed(handles, 0.1, output_path))

confirm_merge(input_paths, output_path)

tmpdir.cleanup()


# Example 8
async def tail_async(handle, interval, write_func):
    loop = asyncio.get_event_loop()

    while not handle.closed:
        try:
            line = await loop.run_in_executor(
                None, readline, handle)
        except NoNewData:
            await asyncio.sleep(interval)
        else:
            await write_func(line)


# Example 9
async def run_tasks(handles, interval, output_path):
    with open(output_path, &#39;wb&#39;) as output:
        async def write_async(data):
            output.write(data)

        tasks = []
        for handle in handles:
            coro = tail_async(handle, interval, write_async)
            task = asyncio.create_task(coro)
            tasks.append(task)

        await asyncio.gather(*tasks)


# Example 10
input_paths = ...
handles = ...
output_path = ...

tmpdir, input_paths, handles, output_path = setup()

asyncio.run(run_tasks(handles, 0.1, output_path))

confirm_merge(input_paths, output_path)

tmpdir.cleanup()


# Example 11
def tail_file(handle, interval, write_func):
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

    async def write_async(data):
        write_func(data)

    coro = tail_async(handle, interval, write_async)
    loop.run_until_complete(coro)


# Example 12
input_paths = ...
handles = ...
output_path = ...

tmpdir, input_paths, handles, output_path = setup()

run_threads(handles, 0.1, output_path)

confirm_merge(input_paths, output_path)

tmpdir.cleanup()

</code></pre>
<h3 id="63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"><a href="#63-让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力" class="headerlink" title="63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力"></a>63. 让asyncio的事件循环保持畅通，以便进一步提升程序的响应能力</h3><p>调用asyncio.run时，可以把debug参数设置成为true，这样可以知道哪些协程降低了事件循环的速度。</p>
<pre><code class="python">
# Example 1
import asyncio

# On Windows, a ProactorEventLoop can&#39;t be created within
# threads because it tries to register signal handlers. This
# is a work-around to always use the SelectorEventLoop policy
# instead. See: https://bugs.python.org/issue33792
policy = asyncio.get_event_loop_policy()
policy._loop_factory = asyncio.SelectorEventLoop

async def run_tasks(handles, interval, output_path):
    with open(output_path, &#39;wb&#39;) as output:
        async def write_async(data):
            output.write(data)

        tasks = []
        for handle in handles:
            coro = tail_async(handle, interval, write_async)
            task = asyncio.create_task(coro)
            tasks.append(task)

        await asyncio.gather(*tasks)


# Example 2
import time

async def slow_coroutine():
    time.sleep(0.5)  # Simulating slow I/O

asyncio.run(slow_coroutine(), debug=True)


# Example 3
from threading import Thread

class WriteThread(Thread):
    def __init__(self, output_path):
        super().__init__()
        self.output_path = output_path
        self.output = None
        self.loop = asyncio.new_event_loop()

    def run(self):
        asyncio.set_event_loop(self.loop)
        with open(self.output_path, &#39;wb&#39;) as self.output:
            self.loop.run_forever()

        # Run one final round of callbacks so the await on
        # stop() in another event loop will be resolved.
        self.loop.run_until_complete(asyncio.sleep(0))


# Example 4
    async def real_write(self, data):
        self.output.write(data)

    async def write(self, data):
        coro = self.real_write(data)
        future = asyncio.run_coroutine_threadsafe(
            coro, self.loop)
        await asyncio.wrap_future(future)


# Example 5
    async def real_stop(self):
        self.loop.stop()

    async def stop(self):
        coro = self.real_stop()
        future = asyncio.run_coroutine_threadsafe(
            coro, self.loop)
        await asyncio.wrap_future(future)


# Example 6
    async def __aenter__(self):
        loop = asyncio.get_event_loop()
        await loop.run_in_executor(None, self.start)
        return self

    async def __aexit__(self, *_):
        await self.stop()


# Example 7
class NoNewData(Exception):
    pass

def readline(handle):
    offset = handle.tell()
    handle.seek(0, 2)
    length = handle.tell()

    if length == offset:
        raise NoNewData

    handle.seek(offset, 0)
    return handle.readline()

async def tail_async(handle, interval, write_func):
    loop = asyncio.get_event_loop()

    while not handle.closed:
        try:
            line = await loop.run_in_executor(
                None, readline, handle)
        except NoNewData:
            await asyncio.sleep(interval)
        else:
            await write_func(line)

async def run_fully_async(handles, interval, output_path):
    async with WriteThread(output_path) as output:
        tasks = []
        for handle in handles:
            coro = tail_async(handle, interval, output.write)
            task = asyncio.create_task(coro)
            tasks.append(task)

        await asyncio.gather(*tasks)


# Example 8
# This is all code to simulate the writers to the handles
import collections
import os
import random
import string
from tempfile import TemporaryDirectory

def write_random_data(path, write_count, interval):
    with open(path, &#39;wb&#39;) as f:
        for i in range(write_count):
            time.sleep(random.random() * interval)
            letters = random.choices(
                string.ascii_lowercase, k=10)
            data = f&#39;{path}-{i:02}-{&quot;&quot;.join(letters)}\n&#39;
            f.write(data.encode())
            f.flush()

def start_write_threads(directory, file_count):
    paths = []
    for i in range(file_count):
        path = os.path.join(directory, str(i))
        with open(path, &#39;w&#39;):
            # Make sure the file at this path will exist when
            # the reading thread tries to poll it.
            pass
        paths.append(path)
        args = (path, 10, 0.1)
        thread = Thread(target=write_random_data, args=args)
        thread.start()
    return paths

def close_all(handles):
    time.sleep(1)
    for handle in handles:
        handle.close()

def setup():
    tmpdir = TemporaryDirectory()
    input_paths = start_write_threads(tmpdir.name, 5)

    handles = []
    for path in input_paths:
        handle = open(path, &#39;rb&#39;)
        handles.append(handle)

    Thread(target=close_all, args=(handles,)).start()

    output_path = os.path.join(tmpdir.name, &#39;merged&#39;)
    return tmpdir, input_paths, handles, output_path


# Example 9
def confirm_merge(input_paths, output_path):
    found = collections.defaultdict(list)
    with open(output_path, &#39;rb&#39;) as f:
        for line in f:
            for path in input_paths:
                if line.find(path.encode()) == 0:
                    found[path].append(line)

    expected = collections.defaultdict(list)
    for path in input_paths:
        with open(path, &#39;rb&#39;) as f:
            expected[path].extend(f.readlines())

    for key, expected_lines in expected.items():
        found_lines = found[key]
        assert expected_lines == found_lines

input_paths = ...
handles = ...
output_path = ...

tmpdir, input_paths, handles, output_path = setup()

asyncio.run(run_fully_async(handles, 0.1, output_path))

confirm_merge(input_paths, output_path)

tmpdir.cleanup()

</code></pre>
<h3 id="64-考虑用concurrent-futures实现真正的并行计算"><a href="#64-考虑用concurrent-futures实现真正的并行计算" class="headerlink" title="64. 考虑用concurrent.futures实现真正的并行计算"></a>64. 考虑用concurrent.futures实现真正的并行计算</h3><ol>
<li>Run_thread.py</li>
</ol>
<pre><code class="python">from concurrent.futures import ThreadPoolExecutor
import time

NUMBERS = [
    (1963309, 2265973), (2030677, 3814172),
    (1551645, 2229620), (2039045, 2020802),
    (1823712, 1924928), (2293129, 1020491),
    (1281238, 2273782), (3823812, 4237281),
    (3812741, 4729139), (1292391, 2123811),
]


def gcd(pair):
    a, b = pair
    low = min(a, b)
    for i in range(low, 0, -1):
        if a % i == 0 and b % i == 0:
            return i
    assert False, &#39;Not reachable&#39;


def main():    
    start = time.time()
    pool = ThreadPoolExecutor(max_workers=2)
    results = list(pool.map(gcd, NUMBERS))
    end = time.time()
    delta = end - start
    print(f&#39;Took {delta:.3f} seconds&#39;)  # Took 1.278 seconds

if __name__ == &#39;__main__&#39;:
    main()
</code></pre>
<ol start="2">
<li>Run_serial.py</li>
</ol>
<pre><code class="python">import time

NUMBERS = [
    (1963309, 2265973), (2030677, 3814172),
    (1551645, 2229620), (2039045, 2020802),
    (1823712, 1924928), (2293129, 1020491),
    (1281238, 2273782), (3823812, 4237281),
    (3812741, 4729139), (1292391, 2123811),
]


def gcd(pair):
    a, b = pair
    low = min(a, b)
    for i in range(low, 0, -1):
        if a % i == 0 and b % i == 0:
            return i
    assert False, &#39;Not reachable&#39;


def main():
    start = time.time()
    results = list(map(gcd, NUMBERS))
    end = time.time()
    delta = end - start
    print(f&#39;Took {delta:.3f} seconds&#39;)  # Took 1.204 seconds

if __name__ == &#39;__main__&#39;:
    main()

</code></pre>
<ol start="3">
<li>run_parallel.py</li>
</ol>
<pre><code class="python">from concurrent.futures import ProcessPoolExecutor
import time

NUMBERS = [
    (1963309, 2265973), (2030677, 3814172),
    (1551645, 2229620), (2039045, 2020802),
    (1823712, 1924928), (2293129, 1020491),
    (1281238, 2273782), (3823812, 4237281),
    (3812741, 4729139), (1292391, 2123811),
]

def gcd(pair):
    a, b = pair
    low = min(a, b)
    for i in range(low, 0, -1):
        if a % i == 0 and b % i == 0:
            return i
    assert False, &#39;Not reachable&#39;

def main():
    start = time.time()
    pool = ProcessPoolExecutor(max_workers=2)  # The one change
    results = list(pool.map(gcd, NUMBERS))
    end = time.time()
    delta = end - start
    print(f&#39;Took {delta:.3f} seconds&#39;)  # Took 0.635 seconds

if __name__ == &#39;__main__&#39;:
    main()

</code></pre>
<h2 id="八-稳定与性能"><a href="#八-稳定与性能" class="headerlink" title="八. 稳定与性能"></a>八. 稳定与性能</h2><h3 id="65-合理利用try-except-else-finally结构中的每个代码块"><a href="#65-合理利用try-except-else-finally结构中的每个代码块" class="headerlink" title="65. 合理利用try/except/else/finally结构中的每个代码块"></a>65. 合理利用try/except/else/finally结构中的每个代码块</h3><pre><code class="python">import json
UNDEFINED = object()
DIE_IN_ELSE_BLOCK = False

def divide_json(path):
    print(&#39;* Opening file&#39;)
    handle = open(path, &#39;r+&#39;)   # May raise OSError
    try:
        print(&#39;* Reading data&#39;)
        data = handle.read()    # May raise UnicodeDecodeError
        print(&#39;* Loading JSON data&#39;)
        op = json.loads(data)   # May raise ValueError
        print(&#39;* Performing calculation&#39;)
        value = (
            op[&#39;numerator&#39;] /
            op[&#39;denominator&#39;])  # May raise ZeroDivisionError
    except ZeroDivisionError as e:
        print(f&#39;* Handling ZeroDivisionError: {e}&#39;)
        return UNDEFINED
    else:
        print(&#39;* Writing calculation&#39;)
        op[&#39;result&#39;] = value
        result = json.dumps(op)
        handle.seek(0)          # May raise OSError
        if DIE_IN_ELSE_BLOCK:
            import errno
            import os
            raise OSError(errno.ENOSPC, os.strerror(errno.ENOSPC))
        handle.write(result)    # May raise OSError
        return value
    finally:
        print(&#39;* Calling close()&#39;)
        handle.close()          # Always runs


temp_path = &#39;random_data.json&#39;

with open(temp_path, &#39;w&#39;, encoding=&#39;utf-8&#39;) as f:
    f.write(&#39;{&quot;numerator&quot;: 1, &quot;denominator&quot;: 10}&#39;)

assert divide_json(temp_path) == 0.1

</code></pre>
<h3 id="66-考虑用contextlib和with语句来改写可复用的try-finally代码"><a href="#66-考虑用contextlib和with语句来改写可复用的try-finally代码" class="headerlink" title="66. 考虑用contextlib和with语句来改写可复用的try/finally代码"></a>66. 考虑用contextlib和with语句来改写可复用的try/finally代码</h3><pre><code class="python">
# Example 1
from threading import Lock

lock = Lock()
with lock:
    # Do something while maintaining an invariant
    pass


# Example 2
lock.acquire()
try:
    # Do something while maintaining an invariant
    pass
finally:
    lock.release()


# Example 3
import logging
logging.getLogger().setLevel(logging.WARNING)

def my_function():
    logging.debug(&#39;Some debug data&#39;)
    logging.error(&#39;Error log here&#39;)
    logging.debug(&#39;More debug data&#39;)


# Example 4
my_function()


# Example 5
from contextlib import contextmanager

@contextmanager
def debug_logging(level):
    logger = logging.getLogger()
    old_level = logger.getEffectiveLevel()
    logger.setLevel(level)
    try:
        yield
    finally:
        logger.setLevel(old_level)


# Example 6
with debug_logging(logging.DEBUG):
    print(&#39;* Inside:&#39;)
    my_function()

print(&#39;* After:&#39;)
my_function()


# Example 7
with open(&#39;my_output.txt&#39;, &#39;w&#39;, encoding=&#39;utf-8&#39;) as handle:
    handle.write(&#39;This is some data!&#39;)


# Example 8
@contextmanager
def log_level(level, name):
    logger = logging.getLogger(name)
    old_level = logger.getEffectiveLevel()
    logger.setLevel(level)
    try:
        yield logger
    finally:
        logger.setLevel(old_level)


# Example 9
with log_level(logging.DEBUG, &#39;my-log&#39;) as logger:
    logger.debug(f&#39;This is a message for {logger.name}!&#39;)
    logging.debug(&#39;This will not print&#39;)


# Example 10
logger = logging.getLogger(&#39;my-log&#39;)
logger.debug(&#39;Debug will not print&#39;)
logger.error(&#39;Error will print&#39;)


# Example 11
with log_level(logging.DEBUG, &#39;other-log&#39;) as logger:
    logger.debug(f&#39;This is a message for {logger.name}!&#39;)
    logging.debug(&#39;This will not print&#39;)

</code></pre>
<h3 id="67-用datetime模块处理本地时间，不要用time模块"><a href="#67-用datetime模块处理本地时间，不要用time模块" class="headerlink" title="67. 用datetime模块处理本地时间，不要用time模块"></a>67. 用datetime模块处理本地时间，不要用time模块</h3><pre><code class="python">import time
from datetime import datetime, timezone

now = datetime(2019, 3, 16, 22, 14, 35)
now_utc = now.replace(tzinfo=timezone.utc)
now_local = now_utc.astimezone()
print(now_local)  # 2019-03-17 06:14:35+08:00


# Example 6
time_str = &#39;2019-03-16 15:14:35&#39;
time_format = &#39;%Y-%m-%d %H:%M:%S&#39;
now = datetime.strptime(time_str, time_format)
time_tuple = now.timetuple()
utc_now = time.mktime(time_tuple)
print(utc_now)  # 1552720475.0


# Example 7
import pytz

arrival_nyc = &#39;2019-03-16 23:33:24&#39;
nyc_dt_naive = datetime.strptime(arrival_nyc, time_format)
eastern = pytz.timezone(&#39;US/Eastern&#39;)
nyc_dt = eastern.localize(nyc_dt_naive)
utc_dt = pytz.utc.normalize(nyc_dt.astimezone(pytz.utc))
print(utc_dt)  # 2019-03-17 03:33:24+00:00


# Example 8
pacific = pytz.timezone(&#39;US/Pacific&#39;)
sf_dt = pacific.normalize(utc_dt.astimezone(pacific))
print(sf_dt)  # 2019-03-16 20:33:24-07:00


# Example 9
nepal = pytz.timezone(&#39;Asia/Katmandu&#39;)
nepal_dt = nepal.normalize(utc_dt.astimezone(nepal))
print(nepal_dt)  # 2019-03-17 09:18:24+05:45
</code></pre>
<h3 id="68-用copyreg实现可靠的pickle操作"><a href="#68-用copyreg实现可靠的pickle操作" class="headerlink" title="68. 用copyreg实现可靠的pickle操作"></a>68. 用copyreg实现可靠的pickle操作</h3><pre><code class="python">import logging
# Example 1
class GameState:
    def __init__(self):
        self.level = 0
        self.lives = 4


# Example 2
state = GameState()
state.level += 1  # Player beat a level
state.lives -= 1  # Player had to try again

print(state.__dict__)


# Example 3
import pickle

state_path = &#39;game_state.bin&#39;
with open(state_path, &#39;wb&#39;) as f:
    pickle.dump(state, f)


# Example 4
with open(state_path, &#39;rb&#39;) as f:
    state_after = pickle.load(f)

print(state_after.__dict__)


# Example 5
class GameState:
    def __init__(self):
        self.level = 0
        self.lives = 4
        self.points = 0  # New field


# Example 6
state = GameState()
serialized = pickle.dumps(state)
state_after = pickle.loads(serialized)
print(state_after.__dict__)


# Example 7
with open(state_path, &#39;rb&#39;) as f:
    state_after = pickle.load(f)

print(state_after.__dict__)


# Example 8
assert isinstance(state_after, GameState)


# Example 9
class GameState:
    def __init__(self, level=0, lives=4, points=0):
        self.level = level
        self.lives = lives
        self.points = points


# Example 10
def pickle_game_state(game_state):
    kwargs = game_state.__dict__
    return unpickle_game_state, (kwargs,)


# Example 11
def unpickle_game_state(kwargs):
    return GameState(**kwargs)


# Example 12
import copyreg

copyreg.pickle(GameState, pickle_game_state)


# Example 13
state = GameState()
state.points += 1000
serialized = pickle.dumps(state)
state_after = pickle.loads(serialized)
print(state_after.__dict__)


# Example 14
class GameState:
    def __init__(self, level=0, lives=4, points=0, magic=5):
        self.level = level
        self.lives = lives
        self.points = points
        self.magic = magic  # New field


# Example 15
print(&#39;Before:&#39;, state.__dict__)
state_after = pickle.loads(serialized)
print(&#39;After: &#39;, state_after.__dict__)


# Example 16
class GameState:
    def __init__(self, level=0, points=0, magic=5):
        self.level = level
        self.points = points
        self.magic = magic


# Example 17
# try:
#     pickle.loads(serialized)
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 18
def pickle_game_state(game_state):
    kwargs = game_state.__dict__
    kwargs[&#39;version&#39;] = 2
    return unpickle_game_state, (kwargs,)


# Example 19
def unpickle_game_state(kwargs):
    version = kwargs.pop(&#39;version&#39;, 1)
    if version == 1:
        del kwargs[&#39;lives&#39;]
    return GameState(**kwargs)


# Example 20
copyreg.pickle(GameState, pickle_game_state)
print(&#39;Before:&#39;, state.__dict__)
state_after = pickle.loads(serialized)
print(&#39;After: &#39;, state_after.__dict__)


# Example 21
copyreg.dispatch_table.clear()
state = GameState()
serialized = pickle.dumps(state)
del GameState
class BetterGameState:
    def __init__(self, level=0, points=0, magic=5):
        self.level = level
        self.points = points
        self.magic = magic


# Example 22
# try:
#     pickle.loads(serialized)
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 23
print(serialized)


# Example 24
copyreg.pickle(BetterGameState, pickle_game_state)


# Example 25
state = BetterGameState()
serialized = pickle.dumps(state)
print(serialized)

</code></pre>
<h3 id="69-在需要准确计算的场合，用decimal表示相应的数值"><a href="#69-在需要准确计算的场合，用decimal表示相应的数值" class="headerlink" title="69. 在需要准确计算的场合，用decimal表示相应的数值"></a>69. 在需要准确计算的场合，用decimal表示相应的数值</h3><pre><code class="python">
# Example 1
rate = 1.45
seconds = 3*60 + 42
cost = rate * seconds / 60
print(cost)  # 5.364999999999999


# Example 2
print(round(cost, 2))  # 5.36


# Example 3
from decimal import Decimal

rate = Decimal(&#39;1.45&#39;)
seconds = Decimal(3*60 + 42)
cost = rate * seconds / Decimal(60)
print(cost)  # 5.365


# Example 4
print(Decimal(&#39;1.45&#39;))  # 1.45
print(Decimal(1.45))  # 1.4499999999999999555910790149937383830547332763671875


# Example 5
print(&#39;456&#39;)  # 456
print(456)  # 456


# Example 6
rate = Decimal(&#39;0.05&#39;)
seconds = Decimal(&#39;5&#39;)
small_cost = rate * seconds / Decimal(60)
print(small_cost)  # 0.004166666666666666666666666667


# Example 7
print(round(small_cost, 2))  # 0.00


# Example 8
from decimal import ROUND_UP

rounded = cost.quantize(Decimal(&#39;0.01&#39;), rounding=ROUND_UP)
print(f&#39;Rounded {cost} to {rounded}&#39;)  # Rounded 5.365 to 5.37


# Example 9
rounded = small_cost.quantize(Decimal(&#39;0.01&#39;), rounding=ROUND_UP)
print(f&#39;Rounded {small_cost} to {rounded}&#39;)  # Rounded 0.004166666666666666666666666667 to 0.01
</code></pre>
<h3 id="70-先分析性能，然后再优化"><a href="#70-先分析性能，然后再优化" class="headerlink" title="70. 先分析性能，然后再优化"></a>70. 先分析性能，然后再优化</h3><ol>
<li>优化python程序之前，一定要先分析它的性能，程序变慢的真正原因未必和我们想的一样；</li>
<li>可以通过Stats对象筛选出我们关心的结果。</li>
</ol>
<pre><code class="python">
# Example 1
def insertion_sort(data):
    result = []
    for value in data:
        insert_value(result, value)
    return result


# Example 2
def insert_value(array, value):
    for i, existing in enumerate(array):
        if existing &gt; value:
            array.insert(i, value)
            return
    array.append(value)


# Example 3
from random import randint

max_size = 10**4
data = [randint(0, max_size) for _ in range(max_size)]
test = lambda: insertion_sort(data)


# Example 4
from cProfile import Profile

profiler = Profile()
profiler.runcall(test)


# Example 5
from pstats import Stats

stats = Stats(profiler)
# stats = Stats(profiler, stream=STDOUT)
stats.strip_dirs()
stats.sort_stats(&#39;cumulative&#39;)
stats.print_stats()


# Example 6
from bisect import bisect_left

def insert_value(array, value):
    i = bisect_left(array, value)
    array.insert(i, value)


# Example 7
profiler = Profile()
profiler.runcall(test)
# stats = Stats(profiler, stream=STDOUT)
stats.strip_dirs()
stats.sort_stats(&#39;cumulative&#39;)
stats.print_stats()


# Example 8
def my_utility(a, b):
    c = 1
    for i in range(100):
        c += a * b

def first_func():
    for _ in range(1000):
        my_utility(4, 5)

def second_func():
    for _ in range(10):
        my_utility(1, 3)

def my_program():
    for _ in range(20):
        first_func()
        second_func()


# Example 9
profiler = Profile()
profiler.runcall(my_program)
# stats = Stats(profiler, stream=STDOUT)
stats.strip_dirs()
stats.sort_stats(&#39;cumulative&#39;)
stats.print_stats()


# Example 10
# stats = Stats(profiler, stream=STDOUT)
stats.strip_dirs()
stats.sort_stats(&#39;cumulative&#39;)
stats.print_callers()
</code></pre>
<h3 id="71-优先考虑用deque实现生产者-消费者队列"><a href="#71-优先考虑用deque实现生产者-消费者队列" class="headerlink" title="71. 优先考虑用deque实现生产者-消费者队列"></a>71. 优先考虑用deque实现生产者-消费者队列</h3><pre><code class="python">
# Example 1
class Email:
    def __init__(self, sender, receiver, message):
        self.sender = sender
        self.receiver = receiver
        self.message = message


# Example 2
def get_emails():
    yield Email(&#39;foo@example.com&#39;, &#39;bar@example.com&#39;, &#39;hello1&#39;)
    yield Email(&#39;baz@example.com&#39;, &#39;banana@example.com&#39;, &#39;hello2&#39;)
    yield None
    yield Email(&#39;meep@example.com&#39;, &#39;butter@example.com&#39;, &#39;hello3&#39;)
    yield Email(&#39;stuff@example.com&#39;, &#39;avocado@example.com&#39;, &#39;hello4&#39;)
    yield None
    yield Email(&#39;thingy@example.com&#39;, &#39;orange@example.com&#39;, &#39;hello5&#39;)
    yield Email(&#39;roger@example.com&#39;, &#39;bob@example.com&#39;, &#39;hello6&#39;)
    yield None
    yield Email(&#39;peanut@example.com&#39;, &#39;alice@example.com&#39;, &#39;hello7&#39;)
    yield None

EMAIL_IT = get_emails()

class NoEmailError(Exception):
    pass

def try_receive_email():
    # Returns an Email instance or raises NoEmailError
    try:
        email = next(EMAIL_IT)
    except StopIteration:
        email = None

    if not email:
        raise NoEmailError

    print(f&#39;Produced email: {email.message}&#39;)
    return email


# Example 3
def produce_emails(queue):
    while True:
        try:
            email = try_receive_email()
        except NoEmailError:
            return
        else:
            queue.append(email)  # Producer


# Example 4
def consume_one_email(queue):
    if not queue:
        return
    email = queue.pop(0)  # Consumer
    # Index the message for long-term archival
    print(f&#39;Consumed email: {email.message}&#39;)


# Example 5
def loop(queue, keep_running):
    while keep_running():
        produce_emails(queue)
        consume_one_email(queue)

def make_test_end():
    count=list(range(10))

    def func():
        if count:
            count.pop()
            return True
        return False

    return func


def my_end_func():
    pass

my_end_func = make_test_end()
loop([], my_end_func)


# Example 6
import timeit

def print_results(count, tests):
    avg_iteration = sum(tests) / len(tests)
    print(f&#39;Count {count:&gt;5,} takes {avg_iteration:.6f}s&#39;)
    return count, avg_iteration

def list_append_benchmark(count):
    def run(queue):
        for i in range(count):
            queue.append(i)

    tests = timeit.repeat(
        setup=&#39;queue = []&#39;,
        stmt=&#39;run(queue)&#39;,
        globals=locals(),
        repeat=1000,
        number=1)

    return print_results(count, tests)


# Example 7
def print_delta(before, after):
    before_count, before_time = before
    after_count, after_time = after
    growth = 1 + (after_count - before_count) / before_count
    slowdown = 1 + (after_time - before_time) / before_time
    print(f&#39;{growth:&gt;4.1f}x data size, {slowdown:&gt;4.1f}x time&#39;)

baseline = list_append_benchmark(500)
for count in (1_000, 2_000, 3_000, 4_000, 5_000):
    print()
    comparison = list_append_benchmark(count)
    print_delta(baseline, comparison)


# Example 8
def list_pop_benchmark(count):
    def prepare():
        return list(range(count))

    def run(queue):
        while queue:
            queue.pop(0)

    tests = timeit.repeat(
        setup=&#39;queue = prepare()&#39;,
        stmt=&#39;run(queue)&#39;,
        globals=locals(),
        repeat=1000,
        number=1)

    return print_results(count, tests)


# Example 9
baseline = list_pop_benchmark(500)
for count in (1_000, 2_000, 3_000, 4_000, 5_000):
    print()
    comparison = list_pop_benchmark(count)
    print_delta(baseline, comparison)


# Example 10
import collections

def consume_one_email(queue):
    if not queue:
        return
    email = queue.popleft()  # Consumer
    # Process the email message
    print(f&#39;Consumed email: {email.message}&#39;)

def my_end_func():
    pass

my_end_func = make_test_end()
EMAIL_IT = get_emails()
loop(collections.deque(), my_end_func)


# Example 11
def deque_append_benchmark(count):
    def prepare():
        return collections.deque()

    def run(queue):
        for i in range(count):
            queue.append(i)

    tests = timeit.repeat(
        setup=&#39;queue = prepare()&#39;,
        stmt=&#39;run(queue)&#39;,
        globals=locals(),
        repeat=1000,
        number=1)
    return print_results(count, tests)

baseline = deque_append_benchmark(500)
for count in (1_000, 2_000, 3_000, 4_000, 5_000):
    print()
    comparison = deque_append_benchmark(count)
    print_delta(baseline, comparison)


# Example 12
def dequeue_popleft_benchmark(count):
    def prepare():
        return collections.deque(range(count))

    def run(queue):
        while queue:
            queue.popleft()

    tests = timeit.repeat(
        setup=&#39;queue = prepare()&#39;,
        stmt=&#39;run(queue)&#39;,
        globals=locals(),
        repeat=1000,
        number=1)

    return print_results(count, tests)

baseline = dequeue_popleft_benchmark(500)
for count in (1_000, 2_000, 3_000, 4_000, 5_000):
    print()
    comparison = dequeue_popleft_benchmark(count)
    print_delta(baseline, comparison)

</code></pre>
<h3 id="72-考虑用bisect搜索已排序的序列"><a href="#72-考虑用bisect搜索已排序的序列" class="headerlink" title="72. 考虑用bisect搜索已排序的序列"></a>72. 考虑用bisect搜索已排序的序列</h3><pre><code class="python">
# Example 1
data = list(range(10**5))
index = data.index(91234)
assert index == 91234


# Example 2
def find_closest(sequence, goal):
    for index, value in enumerate(sequence):
        if goal &lt; value:
            return index
    raise ValueError(f&#39;{goal} is out of bounds&#39;)


index = find_closest(data, 91234.56)
assert index == 91235

try:
    find_closest(data, 100000000)
except ValueError:
    pass  # Expected
else:
    assert False


# Example 3  python内置的bisect模块可以更好的搜索有序列表
from bisect import bisect_left

index = bisect_left(data, 91234)     # Exact match
assert index == 91234

index = bisect_left(data, 91234.56)  # Closest match
assert index == 91235


# Example 4
import random
import timeit

size = 10**5
iterations = 1000

data = list(range(size))
to_lookup = [random.randint(0, size)
             for _ in range(iterations)]

def run_linear(data, to_lookup):
    for index in to_lookup:
        data.index(index)

def run_bisect(data, to_lookup):
    for index in to_lookup:
        bisect_left(data, index)

baseline = timeit.timeit(
    stmt=&#39;run_linear(data, to_lookup)&#39;,
    globals=globals(),
    number=10)
print(f&#39;Linear search takes {baseline:.6f}s&#39;)

comparison = timeit.timeit(
    stmt=&#39;run_bisect(data, to_lookup)&#39;,
    globals=globals(),
    number=10)
print(f&#39;Bisect search takes {comparison:.6f}s&#39;)

slowdown = 1 + ((baseline - comparison) / comparison)
print(f&#39;{slowdown:.1f}x time&#39;)

</code></pre>
<h3 id="73-学会使用heapq制作优先级队列"><a href="#73-学会使用heapq制作优先级队列" class="headerlink" title="73. 学会使用heapq制作优先级队列"></a>73. 学会使用heapq制作优先级队列</h3><p>有时候，我们想根据元素的优先程度来排序，此时应该使用优先级队列。</p>
<pre><code class="python">import logging
# Example 1
class Book:
    def __init__(self, title, due_date):
        self.title = title
        self.due_date = due_date


# Example 2
def add_book(queue, book):
    queue.append(book)
    queue.sort(key=lambda x: x.due_date, reverse=True)

queue = []
add_book(queue, Book(&#39;Don Quixote&#39;, &#39;2019-06-07&#39;))
add_book(queue, Book(&#39;Frankenstein&#39;, &#39;2019-06-05&#39;))
add_book(queue, Book(&#39;Les Misérables&#39;, &#39;2019-06-08&#39;))
add_book(queue, Book(&#39;War and Peace&#39;, &#39;2019-06-03&#39;))


# Example 3
class NoOverdueBooks(Exception):
    pass

def next_overdue_book(queue, now):
    if queue:
        book = queue[-1]
        if book.due_date &lt; now:
            queue.pop()
            return book

    raise NoOverdueBooks


# Example 4
now = &#39;2019-06-10&#39;

found = next_overdue_book(queue, now)
print(found.title)

found = next_overdue_book(queue, now)
print(found.title)


# Example 5
def return_book(queue, book):
    queue.remove(book)

queue = []
book = Book(&#39;Treasure Island&#39;, &#39;2019-06-04&#39;)

add_book(queue, book)
print(&#39;Before return:&#39;, [x.title for x in queue])

return_book(queue, book)
print(&#39;After return: &#39;, [x.title for x in queue])


# Example 6
try:
    next_overdue_book(queue, now)
except NoOverdueBooks:
    pass          # Expected
else:
    assert False  # Doesn&#39;t happen


# Example 7
import random
import timeit

def print_results(count, tests):
    avg_iteration = sum(tests) / len(tests)
    print(f&#39;Count {count:&gt;5,} takes {avg_iteration:.6f}s&#39;)
    return count, avg_iteration

def print_delta(before, after):
    before_count, before_time = before
    after_count, after_time = after
    growth = 1 + (after_count - before_count) / before_count
    slowdown = 1 + (after_time - before_time) / before_time
    print(f&#39;{growth:&gt;4.1f}x data size, {slowdown:&gt;4.1f}x time&#39;)

def list_overdue_benchmark(count):
    def prepare():
        to_add = list(range(count))
        random.shuffle(to_add)
        return [], to_add

    def run(queue, to_add):
        for i in to_add:
            queue.append(i)
            queue.sort(reverse=True)

        while queue:
            queue.pop()

    tests = timeit.repeat(
        setup=&#39;queue, to_add = prepare()&#39;,
        stmt=f&#39;run(queue, to_add)&#39;,
        globals=locals(),
        repeat=100,
        number=1)

    return print_results(count, tests)


# Example 8
baseline = list_overdue_benchmark(500)
for count in (1_000, 1_500, 2_000):
    print()
    comparison = list_overdue_benchmark(count)
    print_delta(baseline, comparison)


# Example 9
def list_return_benchmark(count):
    def prepare():
        queue = list(range(count))
        random.shuffle(queue)

        to_return = list(range(count))
        random.shuffle(to_return)

        return queue, to_return

    def run(queue, to_return):
        for i in to_return:
            queue.remove(i)

    tests = timeit.repeat(
        setup=&#39;queue, to_return = prepare()&#39;,
        stmt=f&#39;run(queue, to_return)&#39;,
        globals=locals(),
        repeat=100,
        number=1)

    return print_results(count, tests)


# Example 10
baseline = list_return_benchmark(500)
for count in (1_000, 1_500, 2_000):
    print()
    comparison = list_return_benchmark(count)
    print_delta(baseline, comparison)


# Example 11
from heapq import heappush

def add_book(queue, book):
    heappush(queue, book)


# Example 12
# try:
#     queue = []
#     add_book(queue, Book(&#39;Little Women&#39;, &#39;2019-06-05&#39;))
#     add_book(queue, Book(&#39;The Time Machine&#39;, &#39;2019-05-30&#39;))
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 13
import functools

@functools.total_ordering
class Book:
    def __init__(self, title, due_date):
        self.title = title
        self.due_date = due_date

    def __lt__(self, other):
        return self.due_date &lt; other.due_date


# Example 14
queue = []
add_book(queue, Book(&#39;Pride and Prejudice&#39;, &#39;2019-06-01&#39;))
add_book(queue, Book(&#39;The Time Machine&#39;, &#39;2019-05-30&#39;))
add_book(queue, Book(&#39;Crime and Punishment&#39;, &#39;2019-06-06&#39;))
add_book(queue, Book(&#39;Wuthering Heights&#39;, &#39;2019-06-12&#39;))
print([b.title for b in queue])


# Example 15
queue = [
    Book(&#39;Pride and Prejudice&#39;, &#39;2019-06-01&#39;),
    Book(&#39;The Time Machine&#39;, &#39;2019-05-30&#39;),
    Book(&#39;Crime and Punishment&#39;, &#39;2019-06-06&#39;),
    Book(&#39;Wuthering Heights&#39;, &#39;2019-06-12&#39;),
]
queue.sort()
print([b.title for b in queue])


# Example 16
from heapq import heapify

queue = [
    Book(&#39;Pride and Prejudice&#39;, &#39;2019-06-01&#39;),
    Book(&#39;The Time Machine&#39;, &#39;2019-05-30&#39;),
    Book(&#39;Crime and Punishment&#39;, &#39;2019-06-06&#39;),
    Book(&#39;Wuthering Heights&#39;, &#39;2019-06-12&#39;),
]
heapify(queue)
print([b.title for b in queue])


# Example 17
from heapq import heappop

def next_overdue_book(queue, now):
    if queue:
        book = queue[0]           # Most overdue first
        if book.due_date &lt; now:
            heappop(queue)        # Remove the overdue book
            return book

    raise NoOverdueBooks


# Example 18
now = &#39;2019-06-02&#39;

book = next_overdue_book(queue, now)
print(book.title)

book = next_overdue_book(queue, now)
print(book.title)

try:
    next_overdue_book(queue, now)
except NoOverdueBooks:
    pass          # Expected
else:
    assert False  # Doesn&#39;t happen


# Example 19
def heap_overdue_benchmark(count):
    def prepare():
        to_add = list(range(count))
        random.shuffle(to_add)
        return [], to_add

    def run(queue, to_add):
        for i in to_add:
            heappush(queue, i)
        while queue:
            heappop(queue)

    tests = timeit.repeat(
        setup=&#39;queue, to_add = prepare()&#39;,
        stmt=f&#39;run(queue, to_add)&#39;,
        globals=locals(),
        repeat=100,
        number=1)

    return print_results(count, tests)


# Example 20
baseline = heap_overdue_benchmark(500)
for count in (1_000, 1_500, 2_000):
    print()
    comparison = heap_overdue_benchmark(count)
    print_delta(baseline, comparison)


# Example 21
@functools.total_ordering
class Book:
    def __init__(self, title, due_date):
        self.title = title
        self.due_date = due_date
        self.returned = False  # New field

    def __lt__(self, other):
        return self.due_date &lt; other.due_date


# Example 22
def next_overdue_book(queue, now):
    while queue:
        book = queue[0]
        if book.returned:
            heappop(queue)
            continue

        if book.due_date &lt; now:
            heappop(queue)
            return book

        break

    raise NoOverdueBooks

queue = []

book = Book(&#39;Pride and Prejudice&#39;, &#39;2019-06-01&#39;)
add_book(queue, book)

book = Book(&#39;The Time Machine&#39;, &#39;2019-05-30&#39;)
add_book(queue, book)
book.returned = True

book = Book(&#39;Crime and Punishment&#39;, &#39;2019-06-06&#39;)
add_book(queue, book)
book.returned = True

book = Book(&#39;Wuthering Heights&#39;, &#39;2019-06-12&#39;)
add_book(queue, book)

now = &#39;2019-06-11&#39;

book = next_overdue_book(queue, now)
assert book.title == &#39;Pride and Prejudice&#39;

try:
    next_overdue_book(queue, now)
except NoOverdueBooks:
    pass          # Expected
else:
    assert False  # Doesn&#39;t happen


# Example 23
def return_book(queue, book):
    book.returned = True

assert not book.returned
return_book(queue, book)
assert book.returned

</code></pre>
<h3 id="74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作"><a href="#74-考虑用memoryview与bytearray来实现无须拷贝的bytes操作" class="headerlink" title="74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作"></a>74. 考虑用memoryview与bytearray来实现无须拷贝的bytes操作</h3><pre><code class="python"># Example 1
def timecode_to_index(video_id, timecode):
    return 1234
    # Returns the byte offset in the video data

def request_chunk(video_id, byte_offset, size):
    pass
    # Returns size bytes of video_id&#39;s data from the offset

video_id = ...
timecode = &#39;01:09:14:28&#39;
byte_offset = timecode_to_index(video_id, timecode)
size = 20 * 1024 * 1024
video_data = request_chunk(video_id, byte_offset, size)


# Example 2
class NullSocket:
    def __init__(self):
        self.handle = open(os.devnull, &#39;wb&#39;)

    def send(self, data):
        self.handle.write(data)

socket = ...             # socket connection to client
video_data = ...         # bytes containing data for video_id
byte_offset = ...        # Requested starting position
size = 20 * 1024 * 1024  # Requested chunk size
import os

socket = NullSocket()
video_data = 100 * os.urandom(1024 * 1024)
byte_offset = 1234

chunk = video_data[byte_offset:byte_offset + size]
socket.send(chunk)


# Example 3
import timeit

def run_test():
    chunk = video_data[byte_offset:byte_offset + size]
    # Call socket.send(chunk), but ignoring for benchmark

result = timeit.timeit(
    stmt=&#39;run_test()&#39;,
    globals=globals(),
    number=100) / 100

print(f&#39;{result:0.9f} seconds&#39;)


# Example 4
data = b&#39;shave and a haircut, two bits&#39;
view = memoryview(data)
chunk = view[12:19]
print(chunk)
print(&#39;Size:           &#39;, chunk.nbytes)
print(&#39;Data in view:   &#39;, chunk.tobytes())
print(&#39;Underlying data:&#39;, chunk.obj)


# Example 5
video_view = memoryview(video_data)

def run_test():
    chunk = video_view[byte_offset:byte_offset + size]
    # Call socket.send(chunk), but ignoring for benchmark

result = timeit.timeit(
    stmt=&#39;run_test()&#39;,
    globals=globals(),
    number=100) / 100

print(f&#39;{result:0.9f} seconds&#39;)


# Example 6
class FakeSocket:

    def recv(self, size):
        return video_view[byte_offset:byte_offset+size]

    def recv_into(self, buffer):
        source_data = video_view[byte_offset:byte_offset+size]
        buffer[:] = source_data

socket = ...        # socket connection to the client
video_cache = ...   # Cache of incoming video stream
byte_offset = ...   # Incoming buffer position
size = 1024 * 1024  # Incoming chunk size
socket = FakeSocket()
video_cache = video_data[:]
byte_offset = 1234

chunk = socket.recv(size)
video_view = memoryview(video_cache)
before = video_view[:byte_offset]
after = video_view[byte_offset + size:]
new_cache = b&#39;&#39;.join([before, chunk, after])


# Example 7
def run_test():
    chunk = socket.recv(size)
    before = video_view[:byte_offset]
    after = video_view[byte_offset + size:]
    new_cache = b&#39;&#39;.join([before, chunk, after])

result = timeit.timeit(
    stmt=&#39;run_test()&#39;,
    globals=globals(),
    number=100) / 100

print(f&#39;{result:0.9f} seconds&#39;)


# Example 8
# try:
#     my_bytes = b&#39;hello&#39;
#     my_bytes[0] = b&#39;\x79&#39;
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 9
my_array = bytearray(b&#39;hello&#39;)
my_array[0] = 0x79
print(my_array)


# Example 10
my_array = bytearray(b&#39;row, row, row your boat&#39;)
my_view = memoryview(my_array)
write_view = my_view[3:13]
write_view[:] = b&#39;-10 bytes-&#39;
print(my_array)


# Example 11
video_array = bytearray(video_cache)
write_view = memoryview(video_array)
chunk = write_view[byte_offset:byte_offset + size]
socket.recv_into(chunk)


# Example 12
def run_test():
    chunk = write_view[byte_offset:byte_offset + size]
    socket.recv_into(chunk)

result = timeit.timeit(
    stmt=&#39;run_test()&#39;,
    globals=globals(),
    number=100) / 100

print(f&#39;{result:0.9f} seconds&#39;)
</code></pre>
<h2 id="九-测试与调试"><a href="#九-测试与调试" class="headerlink" title="九. 测试与调试"></a>九. 测试与调试</h2><h3 id="75-通过repr字符串输出调试信息"><a href="#75-通过repr字符串输出调试信息" class="headerlink" title="75. 通过repr字符串输出调试信息"></a>75. 通过repr字符串输出调试信息</h3><pre><code class="python"># Example 1
print(&#39;foo bar&#39;)


# Example 2
my_value = &#39;foo bar&#39;
print(str(my_value))
print(&#39;%s&#39; % my_value)
print(f&#39;{my_value}&#39;)
print(format(my_value))
print(my_value.__format__(&#39;s&#39;))
print(my_value.__str__())


# Example 3
print(5)
print(&#39;5&#39;)

int_value = 5
str_value = &#39;5&#39;
print(f&#39;{int_value} == {str_value} ?&#39;)


# Example 4
a = &#39;\x07&#39;
print(repr(a))


# Example 5
b = eval(repr(a))
assert a == b


# Example 6
print(repr(5))
print(repr(&#39;5&#39;))


# Example 7
print(&#39;%r&#39; % 5)
print(&#39;%r&#39; % &#39;5&#39;)

int_value = 5
str_value = &#39;5&#39;
print(f&#39;{int_value!r} != {str_value!r}&#39;)


# Example 8
class OpaqueClass:
    def __init__(self, x, y):
        self.x = x
        self.y = y

obj = OpaqueClass(1, &#39;foo&#39;)
print(obj)


# Example 9
class BetterClass:
    def __init__(self, x, y):
        self.x = x
        self.y = y

    def __repr__(self):
        return f&#39;BetterClass({self.x!r}, {self.y!r})&#39;


# Example 10
obj = BetterClass(2, &#39;bar&#39;)
print(obj)


# Example 11
obj = OpaqueClass(4, &#39;baz&#39;)
print(obj.__dict__)
</code></pre>
<h3 id="76-在TestCase子类里验证相关的行为"><a href="#76-在TestCase子类里验证相关的行为" class="headerlink" title="76. 在TestCase子类里验证相关的行为"></a>76. 在TestCase子类里验证相关的行为</h3><ol>
<li>Helper_test.py</li>
</ol>
<pre><code class="python">from unittest import TestCase, main

def sum_squares(values):
    cumulative = 0
    for value in values:
        cumulative += value ** 2
        yield cumulative

class HelperTestCase(TestCase):
    def verify_complex_case(self, values, expected):
        expect_it = iter(expected)
        found_it = iter(sum_squares(values))
        test_it = zip(expect_it, found_it)

        for i, (expect, found) in enumerate(test_it):
            self.assertEqual(
                expect,
                found,
                f&#39;Index {i} is wrong&#39;)

        # Verify both generators are exhausted
        try:
            next(expect_it)
        except StopIteration:
            pass
        else:
            self.fail(&#39;Expected longer than found&#39;)

        try:
            next(found_it)
        except StopIteration:
            pass
        else:
            self.fail(&#39;Found longer than expected&#39;)

    def test_wrong_lengths(self):
        values = [1.1, 2.2, 3.3]
        expected = [
            1.1**2,
        ]
        self.verify_complex_case(values, expected)

    def test_wrong_results(self):
        values = [1.1, 2.2, 3.3]
        expected = [
            1.1**2,
            1.1**2 + 2.2**2,
            1.1**2 + 2.2**2 + 3.3**2 + 4.4**2,
        ]
        self.verify_complex_case(values, expected)

if __name__ == &#39;__main__&#39;:
    main()

</code></pre>
<ol start="2">
<li>Data_driven_test.py</li>
</ol>
<pre><code class="python">from unittest import TestCase, main
from utils import to_str

class DataDrivenTestCase(TestCase):
    def test_good(self):
        good_cases = [
            (b&#39;my bytes&#39;, &#39;my bytes&#39;),
            (&#39;no error&#39;, b&#39;no error&#39;),  # This one will fail
            (&#39;other str&#39;, &#39;other str&#39;),
        ]
        for value, expected in good_cases:
            with self.subTest(value):
                self.assertEqual(expected, to_str(value))

    def test_bad(self):
        bad_cases = [
            (object(), TypeError),
            (b&#39;\xfa\xfa&#39;, UnicodeDecodeError),
        ]
        for value, exception in bad_cases:
            with self.subTest(value):
                with self.assertRaises(exception):
                    to_str(value)

if __name__ == &#39;__main__&#39;:
    main()

</code></pre>
<h3 id="77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"><a href="#77-把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰" class="headerlink" title="77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰"></a>77. 把测试前、后的准备与清理逻辑写在setUp、tearDown、setUpModule与tearDownModule中，以防用例之间互相干扰</h3><pre><code class="python">from unittest import TestCase, main

def setUpModule():
    print(&#39;* Module setup&#39;)

def tearDownModule():
    print(&#39;* Module clean-up&#39;)

class IntegrationTest(TestCase):
    def setUp(self):
        print(&#39;* Test setup&#39;)

    def tearDown(self):
        print(&#39;* Test clean-up&#39;)

    def test_end_to_end1(self):
        print(&#39;* Test 1&#39;)

    def test_end_to_end2(self):
        print(&#39;* Test 2&#39;)

if __name__ == &#39;__main__&#39;:
    main()

</code></pre>
<h3 id="78-用Mock来模拟受测代码所依赖的复杂函数"><a href="#78-用Mock来模拟受测代码所依赖的复杂函数" class="headerlink" title="78. 用Mock来模拟受测代码所依赖的复杂函数"></a>78. 用Mock来模拟受测代码所依赖的复杂函数</h3><pre><code class="python">import logging
# Example 1
class DatabaseConnection:
    def __init__(self, host, port):
        pass

class DatabaseConnectionError(Exception):
    pass

def get_animals(database, species):
    # Query the Database
    raise DatabaseConnectionError(&#39;Not connected&#39;)
    # Return a list of (name, last_mealtime) tuples


# Example 2
# try:
#     database = DatabaseConnection(&#39;localhost&#39;, &#39;4444&#39;)
#
#     get_animals(database, &#39;Meerkat&#39;)
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 3
from datetime import datetime
from unittest.mock import Mock

mock = Mock(spec=get_animals)
expected = [
    (&#39;Spot&#39;, datetime(2019, 6, 5, 11, 15)),
    (&#39;Fluffy&#39;, datetime(2019, 6, 5, 12, 30)),
    (&#39;Jojo&#39;, datetime(2019, 6, 5, 12, 45)),
]
mock.return_value = expected


# Example 4
# try:
#     mock.does_not_exist
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 5
database = object()
result = mock(database, &#39;Meerkat&#39;)
assert result == expected


# Example 6
mock.assert_called_once_with(database, &#39;Meerkat&#39;)


# Example 7
# try:
#     mock.assert_called_once_with(database, &#39;Giraffe&#39;)
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 8
from unittest.mock import ANY

mock = Mock(spec=get_animals)
mock(&#39;database 1&#39;, &#39;Rabbit&#39;)
mock(&#39;database 2&#39;, &#39;Bison&#39;)
mock(&#39;database 3&#39;, &#39;Meerkat&#39;)

mock.assert_called_with(ANY, &#39;Meerkat&#39;)


# Example 9
# try:
#     class MyError(Exception):
#         pass
#
#     mock = Mock(spec=get_animals)
#     mock.side_effect = MyError(&#39;Whoops! Big problem&#39;)
#     result = mock(database, &#39;Meerkat&#39;)
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 10
def get_food_period(database, species):
    # Query the Database
    pass
    # Return a time delta

def feed_animal(database, name, when):
    # Write to the Database
    pass

def do_rounds(database, species):
    now = datetime.datetime.utcnow()
    feeding_timedelta = get_food_period(database, species)
    animals = get_animals(database, species)
    fed = 0

    for name, last_mealtime in animals:
        if (now - last_mealtime) &gt; feeding_timedelta:
            feed_animal(database, name, now)
            fed += 1

    return fed


# Example 11
def do_rounds(database, species, *,
              now_func=datetime.utcnow,
              food_func=get_food_period,
              animals_func=get_animals,
              feed_func=feed_animal):
    now = now_func()
    feeding_timedelta = food_func(database, species)
    animals = animals_func(database, species)
    fed = 0

    for name, last_mealtime in animals:
        if (now - last_mealtime) &gt; feeding_timedelta:
            feed_func(database, name, now)
            fed += 1

    return fed


# Example 12
from datetime import timedelta

now_func = Mock(spec=datetime.utcnow)
now_func.return_value = datetime(2019, 6, 5, 15, 45)

food_func = Mock(spec=get_food_period)
food_func.return_value = timedelta(hours=3)

animals_func = Mock(spec=get_animals)
animals_func.return_value = [
    (&#39;Spot&#39;, datetime(2019, 6, 5, 11, 15)),
    (&#39;Fluffy&#39;, datetime(2019, 6, 5, 12, 30)),
    (&#39;Jojo&#39;, datetime(2019, 6, 5, 12, 45)),
]

feed_func = Mock(spec=feed_animal)


# Example 13
result = do_rounds(
    database,
    &#39;Meerkat&#39;,
    now_func=now_func,
    food_func=food_func,
    animals_func=animals_func,
    feed_func=feed_func)

assert result == 2


# Example 14
from unittest.mock import call

food_func.assert_called_once_with(database, &#39;Meerkat&#39;)

animals_func.assert_called_once_with(database, &#39;Meerkat&#39;)

feed_func.assert_has_calls(
    [
        call(database, &#39;Spot&#39;, now_func.return_value),
        call(database, &#39;Fluffy&#39;, now_func.return_value),
    ],
    any_order=True)


# Example 15
from unittest.mock import patch

print(&#39;Outside patch:&#39;, get_animals)

with patch(&#39;__main__.get_animals&#39;):
    print(&#39;Inside patch: &#39;, get_animals)

print(&#39;Outside again:&#39;, get_animals)


# Example 16
# try:
#     fake_now = datetime(2019, 6, 5, 15, 45)
#
#     with patch(&#39;datetime.datetime.utcnow&#39;):
#         datetime.utcnow.return_value = fake_now
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 17
def get_do_rounds_time():
    return datetime.datetime.utcnow()

def do_rounds(database, species):
    now = get_do_rounds_time()

with patch(&#39;__main__.get_do_rounds_time&#39;):
    pass


# Example 18
def do_rounds(database, species, *, utcnow=datetime.utcnow):
    now = utcnow()
    feeding_timedelta = get_food_period(database, species)
    animals = get_animals(database, species)
    fed = 0

    for name, last_mealtime in animals:
        if (now - last_mealtime) &gt; feeding_timedelta:
            feed_animal(database, name, now)
            fed += 1

    return fed


# Example 19
from unittest.mock import DEFAULT

with patch.multiple(&#39;__main__&#39;,
                    autospec=True,
                    get_food_period=DEFAULT,
                    get_animals=DEFAULT,
                    feed_animal=DEFAULT):
    now_func = Mock(spec=datetime.utcnow)
    now_func.return_value = datetime(2019, 6, 5, 15, 45)
    get_food_period.return_value = timedelta(hours=3)
    get_animals.return_value = [
        (&#39;Spot&#39;, datetime(2019, 6, 5, 11, 15)),
        (&#39;Fluffy&#39;, datetime(2019, 6, 5, 12, 30)),
        (&#39;Jojo&#39;, datetime(2019, 6, 5, 12, 45))
    ]


# Example 20
    result = do_rounds(database, &#39;Meerkat&#39;, utcnow=now_func)
    assert result == 2

    get_food_period.assert_called_once_with(database, &#39;Meerkat&#39;)
    get_animals.assert_called_once_with(database, &#39;Meerkat&#39;)
    feed_animal.assert_has_calls(
        [
            call(database, &#39;Spot&#39;, now_func.return_value),
            call(database, &#39;Fluffy&#39;, now_func.return_value),
        ],
        any_order=True)

</code></pre>
<h3 id="79-把受测代码所依赖的系统封装起来，以便于模拟和测试"><a href="#79-把受测代码所依赖的系统封装起来，以便于模拟和测试" class="headerlink" title="79. 把受测代码所依赖的系统封装起来，以便于模拟和测试"></a>79. 把受测代码所依赖的系统封装起来，以便于模拟和测试</h3><pre><code class="python"># Example 1
class ZooDatabase:

    def get_animals(self, species):
        pass

    def get_food_period(self, species):
        pass

    def feed_animal(self, name, when):
        pass


# Example 2
from datetime import datetime

def do_rounds(database, species, *, utcnow=datetime.utcnow):
    now = utcnow()
    feeding_timedelta = database.get_food_period(species)
    animals = database.get_animals(species)
    fed = 0

    for name, last_mealtime in animals:
        if (now - last_mealtime) &gt;= feeding_timedelta:
            database.feed_animal(name, now)
            fed += 1

    return fed


# Example 3
from unittest.mock import Mock

database = Mock(spec=ZooDatabase)
print(database.feed_animal)
database.feed_animal()
database.feed_animal.assert_any_call()


# Example 4
from datetime import timedelta
from unittest.mock import call

now_func = Mock(spec=datetime.utcnow)
now_func.return_value = datetime(2019, 6, 5, 15, 45)

database = Mock(spec=ZooDatabase)
database.get_food_period.return_value = timedelta(hours=3)
database.get_animals.return_value = [
    (&#39;Spot&#39;, datetime(2019, 6, 5, 11, 15)),
    (&#39;Fluffy&#39;, datetime(2019, 6, 5, 12, 30)),
    (&#39;Jojo&#39;, datetime(2019, 6, 5, 12, 55))
]


# Example 5
result = do_rounds(database, &#39;Meerkat&#39;, utcnow=now_func)
assert result == 2

database.get_food_period.assert_called_once_with(&#39;Meerkat&#39;)
database.get_animals.assert_called_once_with(&#39;Meerkat&#39;)
database.feed_animal.assert_has_calls(
    [
        call(&#39;Spot&#39;, now_func.return_value),
        call(&#39;Fluffy&#39;, now_func.return_value),
    ],
    any_order=True)


# # Example 6
# try:
#     database.bad_method_name()
# except:
#     logging.exception(&#39;Expected&#39;)
# else:
#     assert False


# Example 7
DATABASE = None

def get_database():
    global DATABASE
    if DATABASE is None:
        DATABASE = ZooDatabase()
    return DATABASE

def main(argv):
    database = get_database()
    species = argv[1]
    count = do_rounds(database, species)
    print(f&#39;Fed {count} {species}(s)&#39;)
    return 0


# Example 8
import contextlib
import io
from unittest.mock import patch

with patch(&#39;__main__.DATABASE&#39;, spec=ZooDatabase):
    now = datetime.utcnow()

    DATABASE.get_food_period.return_value = timedelta(hours=3)
    DATABASE.get_animals.return_value = [
        (&#39;Spot&#39;, now - timedelta(minutes=4.5)),
        (&#39;Fluffy&#39;, now - timedelta(hours=3.25)),
        (&#39;Jojo&#39;, now - timedelta(hours=3)),
    ]

    fake_stdout = io.StringIO()
    with contextlib.redirect_stdout(fake_stdout):
        main([&#39;program name&#39;, &#39;Meerkat&#39;])

    found = fake_stdout.getvalue()
    expected = &#39;Fed 2 Meerkat(s)\n&#39;

    assert found == expected
</code></pre>
<h3 id="80-考虑用pdb做交互调试"><a href="#80-考虑用pdb做交互调试" class="headerlink" title="80. 考虑用pdb做交互调试"></a>80. 考虑用pdb做交互调试</h3><pre><code class="python">import math

def compute_rmse(observed, ideal):
    total_err_2 = 0
    count = 0
    for got, wanted in zip(observed, ideal):
        err_2 = (got - wanted) ** 2
        breakpoint()  # Start the debugger here
        total_err_2 += err_2
        count += 1

    mean_err = total_err_2 / count
    rmse = math.sqrt(mean_err)
    return rmse

result = compute_rmse(
    [1.8, 1.7, 3.2, 6],
    [2, 1.5, 3, 5])
print(result)

</code></pre>
<h3 id="81-用tracemalloc来掌握内存的使用与泄漏情况"><a href="#81-用tracemalloc来掌握内存的使用与泄漏情况" class="headerlink" title="81. 用tracemalloc来掌握内存的使用与泄漏情况"></a>81. 用tracemalloc来掌握内存的使用与泄漏情况</h3><ol>
<li>gc模块可以帮助我们了解垃圾回收器追踪到了哪些对象，但并不能告诉我们那些对象是如何分配的；</li>
</ol>
<pre><code class="python">import gc

found_objects = gc.get_objects()
print(&#39;Before:&#39;, len(found_objects))

import waste_memory

hold_reference = waste_memory.run()

found_objects = gc.get_objects()
print(&#39;After: &#39;, len(found_objects))
for obj in found_objects[:3]:
    print(repr(obj)[:100])

print(&#39;...&#39;)
</code></pre>
<ol>
<li>python内置的tracemalloc模块提供了一套强大的工具，可以帮助我们了解内存的使用情况，并且找到这些内存由那一行代码所分配。</li>
</ol>
<pre><code class="python">import tracemalloc

tracemalloc.start(10)                      # Set stack depth
time1 = tracemalloc.take_snapshot()        # Before snapshot
import os

class MyObject:
    def __init__(self):
        self.data = os.urandom(100)

def get_data():
    values = []
    for _ in range(100):
        obj = MyObject()
        values.append(obj)
    return values

def run():
    deep_values = []
    for _ in range(100):
        deep_values.append(get_data())
    return deep_values


x = run()                     # Usage to debug
time2 = tracemalloc.take_snapshot()        # After snapshot

stats = time2.compare_to(time1, &#39;lineno&#39;)  # Compare snapshots
for stat in stats[:3]:
    print(stat)
</code></pre>
<pre><code class="python">import tracemalloc

tracemalloc.start(10)
time1 = tracemalloc.take_snapshot()

import os

class MyObject:
    def __init__(self):
        self.data = os.urandom(100)

def get_data():
    values = []
    for _ in range(100):
        obj = MyObject()
        values.append(obj)
    return values

def run():
    deep_values = []
    for _ in range(100):
        deep_values.append(get_data())
    return deep_values


x = run()
time2 = tracemalloc.take_snapshot()

stats = time2.compare_to(time1, &#39;traceback&#39;)
top = stats[0]
print(&#39;Biggest offender is:&#39;)
print(&#39;\n&#39;.join(top.traceback.format()))

</code></pre>
<h2 id="十-协作并发"><a href="#十-协作并发" class="headerlink" title="十. 协作并发"></a>十. 协作并发</h2><h3 id="82-学会寻找由其他Python开发者所构建的模块"><a href="#82-学会寻找由其他Python开发者所构建的模块" class="headerlink" title="82. 学会寻找由其他Python开发者所构建的模块"></a>82. 学会寻找由其他Python开发者所构建的模块</h3><p>python集中存放模块的地方：<a href="https://pypi.org" target="_blank" rel="noopener">https://pypi.org</a> 。</p>
<h3 id="83-用虚拟环境隔离项目，并重建依赖关系"><a href="#83-用虚拟环境隔离项目，并重建依赖关系" class="headerlink" title="83. 用虚拟环境隔离项目，并重建依赖关系"></a>83. 用虚拟环境隔离项目，并重建依赖关系</h3><p>通过pip show可以查看它的依赖关系：<code>python3 -m pip show flask</code>, 结果如下：</p>
<pre><code>Name: Flask
Version: 2.0.1
Summary: A simple framework for building complex web applications.
Home-page: https://palletsprojects.com/p/flask
Author: Armin Ronacher
Author-email: armin.ronacher@active-4.com
License: BSD-3-Clause
Location: /usr/local/lib/python3.9/site-packages
Requires: itsdangerous, click, Jinja2, Werkzeug
Required-by: 
</code></pre><p>在命令行界面执行venv命令：</p>
<pre><code class="shell">python3 -m venv 虚拟环境名  # 创建虚拟环境
source bin/activate 和 deactivate  # 启用和禁用该环境
python3 -m pip install -r requirements.txt # 安装包
</code></pre>
<h3 id="84-每一个函数、类与模块都要写docstring"><a href="#84-每一个函数、类与模块都要写docstring" class="headerlink" title="84. 每一个函数、类与模块都要写docstring"></a>84. 每一个函数、类与模块都要写docstring</h3><pre><code class="python">import itertools


def find_anagrams(word, dictionary):
    &quot;&quot;&quot;Find all anagrams for a word.

    This function only runs as fast as the test for
    membership in the &#39;dictionary&#39; container.

    Args:
        word: String of the target word.
        dictionary: collections.abc.Container with all
            strings that are known to be actual words.

    Returns:
        List of anagrams that were found. Empty if
        none were found.
    &quot;&quot;&quot;
    permutations = itertools.permutations(word, len(word))
    possible = (&#39;&#39;.join(x) for x in permutations)
    found = {word for word in possible if word in dictionary}
    return list(found)


assert find_anagrams(&#39;pancakes&#39;, [&#39;scanpeak&#39;]) == [&#39;scanpeak&#39;]
</code></pre>
<h3 id="85-用包来安排模块，以提供稳固的API"><a href="#85-用包来安排模块，以提供稳固的API" class="headerlink" title="85. 用包来安排模块，以提供稳固的API"></a>85. 用包来安排模块，以提供稳固的API</h3><p>如我们想设计一个包，用来计算抛射物之间的碰撞</p>
<pre><code class="python"># mypackage/models.py
__all__ = [&#39;Projectile&#39;]


class Projectile:
    def __init__(self, mass, velocity):
        self.mass = mass
        self.velocity = velocity
</code></pre>
<pre><code class="python"># mypackage/utils.py
from . models import Projectile

__all__ = [&#39;simulate_collision&#39;]


def _dot_product(a, b):
    pass


def simulate_collision(a, b):
    after_a = Projectile(-a.mass, -a.velocity)
    after_b = Projectile(-b.mass, -b.velocity)
    return after_a, after_b
</code></pre>
<pre><code class="python"># mypackage/__init__.py
__all__ = []
from . models import *
__all__ += models.__all__
from . utils import *
__all__ += utils.__all__
</code></pre>
<p>没有出现在<code>__all___</code>之中的，都不会随着<code>from mypackage import *</code>语句引入，对外部使用者隐藏了这些名字。</p>
<pre><code class="python"># api_consumer.py
from mypackage import *

a = Projectile(1.5, 3)
b = Projectile(4, 1.7)
after_a, after_b = simulate_collision(a, b)
print(after_a.__dict__, after_b.__dict__)  # {&#39;mass&#39;: -1.5, &#39;velocity&#39;: -3} {&#39;mass&#39;: -4, &#39;velocity&#39;: -1.7}
</code></pre>
<h3 id="86-考虑用模块级别的代码配置不同的部署环境"><a href="#86-考虑用模块级别的代码配置不同的部署环境" class="headerlink" title="86. 考虑用模块级别的代码配置不同的部署环境"></a>86. 考虑用模块级别的代码配置不同的部署环境</h3><pre><code class="python">class TestingDatabase:
    pass


class RealDatabase:
    pass


TESTING = True
if TESTING:
    Database = TestingDatabase
else:
    Database = RealDatabase
</code></pre>
<h3 id="87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"><a href="#87-为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常" class="headerlink" title="87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常"></a>87. 为自编的模块定义根异常，让调用者能够专门处理与此API有关的异常</h3><pre><code class="python">import logging
# Example 1
# my_module.py
def determine_weight(volume, density):
    if density &lt;= 0:
        raise ValueError(&#39;Density must be positive&#39;)

try:
    determine_weight(1, 0)
except ValueError:
    pass
else:
    assert False


# Example 2
# my_module.py
class Error(Exception):
    &quot;&quot;&quot;Base-class for all exceptions raised by this module.&quot;&quot;&quot;

class InvalidDensityError(Error):
    &quot;&quot;&quot;There was a problem with a provided density value.&quot;&quot;&quot;

class InvalidVolumeError(Error):
    &quot;&quot;&quot;There was a problem with the provided weight value.&quot;&quot;&quot;

def determine_weight(volume, density):
    if density &lt; 0:
        raise InvalidDensityError(&#39;Density must be positive&#39;)
    if volume &lt; 0:
        raise InvalidVolumeError(&#39;Volume must be positive&#39;)
    if volume == 0:
        density / volume


# Example 3
class my_module:
    Error = Error
    InvalidDensityError = InvalidDensityError

    @staticmethod
    def determine_weight(volume, density):
        if density &lt; 0:
            raise InvalidDensityError(&#39;Density must be positive&#39;)
        if volume &lt; 0:
            raise InvalidVolumeError(&#39;Volume must be positive&#39;)
        if volume == 0:
            density / volume

try:
    weight = my_module.determine_weight(1, -1)
except my_module.Error:
    logging.exception(&#39;Unexpected error&#39;)
else:
    assert False


# Example 4
SENTINEL = object()
weight = SENTINEL
try:
    weight = my_module.determine_weight(-1, 1)
except my_module.InvalidDensityError:
    weight = 0
except my_module.Error:
    logging.exception(&#39;Bug in the calling code&#39;)
else:
    assert False

assert weight is SENTINEL


# Example 5
try:
    weight = SENTINEL
    try:
        weight = my_module.determine_weight(0, 1)
    except my_module.InvalidDensityError:
        weight = 0
    except my_module.Error:
        logging.exception(&#39;Bug in the calling code&#39;)
    except Exception:
        logging.exception(&#39;Bug in the API code!&#39;)
        raise  # Re-raise exception to the caller
    else:
        assert False

    assert weight == 0
except:
    logging.exception(&#39;Expected&#39;)
else:
    assert False


# Example 6
# my_module.py

class NegativeDensityError(InvalidDensityError):
    &quot;&quot;&quot;A provided density value was negative.&quot;&quot;&quot;


def determine_weight(volume, density):
    if density &lt; 0:
        raise NegativeDensityError(&#39;Density must be positive&#39;)


# Example 7
try:
    my_module.NegativeDensityError = NegativeDensityError
    my_module.determine_weight = determine_weight
    try:
        weight = my_module.determine_weight(1, -1)
    except my_module.NegativeDensityError:
        raise ValueError(&#39;Must supply non-negative density&#39;)
    except my_module.InvalidDensityError:
        weight = 0
    except my_module.Error:
        logging.exception(&#39;Bug in the calling code&#39;)
    except Exception:
        logging.exception(&#39;Bug in the API code!&#39;)
        raise
    else:
        assert False
except:
    logging.exception(&#39;Expected&#39;)
else:
    assert False
</code></pre>
<h3 id="88-用适当的方式打破循环依赖关系"><a href="#88-用适当的方式打破循环依赖关系" class="headerlink" title="88. 用适当的方式打破循环依赖关系"></a>88. 用适当的方式打破循环依赖关系</h3><ol>
<li><p>如果两个模块都要在开头引入对方，那就会形成循环依赖关系，可能会导致程序启动时崩溃；</p>
</li>
<li><p>想要打破循环依赖，最好的办法是把这两个模块都用到的代码重构到整个依赖的最底层；</p>
</li>
<li><p>如果不想大幅度重构代码，也不想让代码太复杂，最简单的方法就是通过动态引入来消除循环依赖关系。</p>
<pre><code class="python"># dialog.py
class Dialog:
    def __init__(self):
        pass

# Using this instead will break things
# save_dialog = Dialog(app.prefs.get(&#39;save_dir&#39;))
save_dialog = Dialog()

def show():
    import app  # Dynamic import  程序运行时才触发
    save_dialog.save_dir = app.prefs.get(&#39;save_dir&#39;)
    print(&#39;Showing the dialog!&#39;)
</code></pre>
<pre><code class="python"># app.py
import dialog

class Prefs:
    def get(self, name):
        pass

prefs = Prefs()
dialog.show()
</code></pre>
<p>一般来说，还是应该尽量避免动态引入，因为import语句毕竟是有开销的，如果它出现在频繁执行的循环体里面，这种开销会更大。虽然如此，但是比大幅度修改整个程序要好。</p>
</li>
</ol>
<h3 id="89-重构时考虑通过warnings提醒开发者API已经发生变化"><a href="#89-重构时考虑通过warnings提醒开发者API已经发生变化" class="headerlink" title="89. 重构时考虑通过warnings提醒开发者API已经发生变化"></a>89. 重构时考虑通过warnings提醒开发者API已经发生变化</h3><pre><code class="python">
# Example 1
def print_distance(speed, duration):
    distance = speed * duration
    print(f&#39;{distance} miles&#39;)

print_distance(5, 2.5)


# Example 2
print_distance(1000, 3)


# Example 3
CONVERSIONS = {
    &#39;mph&#39;: 1.60934 / 3600 * 1000,   # m/s
    &#39;hours&#39;: 3600,                  # seconds
    &#39;miles&#39;: 1.60934 * 1000,        # m
    &#39;meters&#39;: 1,                    # m
    &#39;m/s&#39;: 1,                       # m
    &#39;seconds&#39;: 1,                   # s
}

def convert(value, units):
    rate = CONVERSIONS[units]
    return rate * value

def localize(value, units):
    rate = CONVERSIONS[units]
    return value / rate

def print_distance(speed, duration, *,
                   speed_units=&#39;mph&#39;,
                   time_units=&#39;hours&#39;,
                   distance_units=&#39;miles&#39;):
    norm_speed = convert(speed, speed_units)
    norm_duration = convert(duration, time_units)
    norm_distance = norm_speed * norm_duration
    distance = localize(norm_distance, distance_units)
    print(f&#39;{distance} {distance_units}&#39;)


# Example 4
print_distance(1000, 3,
               speed_units=&#39;meters&#39;,
               time_units=&#39;seconds&#39;)


# Example 5
import warnings

def print_distance(speed, duration, *,
                   speed_units=None,
                   time_units=None,
                   distance_units=None):
    if speed_units is None:
        warnings.warn(
            &#39;speed_units required&#39;, DeprecationWarning)
        speed_units = &#39;mph&#39;

    if time_units is None:
        warnings.warn(
            &#39;time_units required&#39;, DeprecationWarning)
        time_units = &#39;hours&#39;

    if distance_units is None:
        warnings.warn(
            &#39;distance_units required&#39;, DeprecationWarning)
        distance_units = &#39;miles&#39;

    norm_speed = convert(speed, speed_units)
    norm_duration = convert(duration, time_units)
    norm_distance = norm_speed * norm_duration
    distance = localize(norm_distance, distance_units)
    print(f&#39;{distance} {distance_units}&#39;)


# Example 6
import contextlib
import io

fake_stderr = io.StringIO()
with contextlib.redirect_stderr(fake_stderr):
    print_distance(1000, 3,
                   speed_units=&#39;meters&#39;,
                   time_units=&#39;seconds&#39;)

print(fake_stderr.getvalue())


# Example 7
def require(name, value, default):
    if value is not None:
        return value
    warnings.warn(
        f&#39;{name} will be required soon, update your code&#39;,
        DeprecationWarning,
        stacklevel=3)
    return default

def print_distance(speed, duration, *,
                   speed_units=None,
                   time_units=None,
                   distance_units=None):
    speed_units = require(&#39;speed_units&#39;, speed_units, &#39;mph&#39;)
    time_units = require(&#39;time_units&#39;, time_units, &#39;hours&#39;)
    distance_units = require(
        &#39;distance_units&#39;, distance_units, &#39;miles&#39;)

    norm_speed = convert(speed, speed_units)
    norm_duration = convert(duration, time_units)
    norm_distance = norm_speed * norm_duration
    distance = localize(norm_distance, distance_units)
    print(f&#39;{distance} {distance_units}&#39;)


# Example 8
import contextlib
import io

fake_stderr = io.StringIO()
with contextlib.redirect_stderr(fake_stderr):
    print_distance(1000, 3,
                   speed_units=&#39;meters&#39;,
                   time_units=&#39;seconds&#39;)

print(fake_stderr.getvalue())


# Example 9
warnings.simplefilter(&#39;error&#39;)
try:
    warnings.warn(&#39;This usage is deprecated&#39;,
                  DeprecationWarning)
except DeprecationWarning:
    pass  # Expected
else:
    assert False

warnings.resetwarnings()


# Example 10
warnings.resetwarnings()

warnings.simplefilter(&#39;ignore&#39;)
warnings.warn(&#39;This will not be printed to stderr&#39;)

warnings.resetwarnings()


# Example 11
import logging

fake_stderr = io.StringIO()
handler = logging.StreamHandler(fake_stderr)
formatter = logging.Formatter(
    &#39;%(asctime)-15s WARNING] %(message)s&#39;)
handler.setFormatter(formatter)

logging.captureWarnings(True)
logger = logging.getLogger(&#39;py.warnings&#39;)
logger.addHandler(handler)
logger.setLevel(logging.DEBUG)

warnings.resetwarnings()
warnings.simplefilter(&#39;default&#39;)
warnings.warn(&#39;This will go to the logs output&#39;)

print(fake_stderr.getvalue())

warnings.resetwarnings()


# Example 12
with warnings.catch_warnings(record=True) as found_warnings:
    found = require(&#39;my_arg&#39;, None, &#39;fake units&#39;)
    expected = &#39;fake units&#39;
    assert found == expected


# Example 13
assert len(found_warnings) == 1
single_warning = found_warnings[0]
assert str(single_warning.message) == (
    &#39;my_arg will be required soon, update your code&#39;)
assert single_warning.category == DeprecationWarning

</code></pre>
<h3 id="90-考虑通过typing做静态分析，以消除bug"><a href="#90-考虑通过typing做静态分析，以消除bug" class="headerlink" title="90. 考虑通过typing做静态分析，以消除bug"></a>90. 考虑通过typing做静态分析，以消除bug</h3><p>typing模块：<a href="https://docs.python.org/3.8/library/typing.html" target="_blank" rel="noopener">https://docs.python.org/3.8/library/typing.html</a>。可以给变量，字段，函数与方法标注类型信息。</p>
<pre><code class="python">from typing import Callable, List, TypeVar

Value = TypeVar(&#39;Value&#39;)
Func = Callable[[Value, Value], Value]


def combine(func: Func[Value], values: List[Value]) -&gt; Value:
    assert len(values) &gt; 0

    result = values[0]
    for next_value in values[1:]:
        result = func(result, next_value)
    return result


Real = TypeVar(&#39;Real&#39;, int, float)


def add(x: Real, y: Real) -&gt; Real:
    return x + y


inputs = [1, 2, 3, 4j]  # Oops: included a complex number
result = combine(add, inputs)
print(result)  # (6+4j)
assert result == 10

</code></pre>
<p>下面的python3.7开始支持，程序执行时，忽略类型注解里提到的值，于是就解决了提前引用的问题，而且程序在启动时的性能也会提升。</p>
<pre><code class="python">from __future__ import annotations


class FirstClass:
    def __init__(self, value: SecondClass) -&gt; None:  # OK
        self.value = value


class SecondClass:
    def __init__(self, value: int) -&gt; None:
        self.value = value


second = SecondClass(5)
print(second)  # &lt;__main__.SecondClass object at 0x7fafc12cd4d0&gt;
first = FirstClass(second)  
print(first)  # &lt;__main__.FirstClass object at 0x7fafc12cd510&gt;
</code></pre>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎指出任何有错误或不够清晰的表达。欢迎邮件至 320479069@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2017-2021 CuiYonghua
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 592px;
    }
    .nav.fullscreen {
        margin-left: -592px;
    }
    .nav-left {
        width: 170px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 542px;
        }
        .nav.fullscreen {
            margin-left: -542px;
        }
        .nav-left {
            width: 150px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 542px;
            margin-left: -542px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
